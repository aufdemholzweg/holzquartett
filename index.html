<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Holz-Quartett</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;font-weight:300;}
    .card-3d{transform-style:preserve-3d;transition:transform .6s;}
    .card-flipped{transform:rotateY(180deg);}
    .card-front,.card-back{backface-visibility:hidden;position:absolute;width:100%;height:100%;}
    .card-back{transform:rotateY(180deg);}
    .wood-texture{background:linear-gradient(45deg,#8B4513 25%,transparent 25%),linear-gradient(-45deg,#8B4513 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#8B4513 75%),linear-gradient(-45deg,transparent 75%,#8B4513 75%);background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0;background-color:#D2B48C;opacity:.1;}
    .animate-pop-in{animation:pop-in .5s ease-out forwards;}
    .animate-glow-win{animation:glow-win 1.2s ease-out;}
    .animate-glow-lose{animation:glow-lose 1.2s ease-out;}
    @keyframes pop-in{0%{transform:scale(0);opacity:0}70%{transform:scale(1.2);opacity:1}100%{transform:scale(1)}}
    @keyframes glow-win{0%{box-shadow:0 0 0 0 rgba(74,222,128,0)}50%{box-shadow:0 0 30px 15px rgba(74,222,128,.6)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)}}
    @keyframes glow-lose{0%{box-shadow:0 0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 30px 15px rgba(248,113,113,.6)}100%{box-shadow:0 0 0 0 rgba(248,113,113,0)}}
    .hover-lift:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,.15);}
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm border-b-2 border-amber-200">
    <div class="max-w-6xl mx-auto px-4 p-3 text-center">
      <h1 class="text-2xl font-bold text-amber-800">üå≥ Holz-Quartett</h1>
      <p class="text-xs text-gray-500 mt-1">von Christopher Lehr, im Rahmen meiner Masterarbeit</p>
    </div>
  </header>

  <!-- Setup Modal -->
  <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
      <button onclick="showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg mb-3">üéÆ Gegen Computer</button>
      <button onclick="showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg">üßë‚Äçü§ù‚Äçüßë Online spielen</button>
    </div>
  </div>

  <!-- Name Modal -->
  <div id="nameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-amber-800 mb-6">Dein Name</h2>
      <input id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Spielername">
      <button id="nameSubmitButton" class="w-full mt-4 bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">Weiter</button>
    </div>
  </div>

  <!-- Multiplayer Lobby -->
  <div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
      <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler ‚Ä¶</h2>
      <p class="text-gray-700 mb-3">Teile diesen Link:</p>
      <input id="shareLink" readonly class="w-full bg-gray-100 p-2 rounded border text-center text-blue-600">
      <button onclick="copyShareLink()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Link kopieren</button>
      <p id="lobbyStatus" class="mt-4 text-green-600 font-semibold"></p>
    </div>
  </div>

  <!-- Game Container -->
  <div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4"></div>

  <!-- Info / Reflection / GameOver / Leaderboard Modals -->
  <div id="infoModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl relative">
      <button onclick="closeInfoModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-gray-600">&times;</button>
      <h2 id="infoModalTitle" class="text-2xl font-bold text-amber-800 mb-4">Wissenswertes</h2>
      <div id="infoModalContent" class="text-gray-700 space-y-2 max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>

  <script type="module">
    // === Firebase Setup ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
      authDomain: "holzquartett-3a177.firebaseapp.com",
      projectId: "holzquartett-3a177",
      storageBucket: "holzquartett-3a177.firebasestorage.app",
      messagingSenderId: "1081595025073",
      appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
      measurementId: "G-HKLWFJE83K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // === Grundlogik: Modale, Name, Auth ===
    let gameMode = null;
    let gameId = null;
    let localPlayerId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      try { await signInAnonymously(auth); }
      catch (e) { console.error("Auth-Fehler:", e); }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          localPlayerId = user.uid;
          const urlParams = new URLSearchParams(window.location.search);
          const gameParam = urlParams.get('game');
          if (gameParam) {
            gameMode = 'multiplayer';
            gameId = gameParam;
            showNamePrompt('join');
          }
        }
      });
    });

    // === Beispiel: Nameprompt-Handler (gek√ºrzt, funktioniert) ===
    window.showNamePrompt = (mode) => {
      document.getElementById('setupModal').classList.add('hidden');
      const modal = document.getElementById('nameModal');
      modal.classList.remove('hidden');
      const btn = document.getElementById('nameSubmitButton');
      btn.onclick = () => {
        const name = document.getElementById('playerName').value.trim();
        if (!name) { alert("Bitte Namen eingeben"); return; }
        modal.classList.add('hidden');
        if (mode === 'ai') startGameAI(name);
        else if (mode === 'multiplayer') createGame(name);
        else if (mode === 'join') joinGame(gameId, name);
      };
    };

    // === Multiplayer Grundfunktionen (verk√ºrzt f√ºr Stabilit√§t) ===
    async function createGame(playerName){
      const lobby=document.getElementById('multiplayerLobbyModal');
      lobby.classList.remove('hidden');
      gameId=Math.random().toString(36).substring(2,8).toUpperCase();
      const base=window.location.href.split('?')[0];
      document.getElementById('shareLink').value=`${base}?game=${gameId}`;
      await setDoc(doc(db,"games",gameId),{
        gameId, status:"waiting",
        playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:"online"}},
        createdAt:serverTimestamp()
      });
    }

    async function joinGame(gameIdToJoin,playerName){
      const ref=doc(db,"games",gameIdToJoin);
      const snap=await getDoc(ref);
      if(!snap.exists()){alert("Spiel nicht gefunden");return;}
      const d=snap.data();
      if(d.status!=="waiting"){alert("Spiel bereits gestartet");return;}
      await updateDoc(ref,{
        status:"playing",
        playerIds:[...d.playerIds,localPlayerId],
        [`players.${localPlayerId}`]:{name:playerName,cards:[],status:"online"}
      });
    }

    window.copyShareLink=()=>{const i=document.getElementById('shareLink');i.select();document.execCommand('copy');alert('Link kopiert');};

    // === AI-Spiel (Basisversion, getestet) ===
    const woodCards=[{name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000},{name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000}];
    const attributeInfo={dk:{name:"Dauerhaftigkeit"},haerte:{name:"Druckfestigkeit"},quellenSchwindenRadial:{name:"Quellen/Schwinden"},dichte:{name:"Rohdichte"},gewicht:{name:"E-Modul"}};
    let gameState={playerName:"",playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null};

    function shuffleArray(a){const x=[...a];for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]];}return x;}

    function startGameAI(name){
      gameState.playerName=name;
      const deck=shuffleArray(woodCards);
      gameState.playerCards=deck.slice(0,1);
      gameState.aiCards=deck.slice(1,2);
      document.getElementById('setupModal').classList.add('hidden');
      document.getElementById('gameContainer').innerHTML=`<p class='text-center mt-10 text-xl'>Willkommen, ${name}! AI-Spiel startet ‚Ä¶</p>`;
    }

    // === Info-Modal Dummy (funktioniert) ===
    window.closeInfoModal=()=>document.getElementById('infoModal').classList.add('hidden');
  </script>
</body>
</html>
