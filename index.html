Das ist ein sehr hilfreicher Screenshot\! Das Design wirkt viel aufger√§umter und ‚Äûw√§rmer‚Äú.

Ich habe den Code nun exakt an dieses visuelle Vorbild angepasst:

1.  **Layout-Struktur (Wichtigste √Ñnderung):** Um sicherzustellen, dass die Namens-Boxen **exakt** so breit sind wie die Spielkarten, habe ich das Layout ge√§ndert. Es gibt nun zwei vertikale S√§ulen (Links: Spieler-Score + Karte / Rechts: Gegner-Score + Karte). Dadurch sind Score-Box und Karte immer perfekt b√ºndig.
2.  **Karten-Design:**
      * Die H√∂he wurde um ca. 5% reduziert (`aspect-[20/42]`).
      * Der Hintergrund und die Rahmenfarben sind nun w√§rmer (Creme/Orange/Braun-T√∂ne), passend zum Foto.
3.  **Kategorien (Attribute):**
      * Das Design der Buttons wurde komplett √ºberarbeitet: Heller Hintergrund (`bg-orange-50`), abgerundete Ecken (`rounded-xl`), goldener Rahmen.
      * Die Einheiten (z.B. `N/mm¬≤`) stehen nun klein unter dem Namen der Eigenschaft.
      * Der Wert steht fett und braun rechts au√üen.
4.  **Statusbalken:** Befindet sich nun ganz unten unter den Karten.

Hier ist die aktualisierte `index.html`.

```html
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfbf7; /* W√§rmerer Hintergrund */
            touch-action: manipulation;
            overflow-x: hidden;
        }

        /* 3D Karten Effekte */
        .perspective-1000 { perspective: 1000px; }
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            border-radius: 1rem; /* Etwas runder wie im Bild */
            overflow: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
            background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');
            background-size: cover;
            background-position: center;
            border: 4px solid white;
        }
        .card-front-bg {
            /* Heller Creme-Hintergrund f√ºr die Vorderseite */
            background-color: #fffbeb; 
            background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7);
        }

        /* Animationen */
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        .falling-star {
            position: absolute;
            font-size: 4rem;
            z-index: 100;
            animation: fall-and-fade 1.2s ease-in forwards;
            pointer-events: none;
        }
        @keyframes fall-and-fade {
            0% { transform: translateY(-30px) scale(1.5) rotate(0deg); opacity: 0; }
            30% { transform: translateY(0) scale(1) rotate(45deg); opacity: 1; }
            100% { transform: translateY(300px) scale(0.5) rotate(180deg); opacity: 0; }
        }

        /* Name auf R√ºckseite Gegner */
        .opponent-back-name {
            position: absolute;
            top: 15%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.95);
            font-weight: 700;
            font-size: 1.1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .dimmer { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        
        /* Spezieller Style f√ºr die Attribut-Boxen */
        .attr-box {
            background-color: #fff7ed; /* orange-50 */
            border: 1px solid #fbbf24; /* amber-400 */
            transition: all 0.2s;
        }
        /* Aktiver State f√ºr Orange Flash */
        .attr-box.flash-active {
            background-color: #f97316 !important; /* orange-500 */
            border-color: #ea580c !important; /* orange-600 */
            color: white !important;
        }
        .attr-box.flash-active span {
            color: white !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative text-gray-800">

<header class="bg-amber-600 text-white shadow-md z-20 flex-shrink-0">
    <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold tracking-wider uppercase">HOLZEN!</h1>
            <p class="text-[10px] opacity-90 uppercase tracking-wide">Masterarbeit Projekt</p>
        </div>
    </div>
</header>

<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-4xl mx-auto relative p-2 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <div class="flex justify-center items-start gap-3 w-full flex-grow relative pb-4 mt-2"> 
        
        <div class="flex flex-col w-[48%] max-w-[240px] gap-2 z-10">
            <div class="bg-white rounded-2xl shadow-sm border border-orange-100 p-3 text-center">
                <div id="playerNameDisplay" class="text-lg font-bold text-amber-700 leading-tight">Chris</div>
                <div class="text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-gray-800">16</span></div>
            </div>
            
            <div class="w-full aspect-[20/42] perspective-1000 relative" id="playerCardContainer">
                <div id="playerCard" class="w-full h-full relative"></div>
            </div>
        </div>

        <div class="flex flex-col w-[48%] max-w-[240px] gap-2 z-10">
            <div class="bg-white rounded-2xl shadow-sm border border-orange-100 p-3 text-center">
                <div id="opponentNameDisplay" class="text-lg font-bold text-gray-600 leading-tight">GEGNER</div>
                <div class="text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-gray-800">16</span></div>
            </div>

            <div class="w-full aspect-[20/42] perspective-1000 relative" id="aiCardContainer">
                <div id="aiCard" class="w-full h-full relative"></div>
            </div>
        </div>

    </div>

    <div class="w-full px-4 mb-20 max-w-md"> 
        <div class="h-4 w-full bg-gray-200 rounded-full overflow-hidden border border-gray-300 shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 transition-all duration-500 ease-out" style="width: 50%;"></div>
        </div>
        <div class="flex justify-between text-[10px] font-bold text-gray-400 mt-1 px-2">
            <span>Dein Stapel</span><span>Gegner Stapel</span>
        </div>
    </div>
</div>

<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>

        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-purple-800 transition">
                üéì Zusatzwissen
            </button>
            <button id="bsNextBtn" class="flex-1 bg-amber-500 hover:bg-amber-600 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-700 transition">
                Weiter &rarr;
            </button>
        </div>
    </div>
</div>

<div id="setupModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-sm w-full">
        <div class="bg-amber-500 p-5 text-white text-center font-bold text-xl tracking-wide shadow-md">
            HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus w√§hlen</span>
        </div>
        <div class="p-6 space-y-5">
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 active:scale-[0.98] text-white font-bold py-4 rounded-xl shadow-lg transform transition duration-200 flex items-center justify-center gap-3">
                <span class="text-2xl">ü§ñ</span> Gegen Computer
            </button>
            <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 active:scale-[0.98] text-white font-bold py-4 rounded-xl shadow-lg transform transition duration-200 flex items-center justify-center gap-3">
                <span class="text-2xl">üåç</span> Online gegen Freunde
            </button>

            <div class="pt-4 space-y-4 border-t border-gray-100 mt-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700 flex items-center gap-2">üîä Ton an</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="soundToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700 flex items-center gap-2">üëÄ Gegner-Karte sichtbar</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="revealBackToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
        <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg focus:border-amber-500 focus:outline-none" placeholder="Name eingeben" maxlength="12">
        <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600 transition transform active:scale-95">Starten</button>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Warte auf Mitspieler...</p>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p id="lobbyStatus" class="text-sm text-green-600 font-bold animate-pulse"></p>
    </div>
</div>

<div id="infoModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-md w-full max-h-[90vh] flex flex-col">
        <div class="bg-purple-700 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 id="infoModalTitle" class="font-bold text-lg flex items-center gap-2">üéì Zusatzwissen</h3>
            <button onclick="window.closeInfoModal()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto hide-scrollbar space-y-4"></div>
        <div class="p-3 bg-gray-50 border-t shrink-0 text-center">
            <button onclick="window.closeInfoModal()" class="text-purple-600 font-bold text-sm hover:underline">Schlie√üen</button>
        </div>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
        <p id="gameOverText" class="text-gray-600 mb-6"></p>
        <div class="space-y-3">
            <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">üèÜ Bestenliste</button>
            <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">üîÑ Neues Spiel</button>
        </div>
    </div>
</div>

<div id="reflectionModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-amber-800 mb-4">üéâ Super gespielt!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 font-medium"></p>
        <textarea id="reflectionAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg">Weiter</button>
    </div>
</div>

<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">Schlie√üen</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* --- STATE & AUDIO --- */
let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;
const sounds={
  flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
  win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
  chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
  starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

/* --- DATA --- */
const woodCards=[
 {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000},
 {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000},
 {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000},
 {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000},
 {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000},
 {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000},
 {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000},
 {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500},
 {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000},
 {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500},
 {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000},
 {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000},
 {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500},
 {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500},
 {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000},
 {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000},
 {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000},
 {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000},
 {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000},
 {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500},
 {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000},
 {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000},
 {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000},
 {name:"Zypresse",dk:2,haerte:48,quellenSchwindenRadial:3.0,dichte:520,gewicht:9000},
 {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500},
 {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000},
 {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000},
 {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000},
 {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000},
 {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500}
];

const getSlug = (name) => {
    const map = {
        'Eiche':'eiche', 'Buche':'buche', 'Kiefer':'kiefer', 'Fichte':'fichte', 'Tanne':'tanne',
        'L√§rche':'laerche', 'Birke':'birke', 'Ahorn':'ahorn', 'Esche':'esche', 'Kirsche':'kirsche',
        'Nussbaum':'nussbaum', 'Douglasie':'douglasie', 'Zeder':'zeder', 'Mahagoni':'mahagoni',
        'Teak':'teak', 'Bambus':'bambus', 'Pappel':'pappel', 'Weide':'weide', 'Linde':'linde',
        'Ulme':'ulme', 'Kastanie':'kastanie', 'Robinie':'robinie', 'Hemlock':'hemlock',
        'Zypresse':'zypresse', 'Redwood':'redwood', 'Hickory':'hickory', 'Wenge':'wenge',
        'Zebrano':'zebrano', 'Palisander':'palisander', 'Ebenholz':'ebenholz'
    };
    return map[name] || name.toLowerCase();
};
const getWoodImage = (name, type) => {
    const slug = getSlug(name);
    const num = type === 'tree' ? '1' : '2';
    return `https://github.com/aufdemholzweg/holzquartett/blob/main/images/${slug}_${num}.jpg?raw=true`;
};

const woodInfo = {};
woodCards.forEach(c => {
    woodInfo[c.name] = {
        info: `Die ${c.name} ist eine Holzart mit einer Rohdichte von ca. ${c.dichte} kg/m¬≥.`,
        bildBaum: getWoodImage(c.name, 'tree'),
        bildQuerschnitt: getWoodImage(c.name, 'cross')
    };
});

const reflectionQuestions=[
 "Welches Holz w√ºrdest du f√ºr Gartenm√∂bel w√§hlen und warum?",
 "Eine K√ºchenarbeitsplatte muss schnittfest sein. Welches Holz eignet sich?",
 "F√ºr einen stark beanspruchten Dielenboden: Hartes oder weiches Holz?",
 "Warum verf√§rbt sich Eiche in Verbindung mit Eisen?",
 "Welches der gespielten H√∂lzer hat die h√∂chste Dauerhaftigkeit?",
 "Nenne einen Vorteil von Bambus gegen√ºber heimischen H√∂lzern."
];

const attributeInfo={
  dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit',unit:'(DK)'},
  haerte:{icon:'üíé',name:'Druckfestigkeit',unit:'(N/mm¬≤)'},
  quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schw.',unit:'(%)'},
  dichte:{icon:'‚öñÔ∏è',name:'Rohdichte',unit:'(kg/m¬≥)'},
  gewicht:{icon:'üèãÔ∏è',name:'E-Modul',unit:'(N/mm¬≤)'}
};

/* AI State */
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};
let lastRoundWinningWoodName = null;

/* UI Helpers */
const bottomSheet = document.getElementById('bottomSheet');
const bottomSheetBackdrop = document.getElementById('bottomSheetBackdrop');
const bsInfoBtn = document.getElementById('bsInfoBtn');
const bsNextBtn = document.getElementById('bsNextBtn');

function openBottomSheet(title){
    if(title) document.getElementById('resultText').innerText = title;
    bottomSheetBackdrop.classList.remove('hidden');
    bottomSheet.classList.remove('hidden');
    setTimeout(() => {
        bottomSheetBackdrop.classList.remove('opacity-0');
        bottomSheet.classList.remove('translate-y-full');
    }, 10);
}
function closeBottomSheet(){
    bottomSheet.classList.add('translate-y-full');
    bottomSheetBackdrop.classList.add('opacity-0');
    setTimeout(() => {
        bottomSheet.classList.add('hidden');
        bottomSheetBackdrop.classList.add('hidden');
    }, 300);
}

/* --- INITIALIZATION --- */
document.addEventListener('DOMContentLoaded', async()=>{
  try{await signInAnonymously(auth);}catch(e){console.error(e)}
  onAuthStateChanged(auth,(user)=>{
    if(user){
      localPlayerId=user.uid;
      const p=new URLSearchParams(window.location.search);
      const gid=p.get('game');
      if(gid){gameId=gid;gameMode='multiplayer';window.showNamePrompt('join');}
    }
  });

  const soundToggle=document.getElementById('soundToggle');
  const savedMute=localStorage.getItem('holzquartett_isMuted');
  isMuted=savedMute==='true';
  soundToggle.checked=!isMuted;
  soundToggle.addEventListener('change',(e)=>{
    isMuted=!e.target.checked;
    localStorage.setItem('holzquartett_isMuted',isMuted);
    if(!isMuted) playSound(sounds.chime);
  });

  const revealToggle=document.getElementById('revealBackToggle');
  revealToggle.checked=isOpponentNameBackVisible();
  revealToggle.addEventListener('change',e=>{
    setOpponentNameBackVisible(e.target.checked);
    if(gameMode==='ai') displayCardsAI();
    if(gameMode==='multiplayer'&&localGameState) displayMultiplayerCards(localGameState);
  });

  bsInfoBtn.addEventListener('click',()=>{
    closeBottomSheet();
    const name = lastRoundWinningWoodName || (aiGame.currentPlayerCard ? aiGame.currentPlayerCard.name : 'Holz');
    window.showWoodInfo(name);
  });
  bsNextBtn.addEventListener('click',()=>{
    closeBottomSheet();
    window.nextRound();
  });
});

/* --- STARTUP & NAVIGATION --- */
window.showNamePrompt=(mode)=>{
  document.getElementById('setupModal').classList.add('hidden');
  document.getElementById('nameModal').classList.remove('hidden');
  const btn=document.getElementById('nameSubmitButton');
  const clone=btn.cloneNode(true);
  btn.parentNode.replaceChild(clone,btn);
  clone.addEventListener('click',()=>{
    const playerName=document.getElementById('playerName').value.trim();
    if(!playerName){alert('Bitte gib deinen Namen ein!');return;}
    document.getElementById('nameModal').classList.add('hidden');
    if(mode==='ai'){gameMode='ai';startGameAI(playerName);}
    else if(mode==='multiplayer'){gameMode='multiplayer';createGame(playerName);}
    else if(mode==='join'){joinGame(gameId,playerName);}
  });
};

window.copyShareLink=async()=>{
  const el=document.getElementById('shareLink');
  try{await navigator.clipboard.writeText(el.value);}catch{el.select();document.execCommand('copy');}
  hasCopiedShareLink=true;
  const s=document.getElementById('lobbyStatus'); if(s) s.textContent='Link kopiert! Warte...';
};

/* --- MULTIPLAYER LOGIC --- */
async function createGame(playerName){
  const lobby=document.getElementById('multiplayerLobbyModal');
  lobby.classList.remove('hidden');
  hasCopiedShareLink=false;
  gameId=Math.random().toString(36).substring(2,8).toUpperCase();
  const base=window.location.href.split('?')[0];
  document.getElementById('shareLink').value=`${base}?game=${gameId}`;
  
  const ref=doc(db,"games",gameId);
  await setDoc(ref,{
    gameId, status:'waiting', playerIds:[localPlayerId],
    players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
    createdAt:serverTimestamp()
  });
  listenToGameChanges();
}

async function joinGame(id,playerName){
  const ref=doc(db,"games",id);
  const snap=await getDoc(ref);
  if(snap.exists()&&snap.data().status==='waiting'){
      document.getElementById('lobbyTitle').textContent="Verbinde...";
      document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
      hasCopiedShareLink=true;
      const shuffled=shuffleArray([...woodCards]);
      const p1=snap.data().playerIds[0];
      await updateDoc(ref,{
        status:'playing',
        playerIds:[p1,localPlayerId],
        [`players.${localPlayerId}`]:{name:playerName,cards:shuffled.slice(15,30),status:'online'},
        [`players.${p1}.cards`]:shuffled.slice(0,15),
        turn:p1,
        currentCards:{[p1]:shuffled[0],[localPlayerId]:shuffled[15]},
        lastResult:null
      });
      listenToGameChanges();
  } else {
      alert("Spiel nicht verf√ºgbar."); window.location.search='';
  }
}

function listenToGameChanges(){
  if(!gameId) return;
  unsubscribeGame=onSnapshot(doc(db,"games",gameId),(ds)=>{
    if(!ds.exists()) { resetGame(); return; }
    const gd=ds.data(); localGameState=gd;
    
    if(gd.status==='playing'||gd.status==='finished'){
        document.getElementById('multiplayerLobbyModal').classList.add('hidden');
        document.getElementById('gameContainer').classList.remove('hidden');
        updateMultiplayerUI(gd);
    }
  });
}

function updateMultiplayerUI(gd){
    const oppId=gd.playerIds.find(id=>id!==localPlayerId);
    document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
    document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
    
    const pCount = gd.players[localPlayerId]?.cards?.length||0;
    const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
    
    document.getElementById('playerCards').innerText = pCount;
    document.getElementById('aiCards').innerText = oCount;
    updateStatusBar(pCount, oCount);
    displayMultiplayerCards(gd);

    if(gd.lastResult){
        if(!roundSoundPlayed){
            roundSoundPlayed=true;
            playSound(sounds.flip);
            if(gd.lastResult.winnerId===localPlayerId) playSound(sounds.win);
        }
        const winnerName = gd.lastResult.winnerId===localPlayerId ? 'Du gewinnst!' : (gd.lastResult.winnerId==='tie'?'Unentschieden':'Gegner gewinnt!');
        document.getElementById('resultText').className = gd.lastResult.winnerId===localPlayerId ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
        document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
        if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(winnerName);
    } else {
        roundSoundPlayed=false;
        closeBottomSheet();
    }
    
    const ti = document.getElementById('turnIndicator');
    if(gd.turn===localPlayerId) ti.innerText = "Du bist am Zug!";
    else ti.innerText = "Gegner w√§hlt...";

    if(gd.status==='finished') endGame();
}

/* --- CARD RENDERING --- */
function createCard(data, isRevealed=true, isPlayer=true){
    const card = document.createElement('div');
    card.className = `card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''}`;
    if(!isRevealed) card.classList.add('card-flipped');

    const canSelect = isPlayer && (
        (gameMode==='ai' && aiGame.turn==='player' && !aiGame.roundInProgress) ||
        (gameMode==='multiplayer' && localGameState.turn===localPlayerId && !localGameState.lastResult)
    );

    const front = document.createElement('div');
    // Runde Ecken wie im Foto (rounded-2xl)
    front.className = `card-front card-front-bg rounded-2xl shadow-lg border-4 ${isPlayer?'border-orange-200':'border-gray-200'} flex flex-col`;
    
    // Header (Name oben links) - Etwas gr√∂√üer
    const header = `
        <div class="pt-3 px-3 pb-1">
            <h2 class="text-xl font-bold text-amber-900 leading-none tracking-tight">${data.name}</h2>
        </div>`;
    
    // Bild - Runder wie im Foto
    const imgUrl = getWoodImage(data.name, 'tree');
    const image = `
        <div class="mx-3 mt-1 mb-2 aspect-[4/3] rounded-xl overflow-hidden bg-white shadow-sm border border-orange-100">
            <img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.style.opacity='0.2'">
        </div>`;
    
    // Attribute - Layout wie im Foto
    let attrs = '<div class="flex-grow flex flex-col justify-start space-y-2 px-3 pb-3 overflow-y-auto hide-scrollbar">';
    for(const k in attributeInfo){
        const val = data[k];
        const info = attributeInfo[k];
        // Standard Style (Creme Box, Gold Border)
        const rowClass = `attr-box w-full flex justify-between items-center px-3 py-2 rounded-xl transition cursor-pointer select-none`;
        
        let flashClass = '';
        if(gameMode==='ai' && aiGame.roundInProgress && document.getElementById('resultDetails').innerText.includes(info.name)) {
             // Ergebnis Highlight (nach Runde)
             flashClass='flash-active';
        }

        const content = `
            <div class="flex items-center gap-3">
                <span class="text-xl opacity-80">${info.icon}</span>
                <div class="flex flex-col text-left leading-none">
                    <span class="font-bold text-gray-800 text-sm mb-0.5">${info.name}</span>
                    <span class="text-[10px] text-gray-500 font-medium">${info.unit}</span>
                </div>
            </div>
            <span class="text-lg font-bold text-amber-800">${val}</span>
        `;
        
        if(canSelect){
            attrs += `<div onclick="window.selectAttribute('${k}')" data-attr-btn="${k}" class="${rowClass} hover:brightness-95 ${flashClass}">
                        ${content}
                      </div>`;
        } else {
             attrs += `<div class="${rowClass} opacity-90 ${flashClass}" data-attr-row="${k}">
                        ${content}
                      </div>`;
        }
    }
    attrs += '</div>';

    front.innerHTML = header + image + attrs;
    
    const back = document.createElement('div');
    back.className = 'card-back rounded-2xl shadow-lg relative';
    if(!isPlayer && isOpponentNameBackVisible()){
        const lbl = document.createElement('div');
        lbl.className = 'opponent-back-name';
        lbl.innerText = data.name;
        back.appendChild(lbl);
    }

    card.appendChild(front);
    card.appendChild(back);
    return card;
}

function displayMultiplayerCards(gd){
    const pc = document.getElementById('playerCard');
    const ac = document.getElementById('aiCard');
    pc.innerHTML=''; ac.innerHTML='';
    
    if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true));
    
    const oppId = gd.playerIds.find(i=>i!==localPlayerId);
    if(oppId && gd.currentCards[oppId]){
        const c = createCard(gd.currentCards[oppId], false, false);
        ac.appendChild(c);
        if(gd.lastResult){
             setTimeout(()=> {
                 c.classList.remove('card-flipped');
                 playSound(sounds.flip);
             }, 100);
        }
    } else {
        ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte...</div>`;
    }
}

/* --- GAME ACTIONS --- */
window.selectAttribute = function(attr){
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`);
        if(btn) btn.classList.add('flash-active');

        aiGame.roundInProgress = true; 
        setTimeout(() => { selectAttributeAI(attr); }, 1500);

    } else if(gameMode==='multiplayer') {
        multiplayerSelectAttribute(attr);
    }
};

window.nextRound = function(){
    window.scrollTo({ top: 0, behavior: 'smooth' });
    if(gameMode==='ai') nextRoundAI();
    else if(gameMode==='multiplayer') multiplayerNextRound();
};

async function multiplayerSelectAttribute(attr){
    if(!localGameState || localGameState.turn!==localPlayerId) return;
    const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
    const pv = localGameState.currentCards[localPlayerId][attr];
    const ov = localGameState.currentCards[opp][attr];
    let pWins;
    if(attr==='dk' || attr==='quellenSchwindenRadial') pWins = pv < ov ? true : (ov < pv ? false : 'tie');
    else pWins = pv > ov ? true : (ov > pv ? false : 'tie');
    
    const winner = pWins==='tie' ? 'tie' : (pWins ? localPlayerId : opp);
    await updateDoc(doc(db,"games",gameId),{
        lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:pv, [opp]:ov}},
        lastActivity: serverTimestamp()
    });
}

async function multiplayerNextRound(){
    if(!localGameState.lastResult) return;
    const gs = localGameState;
    const [p1,p2] = gs.playerIds;
    let c1=gs.players[p1].cards.shift();
    let c2=gs.players[p2].cards.shift();
    const w = gs.lastResult.winnerId;
    if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
    else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
    else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
    
    if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
        await updateDoc(doc(db,"games",gameId), {status:'finished', players:gs.players});
        return;
    }
    const nextT = w==='tie' ? gs.turn : w;
    await updateDoc(doc(db,"games",gameId), {
        lastResult:null, turn:nextT, players:gs.players,
        currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
    });
}

/* --- AI LOGIC --- */
function startGameAI(name){
    aiGame.playerName=name;
    document.getElementById('playerNameDisplay').innerText=name;
    document.getElementById('opponentNameDisplay').innerText='Gegner';
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15);
    aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0];
    aiGame.currentAiCard=aiGame.aiCards[0];
    aiGame.turn='player';
    document.getElementById('gameContainer').classList.remove('hidden');
    updateDisplayAI();
}

function updateDisplayAI(){
    const pc=aiGame.playerCards.length; const ac=aiGame.aiCards.length;
    document.getElementById('playerCards').innerText=pc;
    document.getElementById('aiCards').innerText=ac;
    updateStatusBar(pc,ac);
    
    const pcEl = document.getElementById('playerCard');
    const acEl = document.getElementById('aiCard');
    pcEl.innerHTML=''; acEl.innerHTML='';
    
    if(aiGame.currentPlayerCard) pcEl.appendChild(createCard(aiGame.currentPlayerCard, true, true));
    if(aiGame.currentAiCard) acEl.appendChild(createCard(aiGame.currentAiCard, false, false));
    
    if(aiGame.turn==='ai' && !aiGame.roundInProgress) setTimeout(aiTurn, 1000);
}

function aiTurn(){
    if(aiGame.roundInProgress) return;
    const keys=Object.keys(attributeInfo);
    const k=keys[Math.floor(Math.random()*keys.length)];

    aiGame.roundInProgress = true;
    const row = document.querySelector(`div[data-attr-row="${k}"]`);
    if(row) row.classList.add('flash-active');
    
    setTimeout(() => { selectAttributeAI(k); }, 1500);
}

function selectAttributeAI(attr){
    const pv=aiGame.currentPlayerCard[attr];
    const av=aiGame.currentAiCard[attr];
    
    const ac=document.getElementById('aiCard').querySelector('.card-3d');
    if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
    
    setTimeout(()=>{
        let pWins;
        if(attr==='dk'||attr==='quellenSchwindenRadial') pWins = pv<av ? true : (av<pv ? false : 'tie');
        else pWins = pv>av ? true : (av>pv ? false : 'tie');
        
        const resText = pWins===true ? 'Du gewinnst!' : (pWins===false ? 'Computer gewinnt!' : 'Unentschieden');
        const resColor = pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-gray-600');
        
        document.getElementById('resultText').innerText = resText;
        document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
        document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${pv} vs ${av}`;
        openBottomSheet(resText);
        
        if(pWins===true) { playSound(sounds.win); triggerWinStarAnimation(); lastRoundWinningWoodName = aiGame.currentPlayerCard.name; }
        else if(pWins===false) { lastRoundWinningWoodName = aiGame.currentAiCard.name; }
        else { lastRoundWinningWoodName = aiGame.currentPlayerCard.name; }
        
        const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
        if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
        else if(pWins===false){ aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }
        else { aiGame.playerCards.push(pC); aiGame.aiCards.push(aC); }
        
        if(aiGame.playerCards.length===0 || aiGame.aiCards.length===0) setTimeout(endGame, 1000);
    }, 600);
}

function nextRoundAI(){
    aiGame.currentPlayerCard=aiGame.playerCards[0];
    aiGame.currentAiCard=aiGame.aiCards[0];
    aiGame.roundInProgress=false;
    updateDisplayAI();
}

function triggerWinStarAnimation(){
    const con = document.getElementById('animationContainer');
    const star = document.createElement('div');
    star.innerText='‚≠ê'; star.className='falling-star';
    star.style.left='50%'; star.style.top='20%';
    con.appendChild(star);
    playSound(sounds.starWin);
    setTimeout(()=>star.remove(), 1200);
}

function endGame(){
    closeBottomSheet();
    document.getElementById('gameContainer').classList.add('hidden');
    const win = aiGame.playerCards.length>0 || (localGameState?.players?.[localPlayerId]?.cards?.length > 0);
    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    const modal = document.getElementById('gameOverModal');
    const reflect = document.getElementById('reflectionModal');
    
    if(win){
        document.getElementById('reflectionQuestion').innerText = reflectionQuestions[Math.floor(Math.random()*reflectionQuestions.length)];
        reflect.classList.remove('hidden');
    } else {
        title.innerText = "VERLOREN";
        title.className = "text-3xl font-black mb-2 text-red-600";
        text.innerText = "Leider hat der Gegner gewonnen.";
        modal.classList.remove('hidden');
    }
}

window.showFinalWinScreen = function(){
    document.getElementById('reflectionModal').classList.add('hidden');
    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    title.innerText = "GEWONNEN!";
    title.className = "text-3xl font-black mb-2 text-green-600";
    text.innerText = "Herzlichen Gl√ºckwunsch! Du bist der Holz-Meister.";
    document.getElementById('gameOverModal').classList.remove('hidden');
    if(gameMode==='ai') saveToLeaderboard(aiGame.playerName);
    else saveToLeaderboard(localGameState.players[localPlayerId].name);
}

/* --- HELPERS --- */
function updateStatusBar(p, o){
    const total=p+o; const pct=(total===0)?50:(p/total)*100;
    const bar=document.getElementById('statusBar');
    bar.style.width=`${pct}%`;
    if(pct>60) bar.className='h-full bg-green-500 transition-all duration-500';
    else if(pct<40) bar.className='h-full bg-red-500 transition-all duration-500';
    else bar.className='h-full bg-amber-500 transition-all duration-500';
}
function shuffleArray(a){
    for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
    return a;
}

/* --- INFO / LEADERBOARD --- */
window.showWoodInfo = function(name){
    const modal=document.getElementById('infoModal');
    const content=document.getElementById('infoModalContent');
    
    const w = woodInfo[name] || {};
    
    content.innerHTML=`
        <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-500 text-sm text-gray-700 leading-relaxed mb-4">
            <span class="font-bold block mb-1 text-purple-700">${name}</span>
            ${w.info || 'Keine Info verf√ºgbar.'}
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
                <span class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">Baum</span>
                <img src="${w.bildBaum}" class="rounded-lg shadow-sm border w-full h-32 object-cover bg-gray-100" onerror="this.style.opacity=0.3">
            </div>
            <div class="space-y-1">
                <span class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">Querschnitt</span>
                <img src="${w.bildQuerschnitt}" class="rounded-lg shadow-sm border w-full h-32 object-cover bg-gray-100" onerror="this.style.opacity=0.3">
            </div>
        </div>
    `;
    modal.classList.remove('hidden');
};
window.closeInfoModal = function(){ document.getElementById('infoModal').classList.add('hidden'); openBottomSheet(); };

window.showLeaderboard = async function(){
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    
    try {
        const q=query(collection(db,"leaderboard"),orderBy("wins","desc"),limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine Eintr√§ge</div>'; return; }
        
        list.innerHTML = snap.docs.map((d,i)=>`
            <div class="flex justify-between items-center p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100">
                <span class="font-bold text-gray-700 text-sm">${i+1}. ${d.data().name}</span>
                <span class="font-bold text-amber-600 text-sm">${d.data().wins} üèÜ</span>
            </div>
        `).join('');
    } catch(e){ list.innerHTML='<div class="text-center text-red-400">Fehler beim Laden</div>'; }
};
window.closeLeaderboard = function(){
    document.getElementById('leaderboardModal').classList.add('hidden');
    document.getElementById('gameOverModal').classList.remove('hidden');
};
async function saveToLeaderboard(name){
    if(!name) return;
    const safe=name.replace(/[.#$[\]]/g,'_');
    try{ await setDoc(doc(db,"leaderboard",safe),{name,wins:increment(1),lastWin:serverTimestamp()},{merge:true}); }catch(e){}
}
window.resetGame = function(){ location.reload(); };
</script>
</body>
</html>
```
