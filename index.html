<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Holz-Quartett</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: 300; }
    .card-3d { transform-style: preserve-3d; transition: transform 0.6s; }
    .card-flipped { transform: rotateY(180deg); }
    .card-front,.card-back { backface-visibility: hidden; position:absolute; width:100%; height:100%; }
    .card-back {
      transform: rotateY(180deg);
      background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');
      background-size: cover; background-position: center;
    }
    .animate-pop-in { animation: pop-in 0.5s ease-out forwards; }
    .animate-glow-win { animation: glow-win 1.2s ease-out; }
    .animate-glow-lose { animation: glow-lose 1.2s ease-out; }
    @keyframes pop-in { 0%{transform:scale(0);opacity:0}70%{transform:scale(1.2);opacity:1}100%{transform:scale(1)}}
    @keyframes glow-win { 0%{box-shadow:0 0 0 0 rgba(74,222,128,0)}50%{box-shadow:0 0 30px 15px rgba(74,222,128,0.6)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)}}
    @keyframes glow-lose{ 0%{box-shadow:0 0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 30px 15px rgba(248,113,113,0.6)}100%{box-shadow:0 0 0 0 rgba(248,113,113,0)}}
    .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .status-flash-win { animation: flash-green 1.2s ease-out; } .status-flash-lose { animation: flash-red 1.2s ease-out; }
    @keyframes flash-green { 50% { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; } }
    @keyframes flash-red { 50% { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; } }
    .falling-star { position:absolute; font-size:7rem; z-index:100; animation: fall-and-fade 1.2s ease-in forwards; }
    @keyframes fall-and-fade { 0%{ transform:translateY(-30px) scale(1.5); opacity:0 } 30%{ transform:translateY(0) scale(1); opacity:1 } 100%{ transform:translateY(var(--end-y)) scale(0.3); opacity:0 } }
    .card-background {
      background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg');
      background-size: cover; background-position: center;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
  <header class="bg-white shadow-sm border-b-2 border-amber-200">
    <div class="max-w-6xl mx-auto px-4 p-3 relative">
      <button onclick="window.resetGame()" class="absolute top-3 left-4 text-3xl text-gray-400 hover:text-amber-600 transition-colors z-20" title="Spiel neustarten">‚ò∞</button>
      <h1 class="text-2xl font-bold text-amber-800 text-center">üå≥ HOLZEN! üå≥</h1>
      <p class="text-xs text-gray-500 text-center mt-1">C.Lehr, in Verbindung mit meiner Abschlussarbeit</p>
    </div>
  </header>

  <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
      <div class="space-y-4">
        <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üéÆ gegen Computer</button>
        <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üßë‚Äçü§ù‚Äçüßë online gegen Freunde</button>
      </div>

      <div class="mt-6 flex items-center justify-center space-x-2">
        <span class="text-gray-700">üîá </span>
        <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="soundToggle" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
        </label>
        <span class="text-gray-700"> üîä</span>
      </div>
    </div>
  </div>

  <div id="nameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Dein Name</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Bitte gib deinen Namen ein:</label>
          <input type="text" id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Spielername">
        </div>
        <button id="nameSubmitButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Weiter</button>
      </div>
    </div>
  </div>

  <div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
      <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler...</h2>
      <p id="lobbyText" class="text-gray-700 mb-6">Teile diesen Link mit deinem Freund, um das Spiel zu starten:</p>
      <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
        <input id="shareLink" type="text" class="w-full bg-transparent text-center text-blue-600" readonly>
      </div>
      <button onclick="window.copyShareLink()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Link kopieren</button>
      <div id="qrCodeContainer" class="mt-4 flex justify-center"></div>
      <p id="lobbyStatus" class="mt-6 text-green-600 font-semibold"></p>
    </div>
  </div>

  <div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4 relative">
    <div id="animationContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
    <div class="max-w-md mx-auto mb-1 space-y-1">
      <div class="flex justify-center space-x-2">
        <div id="playerScoreBox" class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center relative">
          <p id="playerNameDisplay" class="text-base font-bold text-amber-600 truncate"></p>
          <p class="text-sm text-gray-500">Karten: <span id="playerCards" class="font-semibold">15</span></p>
        </div>
        <div class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center">
          <p id="opponentNameDisplay" class="text-base font-bold text-red-600">Computer</p>
          <p class="text-sm text-gray-500">Karten: <span id="aiCards" class="font-semibold">15</span></p>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden border border-gray-300">
        <div id="statusBar" class="h-full rounded-l-full transition-all duration-500" style="width:50%; background-color:#f59e0b;"></div>
        <div class="absolute inset-0 flex justify-center items-center">
          <div class="w-0.5 h-full bg-white opacity-75"></div>
        </div>
      </div>
    </div>

    <div class="flex justify-center space-x-2 sm:space-x-2 mb-4 max-w-md mx-auto">
      <div class="text-center w-1/2"><div id="playerCard" class="relative aspect-[20/38] perspective-1000"></div></div>
      <div class="text-center w-1/2"><div id="aiCard" class="relative aspect-[20/38] perspective-1000"></div></div>
    </div>

    <div class="bg-white rounded-xl shadow-lg px-1 pt-1 pb-0.5 mt-4 text-center mx-auto flex flex-col items-center max-w-md w-full min-h-[6rem]">
      <div id="turnIndicator" class="hidden text-sm font-semibold p-1"></div>
      <div id="attributeSelection"><h3 class="text-base font-semibold text-gray-700 mb-1">W√§hle eine Eigenschaft!</h3></div>
      <div id="resultDisplay" class="hidden flex flex-col flex-grow w-full px-2">
        <h3 id="resultText" class="text-lg sm:text-xl font-bold"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mt-auto pb-0.5"></p>
      </div>
      <div id="nextRoundButton" class="hidden w-full mt-2">
        <button onclick="window.nextRound()" class="w-full bg-amber-600 hover:bg-amber-800 text-white font-bold py-3 px-8 rounded-xl transition-colors">‚û°Ô∏è N√§chster Zug</button>
      </div>
    </div>
  </div>

  <div id="reflectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-amber-800 mb-4">üéâ Super gespielt! Zeit zum Reflektieren!</h2>
      <p id="reflectionQuestion" class="text-gray-700 mb-6 text-left"></p>
      <textarea id="reflectionAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent min-h-[100px]" placeholder="Deine Begr√ºndung..."></textarea>
      <button onclick="window.showFinalWinScreen()" class="mt-6 w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Weiter zum Ergebnis</button>
    </div>
  </div>

  <div id="gameOverModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 id="gameOverTitle" class="text-3xl font-bold mb-3"></h2>
      <p id="gameOverText" class="text-gray-600 mb-6"></p>
      <div class="space-y-2">
        <button onclick="window.showLeaderboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">üèÜ Bestenliste anzeigen</button>
        <button onclick="window.resetGame()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">üîÑ Neues Spiel</button>
      </div>
    </div>
  </div>

  <div id="leaderboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">üèÜ Bestenliste</h2>
      <div id="leaderboardList" class="space-y-1 mb-6"></div>
      <button onclick="window.closeLeaderboard()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg">Schlie√üen</button>
    </div>
  </div>

  <div id="infoModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl relative">
      <button onclick="window.closeInfoModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-gray-600">&times;</button>
      <h2 id="infoModalTitle" class="text-2xl font-bold text-amber-800 mb-4">Wissenswertes</h2>
      <div id="infoModalContent" class="text-gray-700 space-y-2 max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
      authDomain: "holzquartett-3a177.firebaseapp.com",
      projectId: "holzquartett-3a177",
      storageBucket: "holzquartett-3a177.appspot.com",
      messagingSenderId: "1081595025073",
      appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
      measurementId: "G-HKLWFJE83K"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ========= Konfigurierbare Sound-Links =========
    const SOUND_URLS = {
      flip: "https://github.com/aufdemholzweg/holzquartett/raw/refs/heads/main/sounds/Spielzug%20gewonnen.wav",
      turnWin: "https://github.com/aufdemholzweg/holzquartett/raw/refs/heads/main/sounds/Spielzug%20gewonnen.wav",
      gameWin: "https://github.com/aufdemholzweg/holzquartett/raw/refs/heads/main/sounds/Spiel%20gewonnen.wav",
      bg: "https://github.com/aufdemholzweg/holzquartett/raw/refs/heads/main/sounds/backroundnoise.wav"
    };

    // ========= Audio-Objekte =========
    const sounds = {
      flip: new Audio(SOUND_URLS.flip),
      turnWin: new Audio(SOUND_URLS.turnWin),
      gameWin: new Audio(SOUND_URLS.gameWin),
      bg: new Audio(SOUND_URLS.bg)
    };
    sounds.flip.volume = 0.4;
    sounds.turnWin.volume = 0.6;
    sounds.gameWin.volume = 0.5;
    sounds.bg.volume = 0.12;
    sounds.bg.loop = true;
    Object.values(sounds).forEach(a => { try { a.preload = 'auto'; } catch(_){} });

    let isMuted = false;
    function playSound(audio){ if(isMuted) return; try{ audio.currentTime=0; audio.play().catch(()=>{});}catch(_){}};
    function previewTurnWinEvenIfMuted(){ try{ const c=new Audio(SOUND_URLS.turnWin); c.volume=0.6; c.play().catch(()=>{});}catch(_){} };
    function startBgMusic(){ if(!isMuted){ try{ sounds.bg.play().catch(()=>{});}catch(_){}} }
    function stopBgMusic(){ try{ sounds.bg.pause(); }catch(_){}};

    // ========= Global State =========
    let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false, roundSoundPlayed=false;

    // ========= Daten =========
    const woodCards=[
      {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000},
      {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000},
      {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000},
      {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000},
      {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000},
      {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000},
      {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000},
      {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500},
      {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000},
      {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500},
      {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000},
      {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000},
      {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500},
      {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500},
      {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000},
      {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000},
      {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000},
      {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000},
      {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000},
      {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500},
      {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000},
      {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000},
      {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000},
      {name:"Zypresse",dk:2,haerte:48,quellenSchwindenRadial:3.0,dichte:520,gewicht:9000},
      {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500},
      {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000},
      {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000},
      {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000},
      {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000},
      {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500}
    ];

    const attributeInfo={
      dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit (DK)'},
      haerte:{icon:'üíé',name:'Druckfestigkeit (N/mm¬≤)'},
      quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schwinden (%)'},
      dichte:{icon:'‚öñÔ∏è',name:'Rohdichte (kg/m¬≥)'},
      gewicht:{icon:'üèãÔ∏è',name:'E-Modul (N/mm¬≤)'}
    };

    function shuffleArray(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}

    document.addEventListener('DOMContentLoaded', async () => {
      const soundToggle = document.getElementById('soundToggle');
      const saved = localStorage.getItem('holzquartett_isMuted'); isMuted = saved === 'true';
      if (soundToggle) {
        soundToggle.checked = !isMuted;
        soundToggle.addEventListener('change', (e) => {
          const goingOn = e.target.checked;
          if (goingOn) {
            isMuted = false; localStorage.setItem('holzquartett_isMuted', isMuted);
            previewTurnWinEvenIfMuted(); startBgMusic();
          } else {
            previewTurnWinEvenIfMuted();
            isMuted = true; localStorage.setItem('holzquartett_isMuted', isMuted);
            stopBgMusic();
          }
        });
      }

      try { await signInAnonymously(auth); } catch(e){}
      const urlParams = new URLSearchParams(window.location.search);
      const gameIdFromUrl = urlParams.get('game');
      onAuthStateChanged(auth, (user) => {
        if (!user) return;
        localPlayerId = user.uid;
        if (gameIdFromUrl) { gameId = gameIdFromUrl; gameMode='multiplayer'; window.showNamePrompt('join'); }
        else { document.getElementById('setupModal').classList.remove('hidden'); }
      });
    });

    window.addEventListener('beforeunload', async () => { stopBgMusic(); });

    // ===== UI / Multiplayer (gek√ºrzt auf Relevanz) =====
    window.showNamePrompt=(mode)=>{
      document.getElementById('setupModal').classList.add('hidden');
      const nameModal=document.getElementById('nameModal'); nameModal.classList.remove('hidden');
      const btn=document.getElementById('nameSubmitButton'); const nb=btn.cloneNode(true); btn.parentNode.replaceChild(nb,btn);
      nb.addEventListener('click',()=>{
        const playerName=document.getElementById('playerName').value.trim();
        if(!playerName){alert('Bitte gib deinen Namen ein!');return;}
        nameModal.classList.add('hidden');
        if(mode==='ai'){gameMode='ai'; startGameAI(playerName);}
        else if(mode==='multiplayer'){gameMode='multiplayer'; createGame(playerName);}
        else if(mode==='join'){joinGame(gameId, playerName);}
      });
    };

    async function createGame(playerName){
      const lobbyModal=document.getElementById('multiplayerLobbyModal'); lobbyModal.classList.remove('hidden');
      hasCopiedShareLink=false;
      gameId=Math.random().toString(36).substring(2,8).toUpperCase();
      const shareLinkInput=document.getElementById('shareLink'); const baseUrl=window.location.href.split('?')[0];
      shareLinkInput.value=`${baseUrl}?game=${gameId}`;
      const qrContainer=document.getElementById('qrCodeContainer'); qrContainer.innerHTML='';
      try{ if(window.QRCode&&QRCode.toCanvas){const c=document.createElement('canvas'); QRCode.toCanvas(c,shareLinkInput.value,{width:180,margin:1,color:{dark:'#854d0e',light:'#ffffff'}},()=>{}); c.style.borderRadius='0.5rem'; c.style.border='1px solid #f59e0b'; qrContainer.appendChild(c);} }catch(_){}
      const gameRef=doc(db,"games",gameId);
      const initialGameData={gameId,status:'waiting',playerIds:[localPlayerId],players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},createdAt:serverTimestamp()};
      try{ await setDoc(gameRef,initialGameData); listenToGameChanges(); }catch(e){ alert('Fehler beim Erstellen des Spiels.'); }
    }

    async function joinGame(gameIdToJoin, playerName){
      const gameRef=doc(db,"games",gameIdToJoin);
      try{
        const snap=await getDoc(gameRef);
        if(snap.exists() && snap.data().status==='waiting' && snap.data().playerIds.length===1){
          document.getElementById('multiplayerLobbyModal').classList.remove('hidden'); hasCopiedShareLink=true;
          const shuffled=shuffleArray([...woodCards]); const p1=snap.data().playerIds[0];
          const p1c=shuffled.slice(0,15); const p2c=shuffled.slice(15,30);
          await updateDoc(gameRef,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:p2c,status:'online'},
            [`players.${p1}.cards`]:p1c, turn:p1,
            currentCards:{[p1]:p1c[0],[localPlayerId]:p2c[0]}, lastResult:null, lastActivity:serverTimestamp()
          });
          listenToGameChanges(); startBgMusic();
        } else { alert("Spiel nicht gefunden, bereits voll oder beendet."); window.location.search=''; }
      }catch(e){ alert("Fehler beim Beitreten zum Spiel."); window.location.search=''; }
    }

    function listenToGameChanges(){
      if(!gameId) return;
      const gameRef=doc(db,"games",gameId);
      unsubscribeGame = onSnapshot(gameRef,(d)=>{
        if(!d.exists()){ if(gameMode==='multiplayer'){ alert('Das Spiel wurde beendet oder gel√∂scht.'); resetGame(); } return; }
        const g=d.data(); localGameState=g;
        if(g.status==='playing'||g.status==='finished'){
          if(hasCopiedShareLink || g.playerIds.includes(localPlayerId) && g.playerIds.length===2){
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            updateMultiplayerUI(g);
          }
        } else if (g.status==='waiting'){
          document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
          document.getElementById('gameContainer').classList.add('hidden');
        }
      });
    }

    function updateStatusBar(pc, oc){
      const total=pc+oc; const pct= total>0?(pc/total)*100:50;
      const bar=document.getElementById('statusBar'); if(!bar) return;
      bar.style.width=`${pct}%`;
      let color='#f59e0b'; if(pct<25) color='#ef4444'; else if(pct<45) color='#f97316'; else if(pct>75) color='#22c55e'; else if(pct>55) color='#84cc16';
      bar.style.backgroundColor=color;
    }

    function createCard(cardData,isRevealed=true,isPlayer=true){
      const card=document.createElement('div');
      card.className=`card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''} transition-all duration-300`;
      if(!isRevealed){ card.classList.add('card-flipped'); }
      const borderColor=isPlayer?'border-amber-400':'border-gray-300';
      const shadow=isPlayer?'shadow-lg':'shadow-md';
      const front=document.createElement('div');
      front.className=`card-front card-background rounded-xl ${shadow} border-2 ${borderColor} p-2 sm:p-3 flex flex-col overflow-hidden`;
      const name=cardData?.name||'Unbekannt';
      let inner='<div class="space-y-1 mt-auto">';
      for(const k in attributeInfo){
        const attr=attributeInfo[k]; const v = cardData?.[k] ?? '?'; const fv = typeof v==='number'? v.toLocaleString('de-DE'): v;
        inner += `<div class="w-full flex justify-between items-center py-0.5 sm:py-1 px-1 rounded-lg text-left border border-amber-300 bg-amber-50">
          <div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${attr.icon}</span><span class="text-[11px] sm:text-xs font-medium leading-tight text-gray-700">${attr.name}</span></div>
          <span class="font-semibold text-amber-800 text-sm sm:text-base">${fv}</span>
        </div>`;
      }
      inner+='</div>';
      front.innerHTML = `<div class="flex justify-between items-center w-full mb-2 px-1 h-9 sm:h-10"><h3 class="text-base sm:text-lg font-bold text-amber-800 truncate text-left mr-2">${name}</h3></div>${inner}`;
      const back=document.createElement('div'); back.className='card-back rounded-xl shadow-lg border-2 border-amber-300 flex items-center justify-center relative overflow-hidden';
      card.appendChild(front); card.appendChild(back); return card;
    }

    function displayMultiplayerCards(g){
      if(!g.currentCards||!g.playerIds) return;
      const opp=g.playerIds.find(id=>id!==localPlayerId);
      const pc=document.getElementById('playerCard'); const ac=document.getElementById('aiCard');
      pc.innerHTML=''; ac.innerHTML='';
      if(g.currentCards[localPlayerId]) pc.appendChild(createCard(g.currentCards[localPlayerId], true, true));
      if(opp && g.currentCards[opp]){
        const show = !!g.lastResult;
        ac.appendChild(createCard(g.currentCards[opp], show, false));
        if (show) playSound(sounds.flip);
      }
    }

    function updateMultiplayerUI(g){
      const opp=g.playerIds.find(id=>id!==localPlayerId);
      document.getElementById('playerNameDisplay').textContent=g.players[localPlayerId]?.name||'Du';
      document.getElementById('playerCards').textContent=g.players[localPlayerId]?.cards?.length??'?';
      if(opp && g.players[opp]){
        document.getElementById('opponentNameDisplay').textContent=g.players[opp].name;
        document.getElementById('aiCards').textContent=g.players[opp].cards?.length??'?';
      }
      updateStatusBar(g.players[localPlayerId]?.cards?.length??0, g.players[opp]?.cards?.length??0);
      displayMultiplayerCards(g);

      const ti=document.getElementById('turnIndicator');
      const attrSel=document.getElementById('attributeSelection');
      const res=document.getElementById('resultDisplay');
      const next=document.getElementById('nextRoundButton');
      ti.classList.remove('hidden');

      if (g.lastResult){
        if(!roundSoundPlayed){ roundSoundPlayed=true; if(g.lastResult.winnerId===localPlayerId) playSound(sounds.turnWin); }
        attrSel.classList.add('hidden'); res.classList.remove('hidden'); next.classList.remove('hidden');
        window.scrollTo({top:0,behavior:'smooth'});
      } else {
        roundSoundPlayed=false; res.classList.add('hidden'); next.classList.add('hidden');
        if(g.turn===localPlayerId){ ti.textContent="Du bist am Zug!"; ti.className='text-sm font-semibold p-1 text-green-600'; }
        else { ti.textContent=`${g.players[g.turn]?.name||'Gegner'} ist am Zug...`; ti.className='text-sm font-semibold p-1 text-gray-500'; }
      }

      if(g.status==='finished'){ endGame(); }
    }

    async function multiplayerSelectAttribute(attribute){
      if(!localGameState || localGameState.turn!==localPlayerId || localGameState.lastResult || !attributeInfo[attribute]) return;
      const me = localGameState.currentCards?.[localPlayerId];
      const oppId = localGameState.playerIds?.find(id=>id!==localPlayerId);
      const oppC = localGameState.currentCards?.[oppId];
      const pv=me?.[attribute]; const ov=oppC?.[attribute];
      if(pv===undefined || ov===undefined) return;
      let meWin;
      if(attribute==='quellenSchwindenRadial'||attribute==='dk') meWin = (pv<ov)?true:(ov<pv?false:'tie'); else meWin=(pv>ov)?true:(ov>pv?false:'tie');
      const winnerId = meWin==='tie' ? 'tie' : (meWin ? localPlayerId : oppId);
      await updateDoc(doc(db,"games",gameId), { lastResult:{ winnerId, attribute, values:{[localPlayerId]:pv,[oppId]:ov}}, lastActivity:serverTimestamp() });
    }

    async function multiplayerNextRound(){
      const g=localGameState; if(!g||!g.lastResult||!gameId) return;
      const [p1,p2]=g.playerIds; let c1=[...g.players[p1].cards], c2=[...g.players[p2].cards];
      const c1top=c1.shift(); const c2top=c2.shift();
      const w=g.lastResult.winnerId;
      if(w===p1){ if(c1top) c1.push(c1top); if(c2top) c1.push(c2top); }
      else if(w===p2){ if(c1top) c2.push(c1top); if(c2top) c2.push(c2top); }
      else { if(c1top) c1.push(c1top); if(c2top) c2.push(c2top); }
      if(c1.length===0 || c2.length===0){
        await updateDoc(doc(db,"games",gameId), { status:'finished', players:{ [p1]:{...g.players[p1],cards:c1}, [p2]:{...g.players[p2],cards:c2} }, currentCards:{[p1]:null,[p2]:null}, lastResult:null });
        return;
      }
      const next = w==='tie' ? g.turn : w;
      await updateDoc(doc(db,"games",gameId), { lastResult:null, turn:next, players:{ [p1]:{...g.players[p1],cards:c1}, [p2]:{...g.players[p2],cards:c2} }, currentCards:{[p1]:c1[0],[p2]:c2[0]}, lastActivity:serverTimestamp() });
    }

    // ====== AI ======
    let aiGame={ playerName:'', playerCards:[], aiCards:[], currentPlayerCard:null, currentAiCard:null, roundInProgress:false, turn:'player' };

    function startGameAI(name){
      aiGame.playerName=name;
      document.getElementById('playerNameDisplay').textContent=name;
      document.getElementById('opponentNameDisplay').textContent='Computer';
      const sh=shuffleArray(woodCards); aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
      aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
      aiGame.roundInProgress=false; aiGame.turn='player';
      document.getElementById('attributeSelection').classList.remove('hidden');
      document.getElementById('resultDisplay').classList.add('hidden');
      document.getElementById('nextRoundButton').classList.add('hidden');
      document.getElementById('turnIndicator').classList.remove('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      updateDisplayAI(); displayCardsAI();
      startBgMusic();
    }

    function displayCardsAI(){
      const pc=document.getElementById('playerCard'); const ac=document.getElementById('aiCard');
      pc.innerHTML=''; ac.innerHTML='';
      if(aiGame.currentPlayerCard) pc.appendChild(createCard(aiGame.currentPlayerCard, true, true));
      if(aiGame.currentAiCard){
        const reveal=aiGame.roundInProgress;
        ac.appendChild(createCard(aiGame.currentAiCard, reveal, false));
        if(reveal) playSound(sounds.flip);
      }
    }

    window.selectAttribute=(a)=>{ if(gameMode==='ai') selectAttributeAI(a); else if(gameMode==='multiplayer') multiplayerSelectAttribute(a); };
    window.nextRound=()=>{ if(gameMode==='ai') nextRoundAI(); else if(gameMode==='multiplayer') multiplayerNextRound(); };

    function selectAttributeAI(a){
      if(aiGame.roundInProgress||aiGame.turn!=='player'||!aiGame.currentPlayerCard||!aiGame.currentAiCard) return;
      aiGame.roundInProgress=true;
      playSound(sounds.flip);
      const pv=aiGame.currentPlayerCard[a]; const av=aiGame.currentAiCard[a];
      if(pv===undefined||av===undefined){ aiGame.roundInProgress=false; return; }
      let win;
      if(a==='quellenSchwindenRadial'||a==='dk') win = (pv<av)?true:(av<pv?false:'tie'); else win = (pv>av)?true:(av>pv?false:'tie');
      const p=aiGame.playerCards.shift(); const q=aiGame.aiCards.shift();
      if(win===true){ if(p) aiGame.playerCards.push(p); if(q) aiGame.playerCards.push(q); aiGame.turn='player'; playSound(sounds.turnWin); }
      else if(win===false){ if(q) aiGame.aiCards.push(q); if(p) aiGame.aiCards.push(p); aiGame.turn='ai'; }
      else { if(p) aiGame.playerCards.push(p); if(q) aiGame.aiCards.push(q); }
      setTimeout(()=>{
        displayCardsAI();
        document.getElementById('attributeSelection').classList.add('hidden');
        document.getElementById('resultDisplay').classList.remove('hidden');
        document.getElementById('nextRoundButton').classList.remove('hidden');
        updateDisplayAI(); checkGameOverAI(); window.scrollTo({top:0,behavior:'smooth'});
      },400);
    }

    function aiSelectAttribute(){
      if(aiGame.roundInProgress||aiGame.turn!=='ai'||!aiGame.currentPlayerCard||!aiGame.currentAiCard) return;
      aiGame.roundInProgress=true;
      const keys=Object.keys(attributeInfo); const k=keys[Math.floor(Math.random()*keys.length)];
      const pv=aiGame.currentPlayerCard[k]; const av=aiGame.currentAiCard[k];
      let win;
      if(k==='quellenSchwindenRadial'||k==='dk') win=(pv<av)?true:(av<pv?false:'tie'); else win=(pv>av)?true:(av>pv?false:'tie');
      const p=aiGame.playerCards.shift(); const q=aiGame.aiCards.shift();
      if(win===true){ if(p) aiGame.playerCards.push(p); if(q) aiGame.playerCards.push(q); aiGame.turn='player'; playSound(sounds.turnWin); }
      else if(win===false){ if(q) aiGame.aiCards.push(q); if(p) aiGame.aiCards.push(p); aiGame.turn='ai'; }
      else { if(p) aiGame.playerCards.push(p); if(q) aiGame.aiCards.push(q); }
      displayCardsAI();
      document.getElementById('attributeSelection').classList.add('hidden');
      document.getElementById('resultDisplay').classList.remove('hidden');
      document.getElementById('nextRoundButton').classList.remove('hidden');
      updateDisplayAI(); checkGameOverAI(); window.scrollTo({top:0,behavior:'smooth'});
    }

    function nextRoundAI(){
      if(aiGame.playerCards.length===0 || aiGame.aiCards.length===0){ endGameAI(); return; }
      aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
      aiGame.roundInProgress=false;
      document.getElementById('nextRoundButton').classList.add('hidden');
      document.getElementById('resultDisplay').classList.add('hidden');
      updateDisplayAI(); displayCardsAI();
      if(aiGame.turn==='ai'){ aiSelectAttribute(); } else { document.getElementById('attributeSelection').classList.remove('hidden'); }
    }

    function updateDisplayAI(){
      const pc=aiGame.playerCards.length, oc=aiGame.aiCards.length;
      document.getElementById('playerCards').textContent=pc; document.getElementById('aiCards').textContent=oc;
      updateStatusBar(pc,oc);
      const ti=document.getElementById('turnIndicator'); ti.classList.remove('hidden');
      if(aiGame.roundInProgress){ if(aiGame.turn==='ai'){ ti.textContent='Computer √ºberlegt...'; ti.className='text-sm font-semibold p-1 text-gray-500'; } else { ti.textContent=''; } }
      else if(aiGame.turn==='player'){ ti.textContent='Du bist am Zug!'; ti.className='text-sm font-semibold p-1 text-green-600'; }
      else { ti.textContent='Computer ist am Zug...'; ti.className='text-sm font-semibold p-1 text-gray-500'; }
    }

    function checkGameOverAI(){ if(aiGame.playerCards.length===0||aiGame.aiCards.length===0) setTimeout(endGameAI,300); }

    function endGame(){
      if(gameMode==='ai'){ endGameAI(); return; }
      const me = localGameState?.players?.[localPlayerId]?.cards?.length ?? 0;
      const oppId = localGameState?.playerIds?.find(id=>id!==localPlayerId);
      const him = localGameState?.players?.[oppId]?.cards?.length ?? 0;
      const meWin = me>him; const draw = (me===0 && him===0);
      if(draw){ showGameOverScreen(null); stopBgMusic(); }
      else if(meWin){ playSound(sounds.gameWin); showReflectionOrWinScreen(); }
      else { showGameOverScreen(false); stopBgMusic(); }
    }

    function endGameAI(){
      const meWin = aiGame.playerCards.length>0;
      if(meWin){ playSound(sounds.gameWin); showReflectionOrWinScreen(); }
      else { showGameOverScreen(false); }
      stopBgMusic();
    }

    function showReflectionOrWinScreen(){
      document.getElementById('reflectionQuestion').textContent="Kurze Reflexion: Welche Materialeigenschaft war heute f√ºr deine Entscheidungen am wichtigsten? Begr√ºnde knapp.";
      document.getElementById('reflectionModal').classList.remove('hidden');
    }

    window.showFinalWinScreen=function(){
      document.getElementById('reflectionModal').classList.add('hidden');
      document.getElementById('reflectionAnswer').value='';
      showGameOverScreen(true);
    };

    function showGameOverScreen(win){
      const t=document.getElementById('gameOverTitle');
      const p=document.getElementById('gameOverText');
      const m=document.getElementById('gameOverModal');
      if(win===true){ t.textContent='üéâ Gl√ºckwunsch!'; t.className='text-3xl font-bold mb-3 text-green-600'; p.textContent='Du hast gewonnen! Du hast alle Karten gesammelt.'; }
      else if(win===false){ t.textContent='üòû Spiel verloren'; t.className='text-3xl font-bold mb-3 text-red-600'; p.textContent='Dein Gegner hat gewonnen. Versuche es nochmal!'; }
      else { t.textContent='ü§ù Unentschieden!'; t.className='text-3xl font-bold mb-3 text-yellow-600'; p.textContent='Das Spiel endet unentschieden!'; }
      m.classList.remove('hidden');
    }

    async function saveToLeaderboard(playerName){
      if(!playerName) return;
      try{ await setDoc(doc(db,"leaderboard", playerName.replace(/[.#$[\\]]/g,'_')), {name:playerName,wins:increment(1),lastWin:serverTimestamp()}, {merge:true}); }catch(_){}
    }

    window.resetGame = async function(){
      if(unsubscribeGame){ try{unsubscribeGame();}catch(_){ } unsubscribeGame=null; }
      stopBgMusic();
      gameMode=null; gameId=null; localGameState={}; hasCopiedShareLink=false; roundSoundPlayed=false;
      document.getElementById('gameOverModal').classList.add('hidden');
      document.getElementById('leaderboardModal').classList.add('hidden');
      document.getElementById('reflectionModal').classList.add('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('multiplayerLobbyModal').classList.add('hidden');
      document.getElementById('nameModal').classList.add('hidden');
      document.getElementById('playerCard').innerHTML=''; document.getElementById('aiCard').innerHTML='';
      updateStatusBar(0,0);
      document.getElementById('setupModal').classList.remove('hidden');
      window.history.pushState({}, document.title, window.location.pathname);
    };

    window.showLeaderboard = async function(){
      const list=document.getElementById('leaderboardList');
      list.innerHTML='<p class="text-gray-500 text-center">Lade Bestenliste...</p>';
      document.getElementById('gameOverModal').classList.add('hidden');
      document.getElementById('leaderboardModal').classList.remove('hidden');
      try{
        const q=query(collection(db,"leaderboard"), orderBy("wins","desc"), limit(10));
        const s=await getDocs(q);
        if(s.empty){ list.innerHTML='<p class="text-gray-500 text-center">Noch keine Eintr√§ge vorhanden.</p>'; return; }
        list.innerHTML=s.docs.map((d,i)=>{
          const data=d.data(); const safe=(data.name||'Unbekannt').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return `<div class="flex justify-between items-center p-3 ${i%2===0?'bg-gray-50':'bg-white'} rounded-lg"><span class="font-semibold">${i+1}. ${safe}</span><span class="text-sm text-gray-600">${data.wins||0} Siege</span></div>`;
        }).join('');
      }catch(e){ list.innerHTML='<p class="text-red-500 text-center">Fehler beim Laden der Bestenliste.</p>'; }
    };

    window.closeLeaderboard=function(){
      document.getElementById('leaderboardModal').classList.add('hidden');
      document.getElementById('gameOverModal').classList.remove('hidden');
    };

    window.showWoodInfo=function(){ document.getElementById('infoModal').classList.remove('hidden'); };
    window.closeInfoModal=function(){ document.getElementById('infoModal').classList.add('hidden'); };
  </script>
</body>
</html>
