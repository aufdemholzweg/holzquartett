<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;font-weight:300}

        .card-3d{transform-style:preserve-3d;transition:transform .6s}
        .card-flipped{transform:rotateY(180deg)}
        .card-front,.card-back{backface-visibility:hidden;position:absolute;width:100%;height:100%}
        /* R√ºckseitenbild */
        .card-back{transform:rotateY(180deg);background-image:url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');background-size:cover;background-position:center}

        /* Animationen */
        .animate-pop-in{animation:pop-in .5s ease-out forwards}
        @keyframes pop-in{0%{transform:scale(0);opacity:0}70%{transform:scale(1.2);opacity:1}100%{transform:scale(1)}}
        
        .hover-lift:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,.15)}

        .falling-star{position:absolute;font-size:7rem;z-index:100;animation:fall-and-fade 1.2s ease-in forwards}
        @keyframes fall-and-fade{0%{transform:translateY(-30px) scale(1.5);opacity:0}30%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(var(--end-y)) scale(.3);opacity:0}}

        /* Hintergrund f√ºr Kartenfront */
        .card-background{
            background-image:url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg');
            background-size:cover;background-position:center
        }

        /* Gegner Name auf R√ºckseite */
        .opponent-back-name{
            position:absolute;top:12%;left:0;width:100%;text-align:center;
            font-family:Arial,Helvetica,sans-serif;color:#e5e7eb;font-weight:700;letter-spacing:.02em;line-height:1.1;z-index:2;
            font-size:clamp(0.8rem,3vw,1.375rem);
            text-shadow:0 1px 2px rgba(0,0,0,.25);pointer-events:none;padding:0 .5rem
        }

        /* Dimmer */
        .dimmer-light{background:rgba(0,0,0,0.2)}
    
        /* Info Button auf Bild */
        .info-tiny-btn{
            position:absolute;
            top:6px; right:6px;
            width:24px; height:24px;
            border:none; padding:0;
            border-radius:9999px;
            background:rgba(255,255,255,0.3);
            z-index:20; cursor:pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: rgba(0,0,0,0.6);
            font-size: 14px;
        }
        .info-tiny-btn:hover{ background:rgba(255,255,255,0.9); color: black; }
        .info-tiny-btn::after { content: "?"; }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">

<!-- Header -->
<header class="bg-white shadow-sm border-b-2 border-amber-200">
    <div class="max-w-6xl mx-auto px-4 p-3">
        <h1 class="text-2xl font-bold text-amber-800 text-center">üå≥ HOLZEN! üå≥</h1>
        <p class="text-xs text-gray-500 text-center mt-1">von Christopher Lehr, in Verbindung mit meiner Masterarbeit</p>
    </div>
</header>

<!-- Setup Modal (Startbildschirm) -->
<div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
        <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
        <div class="space-y-4">
            <!-- AI Button (Funktioniert immer) -->
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg shadow-md">
                üéÆ gegen Computer
            </button>
            
            <!-- Multiplayer Button (Wird deaktiviert, wenn offline) -->
            <button id="btnMultiplayer" onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg shadow-md flex items-center justify-center gap-2">
                <span>üßë‚Äçü§ù‚Äçüßë</span>
                <span id="txtMultiplayer">online gegen Freunde</span>
            </button>
            <p id="firebaseStatus" class="text-xs text-gray-400 mt-1 hidden">Verbindung wird gepr√ºft...</p>
        </div>

        <!-- Einstellungen -->
        <div class="mt-6 grid grid-cols-1 gap-4 border-t pt-4">
            <div class="flex items-center justify-center space-x-3">
                <span class="text-gray-700">üîá</span>
                <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="soundToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                </label>
                <span class="text-gray-700">üîä</span>
            </div>
            <div class="flex items-center justify-center space-x-3">
                <span class="text-xs text-gray-500">Gegner-Holz:</span>
                <span class="text-gray-700">Aus</span>
                <label for="revealBackToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="revealBackToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                <span class="text-gray-700">An</span>
            </div>
        </div>
    </div>
</div>

<!-- Namens-Eingabe Modal -->
<div id="nameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Dein Name</h2>
        <div class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Bitte gib deinen Namen ein:</label>
                <input type="text" id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Spielername" maxlength="15">
            </div>
            <button id="nameSubmitButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors shadow-md">Weiter</button>
        </div>
    </div>
</div>

<!-- Multiplayer Lobby -->
<div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
        <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler...</h2>
        <p id="lobbyText" class="text-gray-700 mb-6">Teile diesen Link mit deinem Freund:</p>
        <div class="bg-gray-100 p-3 rounded-lg border border-gray-300 mb-4">
            <input id="shareLink" type="text" class="w-full bg-transparent text-center text-blue-600 font-mono text-sm" readonly>
        </div>
        <button onclick="window.copyShareLink()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors shadow-md">Link kopieren</button>
        <p id="lobbyStatus" class="mt-4 text-sm text-green-600 font-semibold min-h-[1.5em]"></p>
        <button onclick="window.resetGame()" class="mt-6 text-gray-400 hover:text-gray-600 text-sm underline">Abbrechen</button>
    </div>
</div>

<!-- Haupt-Spielbereich -->
<div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4 relative">
    <div id="animationContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-30"></div>
    
    <!-- Status Scoreboard -->
    <div class="max-w-md mx-auto mb-2 space-y-1">
        <div class="flex justify-center space-x-2">
            <div id="playerScoreBox" class="w-1/2 bg-white rounded-xl shadow-md p-2 text-center relative border border-amber-100">
                <p id="playerNameDisplay" class="text-base font-bold text-amber-600 truncate">Du</p>
                <p class="text-xs text-gray-500">Karten: <span id="playerCards" class="font-bold text-amber-800 text-lg">15</span></p>
            </div>
            <div class="w-1/2 bg-white rounded-xl shadow-md p-2 text-center border border-amber-100">
                <p id="opponentNameDisplay" class="text-base font-bold text-red-600 truncate">Computer</p>
                <p class="text-xs text-gray-500">Karten: <span id="aiCards" class="font-bold text-red-800 text-lg">15</span></p>
            </div>
        </div>
        <!-- Balken -->
        <div class="w-full bg-gray-200 rounded-full h-3 relative overflow-hidden border border-gray-300 shadow-inner">
            <div id="statusBar" class="h-full rounded-l-full transition-all duration-500 ease-out" style="width:50%;background-color:#f59e0b"></div>
            <div class="absolute inset-0 flex justify-center items-center"><div class="w-0.5 h-full bg-white opacity-50"></div></div>
        </div>
    </div>

    <!-- Kartenbereich -->
    <div class="flex justify-center items-start gap-3 sm:gap-4 mb-4 max-w-md mx-auto h-[480px]"> <!-- Feste H√∂he Container -->
        <div class="w-1/2 h-full"><div id="playerCard" class="relative w-full h-full perspective-1000"></div></div>
        <div class="w-1/2 h-full"><div id="aiCard" class="relative w-full h-full perspective-1000"></div></div>
    </div>

    <!-- Unterer Bereich: Zug-Info & Resultat -->
    <div class="bg-white/90 backdrop-blur rounded-xl shadow-lg px-2 py-3 text-center mx-auto flex flex-col items-center max-w-md w-full border border-amber-100 relative z-10">
        <div id="turnIndicator" class="hidden text-sm font-bold uppercase tracking-wider mb-1"></div>
        <div id="attributeSelection" class="w-full"><h3 class="text-sm font-semibold text-gray-500 animate-pulse">W√§hle eine Eigenschaft!</h3></div>
        
        <!-- Resultat Anzeige (versteckt per Default) -->
        <div id="resultDisplay" class="hidden flex flex-col w-full">
            <h3 id="resultText" class="text-xl font-black mb-1 transform transition-all"></h3>
            <p id="resultDetails" class="text-sm text-gray-600 font-mono"></p>
        </div>
    </div>
</div>

<!-- Bottom-Sheet (Ergebnis & Aktionen) -->
<div id="bottomSheetBackdrop" class="hidden fixed inset-0 dimmer-light z-40 transition-opacity duration-300"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-50 flex justify-center px-0 sm:px-4 pb-0 sm:pb-4 transform transition-transform duration-300 translate-y-full">
  <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.15)] border border-amber-200 w-full max-w-md p-5 pb-8 sm:pb-5">
    <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
    <h3 id="bottomSheetTitle" class="text-xl font-bold mb-4 text-center text-gray-800">Ergebnis</h3>
    <div class="flex gap-3">
        <button id="bsInfoBtn" class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-800 border border-purple-200 font-bold py-3 px-3 rounded-xl transition-colors flex flex-col items-center justify-center gap-1">
            <span class="text-xl">‚ÑπÔ∏è</span>
            <span class="text-xs">Wissen</span>
        </button>
        <button id="bsNextBtn" class="flex-[2] bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-3 rounded-xl shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2 text-lg">
            <span>N√§chster Zug</span>
            <span>‚û°Ô∏è</span>
        </button>
    </div>
  </div>
</div>

<!-- Info Modal (Zusatzwissen) -->
<div id="infoModal" class="hidden fixed inset-0 dimmer-light flex items-center justify-center z-[60] px-4">
    <div class="bg-white rounded-2xl p-0 max-w-lg w-full mx-4 shadow-2xl relative overflow-hidden flex flex-col max-h-[85vh]">
        <div class="bg-amber-50 p-4 border-b border-amber-100 flex justify-between items-center">
             <h2 id="infoModalTitle" class="text-lg font-bold text-amber-900">Zusatzwissen</h2>
             <button onclick="window.closeInfoModal()" class="text-gray-400 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto"></div>
    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[70] px-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl text-center border-4 border-white">
        <div id="goIcon" class="text-6xl mb-4">üèÜ</div>
        <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
        <p id="gameOverText" class="text-gray-600 mb-8 text-lg leading-relaxed"></p>
        <div class="space-y-3">
            <button onclick="window.showLeaderboard()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow transition-colors">üèÜ Bestenliste</button>
            <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-xl shadow transition-colors">üîÑ Neues Spiel</button>
        </div>
    </div>
</div>

<!-- Reflection Modal -->
<div id="reflectionModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[70] px-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl text-center">
        <h2 class="text-2xl font-bold text-amber-800 mb-2">Kurz nachgedacht... ü§î</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 text-left font-medium bg-amber-50 p-4 rounded-lg border border-amber-100"></p>
        <textarea id="reflectionAnswer" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-xl transition-colors">Weiter zum Ergebnis</button>
    </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboardModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[80] px-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
        <h2 class="text-2xl font-bold text-amber-800 mb-4 text-center">üèÜ Bestenliste (Top 10)</h2>
        <div id="leaderboardList" class="space-y-2 mb-6 max-h-[50vh] overflow-y-auto custom-scrollbar"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-colors">Schlie√üen</button>
    </div>
</div>

<script type="module">
/* ARCHITEKTUR-√ÑNDERUNG:
   Um sicherzustellen, dass das Spiel auch OFFLINE funktioniert, importieren wir Firebase
   jetzt dynamisch. Wenn der Import fehlschl√§gt (kein Internet), wird Multiplayer
   einfach deaktiviert, aber der Rest des Codes l√§uft weiter.
*/

// Globale Variablen f√ºr Firebase-Instanzen
let db = null;
let auth = null;
let localPlayerId = null;
let serverTimestamp = null;
let increment = null;
let collection = null, query = null, orderBy = null, limit = null, getDocs = null;
let doc = null, getDoc = null, setDoc = null, updateDoc = null, onSnapshot = null, deleteDoc = null;

const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};

/* --- Initialisierung --- */
async function initGameSystem() {
    // 1. UI Handler binden
    window.showNamePrompt = showNamePrompt;
    window.showWoodInfo = showWoodInfo;
    window.closeInfoModal = closeInfoModal;
    window.selectAttribute = selectAttribute;
    window.nextRound = nextRound;
    window.showFinalWinScreen = showFinalWinScreen;
    window.showLeaderboard = showLeaderboard;
    window.closeLeaderboard = closeLeaderboard;
    window.resetGame = resetGame;
    window.copyShareLink = copyShareLink;

    // 2. Settings checken (bevor wir async warten)
    const soundToggle=document.getElementById('soundToggle');
    const savedMute=localStorage.getItem('holzquartett_isMuted');
    isMuted=savedMute==='true';
    if(soundToggle) {
        soundToggle.checked = !isMuted;
        soundToggle.addEventListener('change',(e)=>{
            isMuted=!e.target.checked;
            localStorage.setItem('holzquartett_isMuted',isMuted);
            if(!isMuted) playSound(sounds.chime);
        });
    }

    const revealToggle=document.getElementById('revealBackToggle');
    if(revealToggle) {
        revealToggle.checked=isOpponentNameBackVisible();
        revealToggle.addEventListener('change',e=>{
            setOpponentNameBackVisible(e.target.checked);
            if(gameMode==='ai') displayCardsAI();
            if(gameMode==='multiplayer'&&localGameState) displayMultiplayerCards(localGameState);
        });
    }

    document.getElementById('bsInfoBtn').addEventListener('click', () => {
        closeBottomSheet();
        const currentCardName = lastRoundWinningWoodName || aiGame.currentPlayerCard?.name || 'Holzart';
        window.showWoodInfo(currentCardName);
    });
    document.getElementById('bsNextBtn').addEventListener('click', () => {
        closeBottomSheet();
        window.nextRound();
    });

    // 3. Versuche Firebase zu laden (Async)
    const mpBtn = document.getElementById('btnMultiplayer');
    const mpTxt = document.getElementById('txtMultiplayer');
    const fbStatus = document.getElementById('firebaseStatus');
    
    try {
        if(fbStatus) {
            fbStatus.textContent = "Verbinde...";
            fbStatus.classList.remove('hidden');
        }
        
        const firebaseApp = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
        const firebaseAuth = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
        const firebaseFirestore = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

        const app = firebaseApp.initializeApp(firebaseConfig);
        auth = firebaseAuth.getAuth(app);
        db = firebaseFirestore.getFirestore(app);
        
        doc = firebaseFirestore.doc;
        getDoc = firebaseFirestore.getDoc;
        setDoc = firebaseFirestore.setDoc;
        updateDoc = firebaseFirestore.updateDoc;
        onSnapshot = firebaseFirestore.onSnapshot;
        deleteDoc = firebaseFirestore.deleteDoc;
        serverTimestamp = firebaseFirestore.serverTimestamp;
        collection = firebaseFirestore.collection;
        query = firebaseFirestore.query;
        orderBy = firebaseFirestore.orderBy;
        limit = firebaseFirestore.limit;
        getDocs = firebaseFirestore.getDocs;
        increment = firebaseFirestore.increment;

        await firebaseAuth.signInAnonymously(auth);
        
        firebaseAuth.onAuthStateChanged(auth, (user) => {
            if (user) {
                localPlayerId = user.uid;
                const p = new URLSearchParams(window.location.search);
                const gid = p.get('game');
                if (gid) {
                    gameId = gid;
                    gameMode = 'multiplayer';
                    window.showNamePrompt('join');
                }
            }
        });

        if(fbStatus) {
            fbStatus.textContent = "Online bereit";
            fbStatus.className = "text-xs text-green-500 mt-1";
        }
    } catch (e) {
        console.warn("Firebase konnte nicht geladen werden (Offline?). Multiplayer deaktiviert.", e);
        if(mpBtn) {
            mpBtn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
            mpBtn.onclick = () => alert("Multiplayer ist im Offline-Modus nicht verf√ºgbar.");
        }
        if(mpTxt) mpTxt.textContent = "Offline Modus";
        if(fbStatus) {
            fbStatus.textContent = "Keine Verbindung";
            fbStatus.className = "text-xs text-gray-400 mt-1";
        }
    }
}

// ----------------------------------------------------------------------
// WICHTIG: initGameSystem ganz am Ende aufrufen,
// damit showLeaderboard/closeLeaderboard schon definiert sind (hoisting)
// ----------------------------------------------------------------------

/* --- Daten --- */
const woodCards=[
 {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000},
 {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000},
 {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000},
 {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000},
 {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000},
 {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000},
 {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000},
 {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500},
 {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000},
 {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500},
 {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000},
 {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000},
 {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500},
 {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500},
 {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000},
 {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000},
 {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000},
 {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000},
 {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000},
 {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500},
 {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000},
 {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000},
 {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000},
 {name:"Zypresse",dk:2,haerte:48,quellenSchwindenRadial:3.0,dichte:520,gewicht:9000},
 {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500},
 {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000},
 {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000},
 {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000},
 {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000},
 {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500}
];

const woodInfo = {
 "Eiche": { info: "Die Eiche liefert ein sehr hartes, schweres und dauerhaftes Holz. Sie ist der wichtigste europ√§ische Laubbaum f√ºr Furniere, M√∂bel, Parkett und F√§sser.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/eiche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/eiche_2.jpg?raw=true" },
 "Buche": { info: "Die Rotbuche ist der h√§ufigste Laubbaum in deutschen W√§ldern. Ihr Holz ist hart, aber im Au√üenbereich wenig dauerhaft. Ideal f√ºr M√∂bel, Spielzeug und Parkett.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/buche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/buche_2.jpg?raw=true" },
 "Kiefer": { info: "Kiefernholz ist harzreich und witterungsbest√§ndiger als Fichte. Es wird vielseitig eingesetzt: Bauholz, M√∂bel, Fenster und Dielen.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kiefer_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kiefer_2.jpg?raw=true" },
 "Fichte": { info: "Die Fichte ist der 'Brotbaum' der Forstwirtschaft. Ihr Holz ist weich, leicht und elastisch. Hauptverwendung: Dachst√ºhle, Bauholz, Papier.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/fichte_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/fichte_2.jpg?raw=true" },
 "Tanne": { info: "Tannenholz √§hnelt der Fichte, hat aber keine Harzkan√§le. Es ist hell, leicht und elastisch. Verwendung im Innenausbau und f√ºr Musikinstrumente.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/tanne_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/tanne_2.jpg?raw=true" },
 "L√§rche": { info: "Die L√§rche liefert das h√§rteste und dauerhafteste europ√§ische Nadelholz. Wegen der Witterungsbest√§ndigkeit beliebt f√ºr Fassaden, Terrassen und Fenster.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/laerche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/laerche_2.jpg?raw=true" },
 "Birke": { info: "Birkenholz ist hell, fein und z√§h, aber nicht witterungsfest. Beliebt f√ºr Sperrholzplatten, M√∂bel und Drechselarbeiten.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/birke_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/birke_2.jpg?raw=true" },
 "Ahorn": { info: "Ahorn z√§hlt zu den wertvollsten Edellaubh√∂lzern. Das helle, feinporige Holz wird f√ºr M√∂bel, Tischplatten und Musikinstrumente genutzt.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ahorn_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ahorn_2.jpg?raw=true" },
 "Esche": { info: "Eschenholz ist besonders elastisch und abriebfest. Klassisch f√ºr Werkzeugstiele (Hammer, Axt) und Sportger√§te, heute auch f√ºr M√∂bel und Dielen.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/esche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/esche_2.jpg?raw=true" },
 "Kirsche": { info: "Das r√∂tliche Holz des Kirschbaums dunkelt wundersch√∂n nach. Ein klassisches M√∂belholz f√ºr hochwertige Inneneinrichtungen.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kirsche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kirsche_2.jpg?raw=true" },
 "Nussbaum": { info: "Nussbaumholz ist dunkelbraun, lebhaft gemasert und edel. Es wird f√ºr hochwertige M√∂bel, Furniere und Gewehrsch√§fte verwendet.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/nussbaum_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/nussbaum_2.jpg?raw=true" },
 "Douglasie": { info: "Urspr√ºnglich aus Nordamerika, heute wichtiger Forstbaum. Das Holz ist r√∂tlich, dauerhaft und fest. Ideal f√ºr Terrassen und Carports.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/douglasie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/douglasie_2.jpg?raw=true" },
 "Zeder": { info: "Echtes Zedernholz duftet aromatisch und ist nat√ºrlich dauerhaft. Verwendung f√ºr Zigarrenkisten, Mottenschutz und im Au√üenbereich.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zeder_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zeder_2.jpg?raw=true" },
 "Mahagoni": { info: "Sammelbegriff f√ºr rotbraune Tropenh√∂lzer. Wegen der Sch√∂nheit und Best√§ndigkeit f√ºr Luxusm√∂bel und Bootsbau gesch√§tzt. (Artenschutz beachten!)", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/mahagoni_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/mahagoni_2.jpg?raw=true" },
 "Teak": { info: "Teakholz ist extrem witterungsbest√§ndig durch eingelagerte √ñle. Das klassische Holz f√ºr Gartenm√∂bel und Schiffsdecks.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/teak_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/teak_2.jpg?raw=true" },
 "Bambus": { info: "Botanisch ein Gras, verholzt Bambus extrem schnell. Sehr hart und formstabil, √∂kologisch interessant f√ºr Parkett und Plattenwerkstoffe.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/bambus_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/bambus_2.jpg?raw=true" },
 "Pappel": { info: "Pappelholz ist sehr weich und leicht. Verwendung f√ºr Streichh√∂lzer, Holzschuhe und Paletten, weniger f√ºr M√∂bel.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/pappel_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/pappel_2.jpg?raw=true" },
 "Weide": { info: "Weidenholz ist extrem leicht und weich. Bekannt vor allem durch die Korbflechterei mit den Ruten.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/weide_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/weide_2.jpg?raw=true" },
 "Linde": { info: "Das klassische Schnitzholz. Weich, homogen und leicht zu bearbeiten. Bildhauer nutzen es f√ºr Skulpturen und Alt√§re.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/linde_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/linde_2.jpg?raw=true" },
 "Ulme": { info: "Auch R√ºster genannt. Das Holz ist z√§h und hat eine markante Maserung. Leider durch das Ulmensterben selten geworden.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ulme_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ulme_2.jpg?raw=true" },
 "Kastanie": { info: "Edelkastanie liefert ein dauerhaftes Holz, √§hnlich der Eiche, aber leichter. Verwendung f√ºr Pf√§hle, F√§sser und M√∂bel.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kastanie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kastanie_2.jpg?raw=true" },
 "Robinie": { info: "Das einzige europ√§ische Holz der Dauerhaftigkeitsklasse 1. Extrem hart und z√§h. Ersetzt Tropenholz im Au√üenbereich (Spielpl√§tze!).", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/robinie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/robinie_2.jpg?raw=true" },
 "Hemlock": { info: "Wichtiges Bauholz aus Nordamerika. Harzfrei und nagelfest. Verwendung im Innenausbau, f√ºr Saunen und T√ºren.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hemlock_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hemlock_2.jpg?raw=true" },
 "Zypresse": { info: "Sehr feines, aromatisches und dauerhaftes Holz. In der Antike f√ºr Tempeltore und Schiffe genutzt.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zypresse_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zypresse_2.jpg?raw=true" },
 "Redwood": { info: "Das Holz der Mammutb√§ume. Sehr leicht, aber extrem dauerhaft und rotbraun. In den USA beliebtes Au√üenbauholz.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/redwood_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/redwood_2.jpg?raw=true" },
 "Hickory": { info: "Hickory ist extrem hart, belastbar und elastisch. Das beste Holz f√ºr Werkzeugstiele, Drumsticks und B√∂gen.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hickory_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hickory_2.jpg?raw=true" },
 "Wenge": { info: "Afrikanisches Edelholz. Dunkelbraun bis fast schwarz mit markanter Struktur. Sehr hart. F√ºr exklusives Parkett und M√∂bel.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/wenge_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/wenge_2.jpg?raw=true" },
 "Zebrano": { info: "Auff√§llig gestreiftes westafrikanisches Holz. Dekorativ f√ºr Furniere, Kleinteile und Armaturenbretter.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zebrano_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zebrano_2.jpg?raw=true" },
 "Palisander": { info: "Sammelname f√ºr diverse sehr harte, bunte Tropenh√∂lzer (Dalbergia). Klangholz f√ºr Marimbas und Gitarren. Streng gesch√ºtzt!", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/palisander_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/palisander_2.jpg?raw=true" },
 "Ebenholz": { info: "Eines der h√§rtesten und schwersten H√∂lzer √ºberhaupt. Tiefschwarz. F√ºr Klaviere (schwarze Tasten), Schachfiguren und Blasinstrumente.", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ebenholz_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ebenholz_2.jpg?raw=true" }
};

const reflectionQuestions=[
 "Welches Holz eignet sich am besten f√ºr eine langlebige Terrasse und warum?",
 "Du baust einen Hammerstiel. Warum ist Esche besser als Fichte?",
 "Nenne drei heimische H√∂lzer, die sich gut f√ºr den M√∂belbau eignen.",
 "Warum wird Teakholz oft im Schiffbau verwendet?",
 "Vergleiche die Rohdichte von Eiche und Balsaholz (Pappel). Was bedeutet das f√ºr die Verwendung?",
 "Welches Holz w√ºrdest du f√ºr einen Dachstuhl w√§hlen und warum?",
 "Erkl√§re den Unterschied zwischen Ringporern (z.B. Eiche) und Zerstreutporern (z.B. Buche).",
 "Warum ist Robinienholz eine gute Alternative zu Tropenh√∂lzern im Au√üenbereich?",
 "Welche Eigenschaften machen Ahorn zu einem guten Holz f√ºr Tischplatten?",
 "Warum muss Bauholz trocken sein, bevor es verbaut wird?",
 "Was bedeutet 'Dauerhaftigkeitsklasse'?",
 "F√ºr welche Anwendungen ist eine hohe Elastizit√§t (E-Modul) wichtig?",
 "Warum vergraut Holz im Au√üenbereich?",
 "Welches Holz w√ºrdest du f√ºr eine Sauna-Innenverkleidung nehmen?",
 "Was ist der Vorteil von Furnier gegen√ºber Massivholz?",
 "Nenne einen Nachteil von Buchenholz im Au√üenbereich.",
 "Warum ist der Schutz von Tropenh√∂lzern wichtig?",
 "Welche Rolle spielt Holz als CO2-Speicher?",
 "Was ist 'Bl√§ue' bei Kiefernholz?",
 "Warum wird Fichte oft als Konstruktionsholz verwendet?",
 "Welches Holz eignet sich gut zum Schnitzen?",
 "Was versteht man unter 'Quellen und Schwinden'?",
 "Warum ist Bambus streng genommen kein Holz?",
 "Welche Holzart w√ºrdest du f√ºr einen billigen Einweg-Transportbeh√§lter (Palette) nehmen?",
 "Nenne ein Holz, das sehr witterungsbest√§ndig ist.",
 "Warum ist Eichenholz f√ºr Weinf√§sser geeignet?",
 "Was ist Kernholz und was ist Splintholz?",
 "Warum ist die richtige Holzfeuchte bei Parkett wichtig?",
 "Welches Holz ist besonders schwer und sinkt im Wasser?",
 "Nenne eine Verwendung f√ºr Birkenholz."
];

const attributeInfo={
  dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit (DK)',color:'blue'},
  haerte:{icon:'üíé',name:'Druckfestigkeit (N/mm¬≤)',color:'blue'},
  quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schwinden (%)',color:'blue'},
  dichte:{icon:'‚öñÔ∏è',name:'Rohdichte (kg/m¬≥)',color:'blue'},
  gewicht:{icon:'üèãÔ∏è',name:'E-Modul (N/mm¬≤)',color:'blue'}
};

/* --- Game State --- */
let gameMode = null; 
let gameId = null; 
let unsubscribeGame = null; 
let localGameState = {}; 
let hasCopiedShareLink = false;
let isMuted = false;
let roundSoundPlayed = false;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};
let lastRoundWinningWoodName = null;

const sounds={
  flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
  win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
  chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
  starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
sounds.flip.volume=.5; sounds.win.volume=.4; sounds.chime.volume=.6; sounds.starWin.volume=.7;
function playSound(a){ if(isMuted) return; a.currentTime=0; a.play().catch(()=>{}); }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

/* --- UI Logic --- */

function showNamePrompt(mode){
  if(mode === 'multiplayer' && !db) {
    alert("Multiplayer ist derzeit nicht verf√ºgbar (Offline oder Firebase-Fehler).");
    return;
  }
  document.getElementById('setupModal').classList.add('hidden');
  const nameModal=document.getElementById('nameModal');
  nameModal.classList.remove('hidden');
  
  // Clean listeners to avoid duplicates if re-opened
  const btn = document.getElementById('nameSubmitButton');
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);

  newBtn.addEventListener('click', () => {
      const playerName=document.getElementById('playerName').value.trim();
      if(!playerName){alert('Bitte gib deinen Namen ein!');return;}
      nameModal.classList.add('hidden');
      if(mode==='ai'){ gameMode='ai'; startGameAI(playerName); }
      else if(mode==='multiplayer'){ gameMode='multiplayer'; createGame(playerName); }
      else if(mode==='join'){ joinGame(gameId,playerName); }
  });
}

function copyShareLink() {
  const el=document.getElementById('shareLink');
  navigator.clipboard.writeText(el.value).then(() => {
     hasCopiedShareLink=true;
     const s=document.getElementById('lobbyStatus'); if(s) s.textContent='Link kopiert! Warte auf Mitspieler...';
     // Live check if we can jump
     if(localGameState&&(localGameState.status==='playing'||localGameState.status==='finished')){
       document.getElementById('multiplayerLobbyModal').classList.add('hidden');
       document.getElementById('gameContainer').classList.remove('hidden');
       updateMultiplayerUI(localGameState);
     }
  }).catch(() => {
     el.select(); document.execCommand('copy');
     hasCopiedShareLink=true;
  });
}

/* --- Helpers --- */
function shuffleArray(a){const s=[...a]; for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]];} return s;}

/* --- AI Engine --- */
function startGameAI(name){
  aiGame.playerName=name;
  document.getElementById('playerNameDisplay').textContent=name;
  document.getElementById('opponentNameDisplay').textContent='Computer';
  const sh=shuffleArray(woodCards);
  aiGame.playerCards=sh.slice(0,15);
  aiGame.aiCards=sh.slice(15,30);
  aiGame.currentPlayerCard=aiGame.playerCards[0];
  aiGame.currentAiCard=aiGame.aiCards[0];
  aiGame.roundInProgress=false;
  aiGame.turn='player';
  
  // UI Reset
  document.getElementById('attributeSelection').classList.remove('hidden');
  document.getElementById('resultDisplay').classList.add('hidden');
  document.getElementById('turnIndicator').classList.remove('hidden');
  document.getElementById('gameContainer').classList.remove('hidden');
  document.getElementById('turnIndicator').textContent = "Du bist am Zug!";
  window.scrollTo(0,0);
  
  updateDisplayAI();
  displayCardsAI();
}

function displayCardsAI(){
  const pc=document.getElementById('playerCard');
  const ac=document.getElementById('aiCard');
  pc.innerHTML=''; ac.innerHTML='';
  
  if(aiGame.currentPlayerCard) pc.appendChild(createCard(aiGame.currentPlayerCard,true,true)); 
  else pc.innerHTML=`<div class="flex items-center justify-center h-full bg-gray-100 rounded-xl text-gray-400">Leer</div>`;

  if(aiGame.currentAiCard){
    const reveal=aiGame.roundInProgress;
    ac.appendChild(createCard(aiGame.currentAiCard,reveal,false));
  }else ac.innerHTML=`<div class="flex items-center justify-center h-full bg-gray-100 rounded-xl text-gray-400">Leer</div>`;
}

function selectAttributeAI(attribute){
  if(aiGame.roundInProgress || aiGame.turn!=='player' || !aiGame.currentPlayerCard || !aiGame.currentAiCard || !attributeInfo[attribute]) return;
  aiGame.roundInProgress=true;
  
  const pv=aiGame.currentPlayerCard[attribute];
  const av=aiGame.currentAiCard[attribute];
  
  // Flip Gegnerkarte
  const aiCardEl=document.getElementById('aiCard').querySelector('.card-3d');
  if(aiCardEl){ aiCardEl.classList.remove('card-flipped'); playSound(sounds.flip); }

  // Vergleich
  let pWins;
  if(attribute==='quellenSchwindenRadial' || attribute==='dk'){ pWins = pv<av ? true : (av<pv ? false : 'tie'); }
  else{ pWins = pv>av ? true : (av>pv ? false : 'tie'); }

  const pMove=aiGame.playerCards.shift(), aMove=aiGame.aiCards.shift();
  let resultTitle = 'ü§ù Unentschieden!';
  let nextTurn = aiGame.turn;

  if(pWins===true){ 
      if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.playerCards.push(aMove); 
      nextTurn='player'; resultTitle='üéâ Du gewinnst!'; 
      lastRoundWinningWoodName = aiGame.currentPlayerCard.name; 
  } else if(pWins===false){ 
      if(aMove) aiGame.aiCards.push(aMove); if(pMove) aiGame.aiCards.push(pMove); 
      nextTurn='ai'; resultTitle='üòû KI gewinnt!'; 
      lastRoundWinningWoodName = aiGame.currentAiCard.name; 
  } else { 
      if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.aiCards.push(aMove); 
      lastRoundWinningWoodName = (Math.random() < 0.5 ? aiGame.currentPlayerCard.name : aiGame.currentAiCard.name); 
  }

  aiGame.turn = nextTurn;

  // UI Update Step 1 (Vergleich zeigen)
  setTimeout(()=>{
    displayCardsAI(); // Damit Werte im DOM aktuell gerendert sind (obwohl Karte schon geflippt war)
    
    const res=document.getElementById('resultText');
    const resCls= pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-yellow-600');
    res.textContent= resultTitle;
    res.className=`text-xl font-black mb-1 transform transition-all ${resCls}`;
    
    document.getElementById('resultDetails').textContent=`${attributeInfo[attribute].name.split(' (')[0]}: ${pv.toLocaleString('de-DE')} vs ${av.toLocaleString('de-DE')}`;
    
    document.getElementById('attributeSelection').classList.add('hidden');
    document.getElementById('resultDisplay').classList.remove('hidden');
    highlightChosenAttribute(attribute);

    if(pWins===true){ playSound(sounds.win); triggerWinStarAnimation(); }

    // UI Step 2 (Bottom Sheet)
    setTimeout(()=>{
        openBottomSheet(resultTitle.replace(/[^a-zA-Z√§√∂√º√Ñ√ñ√ú√ü ]/g, "").trim());
    }, 1500);

    updateDisplayAI();
    checkGameOverAI();
    // Scroll mobile to ensure visibility if needed
    // window.scrollTo({top:0,behavior:'smooth'});
  }, 600);
}

function aiSelectAttribute(){
  if(aiGame.roundInProgress || aiGame.turn!=='ai' || !aiGame.currentPlayerCard || !aiGame.currentAiCard) return;
  aiGame.roundInProgress=true;
  closeBottomSheet(); // Safety close

  setTimeout(()=>{
      const keys=Object.keys(attributeInfo);
      const key=keys[Math.floor(Math.random()*keys.length)];
      const pv=aiGame.currentPlayerCard[key], av=aiGame.currentAiCard[key];
      
      const aiCardEl=document.getElementById('aiCard').querySelector('.card-3d');
      if(aiCardEl){ aiCardEl.classList.remove('card-flipped'); playSound(sounds.flip); }

      let pWins;
      if(key==='quellenSchwindenRadial' || key==='dk'){ pWins = pv<av ? true : (av<pv ? false : 'tie'); }
      else{ pWins = pv>av ? true : (av>pv ? false : 'tie'); }

      const pMove=aiGame.playerCards.shift(), aMove=aiGame.aiCards.shift();
      let resultTitle='ü§ù Unentschieden!';
      let nextTurn = aiGame.turn;

      if(pWins===true){ 
          if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.playerCards.push(aMove); 
          nextTurn='player'; resultTitle='üéâ Du gewinnst!'; 
          lastRoundWinningWoodName = aiGame.currentPlayerCard.name;
      } else if(pWins===false){ 
          if(aMove) aiGame.aiCards.push(aMove); if(pMove) aiGame.aiCards.push(pMove); 
          nextTurn='ai'; resultTitle='üòû KI gewinnt!'; 
          lastRoundWinningWoodName = aiGame.currentAiCard.name;
      } else { 
          if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.aiCards.push(aMove); 
          lastRoundWinningWoodName = (Math.random() < 0.5 ? aiGame.currentPlayerCard.name : aiGame.currentAiCard.name);
      }

      aiGame.turn = nextTurn;

      displayCardsAI();
      const res=document.getElementById('resultText');
      const resCls= pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-yellow-600');
      res.textContent= resultTitle;
      res.className=`text-xl font-black mb-1 transform transition-all ${resCls}`;
      
      document.getElementById('resultDetails').textContent=`${attributeInfo[key].name.split(' (')[0]}: ${pv.toLocaleString('de-DE')} vs ${av.toLocaleString('de-DE')}`;
      highlightChosenAttribute(key);
      document.getElementById('attributeSelection').classList.add('hidden');
      document.getElementById('resultDisplay').classList.remove('hidden');

      if(pWins===true){ playSound(sounds.win); triggerWinStarAnimation(); }

      setTimeout(()=>{
          openBottomSheet(resultTitle.replace(/[^a-zA-Z√§√∂√º√Ñ√ñ√ú√ü ]/g, "").trim());
      }, 1500);

      updateDisplayAI(); 
      checkGameOverAI();
  }, 1000);
}

function nextRoundAI(){
  clearAttributeHighlights();
  document.querySelectorAll('#playerCard .space-y-1 > *, #aiCard .space-y-1 > *').forEach(e=>e.classList.remove('bg-yellow-200','bg-gray-300'));
  
  if(aiGame.playerCards.length===0||aiGame.aiCards.length===0){ 
      if(!document.getElementById('gameOverModal').classList.contains('hidden')){ } else { endGameAI(); } 
      return; 
  }

  aiGame.currentPlayerCard=aiGame.playerCards[0];
  aiGame.currentAiCard=aiGame.aiCards[0];
  aiGame.roundInProgress=false;
  
  document.getElementById('resultDisplay').classList.add('hidden');
  updateDisplayAI(); 
  displayCardsAI();

  if(aiGame.turn==='ai'){ 
      document.getElementById('attributeSelection').classList.add('hidden'); 
      aiSelectAttribute(); 
  } else{ 
      document.getElementById('attributeSelection').classList.remove('hidden'); 
  }
  
  // Sheet reset
  const sheet = document.getElementById('bottomSheet');
  sheet.classList.add('translate-y-full');
  document.getElementById('bottomSheetBackdrop').classList.add('hidden');
}

function updateDisplayAI(){
  const pc=aiGame.playerCards.length, oc=aiGame.aiCards.length;
  document.getElementById('playerCards').textContent=pc;
  document.getElementById('aiCards').textContent=oc;
  updateStatusBar(pc,oc);
  
  const ti=document.getElementById('turnIndicator'); 
  ti.classList.remove('hidden');
  
  if(aiGame.roundInProgress){
      // During round/animation
      if(!document.getElementById('resultDisplay').classList.contains('hidden')) ti.textContent='';
      else if(aiGame.turn==='ai'){ 
          ti.textContent='Computer √ºberlegt...'; 
          ti.className='text-sm font-bold uppercase tracking-wider mb-1 text-gray-500'; 
      }
      else ti.textContent='';
  } else if(aiGame.turn==='player'){ 
      ti.textContent='Du bist am Zug!'; 
      ti.className='text-sm font-bold uppercase tracking-wider mb-1 text-green-600'; 
  } else { 
      ti.textContent='Computer ist am Zug...'; 
      ti.className='text-sm font-bold uppercase tracking-wider mb-1 text-gray-500'; 
  }
}

function checkGameOverAI(){ 
    if(aiGame.roundInProgress){ 
        if(aiGame.playerCards.length===0||aiGame.aiCards.length===0) setTimeout(endGameAI,300); 
    } 
}

/* --- Multiplayer logic (condensed) --- */
async function createGame(playerName){
  if(!db) return;
  const lobby=document.getElementById('multiplayerLobbyModal');
  lobby.classList.remove('hidden');
  hasCopiedShareLink=false;
  gameId=Math.random().toString(36).substring(2,8).toUpperCase();
  const base=window.location.href.split('?')[0];
  document.getElementById('shareLink').value=`${base}?game=${gameId}`;
  const ref=doc(db,"games",gameId);
  const data={gameId,status:'waiting',playerIds:[localPlayerId],players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},createdAt:serverTimestamp()};
  try{await setDoc(ref,data);listenToGameChanges();}catch(e){alert("Fehler beim Erstellen des Spiels.");}
}

async function joinGame(id,playerName){
  if(!db) return;
  const ref=doc(db,"games",id);
  try{
    const snap=await getDoc(ref);
    if(snap.exists()&&snap.data().status==='waiting'&&snap.data().playerIds.length===1){
      document.getElementById('lobbyTitle').textContent="Spiel wird beigetreten...";
      document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
      const shuffled=shuffleArray([...woodCards]);
      const p1=snap.data().playerIds[0];
      const p1Cards=shuffled.slice(0,15);
      const p2Cards=shuffled.slice(15,30);
      await updateDoc(ref,{
        status:'playing',
        playerIds:[p1,localPlayerId],
        [`players.${localPlayerId}`]:{name:playerName,cards:p2Cards,status:'online'},
        [`players.${p1}.cards`]:p1Cards,
        turn:p1,
        currentCards:{[p1]:p1Cards[0],[localPlayerId]:p2Cards[0]},
        lastResult:null,
        lastActivity:serverTimestamp()
      });
      listenToGameChanges();
    }else{
      alert("Spiel nicht gefunden."); window.location.search='';
    }
  }catch(e){alert("Fehler beim Beitreten."); window.location.search='';}
}

function listenToGameChanges(){
  if(!gameId || !db) return;
  unsubscribeGame=onSnapshot(doc(db,"games",gameId),(ds)=>{
    if(!ds.exists()){ alert("Spiel beendet."); resetGame(); return; }
    const gd=ds.data(); localGameState=gd;
    if(gd.status==='playing'||gd.status==='finished'){
        if(document.getElementById('multiplayerLobbyModal').classList.contains('hidden') === false) {
           document.getElementById('multiplayerLobbyModal').classList.add('hidden');
           document.getElementById('gameContainer').classList.remove('hidden');
        }
        updateMultiplayerUI(gd);
    }
  });
}

function updateMultiplayerUI(gameData){
    // ... (√§hnlich AI, nur mit Remote Daten)
    const oppId=gameData.playerIds.find(id=>id!==localPlayerId);
    document.getElementById('playerNameDisplay').textContent=gameData.players[localPlayerId]?.name||'Du';
    document.getElementById('playerCards').textContent=gameData.players[localPlayerId]?.cards?.length??0;
    
    if(oppId && gameData.players[oppId]){
        document.getElementById('opponentNameDisplay').textContent=gameData.players[oppId].name;
        document.getElementById('aiCards').textContent=gameData.players[oppId].cards?.length??0;
    }
    
    updateStatusBar(gameData.players[localPlayerId]?.cards?.length??0, gameData.players[oppId]?.cards?.length??0);
    displayMultiplayerCards(gameData);
    
    if(gameData.lastResult){
        if(!roundSoundPlayed){ 
            roundSoundPlayed=true; 
            if(gameData.lastResult.winnerId===localPlayerId) playSound(sounds.win); 
            else playSound(sounds.flip);
        }
        document.getElementById('attributeSelection').classList.add('hidden');
        document.getElementById('resultDisplay').classList.remove('hidden');
        
        const {winnerId,attribute,values}=gameData.lastResult;
        const winnerName=winnerId===localPlayerId?'Du':(winnerId==='tie'?'':(gameData.players[winnerId]?.name||'Gegner'));
        
        let title = winnerId==='tie' ? 'ü§ù Unentschieden!' : (winnerId===localPlayerId?`üéâ ${winnerName} gewinnt!`:`üòû ${winnerName} gewinnt!`);
        document.getElementById('resultText').textContent = title;
        document.getElementById('resultText').className = winnerId===localPlayerId ? 'text-xl font-black mb-1 text-green-600' : (winnerId==='tie' ? 'text-xl font-black mb-1 text-yellow-600' : 'text-xl font-black mb-1 text-red-600');
        
        document.getElementById('resultDetails').textContent = `${attributeInfo[attribute]?.name.split(' (')[0]||attribute}: ${values[localPlayerId]} vs ${values[oppId]}`;
        
        setTimeout(() => openBottomSheet(title.replace(/[^a-zA-Z√§√∂√º√Ñ√ñ√ú√ü ]/g, "").trim()), 1000);
    } else {
        roundSoundPlayed=false;
        closeBottomSheet();
        document.getElementById('resultDisplay').classList.add('hidden');
        const ti=document.getElementById('turnIndicator');
        ti.classList.remove('hidden');
        if(gameData.turn===localPlayerId){
            ti.textContent="Du bist am Zug!";
            ti.className='text-sm font-bold uppercase tracking-wider mb-1 text-green-600';
            document.getElementById('attributeSelection').classList.remove('hidden');
        } else {
            ti.textContent="Gegner ist am Zug...";
            ti.className='text-sm font-bold uppercase tracking-wider mb-1 text-gray-500';
            document.getElementById('attributeSelection').classList.add('hidden');
        }
    }
    
    if(gameData.status==='finished') endGame();
}

async function multiplayerSelectAttribute(attr){
    if(!db) return;
    const gs=localGameState;
    const opp=gs.playerIds.find(id=>id!==localPlayerId);
    const pv=gs.currentCards[localPlayerId][attr];
    const ov=gs.currentCards[opp][attr];
    
    let pWins;
    if(attr==='quellenSchwindenRadial' || attr==='dk'){ pWins = pv<ov ? true : (ov<pv ? false : 'tie'); }
    else{ pWins = pv>av ? true : (av>pv ? false : 'tie'); }
    
    const winner = pWins==='tie' ? 'tie' : (pWins ? localPlayerId : opp);
    await updateDoc(doc(db,"games",gameId),{
        lastResult:{winnerId:winner,attribute:attr,values:{[localPlayerId]:pv,[opp]:ov}},
        lastActivity:serverTimestamp()
    });
}

async function multiplayerNextRound(){
   if(!db) return;
   // Logic for moving cards similar to AI but with db updates
   // Simplified here for brevity since AI mode is primary focus for fixing the "hang"
   // ... (See previous implementation, just needs wrapping in try-catch and db check)
   
   // Reuse old logic but careful with undefined vars if db not loaded
   // Actually, multiplayerNextRound logic is complex. 
   // Assuming user mostly plays AI if offline. 
   
   // FULL IMPLEMENTATION for robustness:
   const gs=localGameState;
   const [p1,p2]=gs.playerIds;
   let p1Cards=[...gs.players[p1].cards], p2Cards=[...gs.players[p2].cards];
   
   const c1=p1Cards.shift(), c2=p2Cards.shift();
   if(gs.lastResult.winnerId===p1){ if(c1) p1Cards.push(c1); if(c2) p1Cards.push(c2); }
   else if(gs.lastResult.winnerId===p2){ if(c1) p2Cards.push(c1); if(c2) p2Cards.push(c2); }
   else { if(c1) p1Cards.push(c1); if(c2) p2Cards.push(c2); }

   if(p1Cards.length===0 || p2Cards.length===0){
     await updateDoc(doc(db,"games",gameId),{status:'finished',players:{[p1]:{...gs.players[p1],cards:p1Cards},[p2]:{...gs.players[p2],cards:p2Cards}},lastResult:null});
   } else {
     const nextTurn = gs.lastResult.winnerId==='tie' ? gs.turn : gs.lastResult.winnerId;
     await updateDoc(doc(db,"games",gameId),{
        lastResult:null, turn:nextTurn,
        players:{[p1]:{...gs.players[p1],cards:p1Cards},[p2]:{...gs.players[p2],cards:p2Cards}},
        currentCards:{[p1]:p1Cards[0],[p2]:p2Cards[0]}
     });
   }
}

/* --- Common UI --- */
function selectAttribute(attr){ if(gameMode==='ai') selectAttributeAI(attr); else multiplayerSelectAttribute(attr); }
function nextRound(){ if(gameMode==='ai') nextRoundAI(); else multiplayerNextRound(); }

function createCard(cardData,isRevealed=true,isPlayer=true){
  const card=document.createElement('div');
  card.className=`card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''} transition-all duration-300`;
  if(!isRevealed) card.classList.add('card-flipped');

  const borderColor=isPlayer?'border-amber-400':'border-gray-300';
  const shadow=isPlayer?'shadow-lg':'shadow-md';

  const front=document.createElement('div');
  front.className=`card-front card-background rounded-xl ${shadow} border-2 ${borderColor} p-2 sm:p-3 flex flex-col overflow-hidden`;

  const canSelect=isPlayer && ((gameMode==='ai' && !aiGame.roundInProgress && aiGame.turn==='player') || (gameMode==='multiplayer' && localGameState?.turn===localPlayerId && !localGameState?.lastResult));
  
  const cardName=cardData?.name||'Unbekannt';
  const safeId=(cardName||'').replace(/[^a-zA-Z0-9]/g,'-')||'unknown';
  const wi=woodInfo[cardName]||{};
  const treeImg=wi.bildBaum||'https://placehold.co/160x120/d1d5db/374151?text=?';
  
  // Zeige Info Button nur, wenn Karte sichtbar ist und nicht gerade spielt oder Ergebnis da ist
  const showInfoBtn = isRevealed;

  const imageContainer = `
    <div class="relative w-full h-40 sm:h-48 mb-3 group flex-shrink-0">
        <div class="absolute top-2 left-2 z-10 bg-gray-900/60 text-white px-2 py-0.5 rounded text-sm sm:text-base font-bold shadow backdrop-blur-sm pointer-events-none">
            ${cardName}
        </div>
        <img src="${treeImg}" alt="${cardName}" class="w-full h-full object-cover rounded-xl shadow-sm bg-amber-50 border border-amber-200">
        <button onclick="window.showWoodInfo('${cardName.replace(/'/g,"\'")}')" class="${showInfoBtn ? 'info-tiny-btn' : 'hidden'}" aria-label="Zusatzwissen"></button>
    </div>
  `;

  let attrs='<div class="space-y-1 mt-auto">';
  for(const key in attributeInfo){
    const a=attributeInfo[key];
    const v=cardData?.[key]??'?';
    const fv=typeof v==='number'?v.toLocaleString('de-DE'):v;
    const label=(key==='quellenSchwindenRadial')?'Quellen/Schw.':a.name.replace(/\s*\(([^)]+)\)/,'');
    const unit=a.name.match(/\(([^)]+)\)/);
    const unitText=unit?`<span class="text-[10px] text-gray-500 ml-1">(${unit[1]})</span>`:'';

    const baseBg=canSelect?'bg-amber-50':'bg-white/50';
    const hov=canSelect?'hover:bg-amber-100':'';
    const border=canSelect?'border-amber-200':'border-transparent';
    const txt=canSelect?'text-amber-900':'text-gray-700';
    const common=`w-full flex justify-between items-center py-1 px-2 rounded-lg text-left border ${border} ${baseBg}`;

    if(canSelect){
      attrs+=`<button onclick="window.selectAttribute('${key}')" class="${common} ${hov} transition-colors group">
                <div class="flex items-center">
                    <span class="mr-2 opacity-70 group-hover:opacity-100">${a.icon}</span>
                    <span class="text-xs font-semibold uppercase tracking-wide text-gray-600 group-hover:text-amber-800">${label}</span>
                </div>
                <div class="flex items-baseline">
                    <span class="font-bold text-lg ${txt}">${fv}</span>
                    ${unitText}
                </div>
              </button>`;
    }else{
      attrs+=`<div data-attr="${key}" class="${common}">
                <div class="flex items-center">
                    <span class="mr-2 opacity-50">${a.icon}</span>
                    <span class="text-xs font-semibold uppercase tracking-wide text-gray-500">${label}</span>
                </div>
                 <div class="flex items-baseline">
                    <span class="font-bold text-lg ${txt}">${fv}</span>
                    ${unitText}
                </div>
              </div>`;
    }
  }
  attrs+='</div>';

  front.innerHTML = imageContainer + attrs;

  const back=document.createElement('div');
  back.className='card-back rounded-xl shadow-lg border-2 border-amber-300 flex items-center justify-center relative overflow-hidden';
  if(!isRevealed && !isPlayer && isOpponentNameBackVisible()){
    const label=document.createElement('div');
    label.className='opponent-back-name';
    label.textContent=cardName;
    back.appendChild(label);
  }

  card.appendChild(front); card.appendChild(back);
  return card;
}

function updateStatusBar(p, o){
  const total=p+o; const perc= total>0 ? (p/total)*100 : 50;
  const el=document.getElementById('statusBar');
  el.style.width=`${perc}%`;
  let c='#f59e0b';
  if(perc<25)c='#ef4444'; else if(perc<45)c='#f97316'; else if(perc>75)c='#22c55e'; else if(perc>55)c='#84cc16';
  el.style.backgroundColor=c;
}

function highlightChosenAttribute(attr){
  document.querySelectorAll(`[data-attr="${attr}"]`).forEach(el => el.classList.add('bg-yellow-200'));
}
function clearAttributeHighlights(){
  document.querySelectorAll('[data-attr]').forEach(el => el.classList.remove('bg-yellow-200'));
}

function showWoodInfo(name){
  const modal=document.getElementById('infoModal');
  const title=document.getElementById('infoModalTitle');
  const content=document.getElementById('infoModalContent');
  title.textContent=`Zusatzwissen: ${name}`;
  
  const key=Object.keys(woodInfo).find(k=>k.toLowerCase()===name.toLowerCase());
  const info=key?woodInfo[key]:null;

  if(info){
      content.innerHTML = `
          <div class="mb-4 text-gray-800 leading-relaxed">${info.info}</div>
          <div class="grid grid-cols-2 gap-3">
              <div class="text-center">
                  <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Baum</span>
                  <img src="${info.bildBaum}" class="rounded-lg shadow-sm border w-full h-32 object-cover bg-gray-100">
              </div>
              <div class="text-center">
                  <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Holz</span>
                  <img src="${info.bildQuerschnitt}" class="rounded-lg shadow-sm border w-full h-32 object-cover bg-gray-100">
              </div>
          </div>
      `;
  } else {
      content.innerHTML = `<p class="text-gray-500 italic">Keine Infos vorhanden.</p>`;
  }
  modal.classList.remove('hidden');
}

function closeInfoModal(){
    document.getElementById('infoModal').classList.add('hidden');
    // Re-open Bottom Sheet if was open
    const bsTitle = document.getElementById('bottomSheetTitle');
    if(bsTitle.textContent && document.getElementById('resultDisplay').classList.contains('hidden') === false) {
        openBottomSheet(bsTitle.textContent);
    }
}

function openBottomSheet(title){
    document.getElementById('bottomSheetTitle').textContent = title;
    document.getElementById('bottomSheetBackdrop').classList.remove('hidden');
    document.getElementById('bottomSheet').classList.remove('translate-y-full');
}
function closeBottomSheet(){
    document.getElementById('bottomSheetBackdrop').classList.add('hidden');
    document.getElementById('bottomSheet').classList.add('translate-y-full');
}

function endGame(){
    // Simplified trigger
    if(gameMode==='ai'){
        const win = aiGame.playerCards.length > 0;
        showGameOverScreen(win);
        saveToLeaderboard(aiGame.playerName);
    } else {
        const pc=localGameState.players[localPlayerId].cards.length;
        showGameOverScreen(pc > 0);
        if(pc>0) saveToLeaderboard(localGameState.players[localPlayerId].name);
    }
}
function endGameAI(){ endGame(); }

function showGameOverScreen(win){
    closeBottomSheet();
    document.getElementById('gameOverModal').classList.remove('hidden');
    const t=document.getElementById('gameOverTitle');
    const txt=document.getElementById('gameOverText');
    const ico=document.getElementById('goIcon');
    if(win){
        t.textContent = "GEWONNEN!"; t.className="text-3xl font-black mb-2 text-green-600";
        txt.textContent = "Fantastisch! Du hast alle Karten gesammelt.";
        ico.textContent = "üèÜ";
        playSound(sounds.win);
    } else {
        t.textContent = "LEIDER VERLOREN"; t.className="text-3xl font-black mb-2 text-red-600";
        txt.textContent = "Der Computer war diesmal st√§rker. Versuch es gleich nochmal!";
        ico.textContent = "üò¢";
    }
}

function showFinalWinScreen(){
    document.getElementById('reflectionModal').classList.add('hidden');
    showGameOverScreen(true);
}

function triggerWinStarAnimation(){
    const cont=document.getElementById('animationContainer');
    const star=document.createElement('div');
    star.textContent='‚≠ê';
    star.className='falling-star';
    star.style.left = '50%';
    star.style.top = '20%';
    star.style.setProperty('--end-y', '300px');
    cont.appendChild(star);
    playSound(sounds.starWin);
    setTimeout(()=>star.remove(), 1500);
}

function resetGame(){
    window.location.reload();
}

async function saveToLeaderboard(name){
    if(!db || !name) return;
    try {
        const safe=name.replace(/[.#$[\]]/g,'_');
        await setDoc(doc(db,"leaderboard",safe),{name,wins:increment(1),lastWin:serverTimestamp()},{merge:true});
    } catch(e){}
}

/* --- LEADERBOARD & CLOSE FUNCTIONS --- */
// Added here to fix hoisting issue
async function showLeaderboard(){
  if(!db) { alert("Bestenliste offline nicht verf√ºgbar."); return; }
  const list=document.getElementById('leaderboardList');
  list.innerHTML='<p class="text-gray-500 text-center">Lade Bestenliste...</p>';
  document.getElementById('gameOverModal').classList.add('hidden');
  document.getElementById('leaderboardModal').classList.remove('hidden');
  try{
    const q=query(collection(db,"leaderboard"),orderBy("wins","desc"),limit(10));
    const snap=await getDocs(q);
    if(snap.empty){ list.innerHTML='<p class="text-gray-500 text-center">Noch keine Eintr√§ge vorhanden.</p>'; return; }
    list.innerHTML=snap.docs.map((d,i)=>{
      const data=d.data(); const safe=(data.name||'Unbekannt').replace(/</g,"&lt;").replace(/>/g,"&gt;");
      return `<div class="flex justify-between items-center p-3 ${i%2===0?'bg-gray-50':'bg-white'} rounded-lg border-b border-gray-100 last:border-0"><span class="font-semibold text-gray-800">${i+1}. ${safe}</span><span class="text-sm font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded-full">${data.wins||0} Siege</span></div>`;
    }).join('');
  }catch(e){ list.innerHTML='<p class="text-red-500 text-center">Fehler beim Laden der Bestenliste.</p>'; }
}

function closeLeaderboard(){
  document.getElementById('leaderboardModal').classList.add('hidden');
  if(localGameState?.status==='finished' || (gameMode==='ai' && (aiGame.playerCards.length===0||aiGame.aiCards.length===0))){
    document.getElementById('gameOverModal').classList.remove('hidden');
  }else{
    document.getElementById('setupModal').classList.remove('hidden');
  }
}

// Ganz am Ende den Init aufrufen, wenn alles definiert ist
initGameSystem();
</script>
</body>
</html>
