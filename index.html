<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett: Fachwissen-Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; touch-action: manipulation; overflow-x: hidden; min-height: 100dvh; }
        .perspective-1000 { perspective: 1000px; }
        .card-3d { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 1rem; overflow: hidden; box-sizing: border-box; }
        .card-back { 
            transform: rotateY(180deg); 
            background-color: #2c3e50;
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images/background_card.jpg?raw=true'); 
            background-size: cover; 
            background-position: center; 
            border: 4px solid white; 
        }
        .card-front-bg { background-color: #fffbeb; background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .dimmer { background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .attr-box { background-color: #fff7ed; border: 1px solid #fbbf24; transition: all 0.2s; }
        .attr-box.flash-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; }
        .attr-box.flash-active span { color: white !important; }
        .attr-box.highlight-compare { background-color: #e5e7eb !important; border-color: #9ca3af !important; }
        
        /* Quiz Timer Animation */
        #quizTimerBar { transition: width 1s linear; }
        
        /* Animation Correction for Quiz Modal */
        @keyframes pop-in { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; }
        
        .falling-star { position: absolute; font-size: 7rem; z-index: 100; animation: fall-and-fade 1.2s ease-in forwards; }
        @keyframes fall-and-fade { 0% { transform: translateY(-30px) scale(1.5); opacity: 0; } 30% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(var(--end-y)) scale(0.3); opacity: 0; } }
        
        .animate-glow-win { animation: glow-win 1.2s ease-out; }
        .animate-glow-lose { animation: glow-lose 1.2s ease-out; }
        @keyframes glow-win { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } 50% { box-shadow: 0 0 30px 15px rgba(74, 222, 128, 0.6); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
        @keyframes glow-lose { 0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); } 50% { box-shadow: 0 0 30px 15px rgba(248, 113, 113, 0.6); } 100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); } }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">
<header class="bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-20">
    <div class="max-w-[600px] mx-auto px-4 py-3 flex justify-between items-center relative">
        <button onclick="location.reload()" class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center border border-white/30">
             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </button>
        <h1 class="text-xl font-black tracking-tighter uppercase italic">üå≤ HOLZEN! üå≤</h1>
        <button onclick="window.showGameInfo()" class="p-2">
             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>
</header>
<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto p-2 relative">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>
    
    <div class="flex justify-center gap-2 sm:gap-4 w-full mt-2"> 
        <div class="flex flex-col w-[48%] gap-2 text-center">
            <div id="playerScoreBox" class="bg-white rounded-2xl shadow-sm border border-orange-100 p-2 relative">
                <div id="playerNameDisplay" class="font-bold text-amber-700 truncate text-sm sm:text-base">Spieler</div>
                <div class="text-xs text-gray-500">Karten: <span id="playerCards" class="font-bold text-lg text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/42] perspective-1000" id="playerCard"></div>
        </div>
        <div class="flex flex-col w-[48%] gap-2 text-center">
            <div class="bg-white rounded-2xl shadow-sm border border-orange-100 p-2">
                <div id="opponentNameDisplay" class="font-bold text-gray-600 truncate text-sm sm:text-base">COMPUTER</div>
                <div class="text-xs text-gray-500">Karten: <span id="aiCards" class="font-bold text-lg text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/42] perspective-1000" id="aiCard"></div>
        </div>
    </div>
    <div class="w-full mt-6 px-4">
        <div class="h-3 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 transition-all duration-500" style="width: 50%;"></div>
        </div>
    </div>
    
    <div class="w-full mt-4 text-center">
        <div id="turnIndicator" class="text-sm font-bold text-amber-600 mb-2"></div>
        <div id="attributeSelection" class="text-sm text-gray-500 animate-pulse">W√§hle eine Eigenschaft...</div>
    </div>
</div>

<div id="quizModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-[100] p-4">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-sm border-4 border-orange-500 animate-pop-in">
        <div class="bg-orange-500 p-4 text-white text-center">
            <h3 class="font-black text-xl uppercase italic tracking-tighter">‚ö° STECHFRAGE ‚ö°</h3>
            <p class="text-xs opacity-90">Unentschieden! Wer zuerst richtig antwortet, gewinnt.</p>
            <div class="w-full bg-orange-900/30 h-2 rounded-full mt-3 overflow-hidden">
                <div id="quizTimerBar" class="bg-white h-full w-full"></div>
            </div>
        </div>
        <div class="p-6">
            <div id="quizQuestion" class="text-gray-800 font-extrabold text-center mb-6 leading-tight text-lg"></div>
            <div id="quizAnswers" class="grid grid-cols-1 gap-3">
                </div>
        </div>
    </div>
</div>

<div id="setupModal" class="fixed inset-0 dimmer flex flex-col items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-sm w-full p-8 text-center border-t-8 border-amber-500 relative">
        <h2 class="text-4xl font-black text-amber-600 mb-2 italic tracking-tighter">HOLZEN!</h2>
        <p class="text-gray-500 text-sm mb-8 font-medium italic">Das Holztechnik-Quartett</p>
        
        <div class="space-y-4">
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-amber-600 transition-all active:scale-95 flex items-center justify-center gap-3">
                <span class="text-2xl">ü§ñ</span> Einzelspieler
            </button>
            <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-all active:scale-95 flex items-center justify-center gap-3">
                <span class="text-2xl">üåç</span> Online-Duell
            </button>
        </div>
        <div class="mt-8 flex items-center justify-center space-x-2">
            <span class="text-gray-400 text-xs">Ton Aus</span>
            <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="soundToggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
            </label>
            <span class="text-gray-600 text-xs font-bold">Ton An</span>
        </div>
    </div>
</div>
<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
        <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg" placeholder="Name eingeben" maxlength="12">
        <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600">Starten</button>
    </div>
</div>
<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund scannen:</p>
        <div class="flex justify-center mb-4"><div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div></div>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>
<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/40 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-8 transition-transform transform translate-y-full duration-300">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 flex flex-col items-center border-t-4 border-amber-500 text-center">
        <h3 id="resultText" class="text-2xl font-black uppercase mb-1"></h3>
        <p id="resultDetails" class="text-sm text-gray-500 mb-6 font-semibold"></p>
        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-800 transition text-sm sm:text-base">üéì Info</button>
            <button id="bsNextBtn" class="flex-[2] bg-green-600 hover:bg-green-700 active:scale-95 text-white font-black py-3 px-4 rounded-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all text-sm sm:text-base">N√ÑCHSTER ZUG &rarr;</button>
        </div>
    </div>
</div>
<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center">
        <h2 id="gameOverTitle" class="text-4xl font-black mb-4 tracking-tighter italic">SPIELENDE</h2>
        <p id="gameOverText" class="text-gray-600 mb-8 font-medium"></p>
        <div class="space-y-3">
             <button onclick="window.showLeaderboard()" class="w-full bg-blue-100 text-blue-800 font-bold py-3 rounded-2xl hover:bg-blue-200">üèÜ Bestenliste</button>
             <button onclick="location.reload()" class="w-full bg-amber-500 text-white font-bold py-4 rounded-2xl shadow-lg">üîÑ Nochmal spielen</button>
        </div>
    </div>
</div>
<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">Schlie√üen</button>
    </div>
</div>
<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[80vh] flex flex-col">
        <div class="bg-amber-500 p-4 text-white font-bold flex justify-between">
            <span>Regeln & Hilfe</span>
            <button onclick="document.getElementById('gameInfoModal').classList.add('hidden')">‚úï</button>
        </div>
        <div class="p-6 overflow-y-auto text-sm space-y-4 text-gray-700">
            <p><strong>Ziel:</strong> Gewinne alle Karten deines Gegners.</p>
            <p><strong>Werte vergleichen:</strong> W√§hle den besten Wert. Bei 'Dauerhaftigkeit' und 'Quell/Schwund' gewinnt der niedrigere Wert!</p>
            <div class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded-r-lg">
                <h5 class="font-bold text-orange-800 text-sm">‚ö° Stechfrage</h5>
                <p class="text-xs text-orange-700 mt-1">Bei Unentschieden erscheint ein Blitz-Quiz. Wer zuerst richtig antwortet, gewinnt!</p>
            </div>
            <div id="infoCategoryList" class="space-y-3 pt-3"></div>
        </div>
    </div>
</div>
<div id="infoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-md max-h-[90vh] flex flex-col">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Wissenskarte</h3>
            <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto">
            </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
// === FIREBASE CONFIGURATION ===
const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = firebaseConfig.projectId;

// === SOUNDS ===
const sounds = {
    flip: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
    winRound: new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
    starWin: new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3'),
    loseRound: new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_941650c1f5.mp3'),
    winGame: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true')
};
sounds.flip.volume = 0.5;
sounds.winRound.volume = 0.6;
sounds.starWin.volume = 0.6;
sounds.loseRound.volume = 0.5;
sounds.winGame.volume = 0.4;
// Preload Sounds
Object.values(sounds).forEach(s => { s.preload = 'auto'; s.load(); });
function playSoundSecure(soundKey) {
    if(isMuted || !sounds[soundKey]) return;
    Object.values(sounds).forEach(s => { if(!s.paused) { s.pause(); s.currentTime = 0; } });
    sounds[soundKey].currentTime = 0;
    sounds[soundKey].play().catch(e => console.log("Audio Error", e));
}
// Global Vars
let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false; // Default off
let roundSoundPlayed=false;
let lastRoundWinningWoodName = null;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};
let quizActive = false, quizTimer = null;
let activeAttributeKeys = ['dk', 'haerte', 'quellenSchwindenRadial', 'dichte', 'gewicht'];
// === DATA ===
const attributeInfo={
 dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit',unit:'(DK)',logic:'Niedrig gewinnt',default:true,description:'Widerstandsf√§higkeit gegen Pilze/Insekten (Kl. 1 = sehr gut).'},
 haerte:{icon:'üíé',name:'Druckfestigkeit',unit:'(N/mm¬≤)',logic:'Hoch gewinnt',default:true,description:'Maximale Belastung vor Bruch.'},
 quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schw.',unit:'(%)',logic:'Niedrig gewinnt',default:true,description:'Ma√ü√§nderung bei Feuchte.'},
 dichte:{icon:'‚öñÔ∏è',name:'Rohdichte',unit:'(kg/m¬≥)',logic:'Hoch gewinnt',default:true,description:'Masse pro Volumen.'},
 gewicht:{icon:'üèãÔ∏è',name:'E-Modul',unit:'(N/mm¬≤)',logic:'Hoch gewinnt',default:true,description:'Steifigkeit des Holzes.'},
 growth:{icon:'üå±',name:'Wachstum',unit:'(cm/Jahr)',logic:'Hoch gewinnt',default:false,description:'H√∂henzuwachs pro Jahr.'},
 price:{icon:'üí∞',name:'Preis',unit:'(‚Ç¨/m¬≥)',logic:'Hoch gewinnt',default:false,description:'Durchschnittspreis.'},
 brennwert:{icon:'üî•',name:'Brennwert',unit:'(kWh/kg)',logic:'Hoch gewinnt',default:false,description:'Energie pro kg.'}
};
const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images";
const IMG_SUFFIX = "?raw=true";
const woodCards=[
 {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000, growth:30, price:1200, brennwert:4.2, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000, growth:40, price:800, brennwert:4.0, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000, growth:50, price:500, brennwert:4.4, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpg${IMG_SUFFIX}`},
 {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000, growth:60, price:450, brennwert:4.5, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000, growth:55, price:460, brennwert:4.4, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000, growth:45, price:700, brennwert:4.4, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000, growth:60, price:650, brennwert:4.3, imgTree:`${IMG_BASE}/birke_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500, growth:35, price:900, brennwert:4.1, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`},
 {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000, growth:40, price:850, brennwert:4.2, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpg${IMG_SUFFIX}`},
 {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500, growth:35, price:1100, brennwert:4.2, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000, growth:30, price:1800, brennwert:4.2, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000, growth:70, price:600, brennwert:4.4, imgTree:`${IMG_BASE}/douglasie_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpg${IMG_SUFFIX}`},
 {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500, growth:40, price:950, brennwert:4.5, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`},
 {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500, growth:20, price:2500, brennwert:4.3, imgTree:`${IMG_BASE}/mahagoni_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000, growth:25, price:3500, brennwert:4.2, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000, growth:100, price:300, brennwert:4.6, imgTree:`${IMG_BASE}/bambus_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/bambus_2.jpg${IMG_SUFFIX}`},
 {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000, growth:120, price:200, brennwert:4.1, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000, growth:100, price:250, brennwert:4.2, imgTree:`${IMG_BASE}/weide_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/weide_2.jpeg${IMG_SUFFIX}`},
 {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000, growth:50, price:550, brennwert:4.3, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500, growth:35, price:900, brennwert:4.1, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000, growth:40, price:750, brennwert:4.2, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000, growth:60, price:1000, brennwert:4.3, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpg${IMG_SUFFIX}`},
 {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000, growth:45, price:580, brennwert:4.4, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 {name:"Erle",dk:5,haerte:30,quellenSchwindenRadial:4.4,dichte:530,gewicht:9700, growth:60, price:520, brennwert:4.1, imgTree:`https://github.com/aufdemholzweg/holzquartett/blob/main/images/erle_1.jpeg?raw=true`, imgCross:`https://github.com/aufdemholzweg/holzquartett/blob/main/images/erle_2.jpeg?raw=true`},
 {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500, growth:80, price:1100, brennwert:4.5, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000, growth:30, price:950, brennwert:4.3, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000, growth:20, price:3200, brennwert:4.3, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000, growth:25, price:2200, brennwert:4.2, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000, growth:15, price:4500, brennwert:4.3, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500, growth:10, price:8000, brennwert:4.4, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`}
];

const woodInfo = {
    "Eiche": { info: "Die Eiche z√§hlt zu den bedeutendsten heimischen Laubh√∂lzern Europas...", bildBaum: `${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}` },
    "Buche": { info: "Die Buche ist ein gleichm√§√üig strukturiertes Hartholz...", bildBaum: `${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}` },
    "Kiefer": { info: "Kiefer ist ein weit verbreitetes Nadelholz...", bildBaum: `${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/kiefer_2.jpg${IMG_SUFFIX}` },
    "Fichte": { info: "Fichte ist ein klassisches Bauholz...", bildBaum: `${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}` },
    "Tanne": { info: "Tanne ist ein harzarmes Nadelholz...", bildBaum: `${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}` },
    "L√§rche": { info: "L√§rche ist bekannt f√ºr nat√ºrliche Witterungsbest√§ndigkeit...", bildBaum: `${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}` },
    "Birke": { info: "Birke ist ein helles, dekoratives Holz...", bildBaum: `${IMG_BASE}/birke_1.jpg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}` },
    "Ahorn": { info: "Ahorn ist hart, hell und elegant...", bildBaum: `${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}` },
    "Esche": { info: "Esche ist besonders z√§h und elastisch...", bildBaum: `${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/esche_2.jpg${IMG_SUFFIX}` },
    "Kirsche": { info: "Kirschbaumholz besitzt warme rote T√∂ne...", bildBaum: `${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}` },
    "Nussbaum": { info: "Nussbaumholz ist dunkel und dekorativ...", bildBaum: `${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}` },
    "Douglasie": { info: "Douglasie ist robust und witterungsbest√§ndig...", bildBaum: `${IMG_BASE}/douglasie_1.jpg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/douglasie_2.jpg${IMG_SUFFIX}` },
    "Zeder": { info: "Zeder duftet angenehm und ist resistent...", bildBaum: `${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}` },
    "Mahagoni": { info: "Mahagoni ist ein tropisches Edelholz...", bildBaum: `${IMG_BASE}/mahagoni_1.jpg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}` },
    "Teak": { info: "Teak ist extrem witterungsbest√§ndig...", bildBaum: `${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}` },
    "Bambus": { info: "Bambus ist botanisch ein Gras...", bildBaum: `${IMG_BASE}/bambus_1.jpg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/bambus_2.jpg${IMG_SUFFIX}` },
    "Pappel": { info: "Pappel ist sehr leicht und weich...", bildBaum: `${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}` },
    "Weide": { info: "Weide ist elastisch und biegsam...", bildBaum: `${IMG_BASE}/weide_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/weide_2.jpeg${IMG_SUFFIX}` },
    "Linde": { info: "Linde ist weich und gut schnitzbar...", bildBaum: `${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}` },
    "Ulme": { info: "Ulme ist z√§h und hat markante Poren...", bildBaum: `${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}` },
    "Kastanie": { info: "Kastanie ist wetterbest√§ndig...", bildBaum: `${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}` },
    "Robinie": { info: "Robinie ist extrem hart und dauerhaft...", bildBaum: `${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/robinie_2.jpg${IMG_SUFFIX}` },
    "Hemlock": { info: "Hemlock ist ein feines Nadelholz...", bildBaum: `${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}` },
    "Erle": { info: "Erle ist unter Wasser extrem dauerhaft...", bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/erle_1.jpeg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/erle_2.jpeg?raw=true" },
    "Redwood": { info: "Redwood ist leicht und dauerhaft...", bildBaum: `${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}` },
    "Hickory": { info: "Hickory ist extrem z√§h...", bildBaum: `${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}` },
    "Wenge": { info: "Wenge ist dunkel und hart...", bildBaum: `${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}` },
    "Zebrano": { info: "Zebrano hat eine markante Streifenoptik...", bildBaum: `${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}` },
    "Palisander": { info: "Palisander ist dekorativ und fest...", bildBaum: `${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}` },
    "Ebenholz": { info: "Ebenholz ist tiefschwarz und sehr dicht...", bildBaum: `${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, bildQuerschnitt: `${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}` }
};

// 20 Spezialfragen f√ºr Unentschieden
const specialQuestions = [
    { q: "Welches Holz verf√§rbt sich bei Kontakt mit Eisen schwarz?", a: "Eiche", w: ["Fichte", "Kiefer", "Buche"] },
    { q: "Welches Holz wurde f√ºr die Gr√ºndungspf√§hle Venedigs verwendet?", a: "Erle", w: ["L√§rche", "Esche", "Pappel"] },
    { q: "Welches 'Holz' ist botanisch gesehen eigentlich ein Gras?", a: "Bambus", w: ["Teak", "Wenge", "Zeder"] },
    { q: "Welches Holz ist extrem z√§h und ideal f√ºr Werkzeugstiele?", a: "Hickory", w: ["Tanne", "Linde", "Birke"] },
    { q: "Welches Holz wirkt durch hohen √ñlgehalt wasserabweisend?", a: "Teak", w: ["Ahorn", "Buche", "Esche"] },
    { q: "Welches helle Holz wird bevorzugt f√ºr Geigendecken genutzt?", a: "Fichte", w: ["Eiche", "Nussbaum", "Kirsche"] },
    { q: "Welches Holz hat den st√§rksten Hell-Dunkel-Kontrast (Splint/Kern)?", a: "Nussbaum", w: ["Ahorn", "Birke", "Buche"] },
    { q: "Welches Holz ist eines der h√§rtesten europ√§ischen H√∂lzer?", a: "Robinie", w: ["Pappel", "Weide", "Linde"] },
    { q: "Welches Holz wird oft f√ºr Bleistifte verwendet?", a: "Zeder", w: ["Eiche", "Buche", "Hickory"] },
    { q: "Was bedeutet 'Dauerhaftigkeitsklasse 1'?", a: "Sehr dauerhaft", w: ["Nicht dauerhaft", "Mittelm√§√üig", "Nur f√ºr Innen"] },
    { q: "Welches Holz ist extrem leicht und wird f√ºr Streichh√∂lzer genutzt?", a: "Pappel", w: ["Eiche", "Esche", "Bambus"] },
    { q: "Welches Holz bekommt im Alter eine r√∂tlich-braune Patina?", a: "Kirsche", w: ["Esche", "Ahorn", "Fichte"] },
    { q: "Welches Holz ist sehr elastisch und wurde f√ºr B√∂gen genutzt?", a: "Esche", w: ["Eiche", "Buche", "Pappel"] },
    { q: "Welches Tropenholz ist fast tiefschwarz?", a: "Ebenholz", w: ["Teak", "Bambus", "Mahagoni"] },
    { q: "Welches Nadelholz hat die deutlichsten Jahresringe?", a: "L√§rche", w: ["Tanne", "Zypresse", "Hemlock"] },
    { q: "Welches Holz riecht intensiv nach √§therischen √ñlen?", a: "Zeder", w: ["Buche", "Erle", "Eiche"] },
    { q: "Welches Holz splittert kaum und wird f√ºr Saunab√§nke genutzt?", a: "Abachi", w: ["Eiche", "Kiefer", "Esche"] },
    { q: "Welches Holz wird f√ºr klassische Hobelk√∂rper verwendet?", a: "Wei√übuche", w: ["Fichte", "Pappel", "L√§rche"] },
    { q: "Wie nennt man das junge, helle Holz unter der Rinde?", a: "Splintholz", w: ["Kernholz", "Mark", "Fr√ºhholz"] },
    { q: "Was ist der Hauptbestandteil von Holz?", a: "Zellulose", w: ["Kalk", "Metall", "Stickstoff"] }
];

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

// === ATTRIBUTE CONFIG FUNCTIONS ===
window.openAttrConfig = () => {
 const list = document.getElementById('attrConfigList');
 list.innerHTML = '';
 Object.keys(attributeInfo).forEach(key => {
     const info = attributeInfo[key];
     const isSelected = activeAttributeKeys.includes(key);
     const div = document.createElement('div');
     div.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
     div.onclick = () => toggleAttribute(key, div);
     div.innerHTML = `
         <div class="flex items-center gap-3">
             <span class="text-xl">${info.icon}</span>
             <div class="text-left leading-tight">
                 <div class="font-bold text-sm">${info.name}</div>
                 <div class="text-[10px] opacity-70">${info.unit}</div>
             </div>
         </div>
         <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}">
             ${isSelected ? '‚úì' : ''}
         </div>
     `;
     list.appendChild(div);
 });
 document.getElementById('attrConfigModal').classList.remove('hidden');
};
function toggleAttribute(key, el) {
 const idx = activeAttributeKeys.indexOf(key);
 if (idx > -1) {
     if(activeAttributeKeys.length <= 3) { alert("Mindestens 3 Eigenschaften m√ºssen aktiv sein!"); return; }
     activeAttributeKeys.splice(idx, 1);
 } else {
     activeAttributeKeys.push(key);
 }
 const isSelected = activeAttributeKeys.includes(key);
 el.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
 el.querySelector('.w-6').className = `w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}`;
 el.querySelector('.w-6').innerHTML = isSelected ? '‚úì' : '';
 document.getElementById('attrCountBadge').innerText = activeAttributeKeys.length;
}

// === CORE UI FUNCTIONS ===
function updateStatusBar(p, o){
 const total=p+o; const pct=(total===0)?50:(p/total)*100;
 const bar=document.getElementById('statusBar');
 bar.style.width=`${pct}%`;
}
function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

function createCard(data, isRevealed, isPlayer, isActive, highlightAttr){
 const card = document.createElement('div');
 card.className = `card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''}`;
 if(!isRevealed) card.classList.add('card-flipped');
 if(isPlayer) { card.setAttribute('role', 'button'); card.setAttribute('tabindex', '0'); }
 const canSelect = isPlayer && ((gameMode==='ai' && aiGame.turn==='player' && !aiGame.roundInProgress) || (gameMode==='multiplayer' && localGameState.turn===localPlayerId && !localGameState.lastResult));
 
 const front = document.createElement('div');
 const bClass = isActive ? 'border-orange-500 ring-4 ring-orange-200' : 'border-orange-200';
 front.className = `card-front card-front-bg rounded-2xl shadow-lg border-4 ${bClass} flex flex-col transition-all`;
 let html = `<div class="pt-3 px-3 pb-1"><h2 class="text-lg sm:text-xl font-bold text-amber-900 leading-none">${data.name}</h2></div>
                 <div class="mx-3 mt-1 mb-2 aspect-[4/3] rounded-xl overflow-hidden bg-white shadow-sm border border-orange-100">
                     <img src="${data.imgTree}" class="w-full h-full object-cover">
                 </div>
                 <div class="flex-grow flex flex-col justify-start gap-1 sm:gap-2 px-2 pb-2 overflow-y-auto hide-scrollbar">`;
 
 for(const k of activeAttributeKeys){
     const info = attributeInfo[k];
     let flashClass = '';
     if(highlightAttr === k) flashClass = isActive ? 'flash-active' : 'highlight-compare';
     
     const rowInner = `<div class="flex items-center gap-2"><span class="text-base">${info.icon}</span><div class="flex flex-col text-left leading-none"><span class="font-bold text-gray-800 text-[10px] sm:text-sm">${info.name}</span><span class="text-[9px] text-gray-500 font-medium">${info.unit}</span></div></div><span class="text-sm font-bold text-amber-800">${data[k]}</span>`;
     if(canSelect) html += `<div onclick="window.selectAttribute('${k}')" data-attr-btn="${k}" class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl cursor-pointer hover:brightness-95 ${flashClass}">${rowInner}</div>`;
     else html += `<div class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl opacity-90 ${flashClass}" data-attr-row="${k}">${rowInner}</div>`;
 }
 html += '</div>';
 front.innerHTML = html;
 const back = document.createElement('div');
 back.className = `card-back rounded-2xl shadow-lg relative ${isActive ? 'border-orange-500' : 'border-white'}`;
 if(!isPlayer && isOpponentNameBackVisible()){
     const lbl = document.createElement('div'); lbl.className = 'opponent-back-name'; lbl.innerText = data.name; back.appendChild(lbl);
 }
 card.appendChild(front); card.appendChild(back);
 return card;
}

function updateDisplayAI(){
 const pc=aiGame.playerCards.length; const ac=aiGame.aiCards.length;
 document.getElementById('playerCards').innerText=pc; document.getElementById('aiCards').innerText=ac;
 updateStatusBar(pc,ac);
 const pcEl=document.getElementById('playerCard'); pcEl.innerHTML='';
 const acEl=document.getElementById('aiCard'); acEl.innerHTML='';
 const isPTurn = aiGame.turn === 'player';
 
 if(aiGame.currentPlayerCard) pcEl.appendChild(createCard(aiGame.currentPlayerCard, true, true, isPTurn, null));
 if(aiGame.currentAiCard) acEl.appendChild(createCard(aiGame.currentAiCard, false, false, !isPTurn, null));
 
 if(aiGame.turn==='ai' && !aiGame.roundInProgress) setTimeout(aiTurn, 1000);
}

function evaluateRoundAI(attr){
 const pv=aiGame.currentPlayerCard[attr]; const av=aiGame.currentAiCard[attr];
 const logic = attributeInfo[attr].logic;
 let pWins = (logic === 'Niedrig gewinnt') ? (pv < av) : (pv > av);
 if(pv === av) pWins = 'tie';
 const resText = pWins===true ? 'Du gewinnst!' : (pWins===false ? 'Computer gewinnt!' : 'Unentschieden');
 const resColor = pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-gray-600');
 
 document.getElementById('resultText').innerText = resText;
 document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
 document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${pv} vs ${av}`;
 
 if(pWins===true) { 
     playSoundSecure('winRound'); 
     triggerStarAnimation();
     showHappyWorm(); 
     lastRoundWinningWoodName = aiGame.currentPlayerCard.name; 
 } 
 else if (pWins===false) { 
     playSoundSecure('loseRound');
     lastRoundWinningWoodName = aiGame.currentAiCard.name; 
 } 
 else { 
     // TIE -> STECHFRAGE
     // Hier nicht sofort Karten verschieben! Erst Quiz abwarten.
     closeBottomSheet();
     triggerTieQuiz(); 
     return;
 }
 
 openBottomSheet(resText);
 const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
 if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
 else if(pWins===false){ aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }
 
 if(aiGame.playerCards.length===0) window.endGame("Computer");
 if(aiGame.aiCards.length===0) window.endGame(aiGame.playerName);
}

function aiTurn(){
 if(aiGame.roundInProgress) return;
 const k=activeAttributeKeys[Math.floor(Math.random()*activeAttributeKeys.length)];
 aiGame.roundInProgress = true;
 const aiCardEl = document.getElementById('aiCard');
 const row = aiCardEl.querySelector(`div[data-attr-row="${k}"]`);
 if(row) row.classList.add('flash-active'); 
 setTimeout(() => { 
     const ac=document.getElementById('aiCard').querySelector('.card-3d');
     if(ac){ ac.classList.remove('card-flipped'); playSoundSecure('flip'); }
     const playerCardEl = document.getElementById('playerCard');
     const pRow = playerCardEl.querySelector(`div[data-attr-btn="${k}"]`) || playerCardEl.querySelector(`div[data-attr-row="${k}"]`);
     if(pRow) pRow.classList.add('highlight-compare');
     setTimeout(() => evaluateRoundAI(k), 2000);
 }, 500);
}

// === TIE QUIZ LOGIC ===
function triggerTieQuiz() {
    quizActive = true;
    const q = specialQuestions[Math.floor(Math.random() * specialQuestions.length)];
    const modal = document.getElementById('quizModal');
    document.getElementById('quizQuestion').innerText = q.q;
    const aEl = document.getElementById('quizAnswers');
    aEl.innerHTML = '';
    
    const ans = shuffleArray([q.a, ...q.w]);
    ans.forEach(a => {
        const btn = document.createElement('button');
        btn.className = "w-full py-4 px-4 bg-gray-100 hover:bg-orange-100 border-2 border-gray-200 rounded-2xl font-bold transition-all active:scale-95 text-sm text-left";
        btn.innerText = a;
        btn.onclick = () => submitQuizAnswer(a, q.a, 'player');
        aEl.appendChild(btn);
    });
    
    modal.classList.remove('hidden');
    let timeLeft = 10;
    const bar = document.getElementById('quizTimerBar');
    bar.style.width = "100%";
    
    quizTimer = setInterval(() => {
        timeLeft--;
        bar.style.width = (timeLeft * 10) + "%";
        if(timeLeft <= 0) {
            clearInterval(quizTimer);
            if(quizActive) submitQuizAnswer(null, q.a, 'ai');
        }
    }, 1000);
    // AI Simulation
    if(gameMode === 'ai') {
        const aiTime = 3000 + Math.random() * 5000;
        setTimeout(() => {
            if(quizActive) {
                const aiCorrect = Math.random() > 0.3; // 70% chance correct
                submitQuizAnswer(aiCorrect ? q.a : "Falsch", q.a, 'ai');
            }
        }, aiTime);
    }
}

function submitQuizAnswer(given, correct, who) {
    if(!quizActive) return;
    quizActive = false;
    clearInterval(quizTimer);
    document.getElementById('quizModal').classList.add('hidden');
    
    // FIX: SPIELSTATUS WIEDER FREIGEBEN!
    aiGame.roundInProgress = false; 
    
    let winner = 'ai';
    let msg = "";
    
    if(who === 'player') {
        if(given === correct) {
            winner = 'player';
            msg = "Blitzschnell & Richtig! Du gewinnst die Karten.";
        } else {
            winner = 'ai';
            msg = "Leider falsch! Die Karten gehen an den Gegner.";
        }
    } else { // AI
        if(given === correct) {
            winner = 'ai';
            msg = "Der Computer war schneller!";
        } else {
            winner = 'player';
            msg = "Der Computer lag falsch! Du gewinnst.";
        }
    }
    
    const pCard = aiGame.playerCards.shift();
    const aCard = aiGame.aiCards.shift();
    
    let title = "";
    let color = "";
    if(winner === 'player') {
        title = "Du gewinnst das Quiz!";
        color = "text-green-600";
        aiGame.playerCards.push(pCard, aCard);
        aiGame.turn = 'player';
        playSoundSecure('winRound');
        triggerStarAnimation();
        showHappyWorm();
    } else {
        title = "Computer gewinnt Quiz!";
        color = "text-red-600";
        aiGame.aiCards.push(aCard, pCard);
        aiGame.turn = 'ai';
        playSoundSecure('loseRound');
    }
    
    aiGame.currentPlayerCard = aiGame.playerCards[0] || null;
    aiGame.currentAiCard = aiGame.aiCards[0] || null;
    document.getElementById('resultText').innerText = title;
    document.getElementById('resultText').className = `text-2xl font-black uppercase mb-1 ${color}`;
    document.getElementById('resultDetails').innerText = msg + ` (L√∂sung: ${correct})`;
    
    document.getElementById('bottomSheet').classList.remove('translate-y-full');
    document.getElementById('bottomSheet').classList.remove('hidden');
    document.getElementById('bottomSheetBackdrop').classList.remove('hidden');
    if(aiGame.playerCards.length===0) window.endGame("Computer");
    if(aiGame.aiCards.length===0) window.endGame(aiGame.playerName);
    updateDisplayAI();
}

// Multiplayer Functions
function listenToGameChanges(){
 if(!gameId) return;
 unsubscribeGame=onSnapshot(getPublicDataRef("games", gameId),(ds)=>{
     if(!ds.exists()) { window.resetGame(); return; }
     const gd=ds.data(); localGameState=gd;
     if(gd.status==='playing'||gd.status==='finished'){
         document.getElementById('multiplayerLobbyModal').classList.add('hidden');
         document.getElementById('gameContainer').classList.remove('hidden');
         scrollToTop();
         
         const oppId=gd.playerIds.find(id=>id!==localPlayerId);
         document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
         document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
         const pCount = gd.players[localPlayerId]?.cards?.length||0;
         const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
         document.getElementById('playerCards').innerText = pCount;
         document.getElementById('aiCards').innerText = oCount;
         updateStatusBar(pCount, oCount);
         
         const highlightAttr = gd.lastResult ? gd.lastResult.attribute : null;
         const pc = document.getElementById('playerCard'); const ac = document.getElementById('aiCard');
         pc.innerHTML=''; ac.innerHTML='';
         const isPlayerTurn = gd.turn === localPlayerId;
         if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true, isPlayerTurn, highlightAttr));
         
         if(oppId && gd.currentCards[oppId]){
             const c = createCard(gd.currentCards[oppId], false, false, !isPlayerTurn, highlightAttr);
             ac.appendChild(c);
             if(gd.lastResult){
                 setTimeout(()=> { c.classList.remove('card-flipped'); playSoundSecure('flip'); }, 100);
             }
         } else {
             ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte auf Gegner-Karte...</div>`;
         }
         
         if(gd.lastResult){
              const wId = gd.lastResult.winnerId;
              const iWin = wId===localPlayerId;
              
              if(wId === 'tie') {
                  lastRoundWinningWoodName = gd.currentCards[localPlayerId].name;
                  // For MP, we keep simple tie handling to avoid complex sync issues with quiz for now
              } else if (gd.currentCards[wId]) {
                  lastRoundWinningWoodName = gd.currentCards[wId].name;
              }
              if(!roundSoundPlayed) {
                  if(iWin) { playSoundSecure('winRound'); triggerStarAnimation(); }
                  else if(wId !== 'tie') playSoundSecure('loseRound');
              }
              roundSoundPlayed=true;
              
              const resText = iWin ? 'Du gewinnst!' : (wId==='tie'?'Unentschieden':'Gegner gewinnt!');
              document.getElementById('resultText').className = iWin ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
              document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
              if(iWin) showHappyWorm();
              if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(resText);
         } else {
              roundSoundPlayed=false; closeBottomSheet();
         }
         document.getElementById('turnIndicator').innerText = (gd.turn===localPlayerId) ? "Du bist am Zug!" : "Gegner w√§hlt...";
         if(gd.status==='finished'){
             let winnerName = "";
             if (gd.players[localPlayerId].cards.length > 0) winnerName = gd.players[localPlayerId].name;
             else if (oppId && gd.players[oppId].cards.length > 0) winnerName = gd.players[oppId].name;
             window.endGame(winnerName);
         }
     }
 });
}
window.selectAttribute = async (attr) => {
 if(gameMode==='ai') {
     if(aiGame.roundInProgress) return;
     aiGame.roundInProgress = true;
     const btn = document.querySelector(`div[data-attr-btn="${attr}"]`); if(btn) btn.classList.add('flash-active');
     setTimeout(() => {
         const ac=document.getElementById('aiCard').querySelector('.card-3d');
         if(ac){ ac.classList.remove('card-flipped'); playSoundSecure('flip'); }
         const oppRow = document.getElementById('aiCard').querySelector(`div[data-attr-row="${attr}"]`);
         if(oppRow) oppRow.classList.add('highlight-compare');
         setTimeout(() => evaluateRoundAI(attr), 2000);
     }, 500);
 } else {
     if(!localGameState || localGameState.turn!==localPlayerId) return;
     const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
     const pv = localGameState.currentCards[localPlayerId][attr];
     const ov = localGameState.currentCards[opp][attr];
     const logic = attributeInfo[attr].logic;
     let pWins = (logic === 'Niedrig gewinnt') ? (pv < ov) : (pv > ov);
     if(pv === ov) pWins = 'tie';
     const winner = pWins==='tie' ? 'tie' : (pWins ? localPlayerId : opp);
     await updateDoc(getPublicDataRef("games", gameId),{
         lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:pv, [opp]:ov}}
     });
 }
};
window.startGameAI = (name) => {
    trackEvent('games_ai');
    gameMode='ai'; aiGame.playerName=name;
    window.setNavState('game');
    document.getElementById('playerNameDisplay').innerText=name;
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
    document.getElementById('gameContainer').classList.remove('hidden');
    scrollToTop(); 
    updateDisplayAI();
};
let authRetries = 0;
window.createGame = async (playerName) => {
    if (!auth || !auth.currentUser) { 
        if(authRetries > 10) { alert("Verbindungsfehler"); return; }
        authRetries++; setTimeout(() => window.createGame(playerName), 500); return; 
    }
    localPlayerId = auth.currentUser.uid;
    trackEvent('games_multiplayer');
    gameMode='multiplayer';
    const lobby=document.getElementById('multiplayerLobbyModal'); lobby.classList.remove('hidden');
    gameId=Math.random().toString(36).substring(2,8).toUpperCase();
    const joinUrl=`${window.location.href.split('?')[0]}?game=${gameId}`;
    document.getElementById('shareLink').value=joinUrl;
    
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {text: joinUrl, width: 128, height: 128});
    
    await setDoc(getPublicDataRef("games", gameId),{
        gameId, status:'waiting', playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
        createdAt:serverTimestamp()
    });
    listenToGameChanges();
};
window.joinGame = async (id, playerName) => {
    if (!auth || !auth.currentUser) { setTimeout(()=>window.joinGame(id,playerName), 500); return; }
    localPlayerId = auth.currentUser.uid;
    gameMode='multiplayer'; gameId = id;
    const ref = getPublicDataRef("games", id);
    const snap = await getDoc(ref);
    if(snap.exists() && snap.data().status==='waiting'){
        document.getElementById('lobbyTitle').textContent="Verbinde...";
        document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
        const sh=shuffleArray([...woodCards]);
        const p1=snap.data().playerIds[0];
        
        await updateDoc(ref,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:sh.slice(15,30),status:'online'},
            [`players.${p1}.cards`]:sh.slice(0,15),
            turn:p1, currentCards:{[p1]:sh.slice(0,15)[0],[localPlayerId]:sh.slice(15,30)[0]},
            lastResult:null
        });
        scrollToTop(); 
        window.setNavState('game');
        listenToGameChanges();
    } else {
        alert("Spiel nicht gefunden oder voll.");
        window.location.href = window.location.href.split('?')[0];
    }
};
window.nextRound = async () => {
    scrollToTop(); 
    if(gameMode==='ai'){
        aiGame.currentPlayerCard=aiGame.playerCards[0];
        aiGame.currentAiCard=aiGame.aiCards[0];
        aiGame.roundInProgress=false;
        updateDisplayAI();
    } else {
        const gs = localGameState;
        const [p1,p2] = gs.playerIds;
        let c1=gs.players[p1].cards.shift();
        let c2=gs.players[p2].cards.shift();
        const w = gs.lastResult.winnerId;
        
        if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
        else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        
        if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
            await updateDoc(getPublicDataRef("games", gameId), {status:'finished', players:gs.players});
            return;
        }
        const nextT = w==='tie' ? gs.turn : w;
        await updateDoc(getPublicDataRef("games", gameId), {
            lastResult:null, turn:nextT, players:gs.players,
            currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
        });
    }
};
window.showFinalWinScreen = () => {
    document.getElementById('reflectionModal').classList.add('hidden');
};
const calculateRank = (count) => {
    if (count >= 100) return { title: "Leim-Legende", stars: 6 };
    if (count >= 50) return { title: "Astloch-Philosoph", stars: 5 };
    if (count >= 30) return { title: "Brett-Bezwinger", stars: 4 };
    if (count >= 20) return { title: "Hobel-Held", stars: 3 };
    if (count >= 10) return { title: "Schleifklotz-Schwinger", stars: 2 };
    return { title: "Werkstatt-Neuling", stars: 1 };
};
async function updateMainMenuStats(user) {
    if (!user) return;
    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'gamification', 'stats');
    try {
        const snap = await getDoc(statsRef);
        const count = snap.exists() ? (snap.data().gamesPlayed || 0) : 0;
        const rank = calculateRank(count);
        
        const container = document.getElementById('mainMenuStats');
        if(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center gap-1">
                    <div class="text-xs text-white/80 font-bold uppercase tracking-wider">Dein Rang</div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-bold text-white drop-shadow-md">${rank.title}</span>
                        <div class="flex text-amber-400 text-sm drop-shadow-sm">${Array(rank.stars).fill('‚òÖ').join('')}</div>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-lg filter drop-shadow">üî•</span>
                        <span class="font-bold text-white text-lg drop-shadow-md">${count} Spiele</span>
                    </div>
                </div>
            `;
            container.classList.remove('hidden');
        }
    } catch (e) { console.error("Stats load error", e); }
}
onAuthStateChanged(auth, (user) => { if (user) updateMainMenuStats(user); });
async function updateLeaderboard(name) {
    if (!auth.currentUser) return;
    const ref = getPublicDataRef("leaderboard", auth.currentUser.uid);
    try { await setDoc(ref, { name: name, wins: increment(1), last_win: serverTimestamp() }, { merge: true }); } catch (e) { console.error(e); }
}
window.endGame = async (winnerName) => {
    document.getElementById('gameContainer').classList.add('hidden');
    document.getElementById('bottomSheet').classList.add('hidden');
    document.getElementById('bottomSheetBackdrop').classList.add('hidden');
    document.getElementById('reflectionModal').classList.add('hidden'); // Ensure hidden
    const isWin = (winnerName === (gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name));
    
    let newGamesCount = 0;
    let rankData = null;
    
    if (auth.currentUser) {
        const statsRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'gamification', 'stats');
        try {
            await setDoc(statsRef, { gamesPlayed: increment(1), lastPlayed: serverTimestamp() }, { merge: true });
            const snap = await getDoc(statsRef);
            newGamesCount = snap.data().gamesPlayed || 0;
            rankData = calculateRank(newGamesCount);
        } catch (e) { console.error(e); }
        if (isWin) {
            const playerName = gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name;
            await updateLeaderboard(playerName);
        }
    }
    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    
    if (isWin) {
        title.innerText = "GEWONNEN!";
        title.className = "text-3xl font-black mb-2 text-green-600";
        text.innerHTML = `Herzlichen Gl√ºckwunsch! Du hast gewonnen.<br><br>
                          <div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg">
                            <span class="text-2xl">üî•</span> ${newGamesCount} Flammen gesammelt
                          </div>
                          <div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
        playSoundSecure('winGame');
        triggerConfetti();
    } else {
        title.innerText = "VERLOREN";
        title.className = "text-3xl font-black mb-2 text-gray-600";
        text.innerHTML = `Schade, ${winnerName} hat gewonnen.<br>Dranbleiben lohnt sich!<br><br>
                          <div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg">
                            <span class="text-2xl">üî•</span> ${newGamesCount} Flammen gesammelt
                          </div>
                          <div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
        playSoundSecure('loseRound');
    }
    
    document.getElementById('gameOverModal').classList.remove('hidden');
};
window.showLeaderboard = async () => { 
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    try {
        const q=query(getPublicDataRef("leaderboard"), orderBy("wins","desc"), limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine Eintr√§ge</div>'; return; }
        list.innerHTML = snap.docs.map((d,i)=>`<div class="flex justify-between p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100"><span class="font-bold text-gray-700">${i+1}. ${d.data().name}</span><span class="font-bold text-amber-600">${d.data().wins} üèÜ</span></div>`).join('');
    } catch(e){ list.innerHTML='<div class="text-center text-red-400 text-sm">Fehler beim Laden</div>'; console.error(e); }
};
window.showNamePrompt = (mode) => {
    document.getElementById('setupModal').classList.add('hidden');
    document.getElementById('nameModal').classList.remove('hidden');
    const btn=document.getElementById('nameSubmitButton');
    const clone=btn.cloneNode(true);
    btn.parentNode.replaceChild(clone,btn);
    clone.addEventListener('click',()=>{
        const n=document.getElementById('playerName').value.trim();
        if(!n)return;
        document.getElementById('nameModal').classList.add('hidden');
        if(mode==='ai') window.startGameAI(n);
        else if(mode==='multiplayer') window.createGame(n); 
    });
};
window.copyShareLink = () => { const l=document.getElementById('shareLink'); l.select(); try { document.execCommand('copy'); } catch(e){} };
window.showGameInfo = () => {
    const list = document.getElementById('infoCategoryList');
    if (!list) return;
    let html = '';
    for (const key in attributeInfo) {
        const info = attributeInfo[key];
        const isBetter = info.logic === 'Hoch gewinnt';
        html += `<div class="p-3 rounded-xl border-2 ${isBetter ? 'border-green-400 bg-green-50' : 'border-blue-400/80 bg-blue-50/50'} mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-lg font-bold text-gray-800">${info.icon} ${info.name}</span>
                        <span class="text-sm font-semibold ${isBetter ? 'text-green-700' : 'text-blue-700'}">${isBetter ? '‚¨Ü Hoch' : '‚¨á Niedrig'}</span>
                    </div>
                    <p class="text-xs text-gray-700 leading-snug">${info.description || ''}</p>
                 </div>`;
    }
    list.innerHTML = html;
    document.getElementById('gameInfoModal').classList.remove('hidden');
}
window.closeInfoModal = () => document.getElementById('infoModal').classList.add('hidden');
window.closeLeaderboard = () => { document.getElementById('leaderboardModal').classList.add('hidden'); document.getElementById('gameOverModal').classList.remove('hidden'); };
window.resetGame = () => location.reload();
function closeBottomSheet(){ const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bs.classList.add('translate-y-full'); bd.classList.add('opacity-0'); setTimeout(()=>{bs.classList.add('hidden');bd.classList.add('hidden');},300); }
function openBottomSheet(title){ if(title)document.getElementById('resultText').innerText=title; const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bd.classList.remove('hidden'); bs.classList.remove('hidden'); setTimeout(()=>{bd.classList.remove('opacity-0'); bs.classList.remove('translate-y-full');},10); }
document.getElementById('bsNextBtn').addEventListener('click',()=> { closeBottomSheet(); window.nextRound(); });
// Settings Listeners
const soundToggle = document.getElementById('soundToggle');
if(soundToggle) { 
    const saved = localStorage.getItem('holzquartett_isMuted');
    isMuted = saved === 'true'; // Default true/muted
    soundToggle.checked = !isMuted; 
    soundToggle.addEventListener('change', function() { 
        isMuted = !this.checked; 
        localStorage.setItem('holzquartett_isMuted', isMuted);
        
        // UNLOCK SOUNDS ON UNMUTE
        if(!isMuted) {
             Object.values(sounds).forEach(s => {
                 const p = s.play();
                 if(p !== undefined) { p.then(()=> { s.pause(); s.currentTime=0; }).catch(e=>{}); }
             });
             playSoundSecure('winRound'); // Feedback
        }
    }); 
}
const revealToggle = document.getElementById('revealBackToggle');
if(revealToggle) { revealToggle.checked = isOpponentNameBackVisible(); revealToggle.addEventListener('change', function() { setOpponentNameBackVisible(this.checked); if(gameMode === 'ai' && !document.getElementById('gameContainer').classList.contains('hidden')) updateDisplayAI(); }); }

document.getElementById('bsInfoBtn').addEventListener('click', ()=>{ 
    const wood = lastRoundWinningWoodName || (aiGame.currentPlayerCard ? aiGame.currentPlayerCard.name : "Eiche");
    
    // FIX: Korrekter Zugriff auf woodInfo
    const woodData = woodInfo[wood];
    const content = (woodData && woodData.info) ? woodData.info : `<p>Keine Detailinfo zu ${wood}</p>`;
    
    const modalContent = document.getElementById('infoModalContent');
    modalContent.innerHTML = `<h4 class="font-bold text-xl mb-2">${wood}</h4>` + content;
    
    const cardData = woodCards.find(c=>c.name===wood);
    if(cardData) {
        const img1 = cardData.imgTree || 'https://placehold.co/400x300?text=Bild+fehlt';
        const img2 = cardData.imgCross || 'https://placehold.co/400x300?text=Detail+fehlt';
        
        modalContent.innerHTML += `
            <div class="grid grid-cols-2 gap-3 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Maserung</p>
                    <img src="${img1}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Detailansicht</p>
                    <img src="${img2}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                </div>
            </div>`;
    }
    const aiSection = document.createElement('div');
    aiSection.className = "mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl";
    aiSection.innerHTML = `
        <h5 class="font-bold text-amber-800 text-sm mb-2 flex items-center gap-2">ü§ñ Experten-Wissen (KI)</h5>
        <div id="aiOutput" class="ai-chat-bubble text-gray-700 bg-white shadow-sm min-h-[40px] text-sm">
            Stelle eine fachliche Frage zu ${wood} oder nutze die Vorschl√§ge.
        </div>
        <div class="flex gap-2 mt-3 overflow-x-auto pb-1 hide-scrollbar">
            <button class="bg-white border border-amber-300 text-amber-800 text-xs px-3 py-1 rounded-full whitespace-nowrap hover:bg-amber-100 transition" onclick="window.triggerAiQuestion('${wood}', 'Nenne eine konkrete, fachgerechte Projektidee f√ºr dieses Holz mit einem kurzen Hinweis zur Konstruktion.')">üî® Verwendung & Projekte</button>
            <button class="bg-white border border-amber-300 text-amber-800 text-xs px-3 py-1 rounded-full whitespace-nowrap hover:bg-amber-100 transition" onclick="window.triggerAiQuestion('${wood}', 'Nenne ein interessantes, wenig bekanntes fachliches oder historisches Detail zu diesem Holz (Trivia).')">üí° Besonderheiten</button>
            <button class="bg-white border border-amber-300 text-amber-800 text-xs px-3 py-1 rounded-full whitespace-nowrap hover:bg-amber-100 transition" onclick="window.triggerAiQuestion('${wood}', 'Wo w√§chst dieses Holz haupts√§chlich und was sind die botanischen Besonderheiten?')">üåç Vorkommen & Botanik</button>
        </div>
        <div class="flex gap-2 mt-2">
            <input type="text" id="aiInput" class="flex-grow text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Eigene Frage (z.B. Bearbeitung)...">
            <button id="aiSendBtn" class="bg-amber-600 text-white p-2 rounded-lg hover:bg-amber-700 transition" onclick="window.triggerAiCustom('${wood}')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
        </div>
    `;
    modalContent.appendChild(aiSection);
    
    document.getElementById('infoModal').classList.remove('hidden');
});
// Helper for AI Buttons
window.triggerAiQuestion = (wood, q) => askGemini(wood, q);
window.triggerAiCustom = (wood) => {
    const val = document.getElementById('aiInput').value.trim();
    if(val) askGemini(wood, val);
};
// Check URL for join (Multiplayer Deep Link)
const p=new URLSearchParams(window.location.search);
if(p.get('game')){ 
    document.getElementById('setupModal').classList.add('hidden');
    gameId=p.get('game'); 
    window.showNamePrompt('join'); 
}
function showHappyWorm() {
 const worm = document.getElementById('happyWorm');
 if(!worm) return;
 worm.classList.remove('hidden', 'animate-worm');
 void worm.offsetWidth; worm.classList.add('animate-worm');
 setTimeout(() => worm.classList.add('hidden'), 3500);
}
function triggerConfetti() {
 var duration = 3000; var end = Date.now() + duration;
 (function frame() {
     confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
     confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
     if (Date.now() < end) requestAnimationFrame(frame);
 }());
}
function triggerStarAnimation() {
    const animContainer = document.getElementById('animationContainer');
    const star = document.createElement('div');
    star.innerText = "‚≠ê";
    star.className = "falling-star";
    star.style.left = "50%";
    star.style.top = "40%";
    star.style.setProperty('--end-y', '150px');
    animContainer.appendChild(star);
    playSoundSecure('starWin'); 
    setTimeout(() => star.remove(), 1200);
}
</script>
</body>
</html>
