<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett: Gamifizierung in der Berufsbildung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; touch-action: manipulation; overflow-x: hidden; min-height: 100dvh; }
        
        /* 3D Karten */
        .perspective-1000 { perspective: 1000px; }
        .card-3d { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 1rem; overflow: hidden; box-sizing: border-box; }
        
        .card-back { 
            transform: rotateY(180deg); 
            background-color: #2c3e50;
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images/background_card.jpg?raw=true'); 
            background-size: cover; 
            background-position: center; 
            border: 4px solid white; 
        }
        
        .card-front-bg { background-color: #fffbeb; background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        /* Animationen */
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); transform: translate(-50%, -50%) scale(1); } 50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); transform: translate(-50%, -50%) scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: translate(-50%, -50%) scale(1); } }
        
        .animate-worm { animation: worm-pop-up 3.5s ease-in-out forwards; }
        @keyframes worm-pop-up { 
            0% { transform: translateY(100%) rotate(0deg); opacity: 0; } 
            20% { transform: translateY(-20%) rotate(-10deg); opacity: 1; } 
            40% { transform: translateY(-20%) rotate(10deg); } 
            50% { transform: translateY(-30%) rotate(0deg) scale(1.1); } 
            60% { transform: translateY(-20%) rotate(-10deg) scale(1); } 
            80% { transform: translateY(-20%) rotate(0deg); opacity: 1; } 
            100% { transform: translateY(100%) rotate(0deg); opacity: 0; } 
        }
        
        /* Utility */
        .opponent-back-name { 
            position: absolute; top: 15%; width: 100%; text-align: center; 
            color: rgba(255,255,255,0.95); font-weight: 700; font-size: 1.1rem; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none; 
            background: rgba(0,0,0,0.3); padding: 4px 0; backdrop-filter: blur(2px);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dimmer { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        
        .attr-box { background-color: #fff7ed; border: 1px solid #fbbf24; transition: all 0.2s; }
        .attr-box.flash-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; }
        .attr-box.flash-active span { color: white !important; }
        .attr-box.highlight-compare { background-color: #e5e7eb !important; border-color: #9ca3af !important; color: #111827 !important; }
        .attr-box.highlight-compare span { color: #000000 !important; }

        .ai-chat-bubble { position: relative; background: #f8fafc; border-radius: 8px; padding: 12px; margin-top: 10px; font-size: 0.9rem; line-height: 1.5; border-left: 4px solid #d97706; }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">

<!-- Header -->
<header class="bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-20 flex-shrink-0">
    <div class="max-w-[600px] mx-auto px-4 py-3 relative flex justify-between items-center">
        <button onclick="window.location.reload();" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-10">
             <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
        </button>
        <h1 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg sm:text-2xl font-black tracking-wider uppercase drop-shadow-sm whitespace-nowrap">
            ğŸŒ² HOLZEN! ğŸŒ²
        </h1>
        <button onclick="window.showGameInfo()" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-10">
             <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>
</header>

<!-- Game Container -->
<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto relative p-2 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>
    <div class="flex justify-center items-start gap-2 sm:gap-4 w-full flex-grow relative pb-2 mt-2"> 
        <!-- Spieler -->
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="playerNameDisplay" class="text-base sm:text-lg font-bold text-amber-700 leading-tight truncate">Spieler</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="playerCardContainer">
                <div id="playerCard" class="w-full h-full relative"></div>
            </div>
        </div>
        <!-- Gegner -->
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10 relative">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="opponentNameDisplay" class="text-base sm:text-lg font-bold text-gray-600 leading-tight truncate">COMPUTER</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="aiCardContainer">
                <div id="aiCard" class="w-full h-full relative"></div>
            </div>
        </div>
    </div>
    
    <!-- Status -->
    <div class="w-full mt-4 mb-24"> 
        <div class="flex justify-between text-[9px] sm:text-[10px] font-bold text-gray-400 mb-1 px-1">
            <span>Dein Stapel</span><span>Gegenspieler</span>
        </div>
        <div class="h-4 w-full bg-gray-200 rounded-full shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 rounded-l-full transition-all duration-500 ease-out" style="width: 50%;"></div>
            <div id="statusBall" class="absolute top-1/2 w-6 h-6 rounded-full border-2 border-white shadow-md transition-all duration-500 ease-out z-10" style="left: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);"></div>
        </div>
    </div>
</div>

<!-- Happy Woodworm (ZurÃ¼ck an alter Position: Unten Rechts) -->
<div id="happyWorm" class="fixed bottom-0 right-4 translate-y-full z-50 pointer-events-none transform transition-transform hidden">
    <div class="relative">
        <div id="wormSpeech" class="absolute -top-10 -left-10 bg-white px-3 py-1.5 rounded-xl shadow-md border-2 border-amber-200 text-xs font-bold text-amber-800 whitespace-nowrap animate-bounce" style="animation-duration: 2s;">Stark! ğŸªµ</div>
        <div class="text-6xl filter drop-shadow-xl cursor-default select-none">ğŸ›</div>
    </div>
</div>

<!-- Bottom Sheet -->
<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-xs sm:text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-xl sm:text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>
        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-800 transition text-sm sm:text-base">ğŸ“ Zusatzwissen</button>
            <button id="bsNextBtn" class="flex-1 bg-green-600 hover:bg-green-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-green-800 transition text-sm sm:text-base">Weiter &rarr;</button>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Info Modal -->
<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[90vh] flex flex-col">
        <div class="bg-amber-500 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 class="font-bold text-lg">Spielregeln & Eigenschaften</h3>
            <button onclick="document.getElementById('gameInfoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto hide-scrollbar space-y-5">
            <h4 class="font-bold text-gray-700 text-md">Regeln (Quartett-Prinzip)</h4>
            <p class="text-sm text-gray-600 leading-relaxed">Die aktive Person wÃ¤hlt auf ihrer Karte die Eigenschaft, die den grÃ¶ÃŸtmÃ¶glichen Vorteil verspricht. Je nach Kategorie zÃ¤hlt der hÃ¶chste oder der niedrigste Wert (siehe die Beschreibung der Eigenschaften). Gewinnt sie den Spielzug, erhÃ¤lt sie beide Karten, legt sie unter den eigenen Stapel und bleibt am Zug. Bei Gleichstand behalten beide ihre Karten. Das Zugrecht bleibt unverÃ¤ndert.</p>
            <div id="infoCategoryList" class="space-y-3 pt-3"></div>
        </div>
    </div>
</div>

<!-- Setup Modal (Startbildschirm) -->
<div id="setupModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-sm w-full">
        <div class="bg-amber-500 p-5 text-white text-center font-bold text-lg sm:text-xl tracking-wide shadow-md">
            HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus wÃ¤hlen</span>
        </div>
        <div class="p-6 space-y-5">
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform">
                <span class="text-2xl">ğŸ¤–</span> Gegen Computer
            </button>
            <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform">
                <span class="text-2xl">ğŸŒ</span> Online gegen Freunde
            </button>
            
            <!-- Checkboxen (Stabil) -->
            <div class="pt-4 border-t border-gray-100 flex flex-col gap-3">
                 <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="soundToggle" class="w-5 h-5 text-amber-600 rounded border-gray-300 focus:ring-amber-500">
                    <span class="text-sm font-bold text-gray-700">ğŸ”Š Ton an</span>
                 </label>
                 <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox" id="revealBackToggle" class="w-5 h-5 text-amber-600 rounded border-gray-300 focus:ring-amber-500">
                    <span class="text-sm font-bold text-gray-700">ğŸ‘€ Gegner-Karte sichtbar</span>
                 </label>
            </div>
        </div>
    </div>
</div>

<!-- Name Eingabe -->
<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
        <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg" placeholder="Name eingeben" maxlength="12">
        <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600">Starten</button>
    </div>
</div>

<!-- Multiplayer Lobby -->
<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund scannen:</p>
        <div class="flex justify-center mb-4"><div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div></div>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>

<!-- Zusatzwissen -->
<div id="infoModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-md w-full max-h-[90vh] flex flex-col">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 id="infoModalTitle" class="font-bold text-lg flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                Fachwissen
            </h3>
            <button onclick="window.closeInfoModal()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto hide-scrollbar space-y-4"></div>
    </div>
</div>

<!-- Game Over -->
<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
        <p id="gameOverText" class="text-gray-600 mb-6"></p>
        <div class="space-y-3">
            <button onclick="window.downloadResult()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg shadow">ğŸ“¸ Ergebnis speichern</button>
            <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">ğŸ† Bestenliste</button>
            <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">ğŸ”„ Neues Spiel</button>
        </div>
    </div>
</div>

<!-- Reflexion -->
<div id="reflectionModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-amber-800 mb-4">ğŸ‰ Super gespielt!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 font-medium"></p>
        <textarea id="reflectionAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg">Weiter</button>
    </div>
</div>

<!-- Leaderboard -->
<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">ğŸ† Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">SchlieÃŸen</button>
    </div>
</div>

<!-- JAVASCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const apiKey = ""; // API Key via Environment

// === FIREBASE CONFIG & AUTH SETUP (Standard Canvas Pattern) ===
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Auth Initialization Logic
let localPlayerId = null;
const initAuth = async () => {
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        try {
            await signInWithCustomToken(auth, __initial_auth_token);
        } catch (e) {
            await signInAnonymously(auth);
        }
    } else {
        await signInAnonymously(auth);
    }
};
initAuth();

onAuthStateChanged(auth, (user) => {
    if (user) {
        localPlayerId = user.uid;
    }
});

// Helper for strict paths
function getPublicDataRef(coll, docId) {
    return docId ? doc(db, 'artifacts', appId, 'public', 'data', coll, docId) : collection(db, 'artifacts', appId, 'public', 'data', coll);
}

// Logging Funktion fÃ¼r Forschungszwecke (Gamification Usage)
async function trackEvent(type) {
    if (!localPlayerId) return; 
    const ref = getPublicDataRef("statistics", "usage"); 
    try {
        await setDoc(ref, {
            [type]: increment(1),
            last_activity: serverTimestamp()
        }, { merge: true });
    } catch (e) {
        console.warn("Tracking eingeschrÃ¤nkt (Permissions/Network).", e);
    }
}

// Globale Variablen
let gameMode=null, gameId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;
let lastRoundWinningWoodName = null;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};
let wormTurnCount = 0;
let wormTarget = Math.floor(Math.random() * 3) + 3;

// Sounds
const sounds={
 flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
 win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
 chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
 starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

// Einstellungen Speicherung
function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

// Daten Konstanten
const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images";
const IMG_SUFFIX = "?raw=true";

// Holzdaten (Muss fÃ¼r Masterarbeit validiert werden!)
const woodCards=[
 {name:"ğŸŒ³ Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² LÃ¤rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000, imgTree:`${IMG_BASE}/birke_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000, imgTree:`${IMG_BASE}/douglasie_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500, imgTree:`${IMG_BASE}/mahagoni_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000, imgTree:`${IMG_BASE}/bambus_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/bambus_2.jpg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Meranti",dk:3,haerte:45,quellenSchwindenRadial:3.0,dichte:650,gewicht:12500, imgTree:"https://github.com/aufdemholzweg/holzquartett/blob/main/images/meranti_1.jpg?raw=true", imgCross:"https://github.com/aufdemholzweg/holzquartett/blob/main/images/meranti_2.jpeg?raw=true"},
 {name:"ğŸŒ³ Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Erle",dk:5,haerte:30,quellenSchwindenRadial:3.4,dichte:530,gewicht:9700, imgTree:"https://github.com/aufdemholzweg/holzquartett/blob/main/images/erle_1.jpeg?raw=true", imgCross:"https://github.com/aufdemholzweg/holzquartett/blob/main/images/erle_2.jpeg?raw=true"},
 {name:"ğŸŒ² Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ´ Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`}
];

// Funktion zum Vorladen der Bilder
const preloadImages = () => {
    // console.log("Starte Preloading der Bilder...");
    const bg = new Image();
    bg.src = 'https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images/background_card.jpg?raw=true';
    
    woodCards.forEach(card => {
        if(card.imgTree) {
            const i1 = new Image();
            i1.src = card.imgTree;
        }
        if(card.imgCross) {
            const i2 = new Image();
            i2.src = card.imgCross;
        }
    });
};

// Start preload immediately
preloadImages();

const detailedWoodInfo = {
    "ğŸŒ³ Eiche": `<p class="mb-2">Hart, schwer, sehr dauerhaft; hoher Gerbstoffanteil, daher widerstandsfÃ¤hig gegen Pilze/SchÃ¤dlinge, kann mit Eisen schwarz verfÃ¤rben. Grobporig, deutliche Jahresringe.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, FuÃŸbÃ¶den, Treppen, Fassdauben, AuÃŸenbau (z. B. Terrassen), Fachwerk.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionsholz und Symbol fÃ¼r StÃ¤rke; hÃ¤ufig in Wappen/MÃ¼nzen.</p>`,
    "ğŸŒ³ Buche": `<p class="mb-2">ZÃ¤h, biegsam, gleichmÃ¤ÃŸige Struktur; ringporig mit dezenten ÃœbergÃ¤ngen, harzarm.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Parkett, Furniere, Sperrholz, Innenausbau.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Historisch beliebt fÃ¼r RÃ¤der/Griffe wegen ZÃ¤higkeit und ElastizitÃ¤t.</p>`,
    "ğŸŒ² Kiefer": `<p class="mb-2">Weiches, harzhaltiges Nadelholz mit markanter Jahresringstruktur und HarzkanÃ¤len.</p><p class="mb-2"><strong>Verwendung:</strong> Bauholz, DachstÃ¼hle, Innenausbau, Paneele, einfache MÃ¶bel.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Kiefernharz diente frÃ¼her als Klebstoff und Dichtmittel.</p>`,
    "ğŸŒ² Fichte": `<p class="mb-2">Leichtes Bauholz mit gutem Festigkeits-Gewichts-VerhÃ¤ltnis; feine Zellstruktur ohne groÃŸe Poren.</p><p class="mb-2"><strong>Verwendung:</strong> Bauholz, Innenverkleidung, Paneele, MÃ¶belgrundkonstruktionen.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Klassiker im Dach- und Hallenbau vieler Alpenregionen.</p>`,
    "ğŸŒ² Tanne": `<p class="mb-2">Harzarm, fein, Ã¤hnlich Fichte; dezente Jahresringe, keine groÃŸen Poren.</p><p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Paneele, Bauholz, MÃ¶bel.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Angenehm geruchsarm im Innenraum durch wenig Harz.</p>`,
    "ğŸŒ² LÃ¤rche": `<p class="mb-2">Relativ hart und witterungsbestÃ¤ndig; deutliche Jahresringe, harzhaltig.</p><p class="mb-2"><strong>Verwendung:</strong> Fassaden, Fenster, Terrassen, AuÃŸenmÃ¶bel.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Vergraut edel im AuÃŸenbereich auch ohne chemische Behandlung.</p>`,
    "ğŸŒ³ Birke": `<p class="mb-2">Helles, dekoratives Holz; zerstreutporig, feine gleichmÃ¤ÃŸige Struktur, gut biegbar.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Furniere, Sperrholz, Innenausbau.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Birkenrinde wurde traditionell als wasserabweisendes Material genutzt.</p>`,
    "ğŸŒ³ Ahorn": `<p class="mb-2">Hart, hell, sehr fein und homogen; zerstreutporig.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Parkett, Schneidebretter, Instrumentenbau.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Ahornsirup stammt v. a. aus nordamerikanischen Arten.</p>`,
    "ğŸŒ³ Esche": `<p class="mb-2">Sehr zÃ¤h und elastisch; ringporig mit deutlichen FrÃ¼hholzporen.</p><p class="mb-2"><strong>Verwendung:</strong> Werkzeugstiele, SportgerÃ¤te, MÃ¶bel, Parkett.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Klassisches Holz fÃ¼r Speichen und Stiele wegen ElastizitÃ¤t.</p>`,
    "ğŸŒ³ Kirsche": `<p class="mb-2">Warm rÃ¶tlich, edel; ringporig, klare Jahresringe, dunkelt mit Licht nach.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Furniere, Innenausbau.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Entwickelt mit der Zeit eine charakteristische, tiefere Farbigkeit.</p>`,
    "ğŸŒ³ Nussbaum": `<p class="mb-2">Dunkles, dekoratives Kernholz; zerstreutporig, markante Maserung.</p><p class="mb-2"><strong>Verwendung:</strong> Hochwertige MÃ¶bel, Furniere, Intarsien.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Renaissance-Liebling fÃ¼r reprÃ¤sentative Innenausstattungen.</p>`,
    "ğŸŒ² Douglasie": `<p class="mb-2">Robust, relativ dauerhaft; deutliche Jahresringe, gut fÃ¼r AuÃŸen.</p><p class="mb-2"><strong>Verwendung:</strong> Bauholz, Fassaden, Terrassen, AuÃŸenmÃ¶bel.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> UrsprÃ¼nglich nordamerikanisch, in Europa weit verbreitet.</p>`,
    "ğŸŒ² Zeder": `<p class="mb-2">Angenehmer Duft, natÃ¼rlich insektenabweisend; fein und gleichmÃ¤ÃŸig.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, SchrÃ¤nke, Fassaden, Innenraum.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Beliebt in KleiderschrÃ¤nken wegen Geruch und Mottenabwehr.</p>`,
    "ğŸŒ´ Mahagoni": `<p class="mb-2">Tropisches Edelholz, dauerhaft; zerstreutporig, dekoratives Kernholz.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Fenster, Bootsbau, hochwertige Ausbauten.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Teilweise artenschutzreguliert â€“ Herkunft/Handel beachten.</p>`,
    "ğŸŒ´ Teak": `<p class="mb-2">Sehr witterungsbestÃ¤ndig (Ã–l-/Harzgehalt); fein zerstreutporig, edle Optik.</p><p class="mb-2"><strong>Verwendung:</strong> GartenmÃ¶bel, Terrassen, Bootsdecks, AuÃŸenfenster.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Historisch geschÃ¤tzt im Schiffbau wegen Dauerhaftigkeit.</p>`,
    "ğŸŒ´ Bambus": `<p class="mb-2">Botanisch Gras, aber sehr fest; rÃ¶hrenartige Struktur statt klassischer Poren.</p><p class="mb-2"><strong>Verwendung:</strong> BÃ¶den, MÃ¶bel, Treppen, nachhaltiger Leichtbau.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Extrem schnelles Wachstum, daher Ã¶kologisch interessant.</p>`,
    "ğŸŒ³ Pappel": `<p class="mb-2">Sehr leicht und weich; feine Struktur, dezente Jahresringe.</p><p class="mb-2"><strong>Verwendung:</strong> Leichtbau, Verpackungen, InnenmÃ¶bel mit geringer Last.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Gern im Modell- und Fahrzeuginnenausbau genutzt.</p>`,
    "ğŸŒ´ Meranti": `<p class="mb-2">Sammelname fÃ¼r tropische HÃ¶lzer (Shorea); rÃ¶tlich-braun, grobporig.</p><p class="mb-2"><strong>Verwendung:</strong> Fensterbau, TÃ¼ren, Fassaden.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> War lange das Standardholz fÃ¼r Holzfenster in Deutschland.</p>`,
    "ğŸŒ³ Linde": `<p class="mb-2">Weich, homogen, sehr gut schnitzbar; fein zerstreutporig.</p><p class="mb-2"><strong>Verwendung:</strong> Bildhauerei, Orgelbau, Intarsien, feine MÃ¶belteile.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionsholz mittelalterlicher Schnitzer.</p>`,
    "ğŸŒ³ Ulme": `<p class="mb-2">ZÃ¤h, eher hart; ringporig, teils unruhiger Faserverlauf.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Innenausbau, Reparatur- und Biegeteile.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Historisch im Wagenbau geschÃ¤tzt.</p>`,
    "ğŸŒ³ Kastanie": `<p class="mb-2">WetterbestÃ¤ndig, warm getÃ¶nt; ringporig mit klarer Jahresringzeichnung.</p><p class="mb-2"><strong>Verwendung:</strong> AuÃŸenbau, MÃ¶bel, Balken, Gartenholz.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Oft Alternative zur Eiche im AuÃŸenbereich.</p>`,
    "ğŸŒ³ Robinie": `<p class="mb-2">Eines der hÃ¤rtesten europÃ¤ischen HÃ¶lzer; sehr dauerhaft im Freien; ringporig.</p><p class="mb-2"><strong>Verwendung:</strong> Terrassen, ZÃ¤une, SpielplÃ¤tze, AuÃŸenkonstruktionen.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> â€EuropÃ¤isches Teakâ€œ wegen seiner Dauerhaftigkeit.</p>`,
    "ğŸŒ² Hemlock": `<p class="mb-2">Weiches, gleichmÃ¤ÃŸiges Nadelholz; feine Struktur, dezente Ringe.</p><p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Paneele, Leichtbau, MÃ¶bel.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Gutes VerhÃ¤ltnis von Gewicht zu StabilitÃ¤t.</p>`,
    "ğŸŒ³ Erle": `<p class="mb-2">Zerstreutporig, rÃ¶tlich-weiÃŸ, weich. Unter Wasser extrem dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Modellbau, Wasserbau (PfÃ¤hle).</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Das Holz fÃ¤rbt sich beim frischen Anschnitt intensiv orangerot.</p>`,
    "ğŸŒ² Redwood": `<p class="mb-2">Leicht, relativ dauerhaft; fein zerstreutporig, dekorative Farbe.</p><p class="mb-2"><strong>Verwendung:</strong> AuÃŸenholz, ZÃ¤une, Gartenkonstruktionen.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Stammt vom KÃ¼stenmammutbaum â€“ einer der hÃ¶chsten Baumarten.</p>`,
    "ğŸŒ³ Hickory": `<p class="mb-2">Sehr zÃ¤h und hart; ringporig mit ausgeprÃ¤gten Poren.</p><p class="mb-2"><strong>Verwendung:</strong> Werkzeugstiele, SportgerÃ¤te, stark beanspruchte MÃ¶bel.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Klassisches Holz fÃ¼r Peitschen- und GerÃ¤teschÃ¤fte.</p>`,
    "ğŸŒ´ Wenge": `<p class="mb-2">Dunkel, sehr hart; zerstreutporig, charakteristische Streifenzeichnung.</p><p class="mb-2"><strong>Verwendung:</strong> LuxusmÃ¶bel, Parkett, Furniere.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Wirkt in Kontrastkombinationen mit hellen HÃ¶lzern besonders.</p>`,
    "ğŸŒ´ Zebrano": `<p class="mb-2">Markante Streifenoptik; zerstreutporig mit dekorativer Maserung.</p><p class="mb-2"><strong>Verwendung:</strong> DesignmÃ¶bel, Furniere, Intarsien.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Beliebt fÃ¼r auffÃ¤llige Akzente.</p>`,
    "ğŸŒ´ Palisander": `<p class="mb-2">Dekorativ, fest und langlebig; feine, gleichmÃ¤ÃŸige Porung.</p><p class="mb-2"><strong>Verwendung:</strong> Gitarren/Instrumente, MÃ¶bel, Furniere.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionell exklusiv im Instrumentenbau; Artenschutz-Lagen beachten.</p>`,
    "ğŸŒ´ Ebenholz": `<p class="mb-2">Extrem hart und dicht, nahezu schwarz; sehr feinporig.</p><p class="mb-2"><strong>Verwendung:</strong> Klaviertasten, Intarsien, Luxusdekore, Griffbretter.</p><p class="italic text-gray-600"><strong>Zusatz:</strong> Seit der Antike als edles, seltenes Holz geschÃ¤tzt.</p>`
};

const reflectionQuestions=[
 "Welches Holz wÃ¼rdest du fÃ¼r GartenmÃ¶bel wÃ¤hlen und warum?",
 "Eine KÃ¼chenarbeitsplatte muss schnittfest sein. Welches Holz eignet sich?",
 "FÃ¼r einen Dielenboden: Hartes oder weiches Holz?",
 "Warum verfÃ¤rbt sich Eiche mit Eisen?"
];

const attributeInfo={
 dk:{icon:'ğŸ›¡ï¸',name:'Dauerhaftigkeit',unit:'(DK)', logic: 'Niedrig gewinnt'},
 haerte:{icon:'ğŸ’',name:'Druckfestigkeit',unit:'(N/mmÂ²)', logic: 'Hoch gewinnt'},
 quellenSchwindenRadial:{icon:'â†”ï¸',name:'Quellen/Schw.',unit:'(%)', logic: 'Niedrig gewinnt'},
 dichte:{icon:'âš–ï¸',name:'Rohdichte',unit:'(kg/mÂ³)', logic: 'Hoch gewinnt'},
 gewicht:{icon:'ğŸ‹ï¸',name:'E-Modul',unit:'(N/mmÂ²)', logic: 'Hoch gewinnt'}
};

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

// === AI FUNCTION ===
window.triggerAiQuestion = (woodName, question) => {
    askGemini(woodName, question);
};

window.triggerAiCustom = (woodName) => {
    const input = document.getElementById('aiInput');
    if(input && input.value.trim()) {
        askGemini(woodName, input.value.trim());
    }
};

async function askGemini(woodName, question) {
    const aiOutput = document.getElementById('aiOutput');
    const aiInput = document.getElementById('aiInput');
    const aiBtn = document.getElementById('aiSendBtn');
    
    // UI Loading State
    aiOutput.innerHTML = '<div class="flex items-center gap-2 text-gray-500"><svg class="animate-spin h-4 w-4 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Recherchiere Fakten...</div>';
    aiInput.disabled = true;
    aiBtn.disabled = true;

    // Prompt - Professional Style for Vocational Training
    const prompt = `Du bist ein erfahrener Tischlermeister und Berufsschullehrer in einem Lernspiel fÃ¼r Holzberufe. 
    Das aktuelle Holz ist: ${woodName}.
    Die Frage des Nutzers ist: "${question}".
    Antworte fachlich fundiert, prÃ¤zise und praxisnah auf Deutsch. Vermeide kindliche Sprache. Nutze Fachbegriffe wo sinnvoll. Nutze Markdown fÃ¼r Fettungen wichtiger Begriffe. Halte die Antwort kompakt (max. 3-4 SÃ¤tze).`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        if (!response.ok) throw new Error('API Fehler');
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Konnte keine Daten abrufen. Bitte versuche es erneut.";
        
        // Render Markdown
        aiOutput.innerHTML = marked.parse(text);
    } catch (e) {
        console.error(e);
        aiOutput.innerHTML = '<span class="text-red-500">Dienst derzeit nicht verfÃ¼gbar (Verbindungsfehler).</span>';
    } finally {
        aiInput.disabled = false;
        aiBtn.disabled = false;
        aiInput.value = '';
    }
}

function showHappyWorm() {
    const worm = document.getElementById('happyWorm');
    const speech = document.getElementById('wormSpeech');
    if(!worm || !speech) return;

    const wormPhrases = [
        "Super gemacht!", "Weiter so!", "Starke Runde!", "Gut gespielt!",
        "Clever gewÃ¤hlt!", "Sauber gelÃ¶st!", "Astrein!", "Meisterhaft!",
        "Top Zug!", "Passt wie gedÃ¼belt!", "SchÃ¶ner Zug!", "Klug entschieden!",
        "SouverÃ¤n!", "PrÃ¤zise!", "Stabil!", "Stark kombiniert!",
        "Schlauer Move!", "Gekonnt!", "Astrein gewÃ¤hlt!", "Punktlandung!",
        "Clever kombiniert!", "Meisterhaft gelÃ¶st!"
    ];
    
    // ZufÃ¤llige Auswahl
    speech.innerText = wormPhrases[Math.floor(Math.random() * wormPhrases.length)];

    worm.classList.remove('hidden', 'animate-worm');
    void worm.offsetWidth; 
    worm.classList.add('animate-worm');
    setTimeout(() => worm.classList.add('hidden'), 3500);
}

function checkWormAppearance(isWin) {
    wormTurnCount++;
    if (isWin && wormTurnCount >= wormTarget) {
        showHappyWorm();
        wormTurnCount = 0;
        wormTarget = Math.floor(Math.random() * 3) + 3;
    }
}

// === CANVAS / SCREENSHOT FEATURE ===
window.downloadResult = async function() {
    const modal = document.getElementById('gameOverModal');
    // Visuelle Vorbereitung fÃ¼r Screenshot
    const btns = modal.querySelectorAll('button');
    btns.forEach(b => b.style.display = 'none'); 
    
    try {
        const canvas = await html2canvas(modal, { backgroundColor: '#ffffff', scale: 2 });
        const link = document.createElement('a');
        link.download = 'holz-quartett-ergebnis.png';
        link.href = canvas.toDataURL();
        link.click();
    } catch(e) {
        console.error("Screenshot Fehler", e);
    } finally {
        // Buttons wiederherstellen
        btns.forEach(b => b.style.display = 'block');
    }
}

// === CORE UI FUNCTIONS ===
function updateStatusBar(p, o){
    const total=p+o; const pct=(total===0)?50:(p/total)*100;
    const bar=document.getElementById('statusBar');
    const ball=document.getElementById('statusBall');
    bar.style.width=`${pct}%`; ball.style.left=`${pct}%`;
    ball.classList.remove('animate-pulse-glow');
    if(pct > 60) { ball.style.background = '#16a34a'; ball.classList.add('animate-pulse-glow'); bar.className='h-full bg-green-500 transition-all duration-500'; } 
    else if (pct < 40) { ball.style.background = '#dc2626'; bar.className='h-full bg-red-500 transition-all duration-500'; } 
    else { ball.style.background = '#d97706'; bar.className='h-full bg-amber-500 transition-all duration-500'; }
}

function createCard(data, isRevealed, isPlayer, isActive, highlightAttr){
    const card = document.createElement('div');
    card.className = `card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''}`;
    if(!isRevealed) card.classList.add('card-flipped');
    
    // Accessibility: Tastaturnavigation ermÃ¶glichen
    if(isPlayer) {
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
    }

    const canSelect = isPlayer && ((gameMode==='ai' && aiGame.turn==='player' && !aiGame.roundInProgress) || (gameMode==='multiplayer' && localGameState.turn===localPlayerId && !localGameState.lastResult));
    
    // Front
    const front = document.createElement('div');
    const bClass = isActive ? 'border-orange-500 ring-4 ring-orange-200' : 'border-orange-200';
    front.className = `card-front card-front-bg rounded-2xl shadow-lg border-4 ${bClass} flex flex-col transition-all`;
    let html = `<div class="pt-3 px-3 pb-1"><h2 class="text-lg sm:text-xl font-bold text-amber-900 leading-none">${data.name}</h2></div>
                <div class="mx-3 mt-1 mb-2 aspect-[4/3] rounded-xl overflow-hidden bg-white shadow-sm border border-orange-100">
                    <img src="${data.imgTree}" class="w-full h-full object-cover">
                </div>
                <div class="flex-grow flex flex-col justify-start gap-1 sm:gap-2 px-2 pb-2 overflow-y-auto hide-scrollbar">`;
    
    for(const k in attributeInfo){
        const info = attributeInfo[k];
        let flashClass = (highlightAttr === k) ? (isActive ? 'flash-active' : 'highlight-compare') : '';
        const rowInner = `<div class="flex items-center gap-2"><span class="text-base">${info.icon}</span><div class="flex flex-col text-left leading-none"><span class="font-bold text-gray-800 text-[10px] sm:text-sm">${info.name}</span><span class="text-[9px] text-gray-500 font-medium">${info.unit}</span></div></div><span class="text-sm font-bold text-amber-800">${data[k]}</span>`;
        if(canSelect) {
             html += `<div onclick="window.selectAttribute('${k}')" data-attr-btn="${k}" class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl cursor-pointer hover:brightness-95 ${flashClass}">${rowInner}</div>`;
        } else {
             html += `<div class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl opacity-90 ${flashClass}" data-attr-row="${k}">${rowInner}</div>`;
        }
    }
    html += '</div>';
    front.innerHTML = html;

    // Back
    const back = document.createElement('div');
    back.className = `card-back rounded-2xl shadow-lg relative ${isActive ? 'border-orange-500' : 'border-white'}`;
    if(!isPlayer && isOpponentNameBackVisible()){
        const lbl = document.createElement('div'); 
        lbl.className = 'opponent-back-name'; 
        lbl.innerText = data.name; 
        back.appendChild(lbl);
    }

    card.appendChild(front); card.appendChild(back);
    return card;
}

// === GAME LOGIC (AI & MULTIPLAYER) ===
function openBottomSheet(title){
    if(title) document.getElementById('resultText').innerText = title;
    const bs = document.getElementById('bottomSheet');
    const bd = document.getElementById('bottomSheetBackdrop');
    bd.classList.remove('hidden'); bs.classList.remove('hidden');
    setTimeout(() => { bd.classList.remove('opacity-0'); bs.classList.remove('translate-y-full'); }, 10);
}
function closeBottomSheet(){
    const bs = document.getElementById('bottomSheet');
    const bd = document.getElementById('bottomSheetBackdrop');
    bs.classList.add('translate-y-full'); bd.classList.add('opacity-0');
    setTimeout(() => { bs.classList.add('hidden'); bd.classList.add('hidden'); }, 300);
}

async function saveToLeaderboard(name){
    if(!name) return;
    const safe=name.replace(/[.#$[\]]/g,'_');
    const ref = getPublicDataRef("leaderboard", safe);
    try{ await setDoc(ref,{name,wins:increment(1),lastWin:serverTimestamp()},{merge:true}); }catch(e){}
}

function endGame(winnerName){
    closeBottomSheet();
    document.getElementById('gameContainer').classList.add('hidden');
    
    // PrÃ¼fen ob Spieler gewonnen hat (Lokal oder AI)
    let isWin = false;
    if (gameMode === 'ai') {
        isWin = (winnerName === aiGame.playerName);
    } else {
        isWin = (localGameState.players && winnerName === localGameState.players[localPlayerId]?.name);
    }
    
    if(isWin){
        document.getElementById('reflectionQuestion').innerText = reflectionQuestions[Math.floor(Math.random()*reflectionQuestions.length)];
        document.getElementById('reflectionModal').classList.remove('hidden');
    } else {
        document.getElementById('gameOverTitle').innerText = "VERLOREN";
        document.getElementById('gameOverTitle').className = "text-3xl font-black mb-2 text-red-600";
        document.getElementById('gameOverText').innerText = "Schade, diesmal hat es nicht gereicht.";
        document.getElementById('gameOverModal').classList.remove('hidden');
    }
}

// AI Functions
function updateDisplayAI(){
    const pc=aiGame.playerCards.length; const ac=aiGame.aiCards.length;
    document.getElementById('playerCards').innerText=pc; document.getElementById('aiCards').innerText=ac;
    updateStatusBar(pc,ac);
    const pcEl=document.getElementById('playerCard'); pcEl.innerHTML='';
    const acEl=document.getElementById('aiCard'); acEl.innerHTML='';
    const isPTurn = aiGame.turn === 'player';
    
    // createCard call with explicit null for highlightAttr to clean state
    if(aiGame.currentPlayerCard) pcEl.appendChild(createCard(aiGame.currentPlayerCard, true, true, isPTurn, null));
    if(aiGame.currentAiCard) acEl.appendChild(createCard(aiGame.currentAiCard, false, false, !isPTurn, null));
    
    if(aiGame.turn==='ai' && !aiGame.roundInProgress) setTimeout(aiTurn, 1000);
}

function evaluateRoundAI(attr){
    const pv=aiGame.currentPlayerCard[attr]; const av=aiGame.currentAiCard[attr];
    const logic = attributeInfo[attr].logic;
    let pWins = (logic === 'Niedrig gewinnt') ? (pv < av) : (pv > av);
    if(pv === av) pWins = 'tie';

    const resText = pWins===true ? 'Du gewinnst!' : (pWins===false ? 'Computer gewinnt!' : 'Unentschieden');
    const resColor = pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-gray-600');
    
    document.getElementById('resultText').innerText = resText;
    document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
    document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${pv} vs ${av}`;
    
    if(pWins===true) { 
        playSound(sounds.win); 
        checkWormAppearance(true); 
        lastRoundWinningWoodName = aiGame.currentPlayerCard.name; 
    } else if (pWins===false) {
        checkWormAppearance(false);
        lastRoundWinningWoodName = aiGame.currentAiCard.name;
    } else {
        checkWormAppearance(false);
        lastRoundWinningWoodName = aiGame.currentPlayerCard.name; // Fallback
    }
    
    openBottomSheet(resText);
    const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
    if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
    else if(pWins===false){ aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }
    else { aiGame.playerCards.push(pC); aiGame.aiCards.push(aC); }

    if(aiGame.playerCards.length===0) endGame("Computer");
    if(aiGame.aiCards.length===0) endGame(aiGame.playerName);
}

function aiTurn(){
    if(aiGame.roundInProgress) return;
    const keys=Object.keys(attributeInfo);
    const k=keys[Math.floor(Math.random()*keys.length)];
    aiGame.roundInProgress = true;
    const aiCardEl = document.getElementById('aiCard');
    const row = aiCardEl.querySelector(`div[data-attr-row="${k}"]`);
    if(row) row.classList.add('flash-active'); 
    setTimeout(() => { 
        const ac=document.getElementById('aiCard').querySelector('.card-3d');
        if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
        // Highlight player row for comparison visual
        const playerCardEl = document.getElementById('playerCard');
        const pRow = playerCardEl.querySelector(`div[data-attr-btn="${k}"]`) || playerCardEl.querySelector(`div[data-attr-row="${k}"]`);
        if(pRow) pRow.classList.add('highlight-compare');

        setTimeout(() => evaluateRoundAI(k), 2000);
    }, 500);
}

// Multiplayer Functions
function listenToGameChanges(){
    if(!gameId) return;
    unsubscribeGame=onSnapshot(getPublicDataRef("games", gameId),(ds)=>{
        if(!ds.exists()) { window.resetGame(); return; }
        const gd=ds.data(); localGameState=gd;
        if(gd.status==='playing'||gd.status==='finished'){
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            
            // UI Update
            const oppId=gd.playerIds.find(id=>id!==localPlayerId);
            document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
            document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
            const pCount = gd.players[localPlayerId]?.cards?.length||0;
            const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
            document.getElementById('playerCards').innerText = pCount;
            document.getElementById('aiCards').innerText = oCount;
            updateStatusBar(pCount, oCount);
            
            // Highlight Attribute logic for Multiplayer
            const highlightAttr = gd.lastResult ? gd.lastResult.attribute : null;

            // Cards Update
            const pc = document.getElementById('playerCard'); const ac = document.getElementById('aiCard');
            pc.innerHTML=''; ac.innerHTML='';
            const isPlayerTurn = gd.turn === localPlayerId;
            if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true, isPlayerTurn, highlightAttr));
            
            if(oppId && gd.currentCards[oppId]){
                const c = createCard(gd.currentCards[oppId], false, false, !isPlayerTurn, highlightAttr);
                ac.appendChild(c);
                if(gd.lastResult){
                    setTimeout(()=> { c.classList.remove('card-flipped'); playSound(sounds.flip); }, 100);
                }
            } else {
                ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte auf Gegner-Karte...</div>`;
            }
            
            // Result handling
            if(gd.lastResult){
                 const wId = gd.lastResult.winnerId;
                 const iWin = wId===localPlayerId;
                 
                 // Winner Wood Logic for Multiplayer
                 if(wId === 'tie') {
                     lastRoundWinningWoodName = gd.currentCards[localPlayerId].name;
                 } else if (gd.currentCards[wId]) {
                     lastRoundWinningWoodName = gd.currentCards[wId].name;
                 }

                 if(!roundSoundPlayed && iWin) playSound(sounds.win);
                 roundSoundPlayed=true;
                 
                 const resText = iWin ? 'Du gewinnst!' : (wId==='tie'?'Unentschieden':'Gegner gewinnt!');
                 document.getElementById('resultText').className = iWin ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
                 document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
                 if(iWin) checkWormAppearance(true);
                 if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(resText);
            } else {
                 roundSoundPlayed=false; closeBottomSheet();
            }
            document.getElementById('turnIndicator').innerText = (gd.turn===localPlayerId) ? "Du bist am Zug!" : "Gegner wÃ¤hlt...";
            if(gd.status==='finished'){
                let winnerName = "";
                // Einfache Logik: Wer Karten hat, hat gewonnen
                if (gd.players[localPlayerId].cards.length > 0) winnerName = gd.players[localPlayerId].name;
                else if (oppId && gd.players[oppId].cards.length > 0) winnerName = gd.players[oppId].name;
                endGame(winnerName);
            }
        }
    });
}

// Global Window Functions (Exports)
window.startGameAI = (name) => {
    trackEvent('games_ai');
    gameMode='ai'; aiGame.playerName=name;
    document.getElementById('playerNameDisplay').innerText=name;
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
    document.getElementById('gameContainer').classList.remove('hidden');
    updateDisplayAI();
};

let authRetries = 0;
window.createGame = async (playerName) => {
    if (!localPlayerId) { 
        if(authRetries > 10) { 
            console.error("Auth timeout"); 
            alert("Verbindungsfehler: Authentifizierung nicht bereit."); 
            return; 
        }
        authRetries++;
        console.warn("Warte auf Auth...");
        setTimeout(() => window.createGame(playerName), 500);
        return; 
    }
    
    trackEvent('games_multiplayer');
    gameMode='multiplayer';
    const lobby=document.getElementById('multiplayerLobbyModal'); lobby.classList.remove('hidden');
    gameId=Math.random().toString(36).substring(2,8).toUpperCase();
    const joinUrl=`${window.location.href.split('?')[0]}?game=${gameId}`;
    document.getElementById('shareLink').value=joinUrl;
    
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {text: joinUrl, width: 128, height: 128});
    
    await setDoc(getPublicDataRef("games", gameId),{
        gameId, status:'waiting', playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
        createdAt:serverTimestamp()
    });
    listenToGameChanges();
};

window.joinGame = async (id, playerName) => {
    if (!localPlayerId) { setTimeout(()=>window.joinGame(id,playerName), 500); return; }
    
    gameMode='multiplayer'; gameId = id;
    const ref=getPublicDataRef("games", id);
    const snap=await getDoc(ref);
    if(snap.exists() && snap.data().status==='waiting'){
        document.getElementById('lobbyTitle').textContent="Verbinde...";
        document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
        const sh=shuffleArray([...woodCards]);
        const p1=snap.data().playerIds[0];
        
        // Karten verteilen
        await updateDoc(ref,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:sh.slice(15,30),status:'online'},
            [`players.${p1}.cards`]:sh.slice(0,15),
            turn:p1, currentCards:{[p1]:sh.slice(0,15)[0],[localPlayerId]:sh.slice(15,30)[0]},
            lastResult:null
        });
        listenToGameChanges();
    } else {
        alert("Spiel nicht gefunden oder voll.");
        window.location.href = window.location.href.split('?')[0];
    }
};

window.selectAttribute = async (attr) => {
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        aiGame.roundInProgress = true;
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`); if(btn) btn.classList.add('flash-active');
        setTimeout(() => {
            const ac=document.getElementById('aiCard').querySelector('.card-3d');
            if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
            const oppRow = document.getElementById('aiCard').querySelector(`div[data-attr-row="${attr}"]`);
            if(oppRow) oppRow.classList.add('highlight-compare');
            setTimeout(() => evaluateRoundAI(attr), 2000);
        }, 500);
    } else {
        if(!localGameState || localGameState.turn!==localPlayerId) return;
        const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
        const pv = localGameState.currentCards[localPlayerId][attr];
        const ov = localGameState.currentCards[opp][attr];
        const logic = attributeInfo[attr].logic;
        let pWins = (logic === 'Niedrig gewinnt') ? (pv < ov) : (pv > ov);
        if(pv === ov) pWins = 'tie';
        const winner = pWins==='tie' ? 'tie' : (pWins ? localPlayerId : opp);
        await updateDoc(getPublicDataRef("games", gameId),{
            lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:pv, [opp]:ov}}
        });
    }
};

window.nextRound = async () => {
    document.getElementById('gameContainer').scrollIntoView();
    if(gameMode==='ai'){
        aiGame.currentPlayerCard=aiGame.playerCards[0];
        aiGame.currentAiCard=aiGame.aiCards[0];
        aiGame.roundInProgress=false;
        updateDisplayAI();
    } else {
        const gs = localGameState;
        const [p1,p2] = gs.playerIds;
        let c1=gs.players[p1].cards.shift();
        let c2=gs.players[p2].cards.shift();
        const w = gs.lastResult.winnerId;
        
        // Karten zum Gewinner
        if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
        else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        
        // PrÃ¼fen ob Spiel vorbei
        if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
            await updateDoc(getPublicDataRef("games", gameId), {status:'finished', players:gs.players});
            return;
        }
        const nextT = w==='tie' ? gs.turn : w;
        await updateDoc(getPublicDataRef("games", gameId), {
            lastResult:null, turn:nextT, players:gs.players,
            currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
        });
    }
};

window.showFinalWinScreen = () => {
    document.getElementById('reflectionModal').classList.add('hidden');
    const title = document.getElementById('gameOverTitle');
    title.innerText = "GEWONNEN!";
    title.className = "text-3xl font-black mb-2 text-green-600";
    document.getElementById('gameOverText').innerText = "Herzlichen GlÃ¼ckwunsch! Du bist der Holz-Meister.";
    document.getElementById('gameOverModal').classList.remove('hidden');
    
    // FIREWORK ANIMATION START
    var duration = 5 * 1000;
    var animationEnd = Date.now() + duration;
    var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

    var randomInRange = (min, max) => Math.random() * (max - min) + min;

    var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) {
            return clearInterval(interval);
        }

        var particleCount = 50 * (timeLeft / duration);
        // since particles fall down, start a bit higher than random
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
    }, 250);
    // FIREWORK ANIMATION END

    // Leaderboard Update
    const name = gameMode==='ai' ? aiGame.playerName : localGameState.players[localPlayerId].name;
    saveToLeaderboard(name);
};

window.showNamePrompt = (mode) => {
    document.getElementById('setupModal').classList.add('hidden');
    document.getElementById('nameModal').classList.remove('hidden');
    const btn=document.getElementById('nameSubmitButton');
    const clone=btn.cloneNode(true);
    btn.parentNode.replaceChild(clone,btn);
    clone.addEventListener('click',()=>{
        const n=document.getElementById('playerName').value.trim();
        if(!n)return;
        document.getElementById('nameModal').classList.add('hidden');
        if(mode==='ai') window.startGameAI(n);
        else if(mode==='multiplayer') window.createGame(n);
        else window.joinGame(gameId,n);
    });
};

window.showLeaderboard = async () => {
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    try {
        const q=query(getPublicDataRef("leaderboard"),orderBy("wins","desc"),limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine EintrÃ¤ge</div>'; return; }
        list.innerHTML = snap.docs.map((d,i)=>`<div class="flex justify-between p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100"><span class="font-bold text-gray-700">${i+1}. ${d.data().name}</span><span class="font-bold text-amber-600">${d.data().wins} ğŸ†</span></div>`).join('');
    } catch(e){ 
        console.error(e);
        list.innerHTML='<div class="text-center text-red-400 text-sm">Fehler (Netzwerk/Rechte)<br>Bitte Firestore Regeln prÃ¼fen.</div>'; 
    }
};

window.copyShareLink = () => { 
    const l=document.getElementById('shareLink'); 
    l.select(); 
    try { document.execCommand('copy'); } catch(e){} 
};

window.showGameInfo = () => populateGameInfoModal();
window.closeInfoModal = () => document.getElementById('infoModal').classList.add('hidden');
window.closeLeaderboard = () => { document.getElementById('leaderboardModal').classList.add('hidden'); document.getElementById('gameOverModal').classList.remove('hidden'); };
window.resetGame = () => location.reload();

// Info Modal fÃ¼llen
function populateGameInfoModal() {
    const list = document.getElementById('infoCategoryList');
    if (!list) return;
    
    // Add descriptions map
    const descriptions = {
        dk: "MaÃŸ fÃ¼r die natÃ¼rliche WiderstandsfÃ¤higkeit des Holzes gegen Pilze und Insekten (DK 1 = sehr dauerhaft, DK 5 = wenig dauerhaft). Im Spiel gewinnt der niedrigere DK-Wert.",
        haerte: "Widerstand des Holzes gegen zusammendrÃ¼ckende Lasten; hohe Werte bedeuten hohe Belastbarkeit. Im Spiel gewinnt der hÃ¶chste Wert.",
        quellenSchwindenRadial: "MaÃŸ fÃ¼r DimensionsÃ¤nderungen bei Feuchtewechsel; kleine Werte bedeuten hÃ¶here FormstabilitÃ¤t. Im Spiel gewinnt der niedrigste Wert.",
        dichte: "Masse pro Volumen; hÃ¶here Dichte geht oft mit grÃ¶ÃŸerer HÃ¤rte und TragfÃ¤higkeit einher. Im Spiel gewinnt der hÃ¶chste Wert.",
        gewicht: "ElastizitÃ¤tsmodul als MaÃŸ fÃ¼r Steifigkeit; hohe Werte bedeuten geringere Durchbiegung. Im Spiel gewinnt der hÃ¶chste Wert."
    };

    let html = '';
    const order = ['dk', 'haerte', 'quellenSchwindenRadial', 'dichte', 'gewicht'];
    for (const key of order) {
        const info = attributeInfo[key];
        const isBetter = info.logic === 'Hoch gewinnt';
        const desc = descriptions[key] || '';
        html += `
            <div class="p-3 rounded-xl border-2 ${isBetter ? 'border-green-400 bg-green-50' : 'border-blue-400/80 bg-blue-50/50'}">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-lg font-bold text-gray-800">${info.icon} ${info.name}</span>
                    <span class="text-sm font-semibold ${isBetter ? 'text-green-700' : 'text-blue-700'}">
                        ${isBetter ? 'â¬† Hoch gewinnt' : 'â¬‡ Niedrig gewinnt'}
                    </span>
                </div>
                <p class="text-xs text-gray-600 mt-1 leading-relaxed">${desc}</p>
            </div>`;
    }
    list.innerHTML = html;
    document.getElementById('gameInfoModal').classList.remove('hidden');
};

// Listeners
document.getElementById('bsInfoBtn').addEventListener('click', ()=>{ 
    const wood = lastRoundWinningWoodName || (aiGame.currentPlayerCard ? aiGame.currentPlayerCard.name : "Eiche");
    const content = detailedWoodInfo[wood] || `<p>Keine Detailinfo zu ${wood}</p>`;
    // Clean name for AI/Logic (remove emoji if needed, but keeping for display)
    const cleanWoodName = wood.replace(/^[^\w\u00C0-\u00FF]+/, '').trim(); 

    const modalContent = document.getElementById('infoModalContent');
    modalContent.innerHTML = `<h4 class="font-bold text-xl mb-2">${wood}</h4>` + content;
    
    // Updated Logic: Dual Coding (Bild + Text)
    const cardData = woodCards.find(c=>c.name===wood);
    if(cardData) {
        // Fallback fÃ¼r fehlende Bilder sicherstellen
        const img1 = cardData.imgTree || 'https://placehold.co/400x300?text=Bild+fehlt';
        const img2 = cardData.imgCross || 'https://placehold.co/400x300?text=Detail+fehlt';
        
        modalContent.innerHTML += `
            <div class="grid grid-cols-2 gap-3 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Maserung</p>
                    <img src="${img1}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Detailansicht</p>
                    <img src="${img2}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                </div>
            </div>`;
    }

    // âœ¨ KI-Feature: Experten-Wissen UI (Updated)
    const aiSection = document.createElement('div');
    aiSection.className = "mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl";
    aiSection.innerHTML = `
        <h5 class="font-bold text-amber-800 text-sm mb-2 flex items-center gap-2">ğŸ¤– Experten-Wissen (KI)</h5>
        <div id="aiOutput" class="ai-chat-bubble text-gray-700 bg-white shadow-sm min-h-[40px] text-sm">
            Stelle eine fachliche Frage zu ${cleanWoodName} oder nutze die VorschlÃ¤ge.
        </div>
        <div class="flex gap-2 mt-3 overflow-x-auto pb-1 hide-scrollbar">
            <button class="bg-white border border-amber-300 text-amber-800 text-xs px-3 py-1 rounded-full whitespace-nowrap hover:bg-amber-100 transition" onclick="window.triggerAiQuestion('${cleanWoodName}', 'Nenne eine konkrete, fachgerechte Projektidee fÃ¼r dieses Holz mit einem kurzen Hinweis zur Konstruktion.')">ğŸ”¨ Verwendung & Projekte</button>
            <button class="bg-white border border-amber-300 text-amber-800 text-xs px-3 py-1 rounded-full whitespace-nowrap hover:bg-amber-100 transition" onclick="window.triggerAiQuestion('${cleanWoodName}', 'Nenne ein interessantes, wenig bekanntes fachliches oder historisches Detail zu diesem Holz (Trivia).')">ğŸ’¡ Besonderheiten</button>
            <button class="bg-white border border-amber-300 text-amber-800 text-xs px-3 py-1 rounded-full whitespace-nowrap hover:bg-amber-100 transition" onclick="window.triggerAiQuestion('${cleanWoodName}', 'Wo wÃ¤chst dieses Holz hauptsÃ¤chlich und was sind die botanischen Besonderheiten?')">ğŸŒ Vorkommen & Botanik</button>
        </div>
        <div class="flex gap-2 mt-2">
            <input type="text" id="aiInput" class="flex-grow text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Eigene Frage (z.B. Bearbeitung)...">
            <button id="aiSendBtn" class="bg-amber-600 text-white p-2 rounded-lg hover:bg-amber-700 transition" onclick="window.triggerAiCustom('${cleanWoodName}')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
        </div>
    `;
    modalContent.appendChild(aiSection);
    
    document.getElementById('infoModal').classList.remove('hidden');
});

document.getElementById('bsNextBtn').addEventListener('click',()=> { closeBottomSheet(); window.nextRound(); });

// --- NEU: Event Listener fÃ¼r die Einstellungen (Sound & Sichtbarkeit) ---
const sToggle = document.getElementById('soundToggle');
const rToggle = document.getElementById('revealBackToggle');

if(sToggle) {
    sToggle.checked = !isMuted; // isMuted default false -> Toggle an (true)
    sToggle.addEventListener('change', (e) => {
        isMuted = !e.target.checked;
    });
}

if(rToggle) {
    rToggle.checked = isOpponentNameBackVisible();
    rToggle.addEventListener('change', (e) => {
        setOpponentNameBackVisible(e.target.checked);
        // Sofortiges Update der UI, falls das Spiel schon lÃ¤uft
        if(gameMode === 'ai' && !document.getElementById('gameContainer').classList.contains('hidden')) {
            updateDisplayAI();
        } else if (gameMode === 'multiplayer' && localGameState && !document.getElementById('gameContainer').classList.contains('hidden')) {
            // Im Multiplayer ist es etwas komplexer, da wir auf den nÃ¤chsten Snapshot warten mÃ¼ssten.
            // Ein lokaler Re-Render der Karten reicht aber fÃ¼r die Sichtbarkeit.
            const oppId = localGameState.playerIds.find(id => id !== localPlayerId);
            if(oppId && localGameState.currentCards[oppId]) {
                 const ac = document.getElementById('aiCard');
                 ac.innerHTML='';
                 // Re-Create opponent card with new visibility setting
                 ac.appendChild(createCard(localGameState.currentCards[oppId], false, false, !(localGameState.turn === localPlayerId), localGameState.lastResult?.attribute));
            }
        }
    });
}
// -----------------------------------------------------------------------

const p=new URLSearchParams(window.location.search);
if(p.get('game')){ 
    document.getElementById('setupModal').classList.add('hidden');
    gameId=p.get('game'); 
    window.showNamePrompt('join'); 
}
</script>
</body>
</html>
