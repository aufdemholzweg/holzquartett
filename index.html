<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Holz-Quartett</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 300;
        }

        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .card-back {
            transform: rotateY(180deg);
            background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');
            background-size: cover;
            background-position: center;
        }

        .wood-texture {
            background: linear-gradient(45deg, #8B4513 25%, transparent 25%),
                        linear-gradient(-45deg, #8B4513 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #8B4513 75%),
                        linear-gradient(-45deg, transparent 75%, #8B4513 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #D2B48C;
            opacity: 0.1;
        }

        .animate-pop-in {
            animation: pop-in 0.5s ease-out forwards;
        }

        .animate-glow-win {
            animation: glow-win 1.2s ease-out;
        }

        .animate-glow-lose {
            animation: glow-lose 1.2s ease-out;
        }

        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }

        @keyframes glow-win {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } /* green-400 */
            50% { box-shadow: 0 0 30px 15px rgba(74, 222, 128, 0.6); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }

        @keyframes glow-lose {
            0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); } /* red-400 */
            50% { box-shadow: 0 0 30px 15px rgba(248, 113, 113, 0.6); }
            100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); }
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .status-flash-win {
            animation: flash-green 1.2s ease-out;
        }
        .status-flash-lose {
            animation: flash-red 1.2s ease-out;
        }

        @keyframes flash-green {
          50% { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; }
        }
        @keyframes flash-red {
          50% { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; }
        }

        .falling-star {
            position: absolute;
            font-size: 7rem; /* 112px */
            z-index: 100;
            animation: fall-and-fade 1.2s ease-in forwards;
        }

        @keyframes fall-and-fade {
            0% { transform: translateY(-30px) scale(1.5); opacity: 0; }
            30% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(var(--end-y)) scale(0.3); opacity: 0; }
        }
        .card-background {
            background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">

    <div id="splashScreen" class="fixed inset-0 z-[100] flex items-start justify-center transition-opacity duration-700 ease-out bg-white">
        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');"></div>

        <div class="absolute inset-0 bg-black bg-opacity-30"></div>

        <div class="relative text-center animate-pop-in mt-32" style="animation-duration: 1.2s;">

            <h1 class="text-4xl sm:text-5xl font-bold text-white" style="text-shadow: 2px 2px 10px rgba(0,0,0,0.6);">
                üå≥ HOLZEN! üå≥
            </h1>
            <p class="text-xl text-amber-100 mt-2" style="text-shadow: 1px 1px 6px rgba(0,0,0,0.5);">
                Holz ist Trumpf
            </p>

        </div>
    </div>
    <header class="bg-white shadow-sm border-b-2 border-amber-200">
        <div class="max-w-6xl mx-auto px-4 p-3 relative">

            <button onclick="window.resetGame()" 
                    class="absolute top-3 left-4 text-3xl text-gray-400 hover:text-amber-600 transition-colors z-20" 
                    title="Spiel neustarten">
                ‚ò∞
            </button>

            <h1 class="text-2xl font-bold text-amber-800 text-center">üå≥ HOLZEN! üå≥</h1>
            <p class="text-xs text-gray-500 text-center mt-1">C.Lehr, in Verbindung mit meiner Abschlussarbeit</p>
        </div>
    </header>

    <div id="setupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
            <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
            <div class="space-y-4">
                <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">
                    üéÆ gegen Computer
                </button>
                <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">
                    üßë‚Äçü§ù‚Äçüßë online gegen Freunde
                </button>
            </div>

            <div class="mt-6 flex items-center justify-center space-x-2">
                <span class="text-gray-700">üîá </span>
                <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="soundToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                </label>
                <span class="text-gray-700"> üîä</span>
            </div>
            </div>
    </div>

    <div id="nameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Dein Name</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bitte gib deinen Namen ein:</label>
                    <input type="text" id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Spielername">
                </div>
                <button id="nameSubmitButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    Weiter
                </button>
            </div>
        </div>
    </div>

    <div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
            <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler...</h2>
            <p id="lobbyText" class="text-gray-700 mb-6">Teile diesen Link mit deinem Freund, um das Spiel zu starten:</p>
            <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
                <input id="shareLink" type="text" class="w-full bg-transparent text-center text-blue-600" readonly>
            </div>
            <button onclick="window.copyShareLink()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                Link kopieren
            </button>

            <div id="qrCodeContainer" class="mt-4 flex justify-center">
                </div>

            <p id="lobbyStatus" class="mt-6 text-green-600 font-semibold"></p>
        </div>
    </div>


    <div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4 relative">
        <div id="animationContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
        <div class="max-w-md mx-auto mb-1 space-y-1"> <div class="flex justify-center space-x-2">
                <div id="playerScoreBox" class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center relative">
                    <p id="playerNameDisplay" class="text-base font-bold text-amber-600 truncate"></p>
                    <p class="text-sm text-gray-500">Karten: <span id="playerCards" class="font-semibold">15</span></p>
                </div>
                <div class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center">
                    <p id="opponentNameDisplay" class="text-base font-bold text-red-600">Computer</p>
                    <p class="text-sm text-gray-500">Karten: <span id="aiCards" class="font-semibold">15</span></p>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden border border-gray-300">
                <div id="statusBar" class="h-full rounded-l-full transition-all duration-500" style="width: 50%; background-color: #f59e0b;"></div>
                <div class="absolute inset-0 flex justify-center items-center">
                    <div class="w-0.5 h-full bg-white opacity-75"></div>
                </div>
            </div>
        </div>

        <div class="flex justify-center space-x-2 sm:space-x-2 mb-4 max-w-md mx-auto">
            <div class="text-center w-1/2">
                <div id="playerCard" class="relative aspect-[20/38] perspective-1000"></div>
            </div>
            <div class="text-center w-1/2">
                <div id="aiCard" class="relative aspect-[20/38] perspective-1000"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg px-1 pt-1 pb-0.5 mt-4 text-center mx-auto flex flex-col items-center max-w-md w-full min-h-[6rem]">
             <div id="turnIndicator" class="hidden text-sm font-semibold p-1"></div>
            <div id="attributeSelection" class="">
                 <h3 class="text-base font-semibold text-gray-700 mb-1">W√§hle eine Eigenschaft!</h3>
            </div>
            <div id="resultDisplay" class="hidden flex flex-col flex-grow w-full px-2">
                 <h3 id="resultText" class="text-lg sm:text-xl font-bold"></h3>
                 <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mt-auto pb-0.5"></p>
            </div>
             <div id="nextRoundButton" class="hidden w-full mt-2">
                 <button onclick="window.nextRound()" class="w-full bg-amber-600 hover:bg-amber-800 text-white font-bold py-3 px-8 rounded-xl transition-colors">
                     ‚û°Ô∏è N√§chster Zug
                 </button>
             </div>
        </div>
    </div>

    <div id="reflectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
            <h2 class="text-2xl font-bold text-amber-800 mb-4">üéâ Super gespielt! Zeit zum Reflektieren!</h2>
            <p id="reflectionQuestion" class="text-gray-700 mb-6 text-left"></p>
            <textarea id="reflectionAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent min-h-[100px]" placeholder="Deine Begr√ºndung..."></textarea>
            <button onclick="window.showFinalWinScreen()" class="mt-6 w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">
                Weiter zum Ergebnis
            </button>
        </div>
    </div>

    <div id="gameOverModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
            <h2 id="gameOverTitle" class="text-3xl font-bold mb-3"></h2>
            <p id="gameOverText" class="text-gray-600 mb-6"></p>
            <div class="space-y-2">
                <button onclick="window.showLeaderboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
                    üèÜ Bestenliste anzeigen
                </button>
                <button onclick="window.resetGame()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">
                    üîÑ Neues Spiel
                </button>
            </div>
        </div>
    </div>

    <div id="leaderboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">üèÜ Bestenliste</h2>
            <div id="leaderboardList" class="space-y-1 mb-6"></div>
            <button onclick="window.closeLeaderboard()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg">
                Schlie√üen
            </button>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 px-4">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl relative">
            <button onclick="window.closeInfoModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            <h2 id="infoModalTitle" class="text-2xl font-bold text-amber-800 mb-4">Wissenswertes</h2>
            <div id="infoModalContent" class="text-gray-700 space-y-2 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <script type="module">
        // ===== Firebase Imports =====
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===== Firebase Config =====
        const firebaseConfig = {
            apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI", // Consider securing this key
            authDomain: "holzquartett-3a177.firebaseapp.com",
            projectId: "holzquartett-3a177",
            storageBucket: "holzquartett-3a177.appspot.com",
            messagingSenderId: "1081595025073",
            appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
            measurementId: "G-HKLWFJE83K"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        // ===== Global State =====
        let gameMode = null;
        let gameId = null;
        let localPlayerId = null;
        let unsubscribeGame = null;
        let localGameState = {};
        let hasCopiedShareLink = false;
        let isMuted = false; 

        // ===== Sound Effects (Updated win sound URL) =====
        const sounds = {
            flip: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/cardflip.mp3?raw=true'),
            win: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
            chime: new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
            starWin: new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3') 
        };
        sounds.flip.volume = 0.5;
        sounds.win.volume = 0.4;
        sounds.chime.volume = 0.6;
        sounds.starWin.volume = 0.7;

        // ===== MODIFIED playSound function =====
        function playSound(sound) {
            if (isMuted) return; 
            sound.currentTime = 0; 
            sound.play().catch(e => console.log("Sound playback error:", e)); 
        }
        let roundSoundPlayed = false;

        // ===== Wood Data =====
        const woodCards = [ /* ... woodCards data ... */
            {name: "Eiche", dk: 2, haerte: 85, quellenSchwindenRadial: 4.0, dichte: 650, gewicht: 12000}, {name: "Buche", dk: 5, haerte: 80, quellenSchwindenRadial: 5.8, dichte: 720, gewicht: 14000}, {name: "Kiefer", dk: 3, haerte: 40, quellenSchwindenRadial: 3.5, dichte: 520, gewicht: 11000}, {name: "Fichte", dk: 4, haerte: 35, quellenSchwindenRadial: 3.6, dichte: 450, gewicht: 11000}, {name: "Tanne", dk: 4, haerte: 38, quellenSchwindenRadial: 3.5, dichte: 460, gewicht: 10000}, {name: "L√§rche", dk: 3, haerte: 55, quellenSchwindenRadial: 3.7, dichte: 590, gewicht: 12000}, {name: "Birke", dk: 5, haerte: 60, quellenSchwindenRadial: 5.4, dichte: 650, gewicht: 13000}, {name: "Ahorn", dk: 5, haerte: 75, quellenSchwindenRadial: 4.8, dichte: 630, gewicht: 12500}, {name: "Esche", dk: 5, haerte: 90, quellenSchwindenRadial: 4.9, dichte: 700, gewicht: 13000}, {name: "Kirsche", dk: 3, haerte: 70, quellenSchwindenRadial: 4.0, dichte: 600, gewicht: 11500}, {name: "Nussbaum", dk: 3, haerte: 65, quellenSchwindenRadial: 4.0, dichte: 640, gewicht: 12000}, {name: "Douglasie", dk: 3, haerte: 45, quellenSchwindenRadial: 3.5, dichte: 510, gewicht: 12000}, {name: "Zeder", dk: 2, haerte: 42, quellenSchwindenRadial: 2.8, dichte: 480, gewicht: 9500}, {name: "Mahagoni", dk: 2, haerte: 55, quellenSchwindenRadial: 3.0, dichte: 550, gewicht: 10500}, {name: "Teak", dk: 1, haerte: 60, quellenSchwindenRadial: 2.5, dichte: 650, gewicht: 11000}, {name: "Bambus", dk: 4, haerte: 50, quellenSchwindenRadial: 3.0, dichte: 400, gewicht: 18000}, {name: "Pappel", dk: 5, haerte: 25, quellenSchwindenRadial: 4.5, dichte: 380, gewicht: 9000}, {name: "Weide", dk: 5, haerte: 30, quellenSchwindenRadial: 4.0, dichte: 420, gewicht: 8000}, {name: "Linde", dk: 5, haerte: 35, quellenSchwindenRadial: 3.8, dichte: 530, gewicht: 9000}, {name: "Ulme", dk: 3, haerte: 75, quellenSchwindenRadial: 4.5, dichte: 680, gewicht: 11500}, {name: "Kastanie", dk: 2, haerte: 50, quellenSchwindenRadial: 3.5, dichte: 600, gewicht: 10000}, {name: "Robinie", dk: 1, haerte: 80, quellenSchwindenRadial: 3.0, dichte: 730, gewicht: 15000}, {name: "Hemlock", dk: 4, haerte: 40, quellenSchwindenRadial: 3.6, dichte: 500, gewicht: 10000}, {name: "Zypresse", dk: 2, haerte: 48, quellenSchwindenRadial: 3.0, dichte: 520, gewicht: 9000}, {name: "Redwood", dk: 2, haerte: 35, quellenSchwindenRadial: 2.8, dichte: 400, gewicht: 8500}, {name: "Hickory", dk: 3, haerte: 95, quellenSchwindenRadial: 5.5, dichte: 750, gewicht: 14000}, {name: "Wenge", dk: 2, haerte: 88, quellenSchwindenRadial: 3.8, dichte: 880, gewicht: 16000}, {name: "Zebrano", dk: 3, haerte: 70, quellenSchwindenRadial: 4.0, dichte: 750, gewicht: 13000}, {name: "Palisander", dk: 2, haerte: 82, quellenSchwindenRadial: 3.0, dichte: 850, gewicht: 16000}, {name: "Ebenholz", dk: 1, haerte: 98, quellenSchwindenRadial: 3.2, dichte: 1200, gewicht: 16500}
        ];
        const woodInfo = { /* ... woodInfo data ... */ };
        const reflectionQuestions = [ /* ... reflectionQuestions data ... */ ];
        const attributeInfo = { /* ... attributeInfo data ... */ };

        // --- Modified aiGame state ---

        let aiGame = { playerName: '', playerCards: [], aiCards: [], currentPlayerCard: null, currentAiCard: null, roundInProgress: false, turn: 'player' };

        // ===== Auth + Deep Link Join =====
        document.addEventListener('DOMContentLoaded', async () => {

            // --- START: SPLASH-SCREEN TIMER ---
            const splashScreen = document.getElementById('splashScreen');
            const setupModal = document.getElementById('setupModal');

            // 3-Sekunden-Timer
            setTimeout(() => {
                // 1. Splash-Screen sanft ausblenden
                splashScreen.classList.add('opacity-0');

                // 2. Warten, bis die Fade-Out-Animation (700ms) vorbei ist
                setTimeout(() => {
                    splashScreen.classList.add('hidden'); // Komplett verstecken

                    // 3. Setup-Modal (Spielmodus-Wahl) einblenden
                    setupModal.classList.remove('hidden');
                    setupModal.classList.add('flex'); // 'flex' macht es wieder sichtbar
                }, 700); // Diese Zeit muss zur 'duration-700' im splashScreen-HTML passen

            }, 3000); // 3 Sekunden (3000ms) Wartezeit
            // --- END: SPLASH-SCREEN TIMER ---


            // --- Restlicher Code (Firebase Auth etc.) ---
            try { await signInAnonymously(auth); } catch (e) { console.error("Firebase Auth Error:", e); }
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    localPlayerId = user.uid;
                    const urlParams = new URLSearchParams(window.location.search);
                    const gameIdFromUrl = urlParams.get('game');
                    if (gameIdFromUrl) {
                        gameId = gameIdFromUrl;
                        gameMode = 'multiplayer';
                        window.showNamePrompt('join');
                    }
                }
            });
           });
        window.addEventListener('beforeunload', async () => { /* ... beforeunload listener ... */
             if (gameMode === 'multiplayer' && gameId && localPlayerId) {
                 const gameRef = doc(db, "games", gameId);
                 const playerStatusPath = `players.${localPlayerId}.status`;
                 await updateDoc(gameRef, { [playerStatusPath]: "offline" }).catch(() => {});
             }
        });

        // ===== UI Control =====
        window.showNamePrompt = (mode) => { /* ... showNamePrompt function ... */
             document.getElementById('setupModal').classList.add('hidden');
            const nameModal = document.getElementById('nameModal');
            nameModal.classList.remove('hidden');
            const nameSubmitButton = document.getElementById('nameSubmitButton');
            const newButton = nameSubmitButton.cloneNode(true);
            nameSubmitButton.parentNode.replaceChild(newButton, nameSubmitButton);
            newButton.addEventListener('click', () => {
                const playerName = document.getElementById('playerName').value.trim();
                if (!playerName) { alert('Bitte gib deinen Namen ein!'); return; }
                nameModal.classList.add('hidden');
                if (mode === 'ai') { gameMode = 'ai'; startGameAI(playerName); }
                else if (mode === 'multiplayer') { gameMode = 'multiplayer'; createGame(playerName); }
                else if (mode === 'join') { joinGame(gameId, playerName); }
            });
        };
        window.copyShareLink = async () => { /* ... copyShareLink function ... */
             const linkInput = document.getElementById('shareLink');
             try { await navigator.clipboard.writeText(linkInput.value); }
             catch (err) { linkInput.select(); document.execCommand('copy'); }
             hasCopiedShareLink = true;
             const statusEl = document.getElementById('lobbyStatus');
             if (statusEl) statusEl.textContent = 'Link kopiert. Warte auf Mitspieler...';
             if (localGameState && (localGameState.status === 'playing' || localGameState.status === 'finished')) {
                 document.getElementById('multiplayerLobbyModal').classList.add('hidden');
                 document.getElementById('gameContainer').classList.remove('hidden');
                 updateMultiplayerUI(localGameState);
             }
        };

        // ===== Multiplayer Logic =====
        async function createGame(playerName) { /* ... createGame function ... */
             const lobbyModal = document.getElementById('multiplayerLobbyModal');
             lobbyModal.classList.remove('hidden');
             hasCopiedShareLink = false;
             gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
             const shareLinkInput = document.getElementById('shareLink');
             const baseUrl = window.location.href.split('?')[0];
             shareLinkInput.value = `${baseUrl}?game=${gameId}`;

             // FIXED: QR-Code generieren ‚Äì Canvas zuerst, dann Text
             const qrContainer = document.getElementById('qrCodeContainer');
             qrContainer.innerHTML = '';
             try {
                 if (!window.QRCode || !QRCode.toCanvas) {
                     console.error('QRCode-Bibliothek nicht geladen oder toCanvas nicht verf√ºgbar.');
                 } else {
                     const canvas = document.createElement('canvas');
                     QRCode.toCanvas(
                         canvas,
                         shareLinkInput.value,
                         {
                             width: 180,
                             margin: 1,
                             color: {
                                 dark: '#854d0e',
                                 light: '#ffffff'
                             }
                         },
                         function (err) {
                             if (err) {
                                 console.error("QR Code generation failed:", err);
                                 return;
                             }
                             canvas.style.borderRadius = '0.5rem'; // rounded-lg
                             canvas.style.border = '1px solid #f59e0b'; // border-amber-500
                             qrContainer.appendChild(canvas);
                         }
                     );
                 }
             } catch (err) {
                 console.error("Fehler beim Generieren des QR-Codes:", err);
             }

             const gameRef = doc(db, "games", gameId);
             const initialGameData = { gameId: gameId, status: 'waiting', playerIds: [localPlayerId], players: { [localPlayerId]: { name: playerName, cards: [], status: 'online' } }, createdAt: serverTimestamp() };
             try { await setDoc(gameRef, initialGameData); listenToGameChanges(); }
             catch (error) { console.error("Error creating game:", error); alert("Fehler beim Erstellen des Spiels."); }
        }
        async function joinGame(gameIdToJoin, playerName) { /* ... joinGame function ... */
             const gameRef = doc(db, "games", gameIdToJoin);
             try {
                 const gameSnap = await getDoc(gameRef);
                 if (gameSnap.exists() && gameSnap.data().status === 'waiting' && gameSnap.data().playerIds.length === 1) {
                     document.getElementById('lobbyTitle').textContent = "Spiel wird beigetreten...";
                     document.getElementById('lobbyText').textContent = "Moment, die Karten werden gemischt.";
                     document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
                     hasCopiedShareLink = true;
                     const shuffledCards = shuffleArray([...woodCards]);
                     const player1Id = gameSnap.data().playerIds[0];
                     const player1Cards = shuffledCards.slice(0, 15);
                     const player2Cards = shuffledCards.slice(15, 30);
                     const gameUpdateData = { status: 'playing', playerIds: [player1Id, localPlayerId], [`players.${localPlayerId}`]: { name: playerName, cards: player2Cards, status: 'online' }, [`players.${player1Id}.cards`]: player1Cards, turn: player1Id, currentCards: { [player1Id]: player1Cards[0], [localPlayerId]: player2Cards[0] }, lastResult: null, lastActivity: serverTimestamp() };
                     await updateDoc(gameRef, gameUpdateData);
                     listenToGameChanges();
                 } else { alert("Spiel nicht gefunden, bereits voll oder beendet."); window.location.search = ''; }
             } catch (error) { console.error("Error joining game:", error); alert("Fehler beim Beitreten zum Spiel."); window.location.search = ''; }
        }
        function listenToGameChanges() { /* ... listenToGameChanges function ... */
             if (!gameId) return;
            const gameRef = doc(db, "games", gameId);
            unsubscribeGame = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) { if(gameMode === 'multiplayer'){ alert("Das Spiel wurde beendet oder gel√∂scht."); resetGame(); } return; }
                const gameData = docSnap.data();
                localGameState = gameData;
                if (gameData.status === 'playing' || gameData.status === 'finished') {
                    if (hasCopiedShareLink || gameData.playerIds.includes(localPlayerId) && gameData.playerIds.length === 2) { document.getElementById('multiplayerLobbyModal').classList.add('hidden'); document.getElementById('gameContainer').classList.remove('hidden'); updateMultiplayerUI(gameData); }
                    else if (!hasCopiedShareLink && gameData.playerIds.length === 2){ const statusEl = document.getElementById('lobbyStatus'); if (statusEl) statusEl.textContent = 'Mitspieler ist beigetreten! Klicke ‚ÄûLink kopieren‚Äú, um zu starten.'; }
                } else if (gameData.status === 'waiting') { document.getElementById('multiplayerLobbyModal').classList.remove('hidden'); document.getElementById('gameContainer').classList.add('hidden'); }
                const opponentId = gameData.playerIds?.find(id => id !== localPlayerId);
                if (opponentId && gameData.players[opponentId]?.status === 'offline') { /* console.log('Opponent appears offline.'); */ }
            }, (error) => { console.error("Error listening to game changes:", error); });
        }
        // ... rest of script unchanged ...
    </script>
</body>
</html>
