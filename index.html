# Build the full game HTML with lobby page showing link, copy button, and QR code.
html = r"""<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Holz-Quartett</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QRCode UMD muss vor dem Modulskript geladen sein -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: 300; }
    .card-3d { transform-style: preserve-3d; transition: transform 0.6s; }
    .card-flipped { transform: rotateY(180deg); }
    .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; }
    .card-back {
      transform: rotateY(180deg);
      background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');
      background-size: cover; background-position: center;
    }
    .animate-pop-in { animation: pop-in 0.5s ease-out forwards; }
    .animate-glow-win { animation: glow-win 1.2s ease-out; }
    .animate-glow-lose { animation: glow-lose 1.2s ease-out; }
    @keyframes pop-in { 0%{transform:scale(0);opacity:0}70%{transform:scale(1.2);opacity:1}100%{transform:scale(1)} }
    @keyframes glow-win { 0%{box-shadow:0 0 0 0 rgba(74,222,128,0)}50%{box-shadow:0 0 30px 15px rgba(74,222,128,0.6)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)} }
    @keyframes glow-lose { 0%{box-shadow:0 0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 30px 15px rgba(248,113,113,0.6)}100%{box-shadow:0 0 0 0 rgba(248,113,113,0)} }
    .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .status-flash-win { animation: flash-green 1.2s ease-out; }
    .status-flash-lose { animation: flash-red 1.2s ease-out; }
    @keyframes flash-green { 50% { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; } }
    @keyframes flash-red { 50% { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; } }
    .falling-star { position: absolute; font-size: 7rem; z-index: 100; animation: fall-and-fade 1.2s ease-in forwards; }
    @keyframes fall-and-fade { 0%{transform:translateY(-30px) scale(1.5);opacity:0}30%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(var(--end-y)) scale(0.3);opacity:0} }
    .card-background {
      background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg');
      background-size: cover; background-position: center;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">

  <!-- Splash -->
  <div id="splashScreen" class="fixed inset-0 z-[100] flex items-start justify-center transition-opacity duration-700 ease-out bg-white">
    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');"></div>
    <div class="absolute inset-0 bg-black bg-opacity-30"></div>
    <div class="relative text-center animate-pop-in mt-32" style="animation-duration: 1.2s;">
      <h1 class="text-4xl sm:text-5xl font-bold text-white" style="text-shadow: 2px 2px 10px rgba(0,0,0,0.6);">üå≥ HOLZEN! üå≥</h1>
      <p class="text-xl text-amber-100 mt-2" style="text-shadow: 1px 1px 6px rgba(0,0,0,0.5);">Holz ist Trumpf</p>
    </div>
  </div>

  <header class="bg-white shadow-sm border-b-2 border-amber-200">
    <div class="max-w-6xl mx-auto px-4 p-3 relative">
      <button onclick="window.resetGame()" class="absolute top-3 left-4 text-3xl text-gray-400 hover:text-amber-600 transition-colors z-20" title="Spiel neustarten">‚ò∞</button>
      <h1 class="text-2xl font-bold text-amber-800 text-center">üå≥ HOLZEN! üå≥</h1>
      <p class="text-xs text-gray-500 text-center mt-1">C.Lehr, in Verbindung mit meiner Abschlussarbeit</p>
    </div>
  </header>

  <!-- Setup -->
  <div id="setupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
      <div class="space-y-4">
        <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üéÆ gegen Computer</button>
        <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üßë‚Äçü§ù‚Äçüßë online gegen Freunde</button>
      </div>
      <div class="mt-6 flex items-center justify-center space-x-2">
        <span class="text-gray-700">üîá </span>
        <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="soundToggle" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
        </label>
        <span class="text-gray-700"> üîä</span>
      </div>
    </div>
  </div>

  <!-- Name -->
  <div id="nameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Dein Name</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Bitte gib deinen Namen ein:</label>
          <input type="text" id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Spielername">
        </div>
        <button id="nameSubmitButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">Weiter</button>
      </div>
    </div>
  </div>

  <!-- Lobby: Link + Button + QR -->
  <div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
      <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler...</h2>
      <p id="lobbyText" class="text-gray-700 mb-4">Teile diesen Link oder den QR-Code:</p>

      <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
        <input id="shareLink" type="text" class="w-full bg-transparent text-center text-blue-600" readonly>
      </div>
      <button onclick="window.copyShareLink()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">Link kopieren</button>

      <div id="qrCodeContainer" class="mt-5 flex justify-center"></div>

      <p id="lobbyStatus" class="mt-6 text-green-600 font-semibold"></p>
    </div>
  </div>

  <!-- Game UI -->
  <div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4 relative">
    <div id="animationContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
    <div class="max-w-md mx-auto mb-1 space-y-1">
      <div class="flex justify-center space-x-2">
        <div id="playerScoreBox" class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center relative">
          <p id="playerNameDisplay" class="text-base font-bold text-amber-600 truncate"></p>
          <p class="text-sm text-gray-500">Karten: <span id="playerCards" class="font-semibold">15</span></p>
        </div>
        <div class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center">
          <p id="opponentNameDisplay" class="text-base font-bold text-red-600">Computer</p>
          <p class="text-sm text-gray-500">Karten: <span id="aiCards" class="font-semibold">15</span></p>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden border border-gray-300">
        <div id="statusBar" class="h-full rounded-l-full transition-all duration-500" style="width: 50%; background-color: #f59e0b;"></div>
        <div class="absolute inset-0 flex justify-center items-center"><div class="w-0.5 h-full bg-white opacity-75"></div></div>
      </div>
    </div>

    <div class="flex justify-center space-x-2 sm:space-x-2 mb-4 max-w-md mx-auto">
      <div class="text-center w-1/2"><div id="playerCard" class="relative aspect-[20/38] perspective-1000"></div></div>
      <div class="text-center w-1/2"><div id="aiCard" class="relative aspect-[20/38] perspective-1000"></div></div>
    </div>

    <div class="bg-white rounded-xl shadow-lg px-1 pt-1 pb-0.5 mt-4 text-center mx-auto flex flex-col items-center max-w-md w-full min-h-[6rem]">
      <div id="turnIndicator" class="hidden text-sm font-semibold p-1"></div>
      <div id="attributeSelection"><h3 class="text-base font-semibold text-gray-700 mb-1">W√§hle eine Eigenschaft!</h3></div>
      <div id="resultDisplay" class="hidden flex flex-col flex-grow w-full px-2">
        <h3 id="resultText" class="text-lg sm:text-xl font-bold"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mt-auto pb-0.5"></p>
      </div>
      <div id="nextRoundButton" class="hidden w-full mt-2">
        <button onclick="window.nextRound()" class="w-full bg-amber-600 hover:bg-amber-800 text-white font-bold py-3 px-8 rounded-xl transition-colors">‚û°Ô∏è N√§chster Zug</button>
      </div>
    </div>
  </div>

  <!-- Reflection / GameOver / Leaderboard -->
  <div id="reflectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-amber-800 mb-4">üéâ Super gespielt! Zeit zum Reflektieren!</h2>
      <p id="reflectionQuestion" class="text-gray-700 mb-6 text-left">Reflexion: Warum hast du dieses Holz gew√§hlt?</p>
      <textarea id="reflectionAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent min-h-[100px]" placeholder="Deine Begr√ºndung..."></textarea>
      <button onclick="window.showFinalWinScreen()" class="mt-6 w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">Weiter zum Ergebnis</button>
    </div>
  </div>

  <div id="gameOverModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 id="gameOverTitle" class="text-3xl font-bold mb-3"></h2>
      <p id="gameOverText" class="text-gray-600 mb-6"></p>
      <div class="space-y-2">
        <button onclick="window.showLeaderboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">üèÜ Bestenliste anzeigen</button>
        <button onclick="window.resetGame()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">üîÑ Neues Spiel</button>
      </div>
    </div>
  </div>

  <div id="leaderboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">üèÜ Bestenliste</h2>
      <div id="leaderboardList" class="space-y-1 mb-6"></div>
      <button onclick="window.closeLeaderboard()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg">Schlie√üen</button>
    </div>
  </div>

  <!-- App -->
  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
      authDomain: "holzquartett-3a177.firebaseapp.com",
      projectId: "holzquartett-3a177",
      storageBucket: "holzquartett-3a177.appspot.com",
      messagingSenderId: "1081595025073",
      appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
      measurementId: "G-HKLWFJE83K"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // State
    let gameMode = null;
    let gameId = null;
    let localPlayerId = null;
    let unsubscribeGame = null;
    let localGameState = {};
    let hasCopiedShareLink = false;
    let isMuted = false;
    let roundSoundPlayed = false;

    // Sounds
    const sounds = {
      flip: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
      win: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
      chime: new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
      starWin: new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
    };
    function playSound(s) { if (isMuted) return; s.currentTime = 0; s.play().catch(()=>{}); }

    // Data
    const woodCards = [
      {name: "Eiche", dk: 2, haerte: 85, quellenSchwindenRadial: 4.0, dichte: 650, gewicht: 12000},
      {name: "Buche", dk: 5, haerte: 80, quellenSchwindenRadial: 5.8, dichte: 720, gewicht: 14000},
      {name: "Kiefer", dk: 3, haerte: 40, quellenSchwindenRadial: 3.5, dichte: 520, gewicht: 11000},
      {name: "Fichte", dk: 4, haerte: 35, quellenSchwindenRadial: 3.6, dichte: 450, gewicht: 11000},
      {name: "Tanne", dk: 4, haerte: 38, quellenSchwindenRadial: 3.5, dichte: 460, gewicht: 10000},
      {name: "L√§rche", dk: 3, haerte: 55, quellenSchwindenRadial: 3.7, dichte: 590, gewicht: 12000},
      {name: "Birke", dk: 5, haerte: 60, quellenSchwindenRadial: 5.4, dichte: 650, gewicht: 13000},
      {name: "Ahorn", dk: 5, haerte: 75, quellenSchwindenRadial: 4.8, dichte: 630, gewicht: 12500},
      {name: "Esche", dk: 5, haerte: 90, quellenSchwindenRadial: 4.9, dichte: 700, gewicht: 13000},
      {name: "Kirsche", dk: 3, haerte: 70, quellenSchwindenRadial: 4.0, dichte: 600, gewicht: 11500},
      {name: "Nussbaum", dk: 3, haerte: 65, quellenSchwindenRadial: 4.0, dichte: 640, gewicht: 12000},
      {name: "Douglasie", dk: 3, haerte: 45, quellenSchwindenRadial: 3.5, dichte: 510, gewicht: 12000},
      {name: "Zeder", dk: 2, haerte: 42, quellenSchwindenRadial: 2.8, dichte: 480, gewicht: 9500},
      {name: "Mahagoni", dk: 2, haerte: 55, quellenSchwindenRadial: 3.0, dichte: 550, gewicht: 10500},
      {name: "Teak", dk: 1, haerte: 60, quellenSchwindenRadial: 2.5, dichte: 650, gewicht: 11000},
      {name: "Bambus", dk: 4, haerte: 50, quellenSchwindenRadial: 3.0, dichte: 400, gewicht: 18000},
      {name: "Pappel", dk: 5, haerte: 25, quellenSchwindenRadial: 4.5, dichte: 380, gewicht: 9000},
      {name: "Weide", dk: 5, haerte: 30, quellenSchwindenRadial: 4.0, dichte: 420, gewicht: 8000},
      {name: "Linde", dk: 5, haerte: 35, quellenSchwindenRadial: 3.8, dichte: 530, gewicht: 9000},
      {name: "Ulme", dk: 3, haerte: 75, quellenSchwindenRadial: 4.5, dichte: 680, gewicht: 11500},
      {name: "Kastanie", dk: 2, haerte: 50, quellenSchwindenRadial: 3.5, dichte: 600, gewicht: 10000},
      {name: "Robinie", dk: 1, haerte: 80, quellenSchwindenRadial: 3.0, dichte: 730, gewicht: 15000},
      {name: "Hemlock", dk: 4, haerte: 40, quellenSchwindenRadial: 3.6, dichte: 500, gewicht: 10000},
      {name: "Zypresse", dk: 2, haerte: 48, quellenSchwindenRadial: 3.0, dichte: 520, gewicht: 9000},
      {name: "Redwood", dk: 2, haerte: 35, quellenSchwindenRadial: 2.8, dichte: 400, gewicht: 8500},
      {name: "Hickory", dk: 3, haerte: 95, quellenSchwindenRadial: 5.5, dichte: 750, gewicht: 14000},
      {name: "Wenge", dk: 2, haerte: 88, quellenSchwindenRadial: 3.8, dichte: 880, gewicht: 16000},
      {name: "Zebrano", dk: 3, haerte: 70, quellenSchwindenRadial: 4.0, dichte: 750, gewicht: 13000},
      {name: "Palisander", dk: 2, haerte: 82, quellenSchwindenRadial: 3.0, dichte: 850, gewicht: 16000},
      {name: "Ebenholz", dk: 1, haerte: 98, quellenSchwindenRadial: 3.2, dichte: 1200, gewicht: 16500}
    ];

    const attributeInfo = {
      dk: {icon: 'üõ°Ô∏è', name: 'Dauerhaftigkeit (DK)', color: 'blue'},
      haerte: {icon: 'üíé', name: 'Druckfestigkeit (N/mm¬≤)', color: 'blue'},
      quellenSchwindenRadial: {icon: '‚ÜîÔ∏è', name: 'Quellen/Schwinden (%)', color: 'blue'},
      dichte: {icon: '‚öñÔ∏è', name: 'Rohdichte (kg/m¬≥)', color: 'blue'},
      gewicht: {icon: 'üèãÔ∏è', name: 'E-Modul (N/mm¬≤)', color: 'blue'}
    };

    // AI mode state
    let aiGame = { playerName: '', playerCards: [], aiCards: [], currentPlayerCard: null, currentAiCard: null, roundInProgress: false, turn: 'player' };

    // Boot
    document.addEventListener('DOMContentLoaded', async () => {
      const splash = document.getElementById('splashScreen');
      const setup = document.getElementById('setupModal');
      setTimeout(() => { splash.classList.add('opacity-0'); setTimeout(()=>{ splash.classList.add('hidden'); setup.classList.remove('hidden'); setup.classList.add('flex'); }, 700); }, 1400);

      try { await signInAnonymously(auth); } catch {}
      onAuthStateChanged(auth, (user) => {
        if (user) {
          localPlayerId = user.uid;
          const urlParams = new URLSearchParams(window.location.search);
          const gameIdFromUrl = urlParams.get('game');
          if (gameIdFromUrl) {
            gameId = gameIdFromUrl;
            gameMode = 'multiplayer';
            window.showNamePrompt('join');
          }
        }
      });
    });

    window.addEventListener('beforeunload', async () => {
      if (gameMode === 'multiplayer' && gameId && localPlayerId) {
        const gameRef = doc(db, "games", gameId);
        const playerStatusPath = `players.${localPlayerId}.status`;
        await updateDoc(gameRef, { [playerStatusPath]: "offline" }).catch(() => {});
      }
    });

    // UI Control
    window.showNamePrompt = (mode) => {
      document.getElementById('setupModal').classList.add('hidden');
      const nameModal = document.getElementById('nameModal');
      nameModal.classList.remove('hidden');
      const nameSubmitButton = document.getElementById('nameSubmitButton');
      const newButton = nameSubmitButton.cloneNode(true);
      nameSubmitButton.parentNode.replaceChild(newButton, nameSubmitButton);
      newButton.addEventListener('click', () => {
        const playerName = document.getElementById('playerName').value.trim();
        if (!playerName) { alert('Bitte gib deinen Namen ein!'); return; }
        nameModal.classList.add('hidden');
        if (mode === 'ai') { gameMode = 'ai'; startGameAI(playerName); }
        else if (mode === 'multiplayer') { gameMode = 'multiplayer'; createGame(playerName); }
        else if (mode === 'join') { joinGame(gameId, playerName); }
      });
    };

    window.copyShareLink = async () => {
      const linkInput = document.getElementById('shareLink');
      try { await navigator.clipboard.writeText(linkInput.value); }
      catch { linkInput.select(); document.execCommand('copy'); }
      hasCopiedShareLink = true;
      const statusEl = document.getElementById('lobbyStatus');
      if (statusEl) statusEl.textContent = 'Link kopiert. Warte auf Mitspieler...';
      if (localGameState && (localGameState.status === 'playing' || localGameState.status === 'finished')) {
        document.getElementById('multiplayerLobbyModal').classList.add('hidden');
        document.getElementById('gameContainer').classList.remove('hidden');
        updateMultiplayerUI(localGameState);
      }
    };

    // Multiplayer
    async function createGame(playerName) {
      const lobbyModal = document.getElementById('multiplayerLobbyModal');
      lobbyModal.classList.remove('hidden');
      hasCopiedShareLink = false;

      gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
      const shareLinkInput = document.getElementById('shareLink');
      const baseUrl = window.location.href.split('?')[0];
      shareLinkInput.value = `${baseUrl}?game=${gameId}`;

      // QR: Link + Button + QR rendern
      const qrContainer = document.getElementById('qrCodeContainer');
      qrContainer.innerHTML = '';
      try {
        if (!window.QRCode || !window.QRCode.toCanvas) {
          console.error('QRCode-Bibliothek nicht geladen oder toCanvas nicht verf√ºgbar.');
        } else {
          const canvas = document.createElement('canvas');
          window.QRCode.toCanvas(
            canvas,
            shareLinkInput.value,
            { width: 220, margin: 1, color: { dark: '#111827', light: '#ffffff' } },
            function (err) {
              if (err) { console.error("QR Code generation failed:", err); return; }
              canvas.style.borderRadius = '12px';
              canvas.style.border = '1px solid #e5e7eb';
              qrContainer.appendChild(canvas);
            }
          );
        }
      } catch (err) { console.error("Fehler beim Generieren des QR-Codes:", err); }

      const gameRef = doc(db, "games", gameId);
      const initialGameData = {
        gameId, status: 'waiting', playerIds: [localPlayerId],
        players: { [localPlayerId]: { name: playerName, cards: [], status: 'online' } },
        createdAt: serverTimestamp()
      };
      try { await setDoc(gameRef, initialGameData); listenToGameChanges(); }
      catch (error) { console.error("Error creating game:", error); alert("Fehler beim Erstellen des Spiels."); }
    }

    async function joinGame(gameIdToJoin, playerName) {
      const gameRef = doc(db, "games", gameIdToJoin);
      try {
        const gameSnap = await getDoc(gameRef);
        if (gameSnap.exists() && gameSnap.data().status === 'waiting' && gameSnap.data().playerIds.length === 1) {
          document.getElementById('lobbyTitle').textContent = "Spiel wird beigetreten...";
          document.getElementById('lobbyText').textContent = "Moment, die Karten werden gemischt.";
          document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
          hasCopiedShareLink = true;

          const shuffledCards = shuffleArray([...woodCards]);
          const player1Id = gameSnap.data().playerIds[0];
          const player1Cards = shuffledCards.slice(0, 15);
          const player2Cards = shuffledCards.slice(15, 30);

          const gameUpdateData = {
            status: 'playing',
            playerIds: [player1Id, localPlayerId],
            [`players.${localPlayerId}`]: { name: playerName, cards: player2Cards, status: 'online' },
            [`players.${player1Id}.cards`]: player1Cards,
            turn: player1Id,
            currentCards: { [player1Id]: player1Cards[0], [localPlayerId]: player2Cards[0] },
            lastResult: null,
            lastActivity: serverTimestamp()
          };
          await updateDoc(gameRef, gameUpdateData);
          listenToGameChanges();
        } else { alert("Spiel nicht gefunden, bereits voll oder beendet."); window.location.search = ''; }
      } catch (error) { console.error("Error joining game:", error); alert("Fehler beim Beitreten zum Spiel."); window.location.search = ''; }
    }

    function listenToGameChanges() {
      if (!gameId) return;
      const gameRef = doc(db, "games", gameId);
      unsubscribeGame = onSnapshot(gameRef, (docSnap) => {
        if (!docSnap.exists()) { if(gameMode === 'multiplayer'){ alert("Das Spiel wurde beendet oder gel√∂scht."); resetGame(); } return; }
        const gameData = docSnap.data();
        localGameState = gameData;

        if (gameData.status === 'playing' || gameData.status === 'finished') {
          if (hasCopiedShareLink || gameData.playerIds.includes(localPlayerId) && gameData.playerIds.length === 2) {
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            updateMultiplayerUI(gameData);
          } else if (!hasCopiedShareLink && gameData.playerIds.length === 2) {
            const statusEl = document.getElementById('lobbyStatus');
            if (statusEl) statusEl.textContent = 'Mitspieler ist beigetreten! Klicke ‚ÄûLink kopieren‚Äú, um zu starten.';
          }
        } else if (gameData.status === 'waiting') {
          document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
          document.getElementById('gameContainer').classList.add('hidden');
        }
      }, (error) => { console.error("Error listening to game changes:", error); });
    }

    function updateMultiplayerUI(gameData) {
      if (!gameData || !gameData.players || !gameData.playerIds) { console.error("Incomplete game data received:", gameData); return; }
      const opponentId = gameData.playerIds.find(id => id !== localPlayerId);
      document.getElementById('playerNameDisplay').textContent = gameData.players[localPlayerId]?.name || 'Du';
      document.getElementById('playerCards').textContent = gameData.players[localPlayerId]?.cards?.length ?? '?';
      if (opponentId && gameData.players[opponentId]) {
        document.getElementById('opponentNameDisplay').textContent = gameData.players[opponentId].name;
        document.getElementById('aiCards').textContent = gameData.players[opponentId].cards?.length ?? '?';
      } else {
        document.getElementById('opponentNameDisplay').textContent = "Wartet...";
        document.getElementById('aiCards').textContent = '-';
      }
      updateStatusBar(gameData.players[localPlayerId]?.cards?.length ?? 0, gameData.players[opponentId]?.cards?.length ?? 0);
      displayMultiplayerCards(gameData);

      const turnIndicator = document.getElementById('turnIndicator');
      const attributeSelection = document.getElementById('attributeSelection');
      const resultDisplay = document.getElementById('resultDisplay');
      const nextRoundBtn = document.getElementById('nextRoundButton');

      turnIndicator.classList.remove('hidden');
      if (gameData.lastResult) {
        if (!roundSoundPlayed) { roundSoundPlayed = true; playSound(sounds.flip); if (gameData.lastResult.winnerId === localPlayerId) { playSound(sounds.win); } }
        attributeSelection.classList.add('hidden');
        resultDisplay.classList.remove('hidden');
        nextRoundBtn.classList.remove('hidden');

        const { winnerId, attribute, values } = gameData.lastResult;
        const opponentActualId = opponentId || 'opponent';
        const winnerName = winnerId === localPlayerId ? 'Du' : (winnerId === 'tie' ? '' : gameData.players[winnerId]?.name || 'Gegner');
        let resultText = winnerId === 'tie' ? `ü§ù Unentschieden!` : `üéâ ${winnerName} gewinnt!`;
        if (winnerId !== localPlayerId && winnerId !== 'tie') { resultText = `üòû ${winnerName} gewinnt!`; }
        const resultDetailsText = `${attributeInfo[attribute]?.name.split(' (')[0] || attribute}: ${values[localPlayerId]?.toLocaleString('de-DE') ?? '?'} vs ${values[opponentActualId]?.toLocaleString('de-DE') ?? '?'}`;
        document.getElementById('resultText').textContent = resultText;
        document.getElementById('resultDetails').textContent = resultDetailsText;
      } else {
        roundSoundPlayed = false;
        resultDisplay.classList.add('hidden');
        nextRoundBtn.classList.add('hidden');
        if (gameData.turn === localPlayerId) { turnIndicator.textContent = "Du bist am Zug!"; turnIndicator.className = 'text-sm font-semibold p-1 text-green-600'; attributeSelection.classList.remove('hidden'); }
        else { turnIndicator.textContent = `${gameData.players[gameData.turn]?.name || 'Gegner'} ist am Zug...`; turnIndicator.className = 'text-sm font-semibold p-1 text-gray-500'; attributeSelection.classList.add('hidden'); }
      }

      if (gameData.status === 'finished') { endGame(); }
    }

    function updateStatusBar(playerCount, opponentCount) {
      const total = playerCount + opponentCount;
      const playerPercentage = total > 0 ? (playerCount / total) * 100 : 50;
      const statusBar = document.getElementById('statusBar');
      if (statusBar) {
        statusBar.style.width = `${playerPercentage}%`;
        let color = '#f59e0b';
        if (playerPercentage < 25) color = '#ef4444';
        else if (playerPercentage < 45) color = '#f97316';
        else if (playerPercentage > 75) color = '#22c55e';
        else if (playerPercentage > 55) color = '#84cc16';
        statusBar.style.backgroundColor = color;
      }
    }

    function displayMultiplayerCards(gameData) {
      if (!gameData.currentCards || !gameData.playerIds) return;
      const opponentId = gameData.playerIds.find(id => id !== localPlayerId);
      const playerCardContainer = document.getElementById('playerCard');
      const aiCardContainer = document.getElementById('aiCard');
      playerCardContainer.innerHTML = ''; aiCardContainer.innerHTML = '';
      const showOpponentCardFace = !!gameData.lastResult;

      if(gameData.currentCards[localPlayerId]) {
        const playerCard = createCard(gameData.currentCards[localPlayerId], true, true);
        playerCardContainer.appendChild(playerCard);
      } else {
        playerCardContainer.innerHTML = `<div class="card-front bg-gray-200 ...">Warte auf Karte...</div>`;
      }

      if (opponentId && gameData.currentCards[opponentId]) {
        const aiCard = createCard(gameData.currentCards[opponentId], showOpponentCardFace, false);
        aiCardContainer.appendChild(aiCard);
      } else if (gameData.playerIds.length < 2) {
        aiCardContainer.innerHTML = `<div class="card-front bg-gray-200 ...">Wartet auf Spieler 2...</div>`;
      } else {
        const dummy = { name: "Gegner", dk: '?', haerte: '?', quellenSchwindenRadial: '?', dichte: '?', gewicht: '?' };
        const aiCard = createCard(dummy, false, false);
        aiCardContainer.appendChild(aiCard);
      }
    }

    async function multiplayerSelectAttribute(attribute) {
      if (!localGameState || localGameState.turn !== localPlayerId || localGameState.lastResult || !attributeInfo[attribute]) return;
      const playerCard = localGameState.currentCards?.[localPlayerId];
      const opponentId = localGameState.playerIds?.find(id => id !== localPlayerId);
      if (!opponentId || !localGameState.currentCards?.[opponentId]) return;
      const opponentCard = localGameState.currentCards[opponentId];
      const playerValue = playerCard?.[attribute];
      const opponentValue = opponentCard?.[attribute];
      if (playerValue === undefined || opponentValue === undefined) return;

      let playerWins;
      if (attribute === 'quellenSchwindenRadial' || attribute === 'dk') {
        if (playerValue < opponentValue) playerWins = true;
        else if (opponentValue < playerValue) playerWins = false;
        else playerWins = 'tie';
      } else {
        if (playerValue > opponentValue) playerWins = true;
        else if (opponentValue > playerValue) playerWins = false;
        else playerWins = 'tie';
      }
      const winnerId = playerWins === 'tie' ? 'tie' : (playerWins ? localPlayerId : opponentId);
      const gameUpdate = { lastResult: { winnerId, attribute, values: { [localPlayerId]: playerValue, [opponentId]: opponentValue } }, lastActivity: serverTimestamp() };
      try { await updateDoc(doc(db, "games", gameId), gameUpdate); } catch {}
    }

    async function multiplayerNextRound() {
      const pf = document.getElementById('playerCard')?.querySelector('.card-front'); if (pf) pf.classList.remove('animate-glow-win', 'animate-glow-lose');
      const af = document.getElementById('aiCard')?.querySelector('.card-front'); if (af) af.classList.remove('animate-glow-win', 'animate-glow-lose');
      document.querySelectorAll('#playerCard .space-y-1 > *, #aiCard .space-y-1 > *').forEach(el => { el.classList.remove('bg-yellow-200', 'bg-gray-300'); });

      if (!localGameState || !localGameState.lastResult || !gameId) return;
      try {
        const current = localGameState;
        if (!current.lastResult) return;
        const currentWinnerId = current.lastResult.winnerId;
        const [player1Id, player2Id] = current.playerIds;
        let p1Cards = [...current.players[player1Id].cards];
        let p2Cards = [...current.players[player2Id].cards];

        if (p1Cards.length === 0 && p2Cards.length === 0 && current.status !== 'finished') {
          await updateDoc(doc(db, "games", gameId), { status: 'finished', lastResult: null });
          return;
        }

        const p1Card = p1Cards.shift();
        const p2Card = p2Cards.shift();

        if (currentWinnerId === player1Id) { if (p1Card) p1Cards.push(p1Card); if (p2Card) p1Cards.push(p2Card); }
        else if (currentWinnerId === player2Id) { if (p1Card) p2Cards.push(p1Card); if (p2Card) p2Cards.push(p2Card); }
        else { if (p1Card) p1Cards.push(p1Card); if (p2Card) p2Cards.push(p2Card); }

        if (p1Cards.length === 0 || p2Cards.length === 0) {
          await updateDoc(doc(db, "games", gameId), {
            status: 'finished',
            'players': {
              [player1Id]: { ...current.players[player1Id], cards: p1Cards },
              [player2Id]: { ...current.players[player2Id], cards: p2Cards }
            },
            currentCards: { [player1Id]: null, [player2Id]: null },
            lastResult: null
          });
          return;
        }

        const nextTurn = currentWinnerId === 'tie' ? current.turn : currentWinnerId;
        const gameUpdate = {
          'lastResult': null,
          'turn': nextTurn,
          'players': {
            [player1Id]: { ...current.players[player1Id], cards: p1Cards },
            [player2Id]: { ...current.players[player2Id], cards: p2Cards }
          },
          'currentCards': { [player1Id]: p1Cards[0] || null, [player2Id]: p2Cards[0] || null },
          'lastActivity': serverTimestamp()
        };
        await updateDoc(doc(db, "games", gameId), gameUpdate);
      } catch (error) { console.error("Error processing multiplayer next round:", error); }
    }

    // Controller
    window.selectAttribute = function(attribute) { if (gameMode === 'ai') { selectAttributeAI(attribute); } else if (gameMode === 'multiplayer') { multiplayerSelectAttribute(attribute); } };
    window.nextRound = function() { if (gameMode === 'ai') { nextRoundAI(); } else if (gameMode === 'multiplayer') { multiplayerNextRound(); } };

    // AI mode
    function shuffleArray(array) { const s=[...array]; for (let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]];} return s; }
    function startGameAI(playerName) {
      aiGame.playerName = playerName;
      document.getElementById('playerNameDisplay').textContent = playerName;
      document.getElementById('opponentNameDisplay').textContent = 'Computer';
      const shuffled = shuffleArray(woodCards);
      aiGame.playerCards = shuffled.slice(0, 15);
      aiGame.aiCards = shuffled.slice(15, 30);
      aiGame.currentPlayerCard = aiGame.playerCards[0];
      aiGame.currentAiCard = aiGame.aiCards[0];
      aiGame.roundInProgress = false;
      aiGame.turn = 'player';
      document.getElementById('attributeSelection').classList.remove('hidden');
      document.getElementById('resultDisplay').classList.add('hidden');
      document.getElementById('nextRoundButton').classList.add('hidden');
      document.getElementById('turnIndicator').classList.remove('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      window.scrollTo(0,0);
      updateDisplayAI();
      displayCardsAI();
    }

    function createCard(cardData, isRevealed = true, isPlayer = true) {
      const card = document.createElement('div');
      card.className = `card-3d w-full h-full relative ${isPlayer ? 'cursor-pointer hover-lift' : ''} transition-all duration-300`;
      if (!isRevealed) { card.classList.add('card-flipped'); }
      const borderColor = isPlayer ? 'border-amber-400' : 'border-gray-300';
      const shadow = isPlayer ? 'shadow-lg' : 'shadow-md';
      const cardFront = document.createElement('div');
      cardFront.className = `card-front card-background rounded-xl ${shadow} border-2 ${borderColor} p-2 sm:p-3 flex flex-col overflow-hidden`;
      const canSelectAttributes = isPlayer && ((gameMode === 'ai' && !aiGame.roundInProgress && aiGame.turn === 'player') || (gameMode === 'multiplayer' && localGameState?.turn === localPlayerId && !localGameState?.lastResult));
      const cardName = cardData?.name || 'Unbekannt';

      let attributeHTML = '<div class="space-y-1 mt-auto">';
      for (const attrKey in attributeInfo) {
        const attr = attributeInfo[attrKey];
        const value = cardData?.[attrKey] ?? '?';
        const formattedValue = typeof value === 'number' ? value.toLocaleString('de-DE') : value;
        const valueUnit = attr.name.match(/\(([^)]+)\)/);
        const unitText = valueUnit ? `<span class="block text-[10px] sm:text-xs text-gray-500 leading-tight">${valueUnit[0]}</span>` : '';
        const nameText = attrKey === 'quellenSchwindenRadial' ? 'Quellen/Schw.' : attr.name.replace(/\s*\(([^)]+)\)/, '');
        const baseBgClass = canSelectAttributes ? 'bg-amber-100' : 'bg-amber-50';
        const hoverBgClass = canSelectAttributes ? 'hover:bg-amber-200' : '';
        const borderClass = canSelectAttributes ? 'border-amber-600' : 'border-amber-300';
        const textClass = canSelectAttributes ? 'text-amber-700' : 'text-amber-800';
        const commonClasses = `w-full flex justify-between items-center py-0.5 sm:py-1 px-1 rounded-lg text-left border ${borderClass} ${baseBgClass}`;
        if (canSelectAttributes) {
          attributeHTML += `<button onclick="window.selectAttribute('${attrKey}')" class="${commonClasses} ${hoverBgClass} transition-colors"><div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${attr.icon}</span><div><span class="text-[11px] sm:text-xs font-medium leading-tight">${nameText}</span>${unitText}</div></div><span class="font-semibold ${textClass} text-sm sm:text-base">${formattedValue}</span></button>`;
        } else {
          attributeHTML += `<div class="${commonClasses}"><div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${attr.icon}</span><div><span class="text-[11px] sm:text-xs font-medium leading-tight text-gray-700">${nameText}</span>${unitText}</div></div><span class="font-semibold ${textClass} text-sm sm:text-base">${formattedValue}</span></div>`;
        }
      }
      attributeHTML += '</div>';
      cardFront.innerHTML = `<div class="flex justify-between items-center w-full mb-2 px-1 h-9 sm:h-10"><h3 class="text-base sm:text-lg font-bold text-amber-800 truncate text-left mr-2">${cardName}</h3></div>${attributeHTML}`;
      const cardBack = document.createElement('div');
      cardBack.className = 'card-back rounded-xl shadow-lg border-2 border-amber-300 flex items-center justify-center relative overflow-hidden';
      card.appendChild(cardFront); card.appendChild(cardBack); return card;
    }

    function displayCardsAI() {
      const playerCardContainer = document.getElementById('playerCard');
      const aiCardContainer = document.getElementById('aiCard');
      playerCardContainer.innerHTML = ''; aiCardContainer.innerHTML = '';
      if (aiGame.currentPlayerCard) { playerCardContainer.appendChild(createCard(aiGame.currentPlayerCard, true, true)); } else { playerCardContainer.innerHTML = `<div class="card-front bg-gray-200 ...">Keine Karte</div>`; }
      if (aiGame.currentAiCard) { const reveal = aiGame.roundInProgress; aiCardContainer.appendChild(createCard(aiGame.currentAiCard, reveal, false)); } else { aiCardContainer.innerHTML = `<div class="card-front bg-gray-200 ...">Keine Karte</div>`; }
    }

    function selectAttributeAI(attribute) {
      if (aiGame.roundInProgress || aiGame.turn !== 'player' || !aiGame.currentPlayerCard || !aiGame.currentAiCard || !attributeInfo[attribute]) return;
      aiGame.roundInProgress = true;
      const playerValue = aiGame.currentPlayerCard[attribute];
      const aiValue = aiGame.currentAiCard[attribute];
      if (playerValue === undefined || aiValue === undefined) { aiGame.roundInProgress = false; return; }
      const aiCardElement = document.getElementById('aiCard').querySelector('.card-3d');
      if (aiCardElement) { aiCardElement.classList.remove('card-flipped'); playSound(sounds.flip); }
      let playerWins;
      if (attribute === 'quellenSchwindenRadial' || attribute === 'dk') { playerWins = playerValue < aiValue ? true : aiValue < playerValue ? false : 'tie'; }
      else { playerWins = playerValue > aiValue ? true : aiValue > playerValue ? false : 'tie'; }
      const playerCardToMove = aiGame.playerCards.shift(); const aiCardToMove = aiGame.aiCards.shift(); let winnerTurn = aiGame.turn;
      if (playerWins === true) { if (playerCardToMove) aiGame.playerCards.push(playerCardToMove); if (aiCardToMove) aiGame.playerCards.push(aiCardToMove); winnerTurn = 'player'; }
      else if (playerWins === false) { if (aiCardToMove) aiGame.aiCards.push(aiCardToMove); if (playerCardToMove) aiGame.aiCards.push(playerCardToMove); winnerTurn = 'ai'; }
      else { if (playerCardToMove) aiGame.playerCards.push(playerCardToMove); if (aiCardToMove) aiGame.aiCards.push(aiCardToMove); }
      aiGame.turn = winnerTurn;

      setTimeout(() => {
        displayCardsAI();
        let resultText, resultClass;
        const statusBar = document.getElementById('statusBar');
        if (playerWins === true) { resultText = `üéâ Du gewinnst!`; resultClass = 'text-green-600'; if (statusBar) { statusBar.classList.add('status-flash-win'); setTimeout(()=>statusBar.classList.remove('status-flash-win'),1200);} playSound(sounds.win); }
        else if (playerWins === false) { resultText = `üòû KI gewinnt!`; resultClass = 'text-red-600'; if (statusBar) { statusBar.classList.add('status-flash-lose'); setTimeout(()=>statusBar.classList.remove('status-flash-lose'),1200);} }
        else { resultText = `ü§ù Unentschieden!`; resultClass = 'text-yellow-600'; }
        document.getElementById('resultText').textContent = resultText; document.getElementById('resultText').className = `text-lg sm:text-xl font-bold ${resultClass}`;
        document.getElementById('resultDetails').textContent = `${attributeInfo[attribute].name.split(' (')[0]}: ${playerValue.toLocaleString('de-DE')} vs ${aiValue.toLocaleString('de-DE')}`;
        document.getElementById('attributeSelection').classList.add('hidden');
        document.getElementById('resultDisplay').classList.remove('hidden');
        document.getElementById('nextRoundButton').classList.remove('hidden');
        updateDisplayAI(); checkGameOverAI();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 600);
    }

    function aiSelectAttribute() {
      if (aiGame.roundInProgress || aiGame.turn !== 'ai' || !aiGame.currentPlayerCard || !aiGame.currentAiCard) return;
      aiGame.roundInProgress = true;
      setTimeout(() => {
        const available = Object.keys(attributeInfo);
        const chosen = available[Math.floor(Math.random() * available.length)];
        const playerValue = aiGame.currentPlayerCard[chosen]; const aiValue = aiGame.currentAiCard[chosen];
        if (playerValue === undefined || aiValue === undefined) { aiGame.roundInProgress = false; nextRoundAI(); return; }
        let playerWins;
        if (chosen === 'quellenSchwindenRadial' || chosen === 'dk') { playerWins = playerValue < aiValue ? true : aiValue < playerValue ? false : 'tie'; }
        else { playerWins = playerValue > aiValue ? true : aiValue > playerValue ? false : 'tie'; }
        const playerCardToMove = aiGame.playerCards.shift(); const aiCardToMove = aiGame.aiCards.shift(); let winnerTurn = aiGame.turn;
        if (playerWins === true) { if (playerCardToMove) aiGame.playerCards.push(playerCardToMove); if (aiCardToMove) aiGame.playerCards.push(aiCardToMove); winnerTurn = 'player'; }
        else if (playerWins === false) { if (aiCardToMove) aiGame.aiCards.push(aiCardToMove); if (playerCardToMove) aiGame.aiCards.push(playerCardToMove); winnerTurn = 'ai'; }
        else { if (playerCardToMove) aiGame.playerCards.push(playerCardToMove); if (aiCardToMove) aiGame.aiCards.push(aiCardToMove); }
        aiGame.turn = winnerTurn;

        displayCardsAI();
        let resultText, resultClass;
        const statusBar = document.getElementById('statusBar');
        if (playerWins === true) { resultText = `üéâ Du gewinnst!`; resultClass = 'text-green-600'; if (statusBar) { statusBar.classList.add('status-flash-win'); setTimeout(()=>statusBar.classList.remove('status-flash-win'),1200);} playSound(sounds.win); }
        else if (playerWins === false) { resultText = `üòû KI gewinnt!`; resultClass = 'text-red-600'; if (statusBar) { statusBar.classList.add('status-flash-lose'); setTimeout(()=>statusBar.classList.remove('status-flash-lose'),1200);} }
        else { resultText = `ü§ù Unentschieden!`; resultClass = 'text-yellow-600'; }
        document.getElementById('resultText').textContent = resultText; document.getElementById('resultText').className = `text-lg sm:text-xl font-bold ${resultClass}`;
        document.getElementById('resultDetails').textContent = `${attributeInfo[chosen].name.split(' (')[0]}: ${playerValue.toLocaleString('de-DE')} vs ${aiValue.toLocaleString('de-DE')}`;
        document.getElementById('attributeSelection').classList.add('hidden');
        document.getElementById('resultDisplay').classList.remove('hidden');
        document.getElementById('nextRoundButton').classList.remove('hidden');
        updateDisplayAI(); checkGameOverAI();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 1500);
    }

    function nextRoundAI() {
      const pf = document.getElementById('playerCard')?.querySelector('.card-front'); if (pf) pf.classList.remove('animate-glow-win', 'animate-glow-lose');
      const af = document.getElementById('aiCard')?.querySelector('.card-front'); if (af) af.classList.remove('animate-glow-win', 'animate-glow-lose');
      document.querySelectorAll('#playerCard .space-y-1 > *, #aiCard .space-y-1 > *').forEach(el => { el.classList.remove('bg-yellow-200', 'bg-gray-300'); });
      if (aiGame.playerCards.length === 0 || aiGame.aiCards.length === 0) { endGameAI(); return; }
      aiGame.currentPlayerCard = aiGame.playerCards[0]; aiGame.currentAiCard = aiGame.aiCards[0]; aiGame.roundInProgress = false;
      document.getElementById('nextRoundButton').classList.add('hidden'); document.getElementById('resultDisplay').classList.add('hidden');
      updateDisplayAI(); displayCardsAI();
      if (aiGame.turn === 'ai') { document.getElementById('attributeSelection').classList.add('hidden'); aiSelectAttribute(); }
      else { document.getElementById('attributeSelection').classList.remove('hidden'); }
    }

    function updateDisplayAI() {
      const playerCount = aiGame.playerCards.length; const opponentCount = aiGame.aiCards.length;
      document.getElementById('playerCards').textContent = playerCount; document.getElementById('aiCards').textContent = opponentCount; updateStatusBar(playerCount, opponentCount);
      const turnIndicator = document.getElementById('turnIndicator'); turnIndicator.classList.remove('hidden');
      if(aiGame.roundInProgress) { if (!document.getElementById('resultDisplay').classList.contains('hidden')) { turnIndicator.textContent = ''; } else if (aiGame.turn === 'ai') { turnIndicator.textContent = `Computer √ºberlegt...`; turnIndicator.className = 'text-sm font-semibold p-1 text-gray-500'; } else { turnIndicator.textContent = ''; } }
      else if (aiGame.turn === 'player') { turnIndicator.textContent = "Du bist am Zug!"; turnIndicator.className = 'text-sm font-semibold p-1 text-green-600'; }
      else { turnIndicator.textContent = `Computer ist am Zug...`; turnIndicator.className = 'text-sm font-semibold p-1 text-gray-500'; }
    }

    function checkGameOverAI() { if (aiGame.roundInProgress) { if (aiGame.playerCards.length === 0 || aiGame.aiCards.length === 0) { setTimeout(endGameAI, 300); } } }

    function endGame() {
      if (gameMode === 'ai') { endGameAI(); }
      else if (gameMode === 'multiplayer') {
        const finalPlayerCards = localGameState?.players?.[localPlayerId]?.cards?.length ?? 0;
        const opponentId = localGameState?.playerIds?.find(id => id !== localPlayerId);
        const finalOpponentCards = localGameState?.players?.[opponentId]?.cards?.length ?? 0;
        const playerWon = finalPlayerCards > finalOpponentCards;
        const isDraw = finalPlayerCards === 0 && finalOpponentCards === 0;
        if (isDraw) { showGameOverScreen(null); }
        else if (playerWon) { saveToLeaderboard(localGameState.players[localPlayerId].name); showReflectionOrWinScreen(); }
        else { showGameOverScreen(false); }
      }
    }

    function endGameAI() {
      if (!document.getElementById('gameOverModal').classList.contains('hidden') || !document.getElementById('reflectionModal').classList.contains('hidden')) return;
      const playerWon = aiGame.playerCards.length > 0;
      if (playerWon) { saveToLeaderboard(aiGame.playerName); showReflectionOrWinScreen(); }
      else { showGameOverScreen(false); }
    }

    function showReflectionOrWinScreen() {
      document.getElementById('reflectionQuestion').textContent = "Reflexion: Warum hast du dieses Holz gew√§hlt?";
      document.getElementById('reflectionModal').classList.remove('hidden');
    }
    window.showFinalWinScreen = function() {
      document.getElementById('reflectionModal').classList.add('hidden'); document.getElementById('reflectionAnswer').value = ''; showGameOverScreen(true);
    };

    function showGameOverScreen(didPlayerWin) {
      document.getElementById('reflectionModal').classList.add('hidden');
      document.getElementById('leaderboardModal').classList.add('hidden');
      const titleEl = document.getElementById('gameOverTitle'); const textEl = document.getElementById('gameOverText'); const modalEl = document.getElementById('gameOverModal');
      if (didPlayerWin === true) {
        titleEl.textContent = 'üéâ Gl√ºckwunsch!'; titleEl.className = `text-3xl font-bold mb-3 text-green-600`;
        const winnerName = (gameMode === 'ai' ? aiGame.playerName : localGameState?.players?.[localPlayerId]?.name) || 'Du';
        textEl.textContent = `Du hast gewonnen, ${winnerName}! Du hast alle Karten gesammelt.`;
      } else if (didPlayerWin === false) {
        titleEl.textContent = 'üòû Spiel verloren'; titleEl.className = `text-3xl font-bold mb-3 text-red-600`;
        const opponentName = (gameMode === 'ai' ? 'Die KI' : localGameState?.players?.[localGameState.playerIds?.find(id => id !== localPlayerId)]?.name) || 'Dein Gegner';
        textEl.textContent = `${opponentName} hat gewonnen. Versuche es nochmal!`;
      } else {
        titleEl.textContent = 'ü§ù Unentschieden!'; titleEl.className = `text-3xl font-bold mb-3 text-yellow-600`; textEl.textContent = `Das Spiel endet unentschieden!`;
      }
      modalEl.classList.remove('hidden');
    }

    async function saveToLeaderboard(playerName) {
      if (!playerName) return;
      const safePlayerName = playerName.replace(/[.#$[\]]/g, '_');
      const leaderboardRef = doc(db, "leaderboard", safePlayerName);
      try {
        await setDoc(leaderboardRef, { name: playerName, wins: increment(1), lastWin: serverTimestamp() }, { merge: true });
      } catch (error) { console.error("Error updating leaderboard:", error); }
    }

    window.showLeaderboard = async function() {
      const list = document.getElementById('leaderboardList'); list.innerHTML = '<p class="text-gray-500 text-center">Lade Bestenliste...</p>';
      document.getElementById('gameOverModal').classList.add('hidden'); document.getElementById('leaderboardModal').classList.remove('hidden');
      try {
        const q = query(collection(db, "leaderboard"), orderBy("wins", "desc"), limit(10));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) { list.innerHTML = '<p class="text-gray-500 text-center">Noch keine Eintr√§ge vorhanden.</p>'; return; }
        list.innerHTML = querySnapshot.docs.map((doc, index) => {
          const data = doc.data();
          const safeName = (data.name || 'Unbekannt').replace(/</g, "&lt;").replace(/>/g, "&gt;");
          return `<div class="flex justify-between items-center p-3 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} rounded-lg"><span class="font-semibold">${index + 1}. ${safeName}</span><span class="text-sm text-gray-600">${data.wins || 0} Siege</span></div>`;
        }).join('');
      } catch (error) { console.error("Error fetching leaderboard:", error); list.innerHTML = '<p class="text-red-500 text-center">Fehler beim Laden der Bestenliste.</p>'; }
    };

    window.closeLeaderboard = function() {
      document.getElementById('leaderboardModal').classList.add('hidden');
      if (localGameState?.status === 'finished' || (gameMode === 'ai' && (aiGame.playerCards.length === 0 || aiGame.aiCards.length === 0))) {
        document.getElementById('gameOverModal').classList.remove('hidden');
      } else {
        document.getElementById('setupModal').classList.remove('hidden');
      }
    };

    window.resetGame = async function() {
      if (unsubscribeGame) { unsubscribeGame(); unsubscribeGame = null; }
      if (gameMode === 'multiplayer' && gameId && localGameState?.playerIds?.[0] === localPlayerId) {
        try { await deleteDoc(doc(db, "games", gameId)); } catch {}
      }
      aiGame = { playerName: '', playerCards: [], aiCards: [], currentPlayerCard: null, currentAiCard: null, roundInProgress: false, turn: 'player' };
      gameMode = null; gameId = null; localGameState = {}; hasCopiedShareLink = false; roundSoundPlayed = false;

      document.getElementById('gameOverModal').classList.add('hidden');
      document.getElementById('leaderboardModal').classList.add('hidden');
      document.getElementById('reflectionModal').classList.add('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('multiplayerLobbyModal').classList.add('hidden');
      document.getElementById('nameModal').classList.add('hidden');
      document.getElementById('infoModal')?.classList.add('hidden');
      document.getElementById('playerName').value = '';
      document.getElementById('reflectionAnswer').value = '';
      document.getElementById('shareLink').value = '';
      const qrContainer = document.getElementById('qrCodeContainer'); if (qrContainer) qrContainer.innerHTML = '';
      document.getElementById('lobbyStatus').textContent = '';
      document.getElementById('playerCard').innerHTML = '';
      document.getElementById('aiCard').innerHTML = '';
      updateStatusBar(0, 0);
      document.getElementById('setupModal').classList.remove('hidden');
      window.history.pushState({}, document.title, window.location.pathname);
    };

    // Sound toggle
    const soundToggleButton = document.getElementById('soundToggle');
    const savedMuteStatus = localStorage.getItem('holzquartett_isMuted');
    isMuted = savedMuteStatus === 'true';
    soundToggleButton.checked = !isMuted;
    soundToggleButton.addEventListener('change', (event) => {
      isMuted = !event.target.checked;
      localStorage.setItem('holzquartett_isMuted', isMuted);
      if (!isMuted) { playSound(sounds.chime); }
    });

    // Multiplayer click handlers
    window.multiplayerSelectAttribute = multiplayerSelectAttribute;
    window.multiplayerNextRound = multiplayerNextRound;
  </script>
</body>
</html>
"""
with open('/mnt/data/holzquartett_full_qr.html', 'w', encoding='utf-8') as f:
    f.write(html)
'/mnt/data/holzquartett_full_qr.html'
