<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett: Gamifizierung in der Berufsbildung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; touch-action: manipulation; overflow-x: hidden; min-height: 100dvh; }
        .perspective-1000 { perspective: 1000px; }
        .card-3d { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 1rem; overflow: hidden; box-sizing: border-box; }
        .card-back { 
            transform: rotateY(180deg); 
            background-color: #2c3e50;
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images/background_card.jpg?raw=true'); 
            background-size: cover; 
            background-position: center; 
            border: 4px solid white; 
        }
        .card-front-bg { background-color: #fffbeb; background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); transform: translate(-50%, -50%) scale(1); } 50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); transform: translate(-50%, -50%) scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: translate(-50%, -50%) scale(1); } }
        .animate-worm { animation: worm-pop-up 3.5s ease-in-out forwards; }
        @keyframes worm-pop-up { 0% { transform: translateY(100%) rotate(0deg); opacity: 0; } 20% { transform: translateY(-20%) rotate(-10deg); opacity: 1; } 40% { transform: translateY(-20%) rotate(10deg); } 50% { transform: translateY(-30%) rotate(0deg) scale(1.1); } 60% { transform: translateY(-20%) rotate(-10deg) scale(1); } 80% { transform: translateY(-20%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100%) rotate(0deg); opacity: 0; } }
        .opponent-back-name { position: absolute; top: 15%; width: 100%; text-align: center; color: rgba(255,255,255,0.95); font-weight: 700; font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dimmer { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .attr-box { background-color: #fff7ed; border: 1px solid #fbbf24; transition: all 0.2s; }
        .attr-box.flash-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; }
        .attr-box.flash-active span { color: white !important; }
        .attr-box.highlight-compare { background-color: #e5e7eb !important; border-color: #9ca3af !important; color: #111827 !important; }
        .attr-box.highlight-compare span { color: #000000 !important; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .attr-toggle-btn { transition: all 0.2s; border: 2px solid transparent; }
        .attr-toggle-btn.selected { background-color: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .attr-toggle-btn:not(.selected) { background-color: #f3f4f6; color: #9ca3af; border-color: transparent; }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">

<header class="bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-20 flex-shrink-0">
    <div class="max-w-[600px] mx-auto px-4 py-3 relative flex justify-between items-center">
        <a id="navButton" href="#" class="relative z-10 w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-white shadow-sm hover:bg-white/30 transition-all border border-white/30" aria-label="Zur√ºck zur Startseite">
             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <polyline points="9 22 9 12 15 12 15 22" />
             </svg>
        </a>
        <h1 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg sm:text-2xl font-black tracking-wider uppercase drop-shadow-sm whitespace-nowrap pointer-events-none">üå≤ HOLZEN! üå≤</h1>
        <button onclick="window.showGameInfo()" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-10" aria-label="Spielregeln">
             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>
</header>

<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto relative p-2 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>
    <div class="flex justify-center items-start gap-2 sm:gap-4 w-full flex-grow relative pb-2 mt-2"> 
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="playerNameDisplay" class="text-base sm:text-lg font-bold text-amber-700 leading-tight truncate">Spieler</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="playerCardContainer"><div id="playerCard" class="w-full h-full relative"></div></div>
        </div>
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="opponentNameDisplay" class="text-base sm:text-lg font-bold text-gray-600 leading-tight truncate">COMPUTER</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="aiCardContainer"><div id="aiCard" class="w-full h-full relative"></div></div>
        </div>
    </div>
    <div class="w-full mt-4 mb-24"> 
        <div class="flex justify-between text-[9px] sm:text-[10px] font-bold text-gray-400 mb-1 px-1"><span>Dein Stapel</span><span>Gegenspieler</span></div>
        <div class="h-4 w-full bg-gray-200 rounded-full shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 rounded-l-full transition-all duration-500 ease-out" style="width: 50%;"></div>
            <div id="statusBall" class="absolute top-1/2 w-6 h-6 rounded-full border-2 border-white shadow-md transition-all duration-500 ease-out z-10" style="left: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);"></div>
        </div>
    </div>
</div>

<div id="happyWorm" class="fixed bottom-0 right-4 translate-y-full z-50 pointer-events-none transform transition-transform hidden">
    <div class="relative"><div id="wormSpeech" class="absolute -top-10 -left-10 bg-white px-3 py-1.5 rounded-xl shadow-md border-2 border-amber-200 text-xs font-bold text-amber-800 whitespace-nowrap animate-bounce" style="animation-duration: 2s;">Stark! ü™µ</div><div class="text-6xl filter drop-shadow-xl cursor-default select-none">üêõ</div></div>
</div>

<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-xs sm:text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-xl sm:text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>
        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-800 transition text-sm sm:text-base">üéì Zusatzwissen</button>
            <button id="bsNextBtn" class="flex-1 bg-green-600 hover:bg-green-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-green-800 transition text-sm sm:text-base">Weiter &rarr;</button>
        </div>
    </div>
</div>

<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[90vh] flex flex-col">
        <div class="bg-amber-500 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 class="font-bold text-lg">Spielregeln & Eigenschaften</h3>
            <button onclick="document.getElementById('gameInfoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto hide-scrollbar space-y-5">
            <h4 class="font-bold text-gray-700 text-md">Regeln (Quartett-Prinzip)</h4>
            <p class="text-sm text-gray-600 leading-relaxed">Die aktive Person w√§hlt auf ihrer Karte die Eigenschaft, die den gr√∂√ütm√∂glichen Vorteil verspricht. Je nach Kategorie z√§hlt der h√∂chste oder der niedrigste Wert (siehe die Beschreibung der Eigenschaften). Gewinnt sie den Spielzug, erh√§lt sie beide Karten, legt sie unter den eigenen Stapel und bleibt am Zug. Bei Gleichstand behalten beide ihre Karten. Das Zugrecht bleibt unver√§ndert.</p>
            <div id="infoCategoryList" class="space-y-3 pt-3"></div>
        </div>
    </div>
</div>

<div id="infoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-md max-h-[90vh] flex flex-col">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Wissenskarte</h3>
            <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto">
            </div>
    </div>
</div>

<div id="impressumModal" class="fixed inset-0 dimmer flex items-center justify-center z-[70] p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-slate-700 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Impressum</h3>
            <button onclick="document.getElementById('impressumModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto text-sm text-gray-700 space-y-4">
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Angaben gem√§√ü ¬ß 5 TMG</h4>
                <p>Christopher Lehr<br>Musterstra√üe 1<br>12345 Musterstadt</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Kontakt</h4>
                <p>E-Mail: muster@student.uni-bremen.de</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Kontext</h4>
                <p>Dieses Lernspiel entstand im Rahmen einer Masterarbeit im Studiengang Lehramt an Berufsschulen (Holztechnik) an der Universit√§t Bremen.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Haftungsausschluss</h4>
                <p class="text-xs text-gray-500">Die Inhalte dieses Spiels wurden mit gr√∂√üter Sorgfalt erstellt. F√ºr die Richtigkeit, Vollst√§ndigkeit und Aktualit√§t der Inhalte k√∂nnen wir jedoch keine Gew√§hr √ºbernehmen.</p>
            </div>
        </div>
    </div>
</div>

<div id="attrConfigModal" class="fixed inset-0 dimmer flex items-center justify-center z-[60] p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Spieloptionen</h3>
            <button onclick="document.getElementById('attrConfigModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto">
            <div class="mb-5 space-y-3">
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <span class="font-bold text-gray-700 text-sm flex items-center gap-2">üîä Ton an</span>
                     <input type="checkbox" id="soundToggle" class="accent-green-500 w-5 h-5">
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <span class="font-bold text-gray-700 text-sm flex items-center gap-2">üëÄ Gegner-Karte sichtbar</span>
                     <input type="checkbox" id="revealBackToggle" class="accent-green-500 w-5 h-5">
                </div>
            </div>

            <hr class="border-gray-200 mb-4 border-t-2 border-dashed">

            <h4 class="font-bold text-gray-800 mb-1 text-sm">Eigenschaften w√§hlen</h4>
            <p class="text-xs text-gray-500 mb-3">W√§hle mindestens 3 und maximal 5 Kategorien.</p>
            <div id="attrConfigList" class="space-y-2">
                </div>
        </div>
        <div class="p-4 bg-gray-50 border-t">
             <button onclick="document.getElementById('attrConfigModal').classList.add('hidden')" class="w-full bg-amber-500 text-white font-bold py-2 rounded-lg shadow">Fertig</button>
        </div>
    </div>
</div>

<div id="setupModal" class="fixed inset-0 dimmer flex flex-col items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-sm w-full relative mb-6">
        
        <a href="https://aufdemholzweg.github.io/Splashscreen-Holztechnik/" class="absolute left-4 top-4 z-[60] w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-white shadow-sm hover:bg-white/30 transition-all border border-white/30" aria-label="Zur√ºck zum Launcher">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 22c0-8 3-14 8-20" opacity="0.9" />
                <path d="M2 16c2-4 4-8 5-14" opacity="0.6" />
                <path d="M8 22c1-6 2-10 6-12 3-1.5 6 0 8 4" opacity="0.8" />
                <path d="M13 22c1-4 3-8 7-8" opacity="0.7" />
                <path d="M18 22c1-3 2-6 4-6" opacity="0.5" />
                <path d="M16 2c2 1 4 4 6 7" opacity="0.6" />
             </svg>
        </a>

        <div class="bg-amber-500 p-5 text-white text-center font-bold text-lg sm:text-xl tracking-wide shadow-md">HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus w√§hlen</span></div>
        <div class="p-6 space-y-4">
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">ü§ñ</span> Gegen Computer</button>
            <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">üåç</span> Online gegen Freunde</button>
            
            <button onclick="window.openAttrConfig()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl border border-gray-200 flex items-center justify-center gap-2 text-sm mt-2">
                <span>‚öôÔ∏è</span> Spieloptionen <span id="attrCountBadge" class="bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">6</span>
            </button>
        </div>
    </div>

    <div id="mainMenuStats" class="text-center hidden mb-8">
        </div>

    <div class="mt-auto pt-4">
        <button onclick="document.getElementById('impressumModal').classList.remove('hidden')" class="text-white/70 text-xs font-medium hover:text-white underline transition-colors">Impressum</button>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
        <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg" placeholder="Name eingeben" maxlength="12">
        <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600">Starten</button>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund scannen:</p>
        <div class="flex justify-center mb-4"><div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div></div>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
        <p id="gameOverText" class="text-gray-600 mb-6"></p>
        <div class="space-y-3">
            <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">üèÜ Bestenliste</button>
            <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">üîÑ Neues Spiel</button>
        </div>
    </div>
</div>

<div id="reflectionModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-amber-800 mb-4">üéâ Super gespielt!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 font-medium"></p>
        <textarea id="reflectionAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg">Weiter</button>
    </div>
</div>

<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">Schlie√üen</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// === FIREBASE CONFIGURATION (FIXED FOR GITHUB DEPLOYMENT) ===
const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};

const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'holzquartett-3a177';

let app, db, auth;
try {
    app = initializeApp(activeConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (e) {
    console.error("Firebase Init Error:", e);
    alert("Fehler beim Laden der Datenbank-Konfiguration.");
}

const initAuth = async () => {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (e) {
        console.error("Auth Failed", e);
    }
};
initAuth();

const getPublicDataRef = (coll, docId) => {
    if(docId) return doc(db, 'artifacts', appId, 'public', 'data', coll, docId);
    return collection(db, 'artifacts', appId, 'public', 'data', coll);
};

async function trackEvent(type) {
    if (!auth || !auth.currentUser) return;
    const ref = getPublicDataRef("statistics", "usage"); 
    try {
        await setDoc(ref, {
            [type]: increment(1),
            last_activity: serverTimestamp()
        }, { merge: true });
    } catch (e) {
        console.warn("Tracking eingeschr√§nkt.", e);
    }
}

const NAV_ICONS = {
    fingerprint: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 20 C 10 18, 10 6, 14 4" opacity="0.5" /><path d="M9 21 C 14 19, 14 5, 18 3" opacity="0.7" /><path d="M13 22 C 18 20, 18 4, 22 2" opacity="0.9" /><path d="M2 15 C 6 13, 6 9, 10 7" opacity="0.3" /><path d="M15 22 C 19 20, 19 12, 22 10" opacity="0.5" /></svg>`,
    house: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>`
};

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

window.setNavState = (state) => {
    const btn = document.getElementById('navButton');
    if(!btn) return;
    if(state === 'game') {
        btn.innerHTML = NAV_ICONS.house;
        btn.removeAttribute('href'); 
        btn.onclick = (e) => { e.preventDefault(); if(confirm('Spiel abbrechen und zum Startbildschirm zur√ºckkehren?')) { window.location.reload(); } };
        btn.setAttribute('aria-label', 'Zur√ºck zur Holzen! Startseite');
    } else {
        btn.innerHTML = NAV_ICONS.house; 
        btn.href = '#';
        btn.onclick = (e) => { e.preventDefault(); location.reload(); }; 
        btn.setAttribute('aria-label', 'Startseite');
    }
};

let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;
let lastRoundWinningWoodName = null;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};

let activeAttributeKeys = ['dk', 'druckfestigkeit', 'quellen', 'rohdichte', 'emodul', 'preis'];

const attributeInfo={
 dk:{
     icon:'üõ°Ô∏è',
     name:'Dauerhaftigkeit',
     unit:'(DK)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Klasse 1 (sehr dauerhaft) bis Klasse 5 (nicht dauerhaft). Niedriger ist besser.'
 },
 druckfestigkeit:{
     icon:'üíé',
     name:'Druckfestigkeit',
     unit:'(N/mm¬≤)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Widerstand gegen Druckkraft parallel zur Faser.'
 },
 quellen:{
     icon:'‚ÜîÔ∏è',
     name:'Quellen/Schw.',
     unit:'(%)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Volumen√§nderung bei Feuchtigkeitswechsel. Weniger Bewegung ist besser.'
 },
 rohdichte:{
     icon:'‚öñÔ∏è',
     name:'Rohdichte',
     unit:'(kg/m¬≥)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Masse pro Volumeneinheit (bei 12-15% Feuchte). Indikator f√ºr H√§rte.'
 },
 emodul:{
     icon:'üìê',
     name:'E-Modul',
     unit:'(N/mm¬≤)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Elastizit√§tsmodul. Ma√ü f√ºr die Steifigkeit des Holzes.'
 },
 preis:{
     icon:'üí∞',
     name:'Preis',
     unit:'(‚Ç¨/m¬≥)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Ungef√§hrer Marktpreis pro Kubikmeter. G√ºnstiger gewinnt.'
 }
};

const sounds={
 flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
 win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
 chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
 starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images";
const IMG_SUFFIX = "?raw=true";

const woodCards=[
 {name:"Douglasie", dk:5, druckfestigkeit:68, quellen:7.7, rohdichte:510, emodul:13000, preis:3450, imgTree:`${IMG_BASE}/douglasie_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpg${IMG_SUFFIX}`},
 {name:"Ebenholz, Afrikanisches", dk:1.5, druckfestigkeit:70, quellen:12.8, rohdichte:1200, emodul:13400, preis:58000, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`},
 {name:"Edelkastanie", dk:2, druckfestigkeit:52, quellen:6.7, rohdichte:620, emodul:9000, preis:1500, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"Eibe", dk:2, druckfestigkeit:58, quellen:5.3, rohdichte:670, emodul:15000, preis:3950, imgTree:`${IMG_BASE}/eibe_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eibe_2.jpeg${IMG_SUFFIX}`},
 {name:"Eiche", dk:2, druckfestigkeit:38, quellen:11.9, rohdichte:665, emodul:13000, preis:1500, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"Erle", dk:5, druckfestigkeit:55, quellen:9.3, rohdichte:550, emodul:9500, preis:680, imgTree:`${IMG_BASE}/erle_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/erle_2.jpeg${IMG_SUFFIX}`},
 {name:"Esche", dk:5, druckfestigkeit:52, quellen:8.4, rohdichte:650, emodul:13000, preis:1050, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpg${IMG_SUFFIX}`},
 {name:"Fichte", dk:4, druckfestigkeit:50, quellen:8, rohdichte:470, emodul:11000, preis:920, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"Hemlock", dk:4, druckfestigkeit:55, quellen:8.5, rohdichte:480, emodul:10000, preis:2550, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 {name:"Hickory", dk:4, druckfestigkeit:63, quellen:11, rohdichte:800, emodul:15000, preis:1900, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"Kiefer", dk:3.5, druckfestigkeit:55, quellen:12.4, rohdichte:510, emodul:11000, preis:660, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpg${IMG_SUFFIX}`},
 {name:"Kirschbaum", dk:3, druckfestigkeit:54, quellen:8.7, rohdichte:630, emodul:10500, preis:1300, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"L√§rche", dk:3.5, druckfestigkeit:55, quellen:10.4, rohdichte:590, emodul:13800, preis:1200, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"Linde", dk:5, druckfestigkeit:52, quellen:10.7, rohdichte:530, emodul:7400, preis:1110, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"Mahagoni Amerikanisch", dk:2, druckfestigkeit:50, quellen:5.1, rohdichte:600, emodul:10700, preis:4600, imgTree:`${IMG_BASE}/mahagoni_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"Meranti (DR)", dk:3.5, druckfestigkeit:63, quellen:9.7, rohdichte:710, emodul:14500, preis:2100, imgTree:`${IMG_BASE}/meranti_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/meranti_2.jpeg${IMG_SUFFIX}`},
 {name:"Nussbaum (EU)", dk:3, druckfestigkeit:72, quellen:7.5, rohdichte:680, emodul:11850, preis:2450, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"Palisander", dk:1, druckfestigkeit:80, quellen:8.1, rohdichte:850, emodul:12900, preis:20000, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"Pappel", dk:5, druckfestigkeit:35, quellen:9.8, rohdichte:450, emodul:8800, preis:1100, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"Platane", dk:5, druckfestigkeit:46, quellen:8.7, rohdichte:620, emodul:12700, preis:1600, imgTree:`${IMG_BASE}/platane_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/platane_2.jpeg${IMG_SUFFIX}`},
 {name:"Redwood", dk:2, druckfestigkeit:43, quellen:5.2, rohdichte:400, emodul:9500, preis:930, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"Robinie", dk:1.5, druckfestigkeit:72, quellen:7.2, rohdichte:770, emodul:13600, preis:1650, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpg${IMG_SUFFIX}`},
 {name:"Rosskastanie", dk:5, druckfestigkeit:31, quellen:6.8, rohdichte:550, emodul:6540, preis:1500, imgTree:`${IMG_BASE}/rosskastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/rosskastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"Rotbuche", dk:5, druckfestigkeit:62, quellen:11.8, rohdichte:720, emodul:14000, preis:940, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"R√ºster", dk:4, druckfestigkeit:46, quellen:8.3, rohdichte:680, emodul:11000, preis:1300, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"Tanne", dk:4, druckfestigkeit:47, quellen:7.6, rohdichte:450, emodul:11000, preis:850, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"Teak", dk:1, druckfestigkeit:59, quellen:5.8, rohdichte:660, emodul:13000, preis:10638, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"Weng√©", dk:2, druckfestigkeit:90, quellen:9.4, rohdichte:860, emodul:16000, preis:3900, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"Zebrano", dk:2.5, druckfestigkeit:50, quellen:9.1, rohdichte:1050, emodul:15400, preis:3200, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"Zeder", dk:1.5, druckfestigkeit:43, quellen:11.2, rohdichte:545, emodul:7000, preis:5780, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`},
 {name:"Birke", dk:5, druckfestigkeit:51, quellen:11.4, rohdichte:650, emodul:14500, preis:750, imgTree:`${IMG_BASE}/birke_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"Ahorn", dk:5, druckfestigkeit:62, quellen:11.5, rohdichte:630, emodul:9400, preis:950, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`}
];

const detailedWoodInfo = {
    "Erle": `<p class="mb-2">R√∂tlich-wei√ües Holz, das an der Luft schnell nachdunkelt. Weich, aber z√§h. Unter Wasser extrem dauerhaft (Venedig-Pf√§hle).</p><p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Drechslerei, Modellbau, Blindholz, Wasserbau (historisch).</p>`,
    "Eiche": `<p class="mb-2">Der Klassiker im deutschen M√∂belbau. Hart, schwer und sehr witterungsbest√§ndig.</p><p class="mb-2"><strong>Verwendung:</strong> Massivholzm√∂bel, Parkett, Fenster, F√§sser.</p>`,
    "Teak": `<p class="mb-2">Sehr √∂lhaltiges Holz, das von Natur aus wasserabweisend ist.</p><p class="mb-2"><strong>Verwendung:</strong> Schiffsbau, Gartenm√∂bel, Terrassen.</p>`,
    "Birke": `<p class="mb-2">Helles, gelblich-wei√ües Holz mit feiner Maserung. Es ist elastisch und z√§h, aber nicht witterungsbest√§ndig.</p><p class="mb-2"><strong>Verwendung:</strong> Sperrholz, M√∂belbau, Drechselarbeiten.</p>`,
    "Ahorn": `<p class="mb-2">Eines der wertvollsten heimischen Edellaubh√∂lzer. Sehr hell, feinporig und dekorativ.</p><p class="mb-2"><strong>Verwendung:</strong> Tischplatten, Musikinstrumente, K√ºchenger√§te, Furniere.</p>`
};

const reflectionQuestions=[ "Welches Holz w√ºrdest du f√ºr Gartenm√∂bel w√§hlen und warum?", "Eine K√ºchenarbeitsplatte muss schnittfest sein. Welches Holz eignet sich?", "F√ºr einen Dielenboden: Hartes oder weiches Holz?", "Warum ist Teak im Schiffbau so beliebt?" ];

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

function showHappyWorm() {
    const worm = document.getElementById('happyWorm');
    if(!worm) return;
    worm.classList.remove('hidden', 'animate-worm');
    void worm.offsetWidth; worm.classList.add('animate-worm');
    setTimeout(() => worm.classList.add('hidden'), 3500);
}

function triggerConfetti() {
    var duration = 3000; var end = Date.now() + duration;
    (function frame() {
        confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
        confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
        if (Date.now() < end) requestAnimationFrame(frame);
    }());
}

// === ATTRIBUTE CONFIG FUNCTIONS ===
window.openAttrConfig = () => {
    const list = document.getElementById('attrConfigList');
    list.innerHTML = '';
    
    Object.keys(attributeInfo).forEach(key => {
        const info = attributeInfo[key];
        const isSelected = activeAttributeKeys.includes(key);
        
        const div = document.createElement('div');
        div.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
        div.onclick = () => toggleAttribute(key, div);
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-xl">${info.icon}</span>
                <div class="text-left leading-tight">
                    <div class="font-bold text-sm">${info.name}</div>
                    <div class="text-[10px] opacity-70">${info.unit}</div>
                </div>
            </div>
            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}">
                ${isSelected ? '‚úì' : ''}
            </div>
        `;
        list.appendChild(div);
    });
    
    document.getElementById('attrConfigModal').classList.remove('hidden');
};

function toggleAttribute(key, el) {
    const idx = activeAttributeKeys.indexOf(key);
    if (idx > -1) {
        if(activeAttributeKeys.length <= 3) { alert("Mindestens 3 Eigenschaften m√ºssen aktiv sein!"); return; }
        activeAttributeKeys.splice(idx, 1);
    } else {
        if(activeAttributeKeys.length >= 5) { alert("Maximal 5 Eigenschaften d√ºrfen aktiv sein!"); return; }
        activeAttributeKeys.push(key);
    }
    // Re-render UI state locally without closing
    const isSelected = activeAttributeKeys.includes(key);
    el.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
    el.querySelector('.w-6').className = `w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}`;
    el.querySelector('.w-6').innerHTML = isSelected ? '‚úì' : '';
    
    // Update badge on start screen
    document.getElementById('attrCountBadge').innerText = activeAttributeKeys.length;
}


// === CORE UI FUNCTIONS ===
function updateStatusBar(p, o){
    const total=p+o; const pct=(total===0)?50:(p/total)*100;
    const bar=document.getElementById('statusBar'); const ball=document.getElementById('statusBall');
    bar.style.width=`${pct}%`; ball.style.left=`${pct}%`;
}

function createCard(data, isRevealed, isPlayer, isActive, highlightAttr){
    const card = document.createElement('div');
    card.className = `card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''}`;
    if(!isRevealed) card.classList.add('card-flipped');
    if(isPlayer) { card.setAttribute('role', 'button'); card.setAttribute('tabindex', '0'); }

    const canSelect = isPlayer && ((gameMode==='ai' && aiGame.turn==='player' && !aiGame.roundInProgress) || (gameMode==='multiplayer' && localGameState.turn===localPlayerId && !localGameState.lastResult));
    
    const front = document.createElement('div');
    const bClass = isActive ? 'border-orange-500 ring-4 ring-orange-200' : 'border-orange-200';
    front.className = `card-front card-front-bg rounded-2xl shadow-lg border-4 ${bClass} flex flex-col transition-all`;
    let html = `<div class="pt-3 px-3 pb-1"><h2 class="text-lg sm:text-xl font-bold text-amber-900 leading-none">${data.name}</h2></div>
                <div class="mx-3 mt-1 mb-2 aspect-[4/3] rounded-xl overflow-hidden bg-white shadow-sm border border-orange-100">
                    <img src="${data.imgTree}" class="w-full h-full object-cover">
                </div>
                <div class="flex-grow flex flex-col justify-start gap-1 sm:gap-2 px-2 pb-2 overflow-y-auto hide-scrollbar">`;
    
    // ITERATE ONLY OVER ACTIVE ATTRIBUTES
    for(const k of activeAttributeKeys){
        const info = attributeInfo[k];
        let flashClass = '';
        if(highlightAttr === k) flashClass = isActive ? 'flash-active' : 'highlight-compare';
        
        const rowInner = `<div class="flex items-center gap-2"><span class="text-base">${info.icon}</span><div class="flex flex-col text-left leading-none"><span class="font-bold text-gray-800 text-[10px] sm:text-sm">${info.name}</span><span class="text-[9px] text-gray-500 font-medium">${info.unit}</span></div></div><span class="text-sm font-bold text-amber-800">${data[k]}</span>`;
        if(canSelect) html += `<div onclick="window.selectAttribute('${k}')" data-attr-btn="${k}" class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl cursor-pointer hover:brightness-95 ${flashClass}">${rowInner}</div>`;
        else html += `<div class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl opacity-90 ${flashClass}" data-attr-row="${k}">${rowInner}</div>`;
    }
    html += '</div>';
    front.innerHTML = html;

    const back = document.createElement('div');
    back.className = `card-back rounded-2xl shadow-lg relative ${isActive ? 'border-orange-500' : 'border-white'}`;
    if(!isPlayer && isOpponentNameBackVisible()){
        const lbl = document.createElement('div'); lbl.className = 'opponent-back-name'; lbl.innerText = data.name; back.appendChild(lbl);
    }
    card.appendChild(front); card.appendChild(back);
    return card;
}

// AI Function: updateDisplayAI (Restored)
function updateDisplayAI(){
    const pc=aiGame.playerCards.length; const ac=aiGame.aiCards.length;
    document.getElementById('playerCards').innerText=pc; document.getElementById('aiCards').innerText=ac;
    updateStatusBar(pc,ac);
    const pcEl=document.getElementById('playerCard'); pcEl.innerHTML='';
    const acEl=document.getElementById('aiCard'); acEl.innerHTML='';
    const isPTurn = aiGame.turn === 'player';
    
    if(aiGame.currentPlayerCard) pcEl.appendChild(createCard(aiGame.currentPlayerCard, true, true, isPTurn, null));
    if(aiGame.currentAiCard) acEl.appendChild(createCard(aiGame.currentAiCard, false, false, !isPTurn, null));
    
    if(aiGame.turn==='ai' && !aiGame.roundInProgress) setTimeout(aiTurn, 1000);
}

function evaluateRoundAI(attr){
    const pv=aiGame.currentPlayerCard[attr]; const av=aiGame.currentAiCard[attr];
    const logic = attributeInfo[attr].logic;
    let pWins = (logic === 'Niedrig gewinnt') ? (pv < av) : (pv > av);
    if(pv === av) pWins = 'tie';

    const resText = pWins===true ? 'Du gewinnst!' : (pWins===false ? 'Computer gewinnt!' : 'Unentschieden');
    const resColor = pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-gray-600');
    
    document.getElementById('resultText').innerText = resText;
    document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
    document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${pv} vs ${av}`;
    
    if(pWins===true) { playSound(sounds.win); showHappyWorm(); lastRoundWinningWoodName = aiGame.currentPlayerCard.name; } 
    else if (pWins===false) { lastRoundWinningWoodName = aiGame.currentAiCard.name; } 
    else { lastRoundWinningWoodName = aiGame.currentPlayerCard.name; }
    
    openBottomSheet(resText);
    const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
    if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
    else if(pWins===false){ aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }
    else { aiGame.playerCards.push(pC); aiGame.aiCards.push(aC); }

    if(aiGame.playerCards.length===0) window.endGame("Computer");
    if(aiGame.aiCards.length===0) window.endGame(aiGame.playerName);
}

function aiTurn(){
    if(aiGame.roundInProgress) return;
    // Choose random attribute from ACTIVE keys
    const k=activeAttributeKeys[Math.floor(Math.random()*activeAttributeKeys.length)];
    aiGame.roundInProgress = true;
    const aiCardEl = document.getElementById('aiCard');
    const row = aiCardEl.querySelector(`div[data-attr-row="${k}"]`);
    if(row) row.classList.add('flash-active'); 
    setTimeout(() => { 
        const ac=document.getElementById('aiCard').querySelector('.card-3d');
        if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
        const playerCardEl = document.getElementById('playerCard');
        const pRow = playerCardEl.querySelector(`div[data-attr-btn="${k}"]`) || playerCardEl.querySelector(`div[data-attr-row="${k}"]`);
        if(pRow) pRow.classList.add('highlight-compare');
        setTimeout(() => evaluateRoundAI(k), 2000);
    }, 500);
}

// Multiplayer Functions - RESTORED
function listenToGameChanges(){
    if(!gameId) return;
    // Updated Path: artifacts/{appId}/public/data/games/{gameId}
    unsubscribeGame=onSnapshot(getPublicDataRef("games", gameId),(ds)=>{
        if(!ds.exists()) { window.resetGame(); return; }
        const gd=ds.data(); localGameState=gd;
        if(gd.status==='playing'||gd.status==='finished'){
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            scrollToTop(); // Scroll to top on game update
            
            const oppId=gd.playerIds.find(id=>id!==localPlayerId);
            document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
            document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
            const pCount = gd.players[localPlayerId]?.cards?.length||0;
            const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
            document.getElementById('playerCards').innerText = pCount;
            document.getElementById('aiCards').innerText = oCount;
            updateStatusBar(pCount, oCount);
            
            const highlightAttr = gd.lastResult ? gd.lastResult.attribute : null;

            const pc = document.getElementById('playerCard'); const ac = document.getElementById('aiCard');
            pc.innerHTML=''; ac.innerHTML='';
            const isPlayerTurn = gd.turn === localPlayerId;
            if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true, isPlayerTurn, highlightAttr));
            
            if(oppId && gd.currentCards[oppId]){
                const c = createCard(gd.currentCards[oppId], false, false, !isPlayerTurn, highlightAttr);
                ac.appendChild(c);
                if(gd.lastResult){
                    setTimeout(()=> { c.classList.remove('card-flipped'); playSound(sounds.flip); }, 100);
                }
            } else {
                ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte auf Gegner-Karte...</div>`;
            }
            
            if(gd.lastResult){
                 const wId = gd.lastResult.winnerId;
                 const iWin = wId===localPlayerId;
                 
                 if(wId === 'tie') {
                     lastRoundWinningWoodName = gd.currentCards[localPlayerId].name;
                 } else if (gd.currentCards[wId]) {
                     lastRoundWinningWoodName = gd.currentCards[wId].name;
                 }

                 if(!roundSoundPlayed && iWin) playSound(sounds.win);
                 roundSoundPlayed=true;
                 
                 const resText = iWin ? 'Du gewinnst!' : (wId==='tie'?'Unentschieden':'Gegner gewinnt!');
                 document.getElementById('resultText').className = iWin ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
                 document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
                 if(iWin) showHappyWorm();
                 if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(resText);
            } else {
                 roundSoundPlayed=false; closeBottomSheet();
            }
            document.getElementById('turnIndicator').innerText = (gd.turn===localPlayerId) ? "Du bist am Zug!" : "Gegner w√§hlt...";
            if(gd.status==='finished'){
                let winnerName = "";
                if (gd.players[localPlayerId].cards.length > 0) winnerName = gd.players[localPlayerId].name;
                else if (oppId && gd.players[oppId].cards.length > 0) winnerName = gd.players[oppId].name;
                window.endGame(winnerName);
            }
        }
    });
}

// Window Exports
window.selectAttribute = async (attr) => {
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        aiGame.roundInProgress = true;
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`); if(btn) btn.classList.add('flash-active');
        setTimeout(() => {
            const ac=document.getElementById('aiCard').querySelector('.card-3d');
            if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
            const oppRow = document.getElementById('aiCard').querySelector(`div[data-attr-row="${attr}"]`);
            if(oppRow) oppRow.classList.add('highlight-compare');
            setTimeout(() => evaluateRoundAI(attr), 2000);
        }, 500);
    } else {
        if(!localGameState || localGameState.turn!==localPlayerId) return;
        const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
        const pv = localGameState.currentCards[localPlayerId][attr];
        const ov = localGameState.currentCards[opp][attr];
        const logic = attributeInfo[attr].logic;
        let pWins = (logic === 'Niedrig gewinnt') ? (pv < ov) : (pv > ov);
        if(pv === ov) pWins = 'tie';
        const winner = pWins==='tie' ? 'tie' : (pWins ? localPlayerId : opp);
        // Update Game Doc
        await updateDoc(getPublicDataRef("games", gameId),{
            lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:pv, [opp]:ov}}
        });
    }
};

window.startGameAI = (name) => {
    trackEvent('games_ai');
    gameMode='ai'; aiGame.playerName=name;
    window.setNavState('game');
    document.getElementById('playerNameDisplay').innerText=name;
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
    document.getElementById('gameContainer').classList.remove('hidden');
    scrollToTop(); // Scroll to top when game starts
    updateDisplayAI();
};

let authRetries = 0;
window.createGame = async (playerName) => {
    if (!auth || !auth.currentUser) { 
        if(authRetries > 10) { alert("Verbindungsfehler"); return; }
        authRetries++; setTimeout(() => window.createGame(playerName), 500); return; 
    }
    localPlayerId = auth.currentUser.uid;
    trackEvent('games_multiplayer');
    gameMode='multiplayer';
    const lobby=document.getElementById('multiplayerLobbyModal'); lobby.classList.remove('hidden');
    gameId=Math.random().toString(36).substring(2,8).toUpperCase();
    const joinUrl=`${window.location.href.split('?')[0]}?game=${gameId}`;
    document.getElementById('shareLink').value=joinUrl;
    
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {text: joinUrl, width: 128, height: 128});
    
    // Create new game in correct path
    await setDoc(getPublicDataRef("games", gameId),{
        gameId, status:'waiting', playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
        createdAt:serverTimestamp()
    });
    listenToGameChanges();
};

window.joinGame = async (id, playerName) => {
    if (!auth || !auth.currentUser) { setTimeout(()=>window.joinGame(id,playerName), 500); return; }
    localPlayerId = auth.currentUser.uid;
    gameMode='multiplayer'; gameId = id;
    const ref = getPublicDataRef("games", id);
    const snap = await getDoc(ref);
    if(snap.exists() && snap.data().status==='waiting'){
        document.getElementById('lobbyTitle').textContent="Verbinde...";
        document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
        const sh=shuffleArray([...woodCards]);
        const p1=snap.data().playerIds[0];
        
        await updateDoc(ref,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:sh.slice(15,30),status:'online'},
            [`players.${p1}.cards`]:sh.slice(0,15),
            turn:p1, currentCards:{[p1]:sh.slice(0,15)[0],[localPlayerId]:sh.slice(15,30)[0]},
            lastResult:null
        });
        scrollToTop(); // Scroll to top when joining
        window.setNavState('game');
        listenToGameChanges();
    } else {
        alert("Spiel nicht gefunden oder voll.");
        window.location.href = window.location.href.split('?')[0];
    }
};

window.nextRound = async () => {
    scrollToTop(); // Scroll to top for next round
    if(gameMode==='ai'){
        aiGame.currentPlayerCard=aiGame.playerCards[0];
        aiGame.currentAiCard=aiGame.aiCards[0];
        aiGame.roundInProgress=false;
        updateDisplayAI();
    } else {
        const gs = localGameState;
        const [p1,p2] = gs.playerIds;
        let c1=gs.players[p1].cards.shift();
        let c2=gs.players[p2].cards.shift();
        const w = gs.lastResult.winnerId;
        
        if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
        else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        
        if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
            await updateDoc(getPublicDataRef("games", gameId), {status:'finished', players:gs.players});
            return;
        }
        const nextT = w==='tie' ? gs.turn : w;
        await updateDoc(getPublicDataRef("games", gameId), {
            lastResult:null, turn:nextT, players:gs.players,
            currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
        });
    }
};

window.showFinalWinScreen = () => {
    document.getElementById('reflectionModal').classList.add('hidden');
    // NOTE: This call is now redundant as endGame handles display, 
    // but kept as transition for Reflection Modal 'Weiter' button
    // It should ideally call window.endGame directly with stored winner name if needed
};

// === GAMIFICATION LOGIC ===
const calculateRank = (count) => {
    if (count >= 100) return { title: "Leim-Legende", stars: 6 };
    if (count >= 50) return { title: "Astloch-Philosoph", stars: 5 };
    if (count >= 30) return { title: "Brett-Bezwinger", stars: 4 };
    if (count >= 20) return { title: "Hobel-Held", stars: 3 };
