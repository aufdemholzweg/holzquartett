<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library (bleibt global) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Optimierung f√ºr Mobile Viewports (Adressleiste) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfbf7;
            touch-action: manipulation;
            overflow-x: hidden;
            min-height: 100dvh;
        }

        /* 3D Karten Effekte */
        .perspective-1000 { perspective: 1000px; }
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            border-radius: 1rem;
            overflow: hidden;
            box-sizing: border-box; /* Wichtig f√ºr Border */
        }
        .card-back {
            transform: rotateY(180deg);
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images/background_card.jpg?raw=true');
            background-size: cover;
            background-position: center;
            border: 4px solid white;
        }
        .card-front-bg {
            background-color: #fffbeb; 
            background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7);
        }

        /* Animationen */
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        .falling-star {
            position: absolute;
            font-size: 4rem;
            z-index: 100;
            animation: fall-and-fade 1.2s ease-in forwards;
            pointer-events: none;
        }
        @keyframes fall-and-fade {
            0% { transform: translateY(-30px) scale(1.5) rotate(0deg); opacity: 0; }
            30% { transform: translateY(0) scale(1) rotate(45deg); opacity: 1; }
            100% { transform: translateY(300px) scale(0.5) rotate(180deg); opacity: 0; }
        }

        /* Glitzer / Pulsieren f√ºr den Status-Ball */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); transform: translate(-50%, -50%) scale(1); }
            50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); transform: translate(-50%, -50%) scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: translate(-50%, -50%) scale(1); }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* Holzwurm Animation */
        @keyframes worm-pop-up {
            0% { transform: translateY(100%) rotate(0deg); opacity: 0; }
            20% { transform: translateY(-20%) rotate(-10deg); opacity: 1; }
            40% { transform: translateY(-20%) rotate(10deg); }
            50% { transform: translateY(-30%) rotate(0deg) scale(1.1); } /* H√ºpfer */
            60% { transform: translateY(-20%) rotate(-10deg) scale(1); }
            80% { transform: translateY(-20%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100%) rotate(0deg); opacity: 0; }
        }
        .animate-worm {
            animation: worm-pop-up 3.5s ease-in-out forwards;
        }

        /* Name auf R√ºckseite Gegner */
        .opponent-back-name {
            position: absolute;
            top: 15%;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.95);
            font-weight: 700;
            font-size: 1.1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .dimmer { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        
        .attr-box {
            background-color: #fff7ed;
            border: 1px solid #fbbf24;
            transition: all 0.2s;
        }
        /* Orange Flash (Aktive Auswahl) - GE√ÑNDERT */
        .attr-box.flash-active {
            background-color: #f97316 !important; /* orange-500 */
            border-color: #ea580c !important; /* orange-600 */
            color: white !important;
        }
        .attr-box.flash-active span {
            color: white !important;
        }
        
        /* Grau/Schwarz Highlight (Vergleichswert) */
        .attr-box.highlight-compare {
            background-color: #e5e7eb !important; /* gray-200 */
            border-color: #9ca3af !important; /* gray-400 */
            color: #111827 !important; /* gray-900 (fast schwarz) */
        }
        .attr-box.highlight-compare span {
            color: #000000 !important;
        }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">

<!-- Header -->
<header class="bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-20 flex-shrink-0">
    <div class="max-w-[600px] mx-auto px-4 py-3 relative flex justify-between items-center">
        <!-- Home Button Links -->
        <button onclick="sessionStorage.setItem('skipSplash', 'true'); window.location.reload();" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-10">
             <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
             </svg>
        </button>

        <!-- Titel Links (Jetzt absolut mittig) -->
        <h1 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg sm:text-2xl font-black tracking-wider uppercase drop-shadow-sm whitespace-nowrap">
            üå≤ HOLZEN! üå≤
        </h1>
        
        <!-- Info Button Rechts -->
        <button onclick="window.showGameInfo()" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-10">
             <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
             </svg>
        </button>
    </div>
</header>

<!-- === GAME AREA === -->
<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto relative p-2 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <!-- Haupt-Layout: Flex Row f√ºr zwei Spalten -->
    <div class="flex justify-center items-start gap-2 sm:gap-4 w-full flex-grow relative pb-2 mt-2"> 
        
        <!-- SPALTE SPIELER -->
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <!-- Score Box -->
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="playerNameDisplay" class="text-base sm:text-lg font-bold text-amber-700 leading-tight truncate">Spieler</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            
            <!-- Karte -->
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="playerCardContainer">
                <div id="playerCard" class="w-full h-full relative"></div>
            </div>
        </div>

        <!-- SPALTE GEGNER -->
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <!-- Score Box -->
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="opponentNameDisplay" class="text-base sm:text-lg font-bold text-gray-600 leading-tight truncate">COMPUTER</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>

            <!-- Karte -->
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="aiCardContainer">
                <div id="aiCard" class="w-full h-full relative"></div>
            </div>
        </div>

    </div>

    <!-- Statusbalken (Breiter & Kugel) -->
    <div class="w-full mt-4 mb-24"> 
        <div class="flex justify-between text-[9px] sm:text-[10px] font-bold text-gray-400 mb-1 px-1">
            <span>Dein Stapel</span><span>Gegenspieler</span>
        </div>
        <!-- Balken Container -->
        <div class="h-4 w-full bg-gray-200 rounded-full shadow-inner relative">
            <!-- Farbiger Balken -->
            <div id="statusBar" class="h-full bg-amber-500 rounded-l-full transition-all duration-500 ease-out" style="width: 50%;"></div>
            
            <!-- Die Kugel (Ball) -->
            <div id="statusBall" class="absolute top-1/2 w-6 h-6 rounded-full border-2 border-white shadow-md transition-all duration-500 ease-out z-10" 
                 style="left: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);">
            </div>
        </div>
    </div>
</div>

<!-- === HAPPY WOODWORM (Holzwurm) === -->
<div id="happyWorm" class="fixed bottom-0 right-4 translate-y-full z-50 pointer-events-none transform transition-transform hidden">
    <div class="relative">
        <!-- Sprechblase -->
        <div id="wormSpeech" class="absolute -top-10 -left-10 bg-white px-3 py-1.5 rounded-xl shadow-md border-2 border-amber-200 text-xs font-bold text-amber-800 whitespace-nowrap animate-bounce" style="animation-duration: 2s;">
            Stark! ü™µ
        </div>
        <!-- Wurm Emoji (Gro√ü) -->
        <div class="text-6xl filter drop-shadow-xl cursor-default select-none">üêõ</div>
    </div>
</div>

<!-- === BOTTOM SHEET === -->
<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-xs sm:text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-xl sm:text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>

        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-purple-800 transition text-sm sm:text-base">
                üéì Zusatzwissen
            </button>
            <button id="bsNextBtn" class="flex-1 bg-amber-500 hover:bg-amber-600 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-700 transition text-sm sm:text-base">
                Weiter &rarr;
            </button>
        </div>
    </div>
</div>

<!-- === SPLASH SCREEN (NEU) === -->
<div id="splashModal" class="fixed inset-0 bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center z-[100]">
    <div class="text-center text-white p-8 animate-pulse" style="animation-duration: 1.5s;">
        <h1 class="text-4xl sm:text-5xl font-black tracking-wider drop-shadow-lg">
            üå≤ HOLZEN! üå≤
        </h1>
    </div>
</div>

<!-- === GAME INFO MODAL (NEU) === -->
<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[90vh] flex flex-col">
        <div class="bg-amber-500 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 class="font-bold text-lg">Spielregeln & Eigenschaften</h3>
            <button onclick="document.getElementById('gameInfoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto hide-scrollbar space-y-5">
            <h4 class="font-bold text-gray-700 text-md">Regeln (Quartett-Prinzip)</h4>
            <p class="text-sm text-gray-600">Wer am Zug ist, w√§hlt eine Eigenschaft seiner Karte, die den gr√∂√ütm√∂glichen Vorteil verspricht (je nach Kategorie gewinnt der h√∂chste oder der niedrigste Wert, siehe unten). Gewinnt die Person den Spielzug, erh√§lt sie beide Karten, legt sie unter den eigenen Stapel und bleibt am Zug. Bei einem Unentschieden behalten beide ihre Karte, das Zugrecht bleibt unver√§ndert.</p>
            
            <h4 class="font-bold text-gray-700 text-md pt-3">Eigenschaften on Holz</h4>

            <!-- Kategorie Liste -->
            <div id="infoCategoryList" class="space-y-3">
                <!-- Dynamisch durch JS gef√ºllt -->
            </div>
            
        </div>
    </div>
</div>

<!-- === MODALS (rest) === -->
<div id="setupModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-sm w-full">
        <div class="bg-amber-500 p-5 text-white text-center font-bold text-lg sm:text-xl tracking-wide shadow-md">
            HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus w√§hlen</span>
        </div>
        <div class="p-6 space-y-5">
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 active:scale-[0.98] text-white font-bold py-4 rounded-xl shadow-lg transform transition duration-200 flex items-center justify-center gap-3">
                <span class="text-2xl">ü§ñ</span> Gegen Computer
            </button>
            <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 active:scale-[0.98] text-white font-bold py-4 rounded-xl shadow-lg transform transition duration-200 flex items-center justify-center gap-3">
                <span class="text-2xl">üåç</span> Online gegen Freunde
            </button>
            <div class="pt-4 space-y-4 border-t border-gray-100 mt-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700 flex items-center gap-2">üîä Ton an</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="soundToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-gray-700 flex items-center gap-2">üëÄ Gegner-Karte sichtbar</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="revealBackToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
        <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg focus:border-amber-500 focus:outline-none" placeholder="Name eingeben" maxlength="12">
        <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600 transition transform active:scale-95">Starten</button>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund den QR-Code scannen:</p>
        
        <!-- QR Code Container -->
        <div class="flex justify-center mb-4">
            <div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div>
        </div>

        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p id="lobbyStatus" class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>

<div id="infoModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-md w-full max-h-[90vh] flex flex-col">
        <div class="bg-purple-700 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 id="infoModalTitle" class="font-bold text-lg flex items-center gap-2">üéì Zusatzwissen</h3>
            <button onclick="window.closeInfoModal()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto hide-scrollbar space-y-4"></div>
        <div class="p-3 bg-gray-50 border-t shrink-0 text-center">
            <button onclick="window.closeInfoModal()" class="text-purple-600 font-bold text-sm hover:underline">Schlie√üen</button>
        </div>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
        <p id="gameOverText" class="text-gray-600 mb-6"></p>
        <div class="space-y-3">
            <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">üèÜ Bestenliste</button>
            <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">üîÑ Neues Spiel</button>
        </div>
    </div>
</div>

<div id="reflectionModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-amber-800 mb-4">üéâ Super gespielt!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 font-medium"></p>
        <textarea id="reflectionAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg">Weiter</button>
    </div>
</div>

<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">Schlie√üen</button>
    </div>
</div>

<!-- Scripts -->
<script type="module">
// Import Firebase directly as module (v9+) to avoid namespace issues
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// === FIREBASE CONFIGURATION (ROBUST HANDLING) ===
let app, auth, db, appId;
let isFirebaseAvailable = false;

try {
    // Check if configuration variables are available
    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        const firebaseConfig = JSON.parse(__firebase_config);
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        isFirebaseAvailable = true;
    } else {
        console.warn("Offline Mode: Firebase configuration not found. Multiplayer features disabled.");
    }
} catch (error) {
    console.warn("Offline Mode: Error initializing Firebase.", error);
    isFirebaseAvailable = false;
}

// Helper for safe collection access
const getPublicCollection = (colName) => {
    if (!isFirebaseAvailable) return null;
    return collection(db, 'artifacts', appId, 'public', 'data', colName);
};
const getPublicDoc = (colName, docId) => {
    if (!isFirebaseAvailable) return null;
    return doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
};

// Safe Auth Init
const initAuth = async () => {
    if (!isFirebaseAvailable) return;
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (e) {
        console.warn("Auth failed, running offline.");
    }
};
initAuth();

// Safe Tracking
async function trackEvent(type) {
    if (!isFirebaseAvailable) return;
    try {
        const ref = getPublicDoc("statistics", "usage"); 
        await setDoc(ref, {
            [type]: increment(1),
            last_activity: serverTimestamp()
        }, { merge: true });
    } catch (e) {
        // Silent fail in offline
    }
}

// Safe Leaderboard Save
async function saveToLeaderboard(name){
    if (!isFirebaseAvailable || !name) return;
    const safe=name.replace(/[.#$[\]]/g,'_');
    try{ await setDoc(getPublicDoc("leaderboard",safe),{name,wins:increment(1),lastWin:serverTimestamp()},{merge:true}); }catch(e){}
}

// Safe Leaderboard Fetch
window.showLeaderboard = async function(){
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    
    if (!isFirebaseAvailable) {
        list.innerHTML = '<div class="text-center py-4 text-gray-400">Offline-Modus<br>Bestenliste nicht verf√ºgbar</div>';
        return;
    }

    try {
        const q=query(getPublicCollection("leaderboard"),orderBy("wins","desc"),limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine Eintr√§ge</div>'; return; }
        
        list.innerHTML = snap.docs.map((d,i)=>`
            <div class="flex justify-between items-center p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100">
                <span class="font-bold text-gray-700 text-sm">${i+1}. ${d.data().name}</span>
                <span class="font-bold text-amber-600 text-sm">${d.data().wins} üèÜ</span>
            </div>
        `).join('');
    } catch(e){ list.innerHTML='<div class="text-center text-red-400">Fehler beim Laden</div>'; }
};

let gameMode=null, gameId=null, localPlayerId='offline-player', unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;
const sounds={
 flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
 win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
 chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
 starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

// --- HOLZ DATEN ---
// GitHub Base URL
const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/b9d51d5b5d930f643a3f3861262361b97c0beb7c/images";
const IMG_SUFFIX = "?raw=true";

// Das Array mit expliziten Bildpfaden, um JPG/JPEG Konflikte zu vermeiden
const woodCards=[
 {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpg${IMG_SUFFIX}`},
 {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000, imgTree:`${IMG_BASE}/birke_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`},
 {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpg${IMG_SUFFIX}`},
 {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000, imgTree:`${IMG_BASE}/douglasie_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpg${IMG_SUFFIX}`},
 {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`},
 {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500, imgTree:`${IMG_BASE}/mahagoni_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000, imgTree:`${IMG_BASE}/bambus_1.jpg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/bambus_2.jpg${IMG_SUFFIX}`},
 {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000, imgTree:`${IMG_BASE}/weide_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/weide_2.jpeg${IMG_SUFFIX}`},
 {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpg${IMG_SUFFIX}`},
 {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 // Zypresse war nicht in deiner Liste, ich nehme Fallback oder Platzhalter
 {name:"Zypresse",dk:2,haerte:48,quellenSchwindenRadial:3.0,dichte:520,gewicht:9000, imgTree:`https://placehold.co/400x300?text=Zypresse`, imgCross:`https://placehold.co/400x300?text=Zypresse+Quer`},
 {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`}
];

const detailedWoodInfo = {
    "Eiche": `
        <p class="mb-2">Hart, schwer, sehr dauerhaft; hoher Gerbstoffanteil, daher widerstandsf√§hig gegen Pilze/Sch√§dlinge, kann mit Eisen schwarz verf√§rben. Grobporig, deutliche Jahresringe.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Fu√üb√∂den, Treppen, Fassdauben, Au√üenbau (z. B. Terrassen), Fachwerk.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionsholz und Symbol f√ºr St√§rke; h√§ufig in Wappen/M√ºnzen.</p>
    `,
    "Buche": `
        <p class="mb-2">Z√§h, biegsam, gleichm√§√üige Struktur; ringporig mit dezenten √úberg√§ngen, harzarm.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Parkett, Furniere, Sperrholz, Innenausbau.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Historisch beliebt f√ºr R√§der/Griffe wegen Z√§higkeit und Elastizit√§t.</p>
    `,
    "Kiefer": `
        <p class="mb-2">Weiches, harzhaltiges Nadelholz mit markanter Jahresringstruktur und Harzkan√§len.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Bauholz, Dachst√ºhle, Innenausbau, Paneele, einfache M√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Kiefernharz diente fr√ºher als Klebstoff und Dichtmittel.</p>
    `,
    "Fichte": `
        <p class="mb-2">Leichtes Bauholz mit gutem Festigkeits-Gewichts-Verh√§ltnis; feine Zellstruktur ohne gro√üe Poren.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Bauholz, Innenverkleidung, Paneele, M√∂belgrundkonstruktionen.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Klassiker im Dach- und Hallenbau vieler Alpenregionen.</p>
    `,
    "Tanne": `
        <p class="mb-2">Harzarm, fein, √§hnlich Fichte; dezente Jahresringe, keine gro√üen Poren.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Paneele, Bauholz, M√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Angenehm geruchsarm im Innenraum durch wenig Harz.</p>
    `,
    "L√§rche": `
        <p class="mb-2">Relativ hart und witterungsbest√§ndig; deutliche Jahresringe, harzhaltig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Fassaden, Fenster, Terrassen, Au√üenm√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Vergraut edel im Au√üenbereich auch ohne chemische Behandlung.</p>
    `,
    "Birke": `
        <p class="mb-2">Helles, dekoratives Holz; zerstreutporig, feine gleichm√§√üige Struktur, gut biegbar.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Furniere, Sperrholz, Innenausbau.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Birkenrinde wurde traditionell als wasserabweisendes Material genutzt.</p>
    `,
    "Ahorn": `
        <p class="mb-2">Hart, hell, sehr fein und homogen; zerstreutporig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Parkett, Schneidebretter, Instrumentenbau.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Ahornsirup stammt v. a. aus nordamerikanischen Arten.</p>
    `,
    "Esche": `
        <p class="mb-2">Sehr z√§h und elastisch; ringporig mit deutlichen Fr√ºhholzporen.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Werkzeugstiele, Sportger√§te, M√∂bel, Parkett.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Klassisches Holz f√ºr Speichen und Stiele wegen Elastizit√§t.</p>
    `,
    "Kirsche": `
        <p class="mb-2">Warm r√∂tlich, edel; ringporig, klare Jahresringe, dunkelt mit Licht nach.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Furniere, Innenausbau.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Entwickelt mit der Zeit eine charakteristische, tiefere Farbigkeit.</p>
    `,
    "Nussbaum": `
        <p class="mb-2">Dunkles, dekoratives Kernholz; zerstreutporig, markante Maserung.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Hochwertige M√∂bel, Furniere, Intarsien.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Renaissance-Liebling f√ºr repr√§sentative Innenausstattungen.</p>
    `,
    "Douglasie": `
        <p class="mb-2">Robust, relativ dauerhaft; deutliche Jahresringe, gut f√ºr Au√üen.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Bauholz, Fassaden, Terrassen, Au√üenm√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Urspr√ºnglich nordamerikanisch, in Europa weit verbreitet.</p>
    `,
    "Zeder": `
        <p class="mb-2">Angenehmer Duft, nat√ºrlich insektenabweisend; fein und gleichm√§√üig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Schr√§nke, Fassaden, Innenraum.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Beliebt in Kleiderschr√§nken wegen Geruch und Mottenabwehr.</p>
    `,
    "Mahagoni": `
        <p class="mb-2">Tropisches Edelholz, dauerhaft; zerstreutporig, dekoratives Kernholz.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Fenster, Bootsbau, hochwertige Ausbauten.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Teilweise artenschutzreguliert ‚Äì Herkunft/Handel beachten.</p>
    `,
    "Teak": `
        <p class="mb-2">Sehr witterungsbest√§ndig (√ñl-/Harzgehalt); fein zerstreutporig, edle Optik.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Gartenm√∂bel, Terrassen, Bootsdecks, Au√üenfenster.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Historisch gesch√§tzt im Schiffbau wegen Dauerhaftigkeit.</p>
    `,
    "Bambus": `
        <p class="mb-2">Botanisch Gras, aber sehr fest; r√∂hrenartige Struktur statt klassischer Poren.</p>
        <p class="mb-2"><strong>Verwendung:</strong> B√∂den, M√∂bel, Treppen, nachhaltiger Leichtbau.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Extrem schnelles Wachstum, daher √∂kologisch interessant.</p>
    `,
    "Pappel": `
        <p class="mb-2">Sehr leicht und weich; feine Struktur, dezente Jahresringe.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Leichtbau, Verpackungen, Innenm√∂bel mit geringer Last.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Gern im Modell- und Fahrzeuginnenausbau genutzt.</p>
    `,
    "Weide": `
        <p class="mb-2">Elastisch und biegsam; fein zerstreutporig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Flechtwerk, K√∂rbe, Gartenbau, leichte M√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Weidenruten sind klassische Materialien f√ºr Geflechte.</p>
    `,
    "Linde": `
        <p class="mb-2">Weich, homogen, sehr gut schnitzbar; fein zerstreutporig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Bildhauerei, Orgelbau, Intarsien, feine M√∂belteile.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionsholz mittelalterlicher Schnitzer.</p>
    `,
    "Ulme": `
        <p class="mb-2">Z√§h, eher hart; ringporig, teils unruhiger Faserverlauf.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Innenausbau, Reparatur- und Biegeteile.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Historisch im Wagenbau gesch√§tzt.</p>
    `,
    "Kastanie": `
        <p class="mb-2">Wetterbest√§ndig, warm get√∂nt; ringporig mit klarer Jahresringzeichnung.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Au√üenbau, M√∂bel, Balken, Gartenholz.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Oft Alternative zur Eiche im Au√üenbereich.</p>
    `,
    "Robinie": `
        <p class="mb-2">Eines der h√§rtesten europ√§ischen H√∂lzer; sehr dauerhaft im Freien; ringporig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Terrassen, Z√§une, Spielpl√§tze, Au√üenkonstruktionen.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> ‚ÄûEurop√§isches Teak‚Äú wegen seiner Dauerhaftigkeit.</p>
    `,
    "Hemlock": `
        <p class="mb-2">Weiches, gleichm√§√üiges Nadelholz; feine Struktur, dezente Ringe.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Paneele, Leichtbau, M√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Gutes Verh√§ltnis von Gewicht zu Stabilit√§t.</p>
    `,
    "Zypresse": `
        <p class="mb-2">Duftend, nat√ºrlich resistent; fein und gleichm√§√üig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Au√üen- und Gartenholz, Fassaden, M√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionelles Bauholz im mediterranen Raum.</p>
    `,
    "Redwood": `
        <p class="mb-2">Leicht, relativ dauerhaft; fein zerstreutporig, dekorative Farbe.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Au√üenholz, Z√§une, Gartenkonstruktionen.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Stammt vom K√ºstenmammutbaum ‚Äì einer der h√∂chsten Baumarten.</p>
    `,
    "Hickory": `
        <p class="mb-2">Sehr z√§h und hart; ringporig mit ausgepr√§gten Poren.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Werkzeugstiele, Sportger√§te, stark beanspruchte M√∂bel.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Klassisches Holz f√ºr Peitschen- und Ger√§tesch√§fte.</p>
    `,
    "Wenge": `
        <p class="mb-2">Dunkel, sehr hart; zerstreutporig, charakteristische Streifenzeichnung.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Luxusm√∂bel, Parkett, Furniere.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Wirkt in Kontrastkombinationen mit hellen H√∂lzern besonders.</p>
    `,
    "Zebrano": `
        <p class="mb-2">Markante Streifenoptik; zerstreutporig mit dekorativer Maserung.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Designm√∂bel, Furniere, Intarsien.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Beliebt f√ºr auff√§llige Akzente.</p>
    `,
    "Palisander": `
        <p class="mb-2">Dekorativ, fest und langlebig; feine, gleichm√§√üige Porung.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Gitarren/Instrumente, M√∂bel, Furniere.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Traditionell exklusiv im Instrumentenbau; Artenschutz-Lagen beachten.</p>
    `,
    "Ebenholz": `
        <p class="mb-2">Extrem hart und dicht, nahezu schwarz; sehr feinporig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Klaviertasten, Intarsien, Luxusdekore, Griffbretter.</p>
        <p class="italic text-gray-600"><strong>Zusatz:</strong> Seit der Antike als edles, seltenes Holz gesch√§tzt.</p>
    `
};

const woodInfo = {};
woodCards.forEach(c => {
    // Falls keine spezifischen Infos da sind, Fallback
    const content = detailedWoodInfo[c.name] || `
        <p class="mb-2">Die ${c.name} ist eine Holzart mit einer Rohdichte von ca. ${c.dichte} kg/m¬≥.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Allgemeine Holzverarbeitung.</p>
    `;

    woodInfo[c.name] = {
        text: content,
        bildBaum: c.imgTree,
        bildQuerschnitt: c.imgCross
    };
});

const reflectionQuestions=[
 "Welches Holz w√ºrdest du f√ºr Gartenm√∂bel w√§hlen und warum?",
 "Eine K√ºchenarbeitsplatte muss schnittfest sein. Welches Holz eignet sich?",
 "F√ºr einen stark beanspruchten Dielenboden: Hartes oder weiches Holz?",
 "Warum verf√§rbt sich Eiche in Verbindung mit Eisen?",
 "Welches der gespielten H√∂lzer hat die h√∂chste Dauerhaftigkeit?",
 "Nenne einen Vorteil von Bambus gegen√ºber heimischen H√∂lzern."
];

const attributeInfo={
  dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit',unit:'(DK)', logic: 'Niedrig gewinnt'},
  haerte:{icon:'üíé',name:'Druckfestigkeit',unit:'(N/mm¬≤)', logic: 'Hoch gewinnt'},
  quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schw.',unit:'(%)', logic: 'Niedrig gewinnt'},
  dichte:{icon:'‚öñÔ∏è',name:'Rohdichte',unit:'(kg/m¬≥)', logic: 'Hoch gewinnt'},
  gewicht:{icon:'üèãÔ∏è',name:'E-Modul',unit:'(N/mm¬≤)', logic: 'Hoch gewinnt'}
};

let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};
let lastRoundWinningWoodName = null;

const bottomSheet = document.getElementById('bottomSheet');
const bottomSheetBackdrop = document.getElementById('bottomSheetBackdrop');

function openBottomSheet(title){
    if(title) document.getElementById('resultText').innerText = title;
    bottomSheetBackdrop.classList.remove('hidden');
    bottomSheet.classList.remove('hidden');
    setTimeout(() => {
        bottomSheetBackdrop.classList.remove('opacity-0');
        bottomSheet.classList.remove('translate-y-full');
    }, 10);
}
function closeBottomSheet(){
    bottomSheet.classList.add('translate-y-full');
    bottomSheetBackdrop.classList.add('opacity-0');
    setTimeout(() => {
        bottomSheet.classList.add('hidden');
        bottomSheetBackdrop.classList.add('hidden');
    }, 300);
}

// Exponiere Funktionen global - DIES MUSS VOR DEM LISTENER PASSIEREN
window.showNamePrompt= (mode) => {
  document.getElementById('setupModal').classList.add('hidden');
  document.getElementById('nameModal').classList.remove('hidden');
  const btn=document.getElementById('nameSubmitButton');
  const clone=btn.cloneNode(true);
  btn.parentNode.replaceChild(clone,btn);
  clone.addEventListener('click',()=>{
    const playerName=document.getElementById('playerName').value.trim();
    if(!playerName){alert('Bitte gib deinen Namen ein!');return;}
    document.getElementById('nameModal').classList.add('hidden');
    if(mode==='ai'){gameMode='ai';startGameAI(playerName);}
    else if(mode==='multiplayer'){gameMode='multiplayer';createGame(playerName);}
    else if(mode==='join'){joinGame(gameId,playerName);}
  });
};

window.showGameInfo = function() {
    const modal = document.getElementById('gameInfoModal');
    if (modal) modal.classList.remove('hidden');
};
window.closeBottomSheet = closeBottomSheet; 

window.populateGameInfoModal = function() {
    const list = document.getElementById('infoCategoryList');
    if (!list) return;

    let html = '';
    
    const order = ['dk', 'haerte', 'quellenSchwindenRadial', 'dichte', 'gewicht'];

    for (const key of order) {
        const info = attributeInfo[key];
        const isBetter = info.logic === 'Hoch gewinnt';
        
        html += `
            <div class="p-3 rounded-xl border-2 ${isBetter ? 'border-green-400 bg-green-50' : 'border-blue-400/80 bg-blue-50/50'}">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-lg font-bold text-gray-800">${info.icon} ${info.name}</span>
                    <span class="text-sm font-semibold ${isBetter ? 'text-green-700' : 'text-blue-700'}">
                        ${isBetter ? '‚¨Ü Hoch gewinnt' : '‚¨á Niedrig gewinnt'}
                    </span>
                </div>
                <p class="text-[12px] text-gray-600 mt-1">
                    ${key === 'dk' ? 'Die Dauerhaftigkeitsklasse (DK) bewertet die nat√ºrliche Widerstandsf√§higkeit gegen holzzerst√∂rende Pilze (1=Sehr dauerhaft, 5=Nicht dauerhaft).' : 
                      key === 'haerte' ? 'Die Druckfestigkeit gibt an, wie widerstandsf√§hig das Holz gegen Druck entlang der Faser ist.' :
                      key === 'quellenSchwindenRadial' ? 'Dieser Wert beschreibt die Ma√ü√§nderung des Holzes bei Feuchtigkeitswechsel. Ein niedriger Wert ist ideal.' :
                      key === 'dichte' ? 'Die Rohdichte ist ein Ma√ü f√ºr die H√§rte und Festigkeit des Holzes. H√∂here Dichte = stabiler.' :
                      key === 'gewicht' ? 'Der E-Modul (Elastizit√§tsmodul) beschreibt die Steifigkeit des Holzes. Ein h√∂herer Wert bedeutet weniger Durchbiegung.' :
                      'Keine Beschreibung verf√ºgbar.'}
                </p>
            </div>
        `;
    }
    list.innerHTML = html;
};
window.showInfoModal = function() {
    if (lastRoundWinningWoodName) {
        showWoodInfo(lastRoundWinningWoodName);
    }
    closeBottomSheet(); 
};

window.copyShareLink=async()=>{
  const el=document.getElementById('shareLink');
  try{await navigator.clipboard.writeText(el.value);}catch{el.select();document.execCommand('copy');}
  hasCopiedShareLink=true;
  const s=document.getElementById('lobbyStatus'); if(s) s.textContent='Link kopiert! Warte...';
};

window.showWoodInfo = function(name){
    const modal=document.getElementById('infoModal');
    const content=document.getElementById('infoModalContent');
    
    const w = woodInfo[name] || {};
    const details = w.text || "Keine Informationen verf√ºgbar.";
    
    content.innerHTML=`
        <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-500 text-sm text-gray-700 leading-relaxed mb-4">
            <h4 class="font-black text-lg text-purple-800 mb-2">${name}</h4>
            ${details}
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
                <img src="${w.bildBaum}" class="rounded-lg shadow-sm border w-full h-32 object-cover bg-gray-100" onerror="this.style.opacity=0.3">
            </div>
            <div class="space-y-1">
                <img src="${w.bildQuerschnitt}" class="rounded-lg shadow-sm border w-full h-32 object-cover bg-gray-100" onerror="this.style.opacity=0.3">
            </div>
        </div>
    `;
    modal.classList.remove('hidden');
};
window.closeInfoModal = function(){ document.getElementById('infoModal').classList.add('hidden'); openBottomSheet(); };

window.closeLeaderboard = function(){
    document.getElementById('leaderboardModal').classList.add('hidden');
    document.getElementById('gameOverModal').classList.remove('hidden');
};

window.resetGame = function(){ location.reload(); };

window.nextRound = function(){
    scrollToGame();
    if(gameMode==='ai') nextRoundAI();
    else if(gameMode==='multiplayer') multiplayerNextRound();
};

window.selectAttribute = function(attr){
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        
        // 1. User Button markieren
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`);
        if(btn) btn.classList.add('flash-active');

        aiGame.roundInProgress = true; 
        
        // 2. Verz√∂gerung 0.5s: Karte drehen + Gegner markieren
        setTimeout(() => {
            // Flip
            const ac=document.getElementById('aiCard').querySelector('.card-3d');
            if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
            
            // Highlight Grey
            // Use specific selector for AI card to ensure correct highlighting
            const aiCardEl = document.getElementById('aiCard');
            const oppRow = aiCardEl.querySelector(`div[data-attr-row="${attr}"]`);
            if(oppRow) oppRow.classList.add('highlight-compare');

            // 3. Verz√∂gerung 2s: Ergebnis
            setTimeout(() => {
                evaluateRoundAI(attr);
            }, 2000);

        }, 500);

    } else if(gameMode==='multiplayer') {
        multiplayerSelectAttribute(attr);
    }
};

window.showFinalWinScreen = function(){
    document.getElementById('reflectionModal').classList.add('hidden');
    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    title.innerText = "GEWONNEN!";
    title.className = "text-3xl font-black mb-2 text-green-600";
    text.innerText = "Herzlichen Gl√ºckwunsch! Du bist der Holz-Meister.";
    document.getElementById('gameOverModal').classList.remove('hidden');
    if(gameMode==='ai') saveToLeaderboard(aiGame.playerName);
    else saveToLeaderboard(localGameState.players[localPlayerId].name);
}

// === DOM CONTENT LOADED - AM ENDE ===
document.addEventListener('DOMContentLoaded', async()=>{
  // Buttons erst hier abfragen, wenn das DOM sicher geladen ist
  const bsInfoBtn = document.getElementById('bsInfoBtn');
  const bsNextBtn = document.getElementById('bsNextBtn');

  if(bsInfoBtn) bsInfoBtn.addEventListener('click',()=>window.showInfoModal());
  if(bsNextBtn) bsNextBtn.addEventListener('click',()=>{
      window.closeBottomSheet(); 
      window.nextRound(); 
  });

  // --- SPLASH SCREEN LOGIC ---
  const splash = document.getElementById('splashModal');
  const setup = document.getElementById('setupModal');
  
  if (sessionStorage.getItem('skipSplash')) {
      if (splash) splash.classList.add('hidden');
      if (setup) setup.classList.remove('hidden');
      sessionStorage.removeItem('skipSplash');
  } else if (splash && setup) {
      splash.classList.remove('hidden');
      setup.classList.add('hidden');

      setTimeout(() => {
          splash.classList.add('hidden');
          setup.classList.remove('hidden');
      }, 2500);
  }

  onAuthStateChanged(auth,(user)=>{
    if(user){
      localPlayerId=user.uid;
      const p=new URLSearchParams(window.location.search);
      const gid=p.get('game');
      if(gid){gameId=gid;gameMode='multiplayer';window.showNamePrompt('join');}
    }
  });
  
  trackEvent('visits');

  const soundToggle=document.getElementById('soundToggle');
  const savedMute=localStorage.getItem('holzquartett_isMuted');
  isMuted=savedMute==='true';
  soundToggle.checked=!isMuted;
  soundToggle.addEventListener('change',(e)=>{
    isMuted=!e.target.checked;
    localStorage.setItem('holzquartett_isMuted',isMuted);
    if(!isMuted) playSound(sounds.chime);
  });

  const revealToggle=document.getElementById('revealBackToggle');
  revealToggle.checked=isOpponentNameBackVisible();
  revealToggle.addEventListener('change',e=>{
    setOpponentNameBackVisible(e.target.checked);
    if(gameMode==='ai') displayCardsAI();
    if(gameMode==='multiplayer'&&localGameState) displayMultiplayerCards(localGameState);
  });
  
  window.populateGameInfoModal();
});
</script>
</body>
</html>
