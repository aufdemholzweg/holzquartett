<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Holz-Quartett - Masterarbeit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wood: {
                            100: '#f7eadd',
                            300: '#d4b499',
                            500: '#8c6b5d',
                            700: '#5c4033',
                            900: '#3e2723',
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'star-fall': 'starFall 1s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        starFall: {
                            '0%': { transform: 'translateY(-50px) scale(0)', opacity: 0 },
                            '50%': { opacity: 1, transform: 'scale(1.2)' },
                            '100%': { transform: 'translateY(200px) scale(1)', opacity: 0 },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom CSS f√ºr 3D Flip und Details */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Karten-Klassen */
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .card-flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .card-back {
            transform: rotateY(180deg);
            background-size: cover;
            background-position: center;
        }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Dimmer */
        .dimmer { background: rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-wood-100 text-gray-800 h-screen w-screen overflow-hidden flex flex-col">

    <header class="bg-wood-900 text-white p-3 shadow-md z-20 flex-none">
        <div class="flex justify-between items-center max-w-4xl mx-auto w-full">
            <div>
                <h1 class="text-xl font-bold tracking-wider">üå≥ HOLZEN! üå≥</h1>
                <p class="text-xs text-wood-300 opacity-80">Masterarbeit Gamifizierung Support</p>
            </div>
            <button id="settings-btn" class="text-2xl hover:text-wood-300 transition" aria-label="Einstellungen">‚öôÔ∏è</button>
        </div>
    </header>

    <main id="game-area" class="flex-grow relative flex flex-col items-center justify-start p-2 sm:p-4 hidden overflow-y-auto no-scrollbar">
        
        <div class="w-full max-w-4xl mb-4 flex justify-between items-end relative">
            <div id="player-stats" class="text-left font-bold text-wood-900 w-1/3">
                <span id="player-name-display">Spieler</span>
                <div class="text-xs font-normal">Karten: <span id="player-count">15</span></div>
            </div>
            
            <div id="turn-indicator" class="text-center font-bold text-sm bg-white/80 px-3 py-1 rounded-full shadow absolute left-1/2 transform -translate-x-1/2 -bottom-2 z-10">
                Du bist am Zug!
            </div>

            <div id="ai-stats" class="text-right font-bold text-wood-900 w-1/3">
                <span id="ai-name-display">Computer</span>
                <div class="text-xs font-normal">Karten: <span id="ai-count">15</span></div>
            </div>
        </div>

        <div class="w-full max-w-4xl h-3 bg-gray-300 rounded-full mb-6 overflow-hidden shadow-inner">
            <div id="health-bar" class="h-full bg-yellow-500 transition-all duration-500" style="width: 50%"></div>
        </div>

        <div class="flex justify-center items-start gap-2 sm:gap-6 w-full max-w-4xl h-full" style="min-height: 450px;">
            
            <div class="w-[48%] max-w-[280px] aspect-[20/38] perspective-1000 relative z-10 group">
                <div id="star-container-player" class="absolute top-0 left-1/2 -translate-x-1/2 -mt-10 pointer-events-none z-50"></div>
                
                <div id="player-card" class="card-inner">
                    <div class="card-front bg-white flex flex-col shadow-xl border-2 border-wood-300">
                        <div class="relative h-[45%] p-2">
                            <div class="absolute top-2 left-3 z-10 bg-black/60 text-white px-2 py-0.5 rounded text-sm font-bold shadow" id="p-card-name">Eiche</div>
                            <img id="p-card-img" src="" class="w-full h-full object-cover rounded-xl shadow-sm bg-wood-100" alt="Holzbild">
                        </div>
                        <div class="flex-grow p-2 flex flex-col gap-1 overflow-y-auto" id="p-attributes">
                            </div>
                    </div>
                    <div class="card-back bg-wood-700 border-4 border-white"></div>
                </div>
            </div>

            <div class="w-[48%] max-w-[280px] aspect-[20/38] perspective-1000 relative z-0">
                 <div id="star-container-ai" class="absolute top-0 left-1/2 -translate-x-1/2 -mt-10 pointer-events-none z-50"></div>

                <div id="ai-card" class="card-inner card-flipped"> <div class="card-front bg-white flex flex-col shadow-xl border-2 border-wood-300">
                         <div class="relative h-[45%] p-2">
                            <div class="absolute top-2 left-3 z-10 bg-black/60 text-white px-2 py-0.5 rounded text-sm font-bold shadow" id="ai-card-name">Buche</div>
                            <img id="ai-card-img" src="" class="w-full h-full object-cover rounded-xl shadow-sm bg-wood-100" alt="Holzbild">
                        </div>
                        <div class="flex-grow p-2 flex flex-col gap-1 overflow-y-auto" id="ai-attributes">
                            </div>
                    </div>
                    <div class="card-back border-4 border-white flex items-start justify-center pt-10" 
                         style="background-image: url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');">
                        <div id="ai-back-name" class="hidden bg-white/90 text-wood-900 px-3 py-1 rounded font-bold shadow-lg mt-4 transform rotate-1">
                            ???
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="round-result-text" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-lg text-xl font-bold shadow-2xl z-40 hidden pointer-events-none text-center whitespace-nowrap">
            </div>

    </main>

    <div id="bottom-sheet-dimmer" class="fixed inset-0 dimmer z-30 hidden transition-opacity duration-300 opacity-0"></div>
    <div id="bottom-sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.2)] z-40 transform translate-y-full transition-transform duration-300 ease-out p-6 pb-8 max-w-4xl mx-auto">
        <h2 id="sheet-title" class="text-2xl font-bold text-center mb-4 text-wood-900">üéâ Du gewinnst!</h2>
        <div class="flex gap-4">
            <button id="btn-info" class="flex-1 bg-wood-300 hover:bg-wood-500 text-wood-900 font-bold py-3 px-4 rounded-xl transition shadow">
                ‚ÑπÔ∏è Zusatzwissen
            </button>
            <button id="btn-next" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition shadow">
                N√§chster Zug ‚û°Ô∏è
            </button>
        </div>
    </div>

    <div id="setup-modal" class="fixed inset-0 bg-wood-900/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-wood-900 mb-2">üå≥ HOLZEN!</h2>
            <p class="text-gray-600 mb-6">W√§hle deinen Spielmodus</p>
            
            <div class="space-y-3 mb-6">
                <button onclick="Game.initSetup('ai')" class="w-full bg-wood-500 hover:bg-wood-700 text-white font-bold py-3 rounded-xl shadow transition flex items-center justify-center gap-2">
                    üéÆ Gegen Computer
                </button>
                <button onclick="Game.initSetup('multiplayer')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow transition flex items-center justify-center gap-2 opacity-70 cursor-not-allowed" title="Ben√∂tigt Firebase Config">
                    üßë‚Äçü§ù‚Äçüßë Online (Demo)
                </button>
            </div>

            <div class="border-t border-gray-200 pt-4 text-left space-y-3">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700">Sound</span>
                    <button id="toggle-sound" class="w-12 h-6 bg-green-500 rounded-full relative transition-colors duration-200" onclick="Game.toggleSetting('sound')">
                        <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-6 shadow transition-all duration-200 transform"></div>
                    </button>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700">Gegner-Holz zeigen</span>
                    <button id="toggle-names" class="w-12 h-6 bg-gray-300 rounded-full relative transition-colors duration-200" onclick="Game.toggleSetting('names')">
                        <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-1 shadow transition-all duration-200 transform"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="name-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Wie hei√üt du?</h3>
            <input type="text" id="player-name-input" class="w-full border-2 border-wood-300 rounded-lg p-2 mb-4 focus:outline-none focus:border-wood-500" placeholder="Dein Name" maxlength="12">
            <button onclick="Game.startGame()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg">Los geht's!</button>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden relative">
            <button onclick="Game.closeInfo()" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl font-bold leading-none">&times;</button>
            <div class="p-6">
                <h3 id="info-title" class="text-2xl font-bold text-wood-900 mb-3">Zusatzwissen</h3>
                <p id="info-text" class="text-gray-700 mb-4 leading-relaxed">...</p>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <p class="text-xs text-center font-bold mb-1 text-gray-500">Baum</p>
                        <img id="info-img-1" src="" class="w-full h-32 object-cover rounded-lg border border-gray-200 bg-gray-100">
                    </div>
                    <div>
                        <p class="text-xs text-center font-bold mb-1 text-gray-500">Querschnitt</p>
                        <img id="info-img-2" src="" class="w-full h-32 object-cover rounded-lg border border-gray-200 bg-gray-100">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="fixed inset-0 bg-wood-900/95 z-[70] hidden flex items-center justify-center p-4 text-center">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <h2 id="go-title" class="text-4xl font-bold mb-2">Spielende</h2>
            <p id="go-msg" class="text-gray-600 mb-6 text-lg"></p>
            <div class="space-y-3">
                <button onclick="alert('Bestenliste: Noch nicht implementiert (Firebase).')" class="w-full border-2 border-wood-500 text-wood-700 font-bold py-2 rounded-lg hover:bg-wood-100">üèÜ Bestenliste</button>
                <button onclick="location.reload()" class="w-full bg-wood-500 text-white font-bold py-3 rounded-lg hover:bg-wood-700">üîÑ Neues Spiel</button>
            </div>
        </div>
    </div>

    <audio id="sfx-flip" src="https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3" preload="auto"></audio>
    <audio id="sfx-win" src="https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true" preload="auto"></audio>
    <audio id="sfx-star" src="https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3" preload="auto"></audio>
    <script type="module">
        /**
         * DATEN
         */
        const WOOD_CARDS = [
            {"name":"Eiche","dk":2,"haerte":85,"quellenSchwindenRadial":4.0,"dichte":650,"gewicht":12000},
            {"name":"Buche","dk":5,"haerte":80,"quellenSchwindenRadial":5.8,"dichte":720,"gewicht":14000},
            {"name":"Kiefer","dk":3,"haerte":40,"quellenSchwindenRadial":3.5,"dichte":520,"gewicht":11000},
            {"name":"Fichte","dk":4,"haerte":35,"quellenSchwindenRadial":3.6,"dichte":450,"gewicht":11000},
            {"name":"Tanne","dk":4,"haerte":38,"quellenSchwindenRadial":3.5,"dichte":460,"gewicht":10000},
            {"name":"L√§rche","dk":3,"haerte":55,"quellenSchwindenRadial":3.7,"dichte":590,"gewicht":12000},
            {"name":"Birke","dk":5,"haerte":60,"quellenSchwindenRadial":5.4,"dichte":650,"gewicht":13000},
            {"name":"Ahorn","dk":5,"haerte":75,"quellenSchwindenRadial":4.8,"dichte":630,"gewicht":12500},
            {"name":"Esche","dk":5,"haerte":90,"quellenSchwindenRadial":4.9,"dichte":700,"gewicht":13000},
            {"name":"Kirsche","dk":3,"haerte":70,"quellenSchwindenRadial":4.0,"dichte":600,"gewicht":11500},
            {"name":"Nussbaum","dk":3,"haerte":65,"quellenSchwindenRadial":4.0,"dichte":640,"gewicht":12000},
            {"name":"Douglasie","dk":3,"haerte":45,"quellenSchwindenRadial":3.5,"dichte":510,"gewicht":12000},
            {"name":"Zeder","dk":2,"haerte":42,"quellenSchwindenRadial":2.8,"dichte":480,"gewicht":9500},
            {"name":"Mahagoni","dk":2,"haerte":55,"quellenSchwindenRadial":3.0,"dichte":550,"gewicht":10500},
            {"name":"Teak","dk":1,"haerte":60,"quellenSchwindenRadial":2.5,"dichte":650,"gewicht":11000},
            {"name":"Bambus","dk":4,"haerte":50,"quellenSchwindenRadial":3.0,"dichte":400,"gewicht":18000},
            {"name":"Pappel","dk":5,"haerte":25,"quellenSchwindenRadial":4.5,"dichte":380,"gewicht":9000},
            {"name":"Weide","dk":5,"haerte":30,"quellenSchwindenRadial":4.0,"dichte":420,"gewicht":8000},
            {"name":"Linde","dk":5,"haerte":35,"quellenSchwindenRadial":3.8,"dichte":530,"gewicht":9000},
            {"name":"Ulme","dk":3,"haerte":75,"quellenSchwindenRadial":4.5,"dichte":680,"gewicht":11500},
            {"name":"Kastanie","dk":2,"haerte":50,"quellenSchwindenRadial":3.5,"dichte":600,"gewicht":10000},
            {"name":"Robinie","dk":1,"haerte":80,"quellenSchwindenRadial":3.0,"dichte":730,"gewicht":15000},
            {"name":"Hemlock","dk":4,"haerte":40,"quellenSchwindenRadial":3.6,"dichte":500,"gewicht":10000},
            {"name":"Zypresse","dk":2,"haerte":48,"quellenSchwindenRadial":3.0,"dichte":520,"gewicht":9000},
            {"name":"Redwood","dk":2,"haerte":35,"quellenSchwindenRadial":2.8,"dichte":400,"gewicht":8500},
            {"name":"Hickory","dk":3,"haerte":95,"quellenSchwindenRadial":5.5,"dichte":750,"gewicht":14000},
            {"name":"Wenge","dk":2,"haerte":88,"quellenSchwindenRadial":3.8,"dichte":880,"gewicht":16000},
            {"name":"Zebrano","dk":3,"haerte":70,"quellenSchwindenRadial":4.0,"dichte":750,"gewicht":13000},
            {"name":"Palisander","dk":2,"haerte":82,"quellenSchwindenRadial":3.0,"dichte":850,"gewicht":16000},
            {"name":"Ebenholz","dk":1,"haerte":98,"quellenSchwindenRadial":3.2,"dichte":1200,"gewicht":16500}
        ];

        const ATTRIBUTES = [
            { id: 'dk', label: 'Dauerh.Kl.', unit: '', lowerIsBetter: true },
            { id: 'haerte', label: 'H√§rte', unit: 'N/mm¬≤', lowerIsBetter: false },
            { id: 'quellenSchwindenRadial', label: 'Quellen/Schw.', unit: '% rad', lowerIsBetter: true },
            { id: 'dichte', label: 'Dichte', unit: 'kg/m¬≥', lowerIsBetter: false },
            { id: 'gewicht', label: 'E-Modul', unit: 'N/mm¬≤', lowerIsBetter: false }
        ];

        // Generiere Bild-URLs und Info-Texte basierend auf der Logik
        const WOOD_INFO = {};
        WOOD_CARDS.forEach(card => {
            const slug = card.name.toLowerCase().replace(/√§/g,'ae').replace(/√∂/g,'oe').replace(/√º/g,'ue').replace(/√ü/g,'ss'); // Einfache Slug-Logik, aber wir nutzen die Namen aus dem Datensatz, die sind sauber genug f√ºr die GitHub Struktur? 
            // Achtung: GitHub URLs waren case sensitive. Die Liste enth√§lt Umlaute.
            // Der Prompt sagt: <slug>_1.jpg. Wir mappen Namen zu slug.
            // Mapping f√ºr die gegebenen Namen zu einfachen Slugs (Umlaute raus f√ºr die Dateinamen, falls im Repo so benannt).
            // Angenommen, das Repo nutzt 'eiche', 'buche', 'fichte' etc.
            // F√ºr 'L√§rche' -> 'laerche'? Im Prompt steht Beispiel: ".../eiche_1.jpg".
            // Wir nutzen eine robuste Mapping-Funktion f√ºr deutsche Umlaute, da Dateinamen oft ASCII sind.
            let safeSlug = card.name.toLowerCase()
                .replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue').replace(/√ü/g, 'ss');
            
            // Ausnahmebehandlung falls n√∂tig, aber wir gehen davon aus, dass das Repo konsistent ist.
            
            WOOD_INFO[card.name] = {
                info: `Die ${card.name} ist ein vielseitiges Holz mit einer Rohdichte von ${card.dichte} kg/m¬≥. Ihre Dauerhaftigkeit liegt in Klasse ${card.dk}.`,
                bildBaum: `https://github.com/aufdemholzweg/holzquartett/blob/main/images/${safeSlug}_1.jpg?raw=true`,
                bildQuerschnitt: `https://github.com/aufdemholzweg/holzquartett/blob/main/images/${safeSlug}_2.jpg?raw=true`
            };
        });

        // Firebase Setup (Dummy/Vorbereitung)
        // TODO: F√ºge hier deine Config ein f√ºr Multiplayer
        const firebaseConfig = null; 
        
        /**
         * GAME ENGINE & STATE
         */
        const Game = {
            state: {
                mode: 'ai', // 'ai' or 'multiplayer'
                playerName: 'Spieler',
                playerCards: [],
                aiCards: [],
                turn: 'player', // 'player' or 'ai'
                roundInProgress: false,
                lastWinner: null,
                lastWinningCard: null,
                settings: {
                    sound: true,
                    showEnemyName: false
                }
            },

            // Hilfsfunktionen
            $: (sel) => document.querySelector(sel),
            $$: (sel) => document.querySelectorAll(sel),

            initSetup(mode) {
                if (mode === 'multiplayer' && !firebaseConfig) {
                    alert('Multiplayer ist in diesem Build nicht konfiguriert (Firebase Config fehlt).');
                    return;
                }
                this.state.mode = mode;
                this.$('#setup-modal').classList.add('hidden');
                this.$('#name-modal').classList.remove('hidden');
                this.$('#player-name-input').focus();
                this.loadSettings();
            },

            loadSettings() {
                const s = localStorage.getItem('holzquartett_settings');
                if (s) {
                    this.state.settings = JSON.parse(s);
                    this.updateSettingsUI();
                }
            },

            saveSettings() {
                localStorage.setItem('holzquartett_settings', JSON.stringify(this.state.settings));
            },

            toggleSetting(key) {
                if (key === 'sound') {
                    this.state.settings.sound = !this.state.settings.sound;
                } else if (key === 'names') {
                    this.state.settings.showEnemyName = !this.state.settings.showEnemyName;
                }
                this.saveSettings();
                this.updateSettingsUI();
            },

            updateSettingsUI() {
                const sndBtn = this.$('#toggle-sound div');
                const sndBg = this.$('#toggle-sound');
                const nameBtn = this.$('#toggle-names div');
                const nameBg = this.$('#toggle-names');

                if (this.state.settings.sound) {
                    sndBg.classList.replace('bg-gray-300', 'bg-green-500');
                    sndBtn.classList.replace('left-1', 'left-6');
                } else {
                    sndBg.classList.replace('bg-green-500', 'bg-gray-300');
                    sndBtn.classList.replace('left-6', 'left-1');
                }

                if (this.state.settings.showEnemyName) {
                    nameBg.classList.replace('bg-gray-300', 'bg-green-500');
                    nameBtn.classList.replace('left-1', 'left-6');
                } else {
                    nameBg.classList.replace('bg-green-500', 'bg-gray-300');
                    nameBtn.classList.replace('left-6', 'left-1');
                }

                // Live Update
                if (this.state.settings.showEnemyName) {
                    this.$('#ai-back-name').classList.remove('hidden');
                } else {
                    this.$('#ai-back-name').classList.add('hidden');
                }
            },

            startGame() {
                const nameInput = this.$('#player-name-input').value.trim();
                this.state.playerName = nameInput || 'Spieler';
                this.$('#player-name-display').innerText = this.state.playerName;
                this.$('#name-modal').classList.add('hidden');
                this.$('#game-area').classList.remove('hidden');

                // Unlock Audio Context logic hack
                const a = new Audio();
                a.play().catch(()=>{}); 

                this.dealCards();
                this.renderGame();
                this.checkTurn();
            },

            dealCards() {
                // Shuffle
                let deck = [...WOOD_CARDS].sort(() => Math.random() - 0.5);
                // Split 15/15
                this.state.playerCards = deck.slice(0, 15);
                this.state.aiCards = deck.slice(15, 30);
                this.state.turn = 'player'; // Spieler beginnt immer
            },

            checkTurn() {
                const pCard = this.state.playerCards[0];
                const aiCard = this.state.aiCards[0];
                
                // Namen auf Backside updaten
                this.$('#ai-back-name').innerText = aiCard.name;

                if (this.state.turn === 'player') {
                    this.$('#turn-indicator').innerText = "Du bist am Zug!";
                    this.enablePlayerControls(true);
                } else {
                    this.$('#turn-indicator').innerText = "Computer √ºberlegt...";
                    this.enablePlayerControls(false);
                    setTimeout(() => this.aiTurn(), 1000);
                }
            },

            enablePlayerControls(enable) {
                const btns = this.$$('.attr-btn');
                btns.forEach(btn => {
                    if (enable) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.classList.add('hover:bg-wood-100');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        btn.classList.remove('hover:bg-wood-100');
                    }
                });
            },

            playRound(attrId) {
                if (this.state.roundInProgress) return;
                this.state.roundInProgress = true;
                
                // 1. KI Karte aufdecken
                this.$('#ai-card').classList.remove('card-flipped'); // Flip Front
                this.playSound('flip');

                const pCard = this.state.playerCards[0];
                const aiCard = this.state.aiCards[0];

                const pVal = pCard[attrId];
                const aiVal = aiCard[attrId];

                // 2. Vergleich
                const attrDef = ATTRIBUTES.find(a => a.id === attrId);
                let playerWins = false;
                let tie = false;

                if (pVal === aiVal) {
                    tie = true;
                } else if (attrDef.lowerIsBetter) {
                    playerWins = pVal < aiVal;
                } else {
                    playerWins = pVal > aiVal;
                }

                // 3. Highlight Attribute
                this.highlightAttribute(attrId);

                // 4. Resultat Text
                const resDiv = this.$('#round-result-text');
                resDiv.innerText = `${pVal} vs ${aiVal}`;
                resDiv.classList.remove('hidden');
                
                // 5. Speichern f√ºr Result logic
                this.currentRoundResult = { playerWins, tie, pCard, aiCard };

                // 6. Delay f√ºr Bottom Sheet (2s)
                setTimeout(() => {
                    this.showBottomSheet(playerWins, tie, pCard.name, aiCard.name);
                }, 2000);
            },

            aiTurn() {
                // Zuf√§lliges Attribut w√§hlen
                const attr = ATTRIBUTES[Math.floor(Math.random() * ATTRIBUTES.length)];
                this.playRound(attr.id);
            },

            highlightAttribute(attrId) {
                const pBtn = document.getElementById(`btn-p-${attrId}`);
                const aiRow = document.getElementById(`row-ai-${attrId}`);
                if (pBtn) pBtn.classList.add('bg-gray-300', 'border-gray-500');
                if (aiRow) aiRow.classList.add('bg-gray-300');
            },

            showBottomSheet(playerWins, tie, pName, aiName) {
                const sheet = this.$('#bottom-sheet');
                const title = this.$('#sheet-title');
                const dimmer = this.$('#bottom-sheet-dimmer');
                
                dimmer.classList.remove('hidden');
                requestAnimationFrame(() => dimmer.classList.remove('opacity-0')); // Fade in

                sheet.classList.remove('translate-y-full');

                if (tie) {
                    title.innerText = `ü§ù Unentschieden!`;
                    this.state.lastWinner = null;
                    this.state.lastWinningCard = Math.random() > 0.5 ? this.state.playerCards[0] : this.state.aiCards[0]; // Zufall f√ºr Info
                } else if (playerWins) {
                    title.innerText = `üéâ Du gewinnst! (${pName})`;
                    this.playSound('win');
                    this.showStarAnimation('player');
                    this.state.lastWinner = 'player';
                    this.state.lastWinningCard = this.state.playerCards[0];
                } else {
                    title.innerText = `üòû ${this.state.settings.showEnemyName ? aiName : 'Gegner'} gewinnt!`;
                    this.state.lastWinner = 'ai';
                    this.state.lastWinningCard = this.state.aiCards[0];
                }

                // Events binden
                this.$('#btn-info').onclick = () => this.openInfo();
                this.$('#btn-next').onclick = () => this.nextTurn();
            },

            showStarAnimation(winner) {
                const container = winner === 'player' ? this.$('#star-container-player') : this.$('#star-container-ai');
                const star = document.createElement('div');
                star.innerText = '‚≠ê';
                star.className = 'text-4xl absolute animate-star-fall';
                container.appendChild(star);
                // Sound dazu
                if(this.state.settings.sound) {
                    const s = this.$('#sfx-star');
                    s.currentTime=0; s.play().catch(()=>{});
                }
                setTimeout(() => star.remove(), 1200);
            },

            openInfo() {
                // Sheet schlie√üen
                this.$('#bottom-sheet').classList.add('translate-y-full');
                this.$('#bottom-sheet-dimmer').classList.add('opacity-0');
                setTimeout(() => this.$('#bottom-sheet-dimmer').classList.add('hidden'), 300);

                const card = this.state.lastWinningCard;
                const info = WOOD_INFO[card.name];

                this.$('#info-title').innerText = `Zusatzwissen: ${card.name}`;
                this.$('#info-text').innerText = info.info;
                this.$('#info-img-1').src = info.bildBaum;
                this.$('#info-img-2').src = info.bildQuerschnitt;

                this.$('#info-modal').classList.remove('hidden');
            },

            closeInfo() {
                this.$('#info-modal').classList.add('hidden');
                // Sheet wieder √∂ffnen f√ºr "N√§chster Zug"
                const dimmer = this.$('#bottom-sheet-dimmer');
                dimmer.classList.remove('hidden');
                setTimeout(() => dimmer.classList.remove('opacity-0'), 10);
                this.$('#bottom-sheet').classList.remove('translate-y-full');
            },

            nextTurn() {
                // UI Reset
                this.$('#bottom-sheet').classList.add('translate-y-full');
                this.$('#bottom-sheet-dimmer').classList.add('opacity-0');
                setTimeout(() => this.$('#bottom-sheet-dimmer').classList.add('hidden'), 300);
                
                this.$('#round-result-text').classList.add('hidden');
                this.$$('#round-result-text').innerText = "";

                // Karten verschieben
                const { playerWins, tie, pCard, aiCard } = this.currentRoundResult;
                
                // Entferne oberste Karten
                this.state.playerCards.shift();
                this.state.aiCards.shift();

                if (tie) {
                    // Beide behalten ihre Karte -> hinten anstellen
                    this.state.playerCards.push(pCard);
                    this.state.aiCards.push(aiCard);
                    // Zug bleibt beim gleichen Spieler
                } else if (playerWins) {
                    this.state.playerCards.push(pCard);
                    this.state.playerCards.push(aiCard);
                    this.state.turn = 'player';
                } else {
                    this.state.aiCards.push(aiCard);
                    this.state.aiCards.push(pCard);
                    this.state.turn = 'ai';
                }

                this.state.roundInProgress = false;

                // KI Karte wieder verdecken (sofort, ohne Transition Glitch)
                this.$('#ai-card').classList.add('card-flipped');

                // Game Over Check
                if (this.state.playerCards.length === 0 || this.state.aiCards.length === 0) {
                    this.gameOver();
                } else {
                    // Render neue Karten
                    setTimeout(() => {
                        this.renderGame();
                        this.checkTurn();
                    }, 500); // Kurz warten f√ºr card flip back
                }
            },

            gameOver() {
                const playerWon = this.state.playerCards.length > 0;
                this.$('#game-over-modal').classList.remove('hidden');
                if (playerWon) {
                    this.$('#go-title').innerText = "Gl√ºckwunsch!";
                    this.$('#go-msg').innerText = "Du hast alle Karten gewonnen!";
                    this.playSound('win');
                } else {
                    this.$('#go-title').innerText = "Spiel verloren";
                    this.$('#go-msg').innerText = "Der Computer hat alle Karten gewonnen.";
                }
            },

            playSound(type) {
                if (!this.state.settings.sound) return;
                const el = this.$(`#sfx-${type}`);
                if (el) {
                    el.currentTime = 0;
                    el.play().catch(e => console.log("Audio play blocked", e));
                }
            },

            renderGame() {
                const pCount = this.state.playerCards.length;
                const aiCount = this.state.aiCards.length;
                const total = pCount + aiCount;

                this.$('#player-count').innerText = pCount;
                this.$('#ai-count').innerText = aiCount;

                // Health Bar
                const pct = (pCount / total) * 100;
                const bar = this.$('#health-bar');
                bar.style.width = `${pct}%`;
                if (pct < 25) bar.className = 'h-full bg-red-500 transition-all duration-500';
                else if (pct < 45) bar.className = 'h-full bg-orange-400 transition-all duration-500';
                else if (pct > 75) bar.className = 'h-full bg-green-600 transition-all duration-500';
                else bar.className = 'h-full bg-yellow-400 transition-all duration-500';

                // Karten rendern
                this.renderCardContent('player', this.state.playerCards[0]);
                this.renderCardContent('ai', this.state.aiCards[0]);
            },

            renderCardContent(side, cardData) {
                if (!cardData) return; // Game Over Fall

                const prefix = side === 'player' ? 'p' : 'ai';
                
                // Front Image & URL (Verwende Background Front aus Prompt als Fallback oder Style)
                const img = this.$(`#${prefix}-card-img`);
                // Mapping Slug logic nochmal f√ºr Image URL
                let safeSlug = cardData.name.toLowerCase()
                .replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue').replace(/√ü/g, 'ss');
                
                // HINTERGRUND Front
                const frontContainer = img.parentElement.parentElement;
                frontContainer.style.backgroundImage = `url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg')`;
                frontContainer.style.backgroundSize = 'cover';

                img.src = `https://github.com/aufdemholzweg/holzquartett/blob/main/images/${safeSlug}_1.jpg?raw=true`;
                this.$(`#${prefix}-card-name`).innerText = cardData.name;

                // Attribute List
                const list = this.$(`#${prefix}-attributes`);
                list.innerHTML = '';

                ATTRIBUTES.forEach(attr => {
                    const val = cardData[attr.id];
                    
                    if (side === 'player') {
                        const btn = document.createElement('button');
                        btn.id = `btn-p-${attr.id}`;
                        btn.className = `attr-btn w-full text-left px-2 py-1.5 text-xs sm:text-sm border border-wood-300 rounded hover:bg-wood-100 transition-colors flex justify-between items-center`;
                        btn.innerHTML = `<span>${attr.label}</span> <span class="font-bold">${val} <span class="text-[9px] font-normal text-gray-500">${attr.unit}</span></span>`;
                        btn.onclick = () => this.playRound(attr.id);
                        list.appendChild(btn);
                    } else {
                        const div = document.createElement('div');
                        div.id = `row-ai-${attr.id}`;
                        div.className = `w-full text-left px-2 py-1.5 text-xs sm:text-sm border border-transparent border-b-gray-100 rounded flex justify-between items-center text-gray-700`;
                        div.innerHTML = `<span>${attr.label}</span> <span class="font-bold">${val} <span class="text-[9px] font-normal text-gray-500">${attr.unit}</span></span>`;
                        list.appendChild(div);
                    }
                });
            }
        };

        // Global verf√ºgbar machen f√ºr HTML Event Handler
        window.Game = Game;

    </script>
</body>
</html>
