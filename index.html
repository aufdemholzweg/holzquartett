<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Holz-Quartett</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;font-weight:300}
    .card-3d{transform-style:preserve-3d;transition:transform .6s}
    .card-flipped{transform:rotateY(180deg)}
    .card-front,.card-back{backface-visibility:hidden;position:absolute;width:100%;height:100%}
    .card-back{transform:rotateY(180deg);background-image:url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');background-size:cover;background-position:center}
    .animate-pop-in{animation:pop-in .5s ease-out forwards}
    .animate-glow-win{animation:glow-win 1.2s ease-out}
    .animate-glow-lose{animation:glow-lose 1.2s ease-out}
    @keyframes pop-in{0%{transform:scale(0);opacity:0}70%{transform:scale(1.2);opacity:1}100%{transform:scale(1)}}
    @keyframes glow-win{0%{box-shadow:0 0 0 0 rgba(74,222,128,0)}50%{box-shadow:0 0 30px 15px rgba(74,222,128,.6)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)}}
    @keyframes glow-lose{0%{box-shadow:0 0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 30px 15px rgba(248,113,113,.6)}100%{box-shadow:0 0 0 0 rgba(248,113,113,0)}}
    .hover-lift:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .status-flash-win{animation:flash-green 1.2s ease-out}
    .status-flash-lose{animation:flash-red 1.2s ease-out}
    @keyframes flash-green{50%{background-color:#22c55e;box-shadow:0 0 15px #22c55e}}
    @keyframes flash-red{50%{background-color:#ef4444;box-shadow:0 0 15px #ef4444}}
    .falling-star{position:absolute;font-size:7rem;z-index:100;animation:fall-and-fade 1.2s ease-in forwards}
    @keyframes fall-and-fade{0%{transform:translateY(-30px) scale(1.5);opacity:0}30%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(var(--end-y)) scale(.3);opacity:0}}
    .card-background{
      background-image:url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg');
      background-size:cover;background-position:center
    }
    .opponent-back-name{
      position:absolute;top:12%;left:0;width:100%;text-align:center;
      font-family:Arial,Helvetica,sans-serif;color:#e5e7eb;font-weight:700;letter-spacing:.02em;line-height:1.1;z-index:2;
      font-size:clamp(0.8rem,3vw,1.375rem);
      text-shadow:0 1px 2px rgba(0,0,0,.25);pointer-events:none;padding:0 .5rem
    }
    /* Bottom Sheet transitions */
    .sheet-hidden{transform:translateY(100%);}
    .sheet-visible{transform:translateY(0%);}
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
<header class="bg-white shadow-sm border-b-2 border-amber-200">
  <div class="max-w-6xl mx-auto px-4 p-3">
    <h1 class="text-2xl font-bold text-amber-800 text-center">üå≥ HOLZEN! üå≥</h1>
    <p class="text-xs text-gray-500 text-center mt-1">von Christopher Lehr, in Verbindung mit meiner Masterarbeit</p>
  </div>
</header>

<!-- Setup -->
<div id="setupModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40">
  <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
    <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
    <div class="space-y-4">
      <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üéÆ gegen Computer</button>
      <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üßë‚Äçü§ù‚Äçüßë online gegen Freunde</button>
    </div>
    <div class="mt-6 grid grid-cols-1 gap-4">
      <div class="flex items-center justify-center space-x-3">
        <span class="text-gray-700">üîá</span>
        <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="soundToggle" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
        </label>
        <span class="text-gray-700">üîä</span>
      </div>
      <div class="flex items-center justify-center space-x-3">
        <span class="text-gray-700">üôà Gegner-Holz aus</span>
        <label for="revealBackToggle" class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="revealBackToggle" class="sr-only peer">
          <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
        </label>
        <span class="text-gray-700">üëÄ Gegner-Holz an</span>
      </div>
    </div>
  </div>
</div>

<!-- Name -->
<div id="nameModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40">
  <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
    <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Dein Name</h2>
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Bitte gib deinen Namen ein:</label>
        <input type="text" id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Spielername">
      </div>
      <button id="nameSubmitButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Weiter</button>
    </div>
  </div>
</div>

<!-- Lobby -->
<div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40 px-4">
  <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
    <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler...</h2>
    <p id="lobbyText" class="text-gray-700 mb-6">Teile diesen Link mit deinem Freund, um das Spiel zu starten:</p>
    <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
      <input id="shareLink" type="text" class="w-full bg-transparent text-center text-blue-600" readonly>
    </div>
    <button onclick="window.copyShareLink()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Link kopieren</button>
    <p id="lobbyStatus" class="mt-6 text-green-600 font-semibold"></p>
  </div>
</div>

<!-- Game -->
<div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4 relative">
  <div id="animationContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
  <div class="max-w-md mx-auto mb-1 space-y-1">
    <div class="flex justify-center space-x-2">
      <div id="playerScoreBox" class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center relative">
        <p id="playerNameDisplay" class="text-base font-bold text-amber-600 truncate"></p>
        <p class="text-sm text-gray-500">Karten: <span id="playerCards" class="font-semibold">15</span></p>
      </div>
      <div class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center">
        <p id="opponentNameDisplay" class="text-base font-bold text-red-600">Computer</p>
        <p class="text-sm text-gray-500">Karten: <span id="aiCards" class="font-semibold">15</span></p>
      </div>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden border border-gray-300">
      <div id="statusBar" class="h-full rounded-l-full transition-all duration-500" style="width:50%;background-color:#f59e0b"></div>
      <div class="absolute inset-0 flex justify-center items-center"><div class="w-0.5 h-full bg-white opacity-75"></div></div>
    </div>
  </div>

  <div class="flex justify-center space-x-2 sm:space-x-2 mb-4 max-w-md mx-auto">
    <div class="text-center w-1/2"><div id="playerCard" class="relative aspect-[20/38] perspective-1000"></div></div>
    <div class="text-center w-1/2"><div id="aiCard" class="relative aspect-[20/38] perspective-1000"></div></div>
  </div>

  <div class="bg-white rounded-xl shadow-lg px-1 pt-1 pb-0.5 mt-4 text-center mx-auto flex flex-col items-center max-w-md w-full min-h-[6rem]">
    <div id="turnIndicator" class="hidden text-sm font-semibold p-1"></div>
    <div id="attributeSelection"><h3 class="text-base font-semibold text-gray-700 mb-1">W√§hle eine Eigenschaft!</h3></div>
    <div id="resultDisplay" class="hidden flex flex-col flex-grow w-full px-2">
      <h3 id="resultText" class="text-lg sm:text-xl font-bold"></h3>
      <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mt-auto pb-0.5"></p>
    </div>
  </div>
</div>

<!-- Reflection -->
<div id="reflectionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40 px-4">
  <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
    <h2 class="text-2xl font-bold text-amber-800 mb-4">üéâ Super gespielt! Zeit zum Reflektieren!</h2>
    <p id="reflectionQuestion" class="text-gray-700 mb-6 text-left"></p>
    <textarea id="reflectionAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent min-h-[100px]" placeholder="Deine Begr√ºndung..."></textarea>
    <button onclick="window.showFinalWinScreen()" class="mt-6 w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Weiter zum Ergebnis</button>
  </div>
</div>

<!-- Game Over -->
<div id="gameOverModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
  <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
    <h2 id="gameOverTitle" class="text-3xl font-bold mb-3"></h2>
    <p id="gameOverText" class="text-gray-600 mb-6"></p>
    <div class="space-y-2">
      <button onclick="window.showLeaderboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">üèÜ Bestenliste anzeigen</button>
      <button onclick="window.resetGame()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">üîÑ Neues Spiel</button>
    </div>
  </div>
</div>

<!-- Leaderboard -->
<div id="leaderboardModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40">
  <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
    <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">üèÜ Bestenliste</h2>
    <div id="leaderboardList" class="space-y-1 mb-6"></div>
    <button onclick="window.closeLeaderboard()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg">Schlie√üen</button>
  </div>
</div>

<!-- Info Modal (Zusatzwissen) -->
<div id="infoModal" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50 px-4">
  <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl relative">
    <button onclick="window.closeInfoModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-gray-600" aria-label="Schlie√üen">&times;</button>
    <h2 id="infoModalTitle" class="text-2xl font-bold text-amber-800 mb-4">Zusatzwissen</h2>
    <div id="infoModalContent" class="text-gray-700 space-y-2 max-h-[60vh] overflow-y-auto"></div>
  </div>
</div>

<!-- After-Turn Bottom Sheet -->
<div id="afterTurnOverlay" class="hidden fixed inset-0 bg-black/20" style="z-index:60;"></div>
<div id="afterTurnSheet" class="fixed bottom-0 inset-x-0 sheet-hidden transition-transform duration-300" style="z-index:61;">
  <div class="max-w-md mx-auto bg-white rounded-t-2xl shadow-2xl border border-gray-200 p-4">
    <h3 id="afterTurnTitle" class="text-lg font-bold text-center mb-2">Ergebnis</h3>
    <div class="flex gap-2">
      <button id="afterTurnInfoBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 rounded-lg transition-colors">üîé Zusatzwissen</button>
      <button id="afterTurnNextBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 rounded-lg transition-colors">N√§chster Zug</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* State */
let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;

/* After-turn state */
let lastWinningWood=null;
let reopenAfterInfo=false;

/* Audio */
const sounds={
  flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
  win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
  chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
  starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
sounds.flip.volume=.5; sounds.win.volume=.4; sounds.chime.volume=.6; sounds.starWin.volume=.7;

function playSound(a){ if(isMuted) return; a.currentTime=0; a.play().catch(()=>{}); }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

const woodCards=[
 {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000},
 {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000},
 {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000},
 {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000},
 {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000},
 {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000},
 {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000},
 {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500},
 {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000},
 {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500},
 {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000},
 {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000},
 {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500},
 {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500},
 {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000},
 {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000},
 {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000},
 {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000},
 {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000},
 {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500},
 {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000},
 {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000},
 {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000},
 {name:"Zypresse",dk:2,haerte:48,quellenSchwindenRadial:3.0,dichte:520,gewicht:9000},
 {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500},
 {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000},
 {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000},
 {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000},
 {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000},
 {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500}
];

const woodInfo = {
 "Eiche": { info: `Eiche (QE) ... hart, schwer, dauerhaft. Verwendung: M√∂bel, Fu√üb√∂den, ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/eiche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/eiche_2.jpg?raw=true" },
 "Buche": { info: `Buche (BU) ... z√§h, biegsam, harzarm. Verwendung: M√∂bel, Parkett, ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/buche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/buche_2.jpg?raw=true" },
 "Kiefer": { info: `Kiefer (KI) ... weich, harzhaltig. Verwendung: Bauholz, Innenausbau, ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kiefer_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kiefer_2.jpg?raw=true" },
 "Fichte": { info: `Fichte (FI) ... klassisches Bauholz, geringe Dichte.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/fichte_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/fichte_2.jpg?raw=true" },
 "Tanne": { info: `Tanne (TA) ... harzarm, fein.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/tanne_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/tanne_2.jpg?raw=true" },
 "L√§rche": { info: `L√§rche (LA) ... witterungsbest√§ndig.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/laerche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/laerche_2.jpg?raw=true" },
 "Birke": { info: `Birke (BI) ... hell, dekorativ.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/birke_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/birke_2.jpg?raw=true" },
 "Ahorn": { info: `Ahorn (AM) ... hart, hell.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ahorn_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ahorn_2.jpg?raw=true" },
 "Esche": { info: `Esche (ES) ... z√§h, elastisch.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/esche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/esche_2.jpg?raw=true" },
 "Kirsche": { info: `Kirsche (KR) ... warme rote T√∂ne.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kirsche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kirsche_2.jpg?raw=true" },
 "Nussbaum": { info: `Nussbaum (NU) ... dunkel, dekorativ.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/nussbaum_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/nussbaum_2.jpg?raw=true" },
 "Douglasie": { info: `Douglasie (DO) ... robust, au√üen einsetzbar.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/douglasie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/douglasie_2.jpg?raw=true" },
 "Zeder": { info: `Zeder (ZE) ... angenehmer Duft.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zeder_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zeder_2.jpg?raw=true" },
 "Mahagoni": { info: `Mahagoni (MA) ... dauerhaft, edel.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/mahagoni_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/mahagoni_2.jpg?raw=true" },
 "Teak": { info: `Teak (TE) ... sehr witterungsbest√§ndig.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/teak_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/teak_2.jpg?raw=true" },
 "Bambus": { info: `Bambus (BA) ... botanisch Gras, sehr stabil.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/bambus_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/bambus_2.jpg?raw=true" },
 "Pappel": { info: `Pappel (PA) ... sehr leicht.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/pappel_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/pappel_2.jpg?raw=true" },
 "Weide": { info: `Weide (WE) ... elastisch, Flechtarbeiten.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/weide_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/weide_2.jpg?raw=true" },
 "Linde": { info: `Linde (LI) ... weich, gut schnitzbar.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/linde_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/linde_2.jpg?raw=true" },
 "Ulme": { info: `Ulme (UL) ... z√§h, markante Poren.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ulme_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ulme_2.jpg?raw=true" },
 "Kastanie": { info: `Kastanie (KA) ... wetterbest√§ndig.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kastanie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kastanie_2.jpg?raw=true" },
 "Robinie": { info: `Robinie (RO) ... sehr hart, dauerhaft.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/robinie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/robinie_2.jpg?raw=true" },
 "Hemlock": { info: `Hemlock (HE) ... weich, gleichm√§√üig.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hemlock_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hemlock_2.jpg?raw=true" },
 "Zypresse": { info: `Zypresse (ZY) ... duftet, resistent.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zypresse_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zypresse_2.jpg?raw=true" },
 "Redwood": { info: `Redwood (RW) ... leicht, dauerhaft.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/redwood_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/redwood_2.jpg?raw=true" },
 "Hickory": { info: `Hickory (HI) ... sehr z√§h, hart.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hickory_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hickory_2.jpg?raw=true" },
 "Wenge": { info: `Wenge ... dunkel, hart.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/wenge_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/wenge_2.jpg?raw=true" },
 "Zebrano": { info: `Zebrano ... markante Streifen.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zebrano_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zebrano_2.jpg?raw=true" },
 "Palisander": { info: `Palisander ... dekorativ, langlebig.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/palisander_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/palisander_2.jpg?raw=true" },
 "Ebenholz": { info: `Ebenholz ... sehr hart, dunkel.`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ebenholz_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ebenholz_2.jpg?raw=true" }
};

const reflectionQuestions=["Frage 1","Frage 2","Frage 3"];

const attributeInfo={
  dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit (DK)',color:'blue'},
  haerte:{icon:'üíé',name:'Druckfestigkeit (N/mm¬≤)',color:'blue'},
  quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schwinden (%)',color:'blue'},
  dichte:{icon:'‚öñÔ∏è',name:'Rohdichte (kg/m¬≥)',color:'blue'},
  gewicht:{icon:'üèãÔ∏è',name:'E-Modul (N/mm¬≤)',color:'blue'}
};

let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};

/* DOM Ready */
document.addEventListener('DOMContentLoaded',async()=>{
  try{await signInAnonymously(auth);}catch(e){}
  onAuthStateChanged(auth,(user)=>{ if(user){ localPlayerId=user.uid; } });

  const soundToggle=document.getElementById('soundToggle');
  const savedMute=localStorage.getItem('holzquartett_isMuted');
  isMuted=savedMute==='true'; soundToggle.checked=!isMuted;
  soundToggle.addEventListener('change',(e)=>{ isMuted=!e.target.checked; localStorage.setItem('holzquartett_isMuted',isMuted); if(!isMuted) playSound(sounds.chime); });

  const revealToggle=document.getElementById('revealBackToggle');
  revealToggle.checked=isOpponentNameBackVisible();
  revealToggle.addEventListener('change',e=>{ setOpponentNameBackVisible(e.target.checked); if(gameMode==='ai') displayCardsAI(); });

  document.getElementById('afterTurnInfoBtn').addEventListener('click',()=>{
    reopenAfterInfo=true; hideAfterTurnSheet();
    const fallback=aiGame.currentPlayerCard?.name||'Holz';
    window.showWoodInfo(lastWinningWood||fallback);
  });
  document.getElementById('afterTurnNextBtn').addEventListener('click',()=>{
    hideAfterTurnSheet(); if(gameMode==='ai') nextRoundAI();
  });
});

/* UI helpers */
function showAfterTurnSheet(title, winnerWoodName=null){
  lastWinningWood=winnerWoodName;
  document.getElementById('afterTurnTitle').textContent=title||'Ergebnis';
  document.getElementById('afterTurnOverlay').classList.remove('hidden');
  const s=document.getElementById('afterTurnSheet'); s.classList.remove('sheet-hidden'); s.classList.add('sheet-visible');
}
function hideAfterTurnSheet(){
  document.getElementById('afterTurnOverlay').classList.add('hidden');
  const s=document.getElementById('afterTurnSheet'); s.classList.add('sheet-hidden'); s.classList.remove('sheet-visible');
}
function shuffleArray(a){const s=[...a]; for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]];} return s;}
function highlightChosenAttribute(attr){
  document.querySelectorAll('#playerCard [data-attr], #aiCard [data-attr]').forEach(e=>e.classList.remove('bg-gray-300','bg-yellow-200'));
  const p=document.querySelector(`#playerCard [data-attr="${attr}"]`);
  const o=document.querySelector(`#aiCard [data-attr="${attr}"]`);
  if(p) p.classList.add('bg-gray-300');
  if(o) o.classList.add('bg-gray-300');
}

/* Entry points */
window.showNamePrompt=(mode)=>{
  document.getElementById('setupModal').classList.add('hidden');
  const nameModal=document.getElementById('nameModal');
  nameModal.classList.remove('hidden');
  const btn=document.getElementById('nameSubmitButton');
  const clone=btn.cloneNode(true); btn.parentNode.replaceChild(clone,btn);
  clone.addEventListener('click',()=>{
    const playerName=document.getElementById('playerName').value.trim();
    if(!playerName){alert('Bitte gib deinen Namen ein!');return;}
    nameModal.classList.add('hidden');
    if(mode==='ai'){gameMode='ai';startGameAI(playerName);}
  });
};

function updateStatusBar(p,o){
  const total=p+o; const perc= total>0 ? (p/total)*100 : 50;
  const el=document.getElementById('statusBar'); el.style.width=`${perc}%`;
  let c='#f59e0b'; if(perc<25)c='#ef4444'; else if(perc<45)c='#f97316'; else if(perc>75)c='#22c55e'; else if(perc>55)c='#84cc16'; el.style.backgroundColor=c;
}

function createCard(cardData,isRevealed=true,isPlayer=true){
  const card=document.createElement('div');
  card.className=`card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''} transition-all duration-300`;
  if(!isRevealed) card.classList.add('card-flipped');
  const borderColor=isPlayer?'border-amber-400':'border-gray-300';
  const shadow=isPlayer?'shadow-lg':'shadow-md';
  const front=document.createElement('div');
  front.className=`card-front card-background rounded-xl ${shadow} border-2 ${borderColor} p-2 sm:p-3 flex flex-col overflow-hidden`;

  const canSelect=isPlayer && (gameMode==='ai' && !aiGame.roundInProgress && aiGame.turn==='player');
  const showInfoBtn=isPlayer && (gameMode==='ai' && aiGame.roundInProgress);
  const cardName=cardData?.name||'Unbekannt';
  const safeId=(cardName||'').replace(/[^a-zA-Z0-9]/g,'-')||'unknown';

  let headerRight='';
  if(isPlayer){
    const wi=woodInfo[cardName]||{};
    const treeImg=wi.bildBaum||'https://placehold.co/36x36/d1d5db/374151?text=?';
    headerRight = `
      <div class="flex-shrink-0 relative w-8 h-8 sm:w-9 sm:h-9">
        <img src="${treeImg}" alt="${cardName}" id="wood-image-icon-${safeId}" class="${showInfoBtn?'hidden':''} absolute inset-0 w-full h-full object-cover rounded-full border-2 border-amber-200">
        <button id="player-info-button-${safeId}" onclick="reopenAfterInfo=false; window.showWoodInfo('${cardName.replace(/'/g,"\\'")}')" class="${showInfoBtn?'':'hidden'} absolute inset-0 bg-purple-600 text-white rounded-full flex items-center justify-center text-lg hover:bg-purple-700 z-10">üí°</button>
      </div>`;
  }

  let attrs='<div class="space-y-1 mt-auto">';
  for(const key in attributeInfo){
    const a=attributeInfo[key];
    const v=cardData?.[key]??'?';
    const fv=typeof v==='number'?v.toLocaleString('de-DE'):v;
    const unit=a.name.match(/\(([^)]+)\)/);
    const unitText=unit?`<span class="block text-[10px] sm:text-xs text-gray-500 leading-tight">(${unit[1]})</span>`:'';
    const label=(key==='quellenSchwindenRadial')?'Quellen/Schw.':a.name.replace(/\s*\(([^)]+)\)/,'');
    const baseBg=canSelect?'bg-amber-100':'bg-amber-50';
    const hov=canSelect?'hover:bg-amber-200':'';
    const border=canSelect?'border-amber-600':'border-amber-300';
    const txt=canSelect?'text-amber-700':'text-amber-800';
    const common=`w-full flex justify-between items-center py-0.5 sm:py-1 px-1 rounded-lg text-left border ${border} ${baseBg}`;
    if(canSelect){
      attrs+=`<button data-attr="${key}" onclick="window.selectAttribute('${key}')" class="${common} ${hov} transition-colors"><div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${a.icon}</span><div><span class="text-[11px] sm:text-xs font-medium leading-tight">${label}</span>${unitText}</div></div><span class="font-semibold ${txt} text-sm sm:text-base">${fv}</span></button>`;
    }else{
      attrs+=`<div data-attr="${key}" class="${common}"><div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${a.icon}</span><div><span class="text-[11px] sm:text-xs font-medium leading-tight text-gray-700">${label}</span>${unitText}</div></div><span class="font-semibold ${txt} text-sm sm:text-base">${fv}</span></div>`;
    }
  }
  attrs+='</div>';

  const header=`<div class="flex justify-between items-center w-full mb-2 px-1 h-9 sm:h-10"><h3 class="text-base sm:text-lg font-bold text-amber-800 truncate text-left mr-2">${cardName}</h3>${headerRight}</div>`;
  front.innerHTML=header+attrs;

  const back=document.createElement('div');
  back.className='card-back rounded-xl shadow-lg border-2 border-amber-300 flex items-center justify-center relative overflow-hidden';
  if(!isRevealed && !isPlayer && isOpponentNameBackVisible()){
    const label=document.createElement('div'); label.className='opponent-back-name'; label.textContent=cardName; back.appendChild(label);
  }

  card.appendChild(front); card.appendChild(back);
  return card;
}

function displayCardsAI(){
  const pc=document.getElementById('playerCard');
  const ac=document.getElementById('aiCard');
  pc.innerHTML=''; ac.innerHTML='';
  if(aiGame.currentPlayerCard) pc.appendChild(createCard(aiGame.currentPlayerCard,true,true)); else pc.innerHTML=`<div class="card-front bg-gray-200 ...">Keine Karte</div>`;
  if(aiGame.currentAiCard){
    const reveal=aiGame.roundInProgress;
    ac.appendChild(createCard(aiGame.currentAiCard,reveal,false));
  }else ac.innerHTML=`<div class="card-front bg-gray-200 ...">Keine Karte</div>`;
}

function updateDisplayAI(){
  const pc=aiGame.playerCards.length, oc=aiGame.aiCards.length;
  document.getElementById('playerCards').textContent=pc;
  document.getElementById('aiCards').textContent=oc;
  updateStatusBar(pc,oc);
  const ti=document.getElementById('turnIndicator'); ti.classList.remove('hidden');
  if(aiGame.roundInProgress){
    if(!document.getElementById('resultDisplay').classList.contains('hidden')) ti.textContent='';
    else if(aiGame.turn==='ai'){ ti.textContent='Computer √ºberlegt...'; ti.className='text-sm font-semibold p-1 text-gray-500'; }
    else ti.textContent='';
  }else if(aiGame.turn==='player'){ ti.textContent='Du bist am Zug!'; ti.className='text-sm font-semibold p-1 text-green-600'; }
  else { ti.textContent='Computer ist am Zug...'; ti.className='text-sm font-semibold p-1 text-gray-500'; }
}

function startGameAI(name){
  aiGame.playerName=name;
  document.getElementById('playerNameDisplay').textContent=name;
  document.getElementById('opponentNameDisplay').textContent='Computer';
  const sh=shuffleArray(woodCards);
  aiGame.playerCards=sh.slice(0,15);
  aiGame.aiCards=sh.slice(15,30);
  aiGame.currentPlayerCard=aiGame.playerCards[0];
  aiGame.currentAiCard=aiGame.aiCards[0];
  aiGame.roundInProgress=false;
  aiGame.turn='player';
  document.getElementById('attributeSelection').classList.remove('hidden');
  document.getElementById('resultDisplay').classList.add('hidden');
  document.getElementById('turnIndicator').classList.remove('hidden');
  document.getElementById('gameContainer').classList.remove('hidden');
  hideAfterTurnSheet();
  window.scrollTo(0,0);
  updateDisplayAI(); displayCardsAI();
}

window.selectAttribute=function(attribute){
  if(gameMode==='ai') selectAttributeAI(attribute);
};

function selectAttributeAI(attribute){
  if(aiGame.roundInProgress || aiGame.turn!=='player' || !aiGame.currentPlayerCard || !aiGame.currentAiCard || !attributeInfo[attribute]) return;
  aiGame.roundInProgress=true;

  const aiCardEl=document.getElementById('aiCard').querySelector('.card-3d');
  if(aiCardEl){ aiCardEl.classList.remove('card-flipped'); playSound(sounds.flip); }

  const pv=aiGame.currentPlayerCard[attribute], av=aiGame.currentAiCard[attribute];
  let pWins;
  if(attribute==='quellenSchwindenRadial' || attribute==='dk'){ pWins = pv<av ? true : (av<pv ? false : 'tie'); }
  else{ pWins = pv>av ? true : (av>pv ? false : 'tie'); }

  const pMove=aiGame.playerCards.shift(), aMove=aiGame.aiCards.shift();
  let nextTurn=aiGame.turn;
  if(pWins===true){ if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.playerCards.push(aMove); nextTurn='player'; }
  else if(pWins===false){ if(aMove) aiGame.aiCards.push(aMove); if(pMove) aiGame.aiCards.push(pMove); nextTurn='ai'; }
  else { if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.aiCards.push(aMove); }
  aiGame.turn=nextTurn;

  setTimeout(()=>{
    displayCardsAI();
    const res=document.getElementById('resultText');
    const resCls= pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-yellow-600');
    res.textContent= pWins===true ? 'üéâ Du gewinnst!' : (pWins===false ? 'üòû KI gewinnt!' : 'ü§ù Unentschieden!');
    res.className=`text-lg sm:text-xl font-bold ${resCls}`;
    document.getElementById('resultDetails').textContent=`${attributeInfo[attribute].name.split(' (')[0]}: ${pv.toLocaleString('de-DE')} vs ${av.toLocaleString('de-DE')}`;
    document.getElementById('attributeSelection').classList.add('hidden');
    document.getElementById('resultDisplay').classList.remove('hidden');

    highlightChosenAttribute(attribute);

    const winningWood = (pWins===true) ? aiGame.currentPlayerCard.name : ((pWins===false) ? aiGame.currentAiCard.name : (aiGame.currentPlayerCard.name));
    lastWinningWood = winningWood;

    setTimeout(()=>{
      if(aiGame.playerCards.length===0||aiGame.aiCards.length===0){ endGameAI(); return; }
      const title = pWins===true ? 'Du gewinnst' : (pWins===false ? 'Du verlierst' : 'Unentschieden');
      showAfterTurnSheet(title, winningWood);
    },2000);
    if(pWins===true){ playSound(sounds.win); triggerWinStarAnimation(); }
    updateDisplayAI(); checkGameOverAI();
    window.scrollTo({top:0,behavior:'smooth'});
  },600);
}

function aiSelectAttribute(){
  if(aiGame.roundInProgress || aiGame.turn!=='ai' || !aiGame.currentPlayerCard || !aiGame.currentAiCard) return;
  aiGame.roundInProgress=true;
  hideAfterTurnSheet();
  document.getElementById('infoModal').classList.add('hidden');
  setTimeout(()=>{
    const keys=Object.keys(attributeInfo);
    const key=keys[Math.floor(Math.random()*keys.length)];
    const pv=aiGame.currentPlayerCard[key], av=aiGame.currentAiCard[key];
    let pWins;
    if(key==='quellenSchwindenRadial' || key==='dk'){ pWins = pv<av ? true : (av<pv ? false : 'tie'); }
    else{ pWins = pv>av ? true : (av>pv ? false : 'tie'); }

    const pMove=aiGame.playerCards.shift(), aMove=aiGame.aiCards.shift();
    let nextTurn=aiGame.turn;
    if(pWins===true){ if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.playerCards.push(aMove); nextTurn='player'; }
    else if(pWins===false){ if(aMove) aiGame.aiCards.push(aMove); if(pMove) aiGame.aiCards.push(pMove); nextTurn='ai'; }
    else { if(pMove) aiGame.playerCards.push(pMove); if(aMove) aiGame.aiCards.push(aMove); }
    aiGame.turn=nextTurn;

    const aiCardEl=document.getElementById('aiCard').querySelector('.card-3d');
    if(aiCardEl){ aiCardEl.classList.remove('card-flipped'); playSound(sounds.flip); }

    displayCardsAI();
    const res=document.getElementById('resultText');
    const resCls= pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-yellow-600');
    res.textContent= pWins===true ? 'üéâ Du gewinnst!' : (pWins===false ? 'üòû KI gewinnt!' : 'ü§ù Unentschieden!');
    res.className=`text-lg sm:text-xl font-bold ${resCls}`;
    document.getElementById('resultDetails').textContent=`${attributeInfo[key].name.split(' (')[0]}: ${pv.toLocaleString('de-DE')} vs ${av.toLocaleString('de-DE')}`;
    document.getElementById('attributeSelection').classList.add('hidden');
    document.getElementById('resultDisplay').classList.remove('hidden');

    highlightChosenAttribute(key);

    const winningWood = (pWins===true) ? aiGame.currentPlayerCard.name : ((pWins===false) ? aiGame.currentAiCard.name : (aiGame.currentPlayerCard.name));
    lastWinningWood = winningWood;

    setTimeout(()=>{
      if(aiGame.playerCards.length===0||aiGame.aiCards.length===0){ endGameAI(); return; }
      const title = pWins===true ? 'Du gewinnst' : (pWins===false ? 'Du verlierst' : 'Unentschieden');
      showAfterTurnSheet(title, winningWood);
    },2000);

    if(pWins===true){ playSound(sounds.win); triggerWinStarAnimation(); }
    updateDisplayAI(); checkGameOverAI();
    window.scrollTo({top:0,behavior:'smooth'});
  },1000);
}

function nextRoundAI(){
  hideAfterTurnSheet();
  const pf=document.getElementById('playerCard')?.querySelector('.card-front'); if(pf) pf.classList.remove('animate-glow-win','animate-glow-lose');
  const af=document.getElementById('aiCard')?.querySelector('.card-front'); if(af) af.classList.remove('animate-glow-win','animate-glow-lose');
  document.querySelectorAll('#playerCard [data-attr], #aiCard [data-attr]').forEach(e=>e.classList.remove('bg-gray-300','bg-yellow-200'));

  if(aiGame.playerCards.length===0||aiGame.aiCards.length===0){ endGameAI(); return; }

  aiGame.currentPlayerCard=aiGame.playerCards[0];
  aiGame.currentAiCard=aiGame.aiCards[0];
  aiGame.roundInProgress=false;
  document.getElementById('resultDisplay').classList.add('hidden');
  updateDisplayAI(); displayCardsAI();

  if(aiGame.turn==='ai'){ document.getElementById('attributeSelection').classList.add('hidden'); aiSelectAttribute(); }
  else{ document.getElementById('attributeSelection').classList.remove('hidden'); }
}

function checkGameOverAI(){
  if(aiGame.roundInProgress) return;
  if(aiGame.playerCards.length===0||aiGame.aiCards.length===0) setTimeout(endGameAI,300);
}

function triggerWinStarAnimation(){
  const cont=document.getElementById('animationContainer');
  const box=document.getElementById('playerScoreBox');
  const bar=document.getElementById('statusBar');
  if(!cont||!box||!bar) return;
  const sr=bar.getBoundingClientRect(), er=box.getBoundingClientRect(), cr=cont.getBoundingClientRect();
  const star=document.createElement('div'); star.textContent='‚≠ê'; star.className='falling-star';
  const w=sr.width*(parseFloat(bar.style.width)/100);
  star.style.left=`${sr.left-cr.left+(w/2)-20}px`; star.style.top=`${sr.top-cr.top-20}px`;
  const endY=(er.top+er.height/2)-sr.top; star.style.setProperty('--end-y',`${endY}px`);
  cont.appendChild(star);
  playSound(sounds.chime); playSound(sounds.starWin);
  setTimeout(()=>star.remove(),1200);
}

function endGameAI(){
  hideAfterTurnSheet();
  if(!document.getElementById('gameOverModal').classList.contains('hidden')||!document.getElementById('reflectionModal').classList.contains('hidden')) return;
  const win=aiGame.playerCards.length>0;
  if(win){ saveToLeaderboard(aiGame.playerName); showReflectionOrWinScreen(); }
  else showGameOverScreen(false);
}

function showReflectionOrWinScreen(){
  let i=parseInt(localStorage.getItem('reflectionQuestionIndex')||'0');
  document.getElementById('reflectionQuestion').textContent=reflectionQuestions[i%reflectionQuestions.length];
  document.getElementById('reflectionModal').classList.remove('hidden');
  i=i+1; localStorage.setItem('reflectionQuestionIndex',i.toString());
}
window.showFinalWinScreen=function(){
  document.getElementById('reflectionModal').classList.add('hidden');
  document.getElementById('reflectionAnswer').value='';
  showGameOverScreen(true);
};
function showGameOverScreen(win){
  hideAfterTurnSheet();
  document.getElementById('reflectionModal').classList.add('hidden');
  document.getElementById('leaderboardModal').classList.add('hidden');
  const t=document.getElementById('gameOverTitle');
  const tx=document.getElementById('gameOverText');
  const m=document.getElementById('gameOverModal');
  if(win===true){
    t.textContent='üéâ Gl√ºckwunsch!'; t.className='text-3xl font-bold mb-3 text-green-600';
    const name=aiGame.playerName||'Du';
    tx.textContent=`Du hast gewonnen, ${name}! Du hast alle Karten gesammelt.`;
  }else if(win===false){
    t.textContent='üòû Spiel verloren'; t.className='text-3xl font-bold mb-3 text-red-600';
    tx.textContent=`Die KI hat gewonnen. Versuche es nochmal!`;
  }else{
    t.textContent='ü§ù Unentschieden!'; t.className='text-3xl font-bold mb-3 text-yellow-600';
    tx.textContent='Das Spiel endet unentschieden!';
  }
  m.classList.remove('hidden');
}

async function saveToLeaderboard(name){
  if(!name) return;
  const safe=name.replace(/[.#$[\]]/g,'_');
  const ref=doc(db,"leaderboard",safe);
  try{ await setDoc(ref,{name,wins:increment(1),lastWin:serverTimestamp()},{merge:true}); }catch(e){}
}

window.showWoodInfo=function(woodName){
  const modal=document.getElementById('infoModal');
  const title=document.getElementById('infoModalTitle');
  const content=document.getElementById('infoModalContent');
  const key=Object.keys(woodInfo).find(k=>k.toLowerCase()===(woodName||'').toLowerCase());
  const info=key?woodInfo[key]:null;
  title.textContent = woodName ? `Zusatzwissen ‚Äì ${woodName}` : `Zusatzwissen`;
  if(info){
    content.innerHTML=`
      <p class="text-left text-sm sm:text-base">${info.info||'Keine Beschreibung verf√ºgbar.'}</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
        <div>
          <h4 class="font-semibold mb-2 text-center text-sm sm:text-base">Baum</h4>
          <img src="${info.bildBaum||''}" alt="Bild von ${woodName} Baum" class="w-full max-h-48 sm:max-h-60 h-auto rounded-lg object-contain mx-auto border" onerror="this.parentElement.style.display='none';">
        </div>
        <div>
          <h4 class="font-semibold mb-2 text-center text-sm sm:text-base">Querschnitt</h4>
          <img src="${info.bildQuerschnitt||''}" alt="Bild von ${woodName} Querschnitt" class="w-full max-h-48 sm:max-h-60 h-auto rounded-lg object-contain mx-auto border" onerror="this.parentElement.style.display='none';">
        </div>
      </div>`;
  }else{
    content.innerHTML="<p>F√ºr diese Holzart sind aktuell keine Detailinformationen verf√ºgbar.</p>";
  }
  modal.classList.remove('hidden');
};
window.closeInfoModal=function(){
  document.getElementById('infoModal').classList.add('hidden');
  if(reopenAfterInfo){
    const t=document.getElementById('afterTurnTitle').textContent || 'Ergebnis';
    showAfterTurnSheet(t, lastWinningWood);
    reopenAfterInfo=false;
  }
};

</script>
</body>
</html>
