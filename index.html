<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett: Gamifizierung in der Berufsbildung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* DESIGN DEFINITIONEN */
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; touch-action: manipulation; overflow-x: hidden; min-height: 100dvh; }
        .perspective-1000 { perspective: 1000px; }
        .card-3d { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 1rem; overflow: hidden; box-sizing: border-box; }
        .card-back { 
            transform: rotateY(180deg); 
            background-color: #2c3e50;
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/326bdfd40ff4d97de5c70dc584fe767aba056135/images/background_card.jpg?raw=true'); 
            background-size: cover; 
            background-position: center; 
            border: 4px solid white; 
        }
        .card-front-bg { background-color: #fffbeb; background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        /* Status-Ball Animation */
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); transform: translate(-50%, -50%) scale(1); } 50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); transform: translate(-50%, -50%) scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: translate(-50%, -50%) scale(1); } }
        
        /* Pop-In Animation f√ºr Fenster */
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* Bounce Animation f√ºr Gleichstand */
        .animate-bounce-slam { animation: bounce-slam 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes bounce-slam { 
            0% { transform: scale(0); opacity: 0; } 
            60% { transform: scale(1.1); opacity: 1; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        /* KLOTZI JUBEL ANIMATION (Runde gewonnen) */
        @keyframes slide-up-bounce {
            0% { transform: translateY(100%) rotate(10deg); opacity: 0; }
            60% { transform: translateY(-20px) rotate(-5deg); opacity: 1; }
            80% { transform: translateY(10px) rotate(5deg); }
            100% { transform: translateY(0) rotate(0deg); opacity: 1; }
        }
        .animate-klotzi-popup { animation: slide-up-bounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .opponent-back-name { position: absolute; top: 15%; width: 100%; text-align: center; color: rgba(255,255,255,0.95); font-weight: 700; font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dimmer { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .attr-box { background-color: #fff7ed; border: 1px solid #fbbf24; transition: all 0.2s; }
        .attr-box.flash-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; }
        .attr-box.flash-active span { color: white !important; }
        .attr-box.highlight-compare { background-color: #e5e7eb !important; border-color: #9ca3af !important; color: #111827 !important; }
        .attr-box.highlight-compare span { color: #000000 !important; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .attr-toggle-btn { transition: all 0.2s; border: 2px solid transparent; }
        .attr-toggle-btn.selected { background-color: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .attr-toggle-btn:not(.selected) { background-color: #f3f4f6; color: #9ca3af; border-color: transparent; }

        /* ANIMATIONEN F√úR DEN BALKEN & PUNKT */
        @keyframes pulse-dot-anim { 
            0%, 100% { transform: translate(50%, -50%) scale(1); } 
            50% { transform: translate(50%, -50%) scale(1.4); } 
        }
        .animate-pulse-dot { animation: pulse-dot-anim 1s infinite ease-in-out; }

        @keyframes chargeWidth { from { width: 0%; } to { width: 100%; } }
        .animate-charge { animation: chargeWidth 1.5s linear forwards; }
        
        @keyframes shrinkWidth { from { width: 100%; } to { width: 0%; } }
        .animate-shrink { animation: shrinkWidth 10s linear forwards; }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">

<header id="mainHeader" class="fixed top-0 left-0 w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-[120]">
    <div class="max-w-[600px] mx-auto px-4 py-3 relative flex justify-between items-center">
        <a id="navButton" href="#" class="relative z-[121] w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-white shadow-sm hover:bg-white/30 transition-all border border-white/30" aria-label="Navigation">
             </a>
        <h1 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg sm:text-2xl font-black tracking-wider uppercase drop-shadow-sm whitespace-nowrap pointer-events-none">üå≤ HOLZEN! üå≤</h1>
        <button id="ruleButton" onclick="window.showGameInfo()" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-[121] hidden" aria-label="Spielregeln">
             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>
</header>

<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto relative p-2 pt-20 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>
    <div class="flex justify-center items-start gap-2 sm:gap-4 w-full flex-grow relative pb-2 mt-2"> 
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="playerNameDisplay" class="text-base sm:text-lg font-bold text-amber-700 leading-tight truncate">Spieler</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="playerCardContainer"><div id="playerCard" class="w-full h-full relative"></div></div>
        </div>
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="opponentNameDisplay" class="text-base sm:text-lg font-bold text-gray-600 leading-tight truncate">COMPUTER</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="aiCardContainer"><div id="aiCard" class="w-full h-full relative"></div></div>
        </div>
    </div>
    <div class="w-full mt-4 mb-24"> 
        <div class="flex justify-between text-[9px] sm:text-[10px] font-bold text-gray-400 mb-1 px-1"><span>Dein Stapel</span><span>Gegenspieler</span></div>
        <div class="h-4 w-full bg-gray-200 rounded-full shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 rounded-l-full transition-all duration-500 ease-out" style="width: 50%;"></div>
            <div id="statusBall" class="absolute top-1/2 w-6 h-6 rounded-full border-2 border-white shadow-md transition-all duration-500 ease-out z-10" style="left: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);"></div>
        </div>
    </div>
</div>

<div id="happyKlotzi" class="fixed bottom-0 right-2 z-[100] transition-transform duration-500 translate-y-full hidden pointer-events-none flex flex-col items-center">
    <div id="happyKlotziText" class="bg-white border-4 border-black text-black font-black text-base sm:text-lg px-4 py-2 rounded-2xl mb-1 shadow-[4px_4px_0px_rgba(0,0,0,0.2)] animate-bounce relative text-center">
        Stark!
        <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[12px] border-t-black"></div>
        <div class="absolute -bottom-[9px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[10px] border-t-white"></div>
    </div>
    <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" alt="Jubel Klotzi" class="w-32 sm:w-40 filter drop-shadow-2xl">
</div>

<div id="tieOverlay" class="fixed inset-0 z-[90] flex items-center justify-center dimmer hidden pt-20">
    <div class="bg-white/10 backdrop-blur-md p-8 rounded-3xl animate-bounce-slam text-center border border-white/20 shadow-2xl relative">
        
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_quiz.png?raw=true" alt="Klotzi Quiz" class="w-32 mx-auto mb-2 object-contain filter drop-shadow-lg" onerror="this.style.display='none'">
        
        <div class="text-5xl mb-2 filter drop-shadow-lg">üí•</div>
        <h2 class="text-4xl sm:text-5xl font-black text-white uppercase tracking-wider drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">
            GLEICHSTAND!
        </h2>
        <p class="text-white font-bold text-lg mt-3 drop-shadow-md bg-black/20 px-4 py-1 rounded-full inline-block">Das Quiz entscheidet...</p>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 dimmer flex items-center justify-center z-[80] p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl relative w-full max-w-sm flex flex-col animate-pop-in border-4 border-amber-500 overflow-visible">
        
        <div class="h-4 w-full bg-gray-200 relative overflow-hidden rounded-t-xl">
            <div id="quizTimerBar" class="h-full w-0 bg-amber-500 rounded-r-sm relative"> 
                <div class="absolute right-0 top-1/2 w-4 h-4 bg-white border-2 border-amber-600 rounded-full shadow z-10 animate-pulse-dot transform translate-x-1/2 -translate-y-1/2"></div>
            </div>
        </div>
        
        <div class="p-6 text-center relative z-10">
            <div id="quizStatusText" class="inline-block bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full mb-3 relative z-30">
                ‚ö†Ô∏è Gleichstand! Quiz l√§dt...
            </div>
            <h3 id="quizQuestion" class="text-lg font-bold text-gray-800 mb-6 leading-tight min-h-[3rem] flex items-center justify-center relative z-30 px-2">
                Frage wird geladen...
            </h3>
            <div id="quizOptions" class="grid grid-cols-1 gap-3 relative z-30">
                </div>
        </div>
    </div>
</div>

<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-xs sm:text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-xl sm:text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>
        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-800 transition text-sm sm:text-base">üéì Zusatzwissen</button>
            <button id="bsNextBtn" class="flex-1 bg-green-600 hover:bg-green-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-green-800 transition text-sm sm:text-base">Weiter &rarr;</button>
        </div>
    </div>
</div>

<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-[130] p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[85vh] flex flex-col">
        <div class="bg-amber-500 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 class="font-bold text-lg">Spielregeln & Eigenschaften</h3>
            <button onclick="window.closeGameInfo()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto hide-scrollbar space-y-5">
            <h4 class="font-bold text-gray-700 text-md">Regeln:</h4>
            <p class="text-sm text-gray-600 leading-relaxed">Die aktive Person w√§hlt auf ihrer Karte die Eigenschaft, die den gr√∂√ütm√∂glichen Vorteil verspricht. Je nach Kategorie z√§hlt der h√∂here oder der niedrigere Wert (siehe die Beschreibung der Eigenschaften).</p>
            
            <h4 class="font-bold text-gray-700 text-md mt-4">Bei Gleichstand:</h4>
            <p class="text-sm text-gray-600 leading-relaxed">Haben beide Karten den gleichen Wert, startet f√ºr BEIDE Spieler ein Quiz! Wer die Frage innerhalb von 10 Sekunden am schnellsten richtig beantwortet, gewinnt die Karte und ist als n√§chstes am Zug. Wird die Frage falsch beantwortet, gewinnt dein Gegenspieler. Wird die Frage von beiden Spielern innerhalb der Zeit NICHT beantwortet, bekommen beide keinen Punkt und jeder beh√§lt seine Karte.</p>
            
            <div id="infoCategoryList" class="space-y-3 pt-3"></div>
        </div>
    </div>
</div>

<div id="infoModal" class="fixed inset-0 dimmer flex items-center justify-center z-50 p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-md max-h-[85vh] flex flex-col">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Wissenskarte</h3>
            <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto"></div>
    </div>
</div>

<div id="impressumModal" class="fixed inset-0 z-[140] flex items-center justify-center p-4 dimmer hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-slate-700 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Impressum</h3>
            <button onclick="document.getElementById('impressumModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto text-sm text-gray-700 space-y-4">
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Angaben gem√§√ü ¬ß 5 TMG</h4>
                <p>Christopher Lehr<br>Waterloostra√üe 49<br>28201 Bremen</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Kontakt</h4>
                <p>E-Mail: christopher_lehr@web.de</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Kontext</h4>
                <p>Dieses interaktive Lernspiel entstand im Rahmen meiner Masterarbeit des Studiengang Lehramt an Berufsbildenden Schulen, Fachrichtung Holztechnik an der <strong>Leibniz Universit√§t Hannover</strong>. Es dient ausschlie√ülich nicht-kommerziellen Bildungs- und Forschungszwecken.</p>
            </div>
            
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Fachliche Grundlagen & Quellen</h4>
                <p class="text-xs text-gray-500 mb-1">Die verwendeten Holzdaten basieren auf folgenden Normen und Quellen:</p>
                <ul class="list-disc pl-4 text-xs text-gray-600 space-y-1">
                    <li><strong>DIN 68364:</strong> Kennwerte von Holzarten (Rohdichte, Elastizit√§tsmodul, Festigkeiten)</li>
                    <li><strong>DIN EN 338:</strong> Bauholz f√ºr tragende Zwecke ‚Äì Festigkeitsklassen</li>
                    <li><strong>DIN EN 350:</strong> Dauerhaftigkeitsklassen von Holz</li>
                    <li><strong>DIN 52184:</strong> Bestimmung der Quellung und Schwindung</li>
                    <li><strong>DIN 52192:</strong> Druckversuch quer zur Faserrichtung</li>
                    <li><strong>Vorlesung:</strong> Dr. Frank Peters (2021): Werkstoffkunde 1, Holzphysik</li>
                    <li><strong>Preise:</strong> <a href="https://www.muehlbauerholz.com/upload/schnittholz-mai-2024.pdf" target="_blank" class="underline text-blue-600">M√ºhlbauer Holz (Preisliste Mai 2024)</a></li>
                </ul>
            </div>

            <div>
                <h4 class="font-bold text-gray-900 mb-1">Haftung f√ºr Inhalte & Daten</h4>
                <p class="mb-2">Die Inhalte dieser Web-App wurden mit gr√∂√üter Sorgfalt und nach bestem Wissen und Gewissen erstellt. F√ºr die Richtigkeit, Vollst√§ndigkeit und Aktualit√§t der Inhalte kann jedoch keine Gew√§hr √ºbernommen werden.</p>
                <p class="mb-2"><strong>Besonderer Hinweis zu fachlichen Daten:</strong> Die im Spiel verwendeten Daten (z. B. Rohdichte, E-Modul, Preise) dienen prim√§r der Spielmechanik und der didaktischen Vereinfachung. Sie stellen Durchschnittswerte oder Richtwerte dar und ersetzen keine fachgerechte Planung nach DIN/EN-Normen.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Haftung f√ºr Links</h4>
                <p>Diese Webseite enth√§lt Links zu externen Webseiten Dritter (z. B. GitHub), auf deren Inhalte wir keinen Einfluss haben. Deshalb k√∂nnen wir f√ºr diese fremden Inhalte auch keine Gew√§hr √ºbernehmen. F√ºr die Inhalte der verlinkten Seiten ist stets der jeweilige Anbieter oder Betreiber der Seiten verantwortlich.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Urheberrecht</h4>
                <p class="mb-2">Die durch den Betreiber erstellten Inhalte und Werke auf diesen Seiten unterliegen dem deutschen Urheberrecht. Die Vervielf√§ltigung, Bearbeitung, Verbreitung und jede Art der Verwertung au√üerhalb der Grenzen des Urheberrechtes bed√ºrfen der schriftlichen Zustimmung des jeweiligen Autors bzw. Erstellers.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Bild- und Tonquellen</h4>
                <ul class="list-disc pl-4 text-xs text-gray-600 space-y-1">
                    <li><strong>Holzbilder:</strong> <a href="https://holzvomfach.de/" target="_blank" class="underline text-blue-600">holzvomfach.de</a> und <a href="https://www.schreiner-seiten.de/index.php" target="_blank" class="underline text-blue-600">schreiner-seiten.de</a></li>
                    <li><strong>Sounds:</strong> <a href="https://pixabay.com/de/" target="_blank" class="underline text-blue-600">Pixabay.com</a></li>
                    <li><strong>Emojis/Icons:</strong> Systemstandard (Unicode)</li>
                </ul>
            </div>
            
            <hr class="my-4 border-gray-300">
            
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Datenschutz & Technik</h4>
                <p class="mb-2">Da dies ein reines Forschungsprojekt ist, werden so wenige Daten wie m√∂glich gespeichert. Dennoch kommen externe Dienstleister zum Einsatz, um die technische Funktion zu gew√§hrleisten:</p>
                
                <ul class="list-disc pl-4 text-xs text-gray-600 space-y-2">
                    <li>
                        <strong>Hosting (GitHub Pages):</strong><br>
                        Diese Webseite wird auf Servern von GitHub Inc. (USA) gehostet. Beim Aufruf der Seite werden technisch bedingt Verbindungsdaten (z. B. IP-Adresse) an GitHub √ºbertragen, um die Inhalte auszuliefern.
                    </li>
                    <li>
                        <strong>Datenbank & Backend (Google Firebase):</strong><br>
                        F√ºr die Multiplayer-Funktion (Spielst√§nde, Synchronisation) nutzen wir Google Firebase (Google Ireland Limited). Die Spieldaten werden tempor√§r auf deren Servern gespeichert. Wir verwenden die "Anonyme Anmeldung", sodass keine Klarnamen oder E-Mail-Adressen von Nutzern gespeichert werden, sofern diese nicht freiwillig eingegeben werden.
                    </li>
                    <li>
                        <strong>Cookies / LocalStorage:</strong><br>
                        Das Spiel speichert lediglich technische Einstellungen (z. B. Sound an/aus) lokal auf Ihrem Ger√§t ("LocalStorage"). Es werden keine Tracking- oder Werbe-Cookies eingesetzt.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="attrConfigModal" class="fixed inset-0 z-[120] flex items-center justify-center p-4 dimmer hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Spieloptionen</h3>
            <button onclick="window.closeAttrConfig()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto">
            <div class="mb-5 space-y-3">
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <span class="font-bold text-gray-700 text-sm flex items-center gap-2">üîä Ton an</span>
                     <input type="checkbox" id="soundToggle" class="accent-green-500 w-5 h-5">
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <span class="font-bold text-gray-700 text-sm flex items-center gap-2">üëÄ Gegner-Karte sichtbar</span>
                     <input type="checkbox" id="revealBackToggle" class="accent-green-500 w-5 h-5">
                </div>
            </div>
            <hr class="border-gray-200 mb-4 border-t-2 border-dashed">
            <h4 class="font-bold text-gray-800 mb-1 text-sm">Eigenschaften w√§hlen</h4>
            <p class="text-xs text-gray-500 mb-3">W√§hle mindestens 3 und maximal 5 Kategorien.</p>
            <div id="attrConfigList" class="space-y-2"></div>
        </div>
        <div class="p-4 bg-gray-50 border-t">
             <button onclick="window.closeAttrConfig()" class="w-full bg-amber-500 text-white font-bold py-2 rounded-lg shadow">Fertig</button>
        </div>
    </div>
</div>

<div id="setupModal" class="fixed inset-0 z-[110] flex flex-col items-center justify-center p-4 dimmer overflow-y-auto h-screen">
    <div class="w-10 h-10 absolute left-4 top-4"></div>
    
    <div class="relative w-full max-w-sm pt-20">
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_menu.png?raw=true" alt="Klotzi Men√º" class="absolute -top-4 -right-2 w-48 z-20 pointer-events-none transform rotate-3 drop-shadow-xl" onerror="this.style.display='none'">
        
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full relative mb-6 z-10">
            <div class="bg-amber-500 p-5 text-white text-center font-bold text-lg sm:text-xl tracking-wide shadow-md">HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus w√§hlen</span></div>
            <div class="p-6 space-y-4">
                <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">ü§ñ</span> Gegen Computer</button>
                <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">üåç</span> Online gegen Freunde</button>
                <button onclick="window.openAttrConfig()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl border border-gray-200 flex items-center justify-center gap-2 text-sm mt-2">
                    <span>‚öôÔ∏è</span> Spieloptionen <span id="attrCountBadge" class="bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">5</span>
                </button>
            </div>
        </div>
        <div id="mainMenuStats" class="text-center hidden mb-8 relative z-10"></div>
        <div class="mt-auto pt-4 text-center relative z-10">
            <button onclick="document.getElementById('impressumModal').classList.remove('hidden')" class="text-white/70 text-xs font-medium hover:text-white underline transition-colors">Impressum</button>
        </div>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center relative overflow-visible">
        
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_name.png?raw=true" alt="Klotzi Name" class="absolute -top-36 left-1/2 -translate-x-1/2 w-80 pointer-events-none drop-shadow-xl z-20" onerror="this.style.display='none'">
        
        <div class="relative z-10 mt-16"> 
            <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
            <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg" placeholder="Name eingeben" maxlength="12">
            <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600">Starten</button>
        </div>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund scannen:</p>
        <div class="flex justify-center mb-4"><div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div></div>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center relative overflow-visible">
        
        <img id="gameOverWorm" src="" alt="Klotzi Ende" class="absolute -top-40 left-1/2 -translate-x-1/2 w-96 z-20 pointer-events-none drop-shadow-xl" onerror="this.style.display='none'">
        
        <div class="relative z-10 mt-24"> 
            <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
            <p id="gameOverText" class="text-gray-600 mb-6"></p>
            <div class="space-y-3">
                <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">üèÜ Bestenliste</button>
                <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">üîÑ Neues Spiel</button>
            </div>
        </div>
    </div>
</div>

<div id="reflectionModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-amber-800 mb-4">üéâ Super gespielt!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 font-medium"></p>
        <textarea id="reflectionAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg">Weiter</button>
    </div>
</div>

<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">Schlie√üen</button>
    </div>
</div>

<script type="module">
// 4. DATENBANK & LOGIK (JAVASCRIPT)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};

const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'holzquartett-3a177';

let app, db, auth;
try {
    app = initializeApp(activeConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (e) {
    console.error("Firebase Init Error:", e);
    alert("Fehler beim Laden der Datenbank-Konfiguration.");
}

const initAuth = async () => {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (e) {
        console.error("Auth Failed", e);
    }
};
initAuth();

const getPublicDataRef = (coll, docId) => {
    if(docId) return doc(db, 'artifacts', appId, 'public', 'data', coll, docId);
    return collection(db, 'artifacts', appId, 'public', 'data', coll);
};

async function trackEvent(type) {
    if (!auth || !auth.currentUser) return;
    const ref = getPublicDataRef("statistics", "usage"); 
    try {
        await setDoc(ref, {
            [type]: increment(1),
            last_activity: serverTimestamp()
        }, { merge: true });
    } catch (e) {
        console.warn("Tracking eingeschr√§nkt.", e);
    }
}

const NAV_ICONS = {
    fingerprint: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 20 C 10 18, 10 6, 14 4" opacity="0.5" /><path d="M9 21 C 14 19, 14 5, 18 3" opacity="0.7" /><path d="M13 22 C 18 20, 18 4, 22 2" opacity="0.9" /><path d="M2 15 C 6 13, 6 9, 10 7" opacity="0.3" /><path d="M15 22 C 19 20, 19 12, 22 10" opacity="0.5" /></svg>`,
    house: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>`
};

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

window.setNavState = (state) => {
    const btn = document.getElementById('navButton');
    if(!btn) return;
    
    // REMOVE OLD HANDLERS (Clean Navigation)
    btn.onclick = null;
    
    if(state === 'game') {
        btn.innerHTML = NAV_ICONS.house;
        btn.removeAttribute('href'); 
        btn.onclick = (e) => { 
            e.preventDefault(); 
            if(confirm('Spiel abbrechen und zum Startbildschirm zur√ºckkehren?')) { 
                if(typeof unsubscribeGame === 'function') unsubscribeGame();
                window.location.href = window.location.origin + window.location.pathname; 
            } 
        };
        btn.setAttribute('aria-label', 'Zur√ºck zur Holzen! Startseite');
        
    } else if (state === 'name_input') {
        // Navigation im Namens-Fenster -> Zur√ºck zum Hauptmen√º
        btn.innerHTML = NAV_ICONS.house;
        btn.href = "#";
        btn.onclick = (e) => {
            e.preventDefault();
            document.getElementById('nameModal').classList.add('hidden');
            document.getElementById('setupModal').classList.remove('hidden');
            window.setNavState('menu'); // Reset to default menu behavior
        };
        btn.setAttribute('aria-label', 'Zur√ºck zum Hauptmen√º');
        
    } else {
        // Default: Startseite (Splashscreen)
        btn.innerHTML = NAV_ICONS.fingerprint; 
        btn.href = 'https://aufdemholzweg.github.io/Splashscreen-Holztechnik/';
        btn.onclick = null; // Standard link behavior
        btn.setAttribute('aria-label', 'Zum Splashscreen');
    }
};

// Initial Call
window.setNavState('menu');

let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;
let lastRoundWinningWoodName = null;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};

// 5. ATTRIBUTE & EIGENSCHAFTEN (Updated)
const attributeInfo={
 dk:{
     icon:'üõ°Ô∏è',
     name:'Dauerhaftigkeit',
     unit:'(DK)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Die Dauerhaftigkeit nach DIN EN 350 gibt an, wie resistent das Kernholz gegen biologischen Befall ist: DK 1 bedeutet eine sehr lange Wiederstandsf√§higkeit gegen√ºber Pilze, Insekten und andere Sch√§dlinge, DK 5 dagegen eine sehr geringe Dauerhaftigkeit.'
 },
 druckfestigkeit:{
     icon:'üíé',
     name:'Druckfestigkeit',
     unit:'(N/mm¬≤)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: `Die Druckfestigkeit gibt die maximale Spannung in (N/mm¬≤) an, die das Holz aufnehmen kann, wenn es in Faserrichtung gestaucht wird.
Der Wert wird an kleinen, fehlerfreien Holzkl√∂tzen im Normalklima (20¬∞C, 65% rel. Luftfeuchte) bestimmt. Dabei wird die maximale Kraft, bei der das Holz versagt, durch den urspr√ºnglichen Querschnitt der Probe geteilt.`
 },
 quellen:{
     icon:'‚ÜîÔ∏è',
     name:'Quellen/Schwinden',
     unit:'(%)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Angegeben ist das maximale tangentiale Schwindma√ü (%). Dieser Wert beschreibt die prozentuale Ma√ü√§nderung in Richtung der Jahresringe vom faserges√§ttigten Zustand (ca. 30 % Holzfeuchte) bis zum darrtrockenen Zustand (0 %).'
 },
 rohdichte:{
     icon:'‚öñÔ∏è',
     name:'Normalrohdichte (Roh)',
     unit:'(kg/m¬≥)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Die Rohdichte ist der Quotient aus Masse und Volumen (kg/m¬≥) bei gleicher Holzfeuchte. Als Referenz gilt hierbei das Normalklima nach DIN 50014 (20 ¬∞C / 65 % rel. Luftfeuchte), was einer Ausgleichsfeuchte des Holzes von rund 12 % entspricht.'
 },
 emodul:{
     icon:'üìê',
     name:'E-Modul',
     unit:'(N/mm¬≤)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Das E-Modul ist eine Materialkonstante und beschreibt die Steifigkeit des Holzes. Der Wert gibt an, welche Kraft (N) erforderlich ist, um einen Stab mit einem Querschnitt von 1x1 mm auf seine doppelte L√§nge zu verformen. Sie wird in N/mm¬≤ angegeben. Ein hoher E-Modul steht f√ºr ein steifes Material, das sich nur schwer verformen l√§sst (steile Steigung im Spannungs-Dehnungs-Diagramm).'
 },
 preis:{
     icon:'üí∞',
     name:'Preisstufe',
     unit:'(Stufe)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: `Um eine einfache Vergleichbarkeit der Materialien zu gew√§hrleisten, beziehen sich alle Preisangaben auf das Volumen von einem Kubikmeter (‚Ç¨/m¬≥) Massivholz. Da reale Marktpreise je nach Region und Zeitpunkt schwanken, sind alle H√∂lzer in f√ºnf feste Preisstufen unterteilt. 
    0‚Ç¨ bis 699‚Ç¨  = 1
  700‚Ç¨ bis 1199‚Ç¨ = 2
 1200‚Ç¨ bis 1999‚Ç¨ = 3
 2000‚Ç¨ bis 3999‚Ç¨ = 4
>4000‚Ç¨           = 5`
 }
};

// RANDOM DEFAULT ATTRIBUTES
function getRandomDefaultAttributes() {
    const keys = Object.keys(attributeInfo);
    // Simple shuffle
    for (let i = keys.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [keys[i], keys[j]] = [keys[j], keys[i]];
    }
    return keys.slice(0, 5);
}

let activeAttributeKeys = getRandomDefaultAttributes();

const sounds={
 flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
 win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/64126fed45ff8c3fb4bd833f473d83f51ba0548b/Sounds/spielzuggewonnen.mp3?raw=true'),
 chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
 starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3'),
 quizTick: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/ticken_bei_quizfrage.mp3?raw=true'),
 tieAlert: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/Quiztime.mp3?raw=true')
};
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/main/images";
const IMG_SUFFIX = "?raw=true";

// 6. KARTEN DATEN
const woodCards=[
 {name:"Ahorn", dk:"5", druckfestigkeit:60, quellen:9, rohdichte:650, emodul:9500, preis:2, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`},
 {name:"Birke", dk:"5", druckfestigkeit:50, quellen:11.7, rohdichte:650, emodul:14500, preis:2, imgTree:`${IMG_BASE}/birke_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"Douglasie", dk:"5", druckfestigkeit:70, quellen:7.5, rohdichte:500, emodul:13000, preis:4, imgTree:`${IMG_BASE}/douglasie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpeg${IMG_SUFFIX}`},
 {name:"Ebenholz, Afrikanisches", dk:"1-2", druckfestigkeit:70, quellen:12.8, rohdichte:1200, emodul:13000, preis:5, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`},
 {name:"Edelkastanie", dk:"2", druckfestigkeit:50, quellen:6.8, rohdichte:620, emodul:9000, preis:3, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"Eibe", dk:"2", druckfestigkeit:60, quellen:5.2, rohdichte:670, emodul:15000, preis:4, imgTree:`${IMG_BASE}/eibe_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eibe_2.jpeg${IMG_SUFFIX}`},
 {name:"Eiche", dk:"2", druckfestigkeit:40, quellen:11.7, rohdichte:670, emodul:13000, preis:3, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"Erle", dk:"5", druckfestigkeit:55, quellen:9.4, rohdichte:550, emodul:9500, preis:1, imgTree:`${IMG_BASE}/erle_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/erle_2.jpeg${IMG_SUFFIX}`},
 {name:"Esche", dk:"5", druckfestigkeit:50, quellen:8.5, rohdichte:670, emodul:13000, preis:2, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpeg${IMG_SUFFIX}`},
 {name:"Fichte", dk:"4", druckfestigkeit:50, quellen:8, rohdichte:480, emodul:11000, preis:2, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"Hemlock", dk:"4", druckfestigkeit:55, quellen:8.5, rohdichte:480, emodul:10000, preis:4, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 {name:"Hickory", dk:"4", druckfestigkeit:65, quellen:11, rohdichte:800, emodul:15000, preis:3, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"Kiefer", dk:"3-4", druckfestigkeit:55, quellen:12.4, rohdichte:520, emodul:11000, preis:1, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpeg${IMG_SUFFIX}`},
 {name:"Kirschbaum", dk:"3", druckfestigkeit:55, quellen:8.5, rohdichte:630, emodul:10600, preis:3, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"L√§rche", dk:"3-4", druckfestigkeit:55, quellen:10.4, rohdichte:590, emodul:13800, preis:3, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"Linde", dk:"5", druckfestigkeit:50, quellen:10.7, rohdichte:520, emodul:7200, preis:2, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"Mahagoni Amerikanisch", dk:"2", druckfestigkeit:50, quellen:5.8, rohdichte:600, emodul:10600, preis:5, imgTree:`${IMG_BASE}/mahagoni_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"Meranti (DR)", dk:"3-4", druckfestigkeit:65, quellen:9.8, rohdichte:720, emodul:14500, preis:4, imgTree:`${IMG_BASE}/meranti_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/meranti_2.jpeg${IMG_SUFFIX}`},
 {name:"Nussbaum (EU)", dk:"3", druckfestigkeit:70, quellen:7.5, rohdichte:670, emodul:12000, preis:4, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"Palisander", dk:"1", druckfestigkeit:80, quellen:8.1, rohdichte:850, emodul:12800, preis:5, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"Pappel", dk:"5", druckfestigkeit:35, quellen:9.8, rohdichte:450, emodul:9000, preis:2, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"Platane", dk:"5", druckfestigkeit:45, quellen:8.5, rohdichte:620, emodul:12800, preis:3, imgTree:`${IMG_BASE}/platane_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/platane_2.jpeg${IMG_SUFFIX}`},
 {name:"Redwood", dk:"2", druckfestigkeit:40, quellen:5.2, rohdichte:400, emodul:9500, preis:2, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"Robinie", dk:"1-2", druckfestigkeit:70, quellen:7.5, rohdichte:770, emodul:13600, preis:3, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpeg${IMG_SUFFIX}`},
 {name:"Rosskastanie", dk:"5", druckfestigkeit:30, quellen:6.8, rohdichte:550, emodul:6500, preis:3, imgTree:`${IMG_BASE}/rosskastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/rosskastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"Rotbuche", dk:"5", druckfestigkeit:60, quellen:11.7, rohdichte:720, emodul:14000, preis:2, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"R√ºster", dk:"4", druckfestigkeit:45, quellen:8.3, rohdichte:670, emodul:11000, preis:3, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"Tanne", dk:"4", druckfestigkeit:45, quellen:7.5, rohdichte:450, emodul:11000, preis:2, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"Teak", dk:"1", druckfestigkeit:60, quellen:5.8, rohdichte:670, emodul:13000, preis:5, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"Weng√©", dk:"2", druckfestigkeit:90, quellen:9.4, rohdichte:850, emodul:16000, preis:4, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"Zebrano", dk:"2-3", druckfestigkeit:50, quellen:9, rohdichte:770, emodul:15400, preis:4, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"Zeder", dk:"1-2", druckfestigkeit:40, quellen:11, rohdichte:550, emodul:7200, preis:5, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`}
];

const detailedWoodInfo = {
    "Ahorn": `
        <p class="mb-2">Feinporiges, zerstreutporiges Laubholz mit gleichm√§√üiger Struktur. Das Holz ist wei√ülich bis gelblich-wei√ü gef√§rbt und zeichnet sich durch hohe H√§rte und Abriebfestigkeit aus. Es neigt zum Vergilben.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Hochwertiger M√∂belbau, Tischplatten, Musikinstrumente, K√ºchenger√§te (geschmacksneutral).</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Ahorn besitzt einen charakteristischen <em>Seidenglanz</em> auf gehobelten Fl√§chen. Die Poren sind mit blo√üem Auge nicht sichtbar.
        </div>`,
    "Birke": `
        <p class="mb-2">Ein helles, gelblich-wei√ües bis r√∂tlich-wei√ües Splintholz ohne sichtbaren Farbkern. Das Holz ist z√§h, elastisch und mittelschwer, jedoch im Au√üenbereich nicht dauerhaft (pilzanf√§llig).</p>
        <p class="mb-2"><strong>Verwendung:</strong> Sperrholz (Multiplex-Platten), Innenausbau, Drechselarbeiten, Brennholz.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Die Gef√§√üe (Poren) sind oft breiter als die Markstrahlen. Im Querschnitt zeigen sich die Poren als feine, helle Punkte. Oft geflammte Zeichnung.
        </div>`,
    "Douglasie": `
        <p class="mb-2">Nadelholz mit ausgepr√§gtem Farbkern (r√∂tlich-braun) und schmalem Splint. Es ist fester und witterungsbest√§ndiger als Fichte, aber harzhaltig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Konstruktiver Holzbau, Terrassendielen, Fensterkanteln, Fassadenbekleidung.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Deutlicher Kontrast zwischen Fr√ºh- und Sp√§tholz. Besitzt Harzkan√§le. Frisch bearbeitet riecht es oft leicht zitronig-harzig.
        </div>`,
    "Ebenholz, Afrikanisches": `
        <p class="mb-2">Ein extrem hartes, schweres und dichtes Laubholz. Das Kernholz ist tiefschwarz (teilweise mit helleren Streifen), der Splint ist grau-wei√ü. Es l√§sst sich polieren, ist aber schwer zu bearbeiten.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Musikinstrumentenbau (Griffbretter, Tasten), Einlegearbeiten, Kunsthandwerk.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Sehr hohe Dichte (sinkt oft im Wasser). Poren sind extrem fein und oft mit dunklen Inhaltsstoffen gef√ºllt.
        </div>`,
    "Edelkastanie": `
        <p class="mb-2">Ringporiges Hartholz mit gelb-braunem Kern, der stark nachdunkelt. Es √§hnelt der Eiche, ist jedoch etwas weicher und leichter. Enth√§lt viel Gerbs√§ure.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Fassbau, Pf√§hle (hohe Dauerhaftigkeit), M√∂belbau, Furniere.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Im Gegensatz zur Eiche fehlen der Edelkastanie die breiten, gut sichtbaren Markstrahlen (keine Spiegel im Radialschnitt).
        </div>`,
    "Eibe": `
        <p class="mb-2">Das h√§rteste und schwerste heimische Nadelholz. Der Kern ist r√∂tlich-braun bis violett-braun. Das Holz ist extrem z√§h, elastisch und sehr dauerhaft. Alle Pflanzenteile (au√üer der Samenmantel) sind giftig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Bogenbau (historisch), Drechslerei, Kunsttischlerei.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Nadelholz <em>ohne</em> Harzkan√§le. Die Jahrringe verlaufen oft sehr eng und wellig.
        </div>`,
    "Eiche": `
        <p class="mb-2">Ringporiges Kernholz mit graugelbem bis gelbbraunem Kern. Das Holz ist hart, schwer und durch den hohen Gerbs√§uregehalt sehr witterungsbest√§ndig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Massivholzm√∂bel, Parkett, Fenster, Treppen, Wasserbau.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Charakteristische, breite Markstrahlen. Im Radialschnitt als gl√§nzende "Spiegel", im Tangentialschnitt als dunkle Linien erkennbar.
        </div>`,
    "Erle": `
        <p class="mb-2">Zerstreutporiges Splintholz. Frisch gef√§llt f√§rbt sich das Holz orangerot, getrocknet ist es r√∂tlich-wei√ü. Es ist weich, aber formstabil.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂belbau (oft als "Kirschbaum-Imitat" gebeizt), Modellbau. Unter Wasser extrem dauerhaft.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Oft treten Markflecken auf. Die "scheinbaren Markstrahlen" sind B√ºndelungen von feinen Strahlen.
        </div>`,
    "Esche": `
        <p class="mb-2">Ringporiges Laubholz. Splint und Kern sind meist gleichfarbig hell (Reifholz), im Alter oft mit fakultativem Braunkern. Z√§h, hart und elastisch.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Werkzeugstiele (Dynamische Belastung), Sportger√§te, Biegeformteile, Treppen.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Ringporig wie Eiche, jedoch <em>ohne</em> breite Markstrahlen. Deutliche Fladerung (tangential) bzw. Streifung (radial).
        </div>`,
    "Fichte": `
        <p class="mb-2">Reifholzbaum. Das Holz ist gelblich-wei√ü, weich und elastisch. Es ist das wichtigste Bau- und Konstruktionsholz in Europa.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Dachst√ºhle, Leimholz (BSH/KVH), Innenausbau, Papierherstellung.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Besitzt Harzkan√§le (Unterschied zur Tanne). Kleine, schwarze, fest verwachsene √Ñste sind typisch.
        </div>`,
    "Hemlock": `
        <p class="mb-2">Nordamerikanisches Nadelholz. Das Holz ist grau-braun, harzfrei und meist sehr astarm ("clears").</p>
        <p class="mb-2"><strong>Verwendung:</strong> Saunabau (wegen Harzfreiheit), Profilbretter, Innenausbau.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Erinnert optisch an Fichte, ist aber dunkler/grauer und besitzt <em>keine</em> Harzkan√§le.
        </div>`,
    "Hickory": `
        <p class="mb-2">Nordamerikanisches Hartholz aus der Familie der Walnussgew√§chse. Es gilt als das Holz mit der h√∂chsten Schlagbiegefestigkeit und Z√§higkeit.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Hochwertige Werkzeugstiele (Axt, Hammer), Sportger√§te (Baseballschl√§ger), Drumsticks.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Im Sp√§tholz sind feine, tangentiale Parenchymb√§nder (Speichergewebe) als helle Netzstruktur erkennbar.
        </div>`,
    "Kiefer": `
        <p class="mb-2">Kernholzbaum mit deutlichem Unterschied zwischen gelblich-wei√üem Splint und r√∂tlich-braunem Kern. Das Holz ist harzreich und mittelschwer.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Fensterbau, T√ºren, M√∂bel (Landhausstil), Dielenb√∂den, Konstruktionsholz.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Gro√üe, deutlich sichtbare Harzkan√§le im Querschnitt. Intensiver Harzgeruch. Astquirle.
        </div>`,
    "Kirschbaum": `
        <p class="mb-2">Mittelschweres, feinporiges Hartholz. Der Kern ist r√∂tlich-gelb bis rotbraun und dunkelt unter Lichteinfluss stark ("feurig") nach.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Hochwertiger M√∂belbau, Stilm√∂bel, Innenausbau, Drechslerei.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Die Markstrahlen sind im Querschnitt als helle, scharf begrenzte Linien sichtbar. Oft treten Gummigallen auf.
        </div>`,
    "L√§rche": `
        <p class="mb-2">Kernholzbaum mit r√∂tlich-braunem Kern und schmalem, gelblichem Splint. Das schwerste und h√§rteste heimische Nadelholz mit guter Witterungsbest√§ndigkeit.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Au√üenanwendungen, Fassadenschalung, Fenster, Dielen, Br√ºckenbau.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Sehr abrupten √úbergang von Fr√ºhholz (hell) zu Sp√§tholz (dunkel), dadurch markante Struktur. Kleine Harzkan√§le.
        </div>`,
    "Linde": `
        <p class="mb-2">Reifholzbaum mit wei√ülichem bis gelblichem Holz. Es ist weich, leicht und sehr homogen (zerstreutporig), aber wenig fest und nicht dauerhaft.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Bildhauerei, Schnitzerei, Modellbau, Blindholz.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Kaum sichtbare Jahresringe. L√§sst sich exzellent in alle Richtungen (auch quer zur Faser) schneiden/schnitzen.
        </div>`,
    "Mahagoni Amerikanisch": `
        <p class="mb-2">Tropisches Kernholz, rotbraun bis kupferfarben gl√§nzend. Es ist mittelschwer, gut zu bearbeiten und resistent gegen Pilze und Insekten.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Hochwertiger Innenausbau, Bootsbau, Luxusm√∂bel.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            H√§ufiger Wechseldrehwuchs, der auf der radialen Fl√§che den typischen "Glanzstreifen" erzeugt.
        </div>`,
    "Meranti (DR)": `
        <p class="mb-2">Sammelbegriff f√ºr Shorea-Arten (hier: Dark Red). Tropisches Laubholz, rotbraun, grobporig und in der Dichte stark schwankend.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Fensterbau (Standardholz der 80er/90er Jahre), Au√üent√ºren.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Gro√üe Poren. Im Querschnitt sind oft feine, tangential verlaufende wei√üe Linien (Gummiadern) gef√ºllt mit Harz sichtbar.
        </div>`,
    "Nussbaum (EU)": `
        <p class="mb-2">Halbringporiges Laubholz. Der Kern ist grau-braun bis schwarz-braun, oft unregelm√§√üig gestreift ("Farbkern"). Es gilt als eines der edelsten heimischen H√∂lzer.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Exklusive M√∂bel, Furniere, Gewehrsch√§fte, Musikinstrumente.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Halbringporig: Die Poren werden vom Fr√ºhholz zum Sp√§tholz hin allm√§hlich kleiner (kein scharfer Ring, aber auch nicht zerstreut).
        </div>`,
    "Palisander": `
        <p class="mb-2">Sammelbegriff f√ºr Dalbergia-Arten. Sehr hartes, schweres Tropenholz. Die Farbe variiert von violett bis dunkelbraun, oft mit charakteristischen schwarzen Farbstreifen.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Musikinstrumente (Marimba, Gitarren), Furniere, Drechseln.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Markante schwarze Streifen. Bearbeitetes Holz verstr√∂mt oft einen s√º√ülichen Geruch.
        </div>`,
    "Pappel": `
        <p class="mb-2">Das weichste und leichteste heimische Laubholz. Es ist wei√ülich-grau bis br√§unlich, sehr faserig und wenig fest.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Verpackungen, Sperrholz, Z√ºndh√∂lzer, Saunab√§nke (geringe W√§rmeleitf√§higkeit).</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Sehr "wollige" Oberfl√§che nach dem S√§gen. Schlechtes Stehverm√∂gen beim Trocknen.
        </div>`,
    "Platane": `
        <p class="mb-2">Zerstreutporiges Laubholz mit r√∂tlich-braunem Kern. Es ist m√§√üig hart und gut zu bearbeiten.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Furniere, Drechselarbeiten.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Besitzt sehr breite und hohe Markstrahlen. Im Radialschnitt entsteht dadurch eine auff√§llige Spiegelzeichnung ("Perlholz").
        </div>`,
    "Redwood": `
        <p class="mb-2">Holz des K√ºstenmammutbaums. Das Kernholz ist rotbraun, sehr leicht, weich und extrem dauerhaft, aber spr√∂de.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Au√üenfassaden, Schindeln, Gartenm√∂bel.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Nadelholz ohne Harzkan√§le. Sehr grobfaserige Struktur.
        </div>`,
    "Robinie": `
        <p class="mb-2">Ringporiges Kernholz mit gr√ºnlich-gelbem bis goldbraunem Kern. Es ist das einzige europ√§ische Holz der Dauerhaftigkeitsklasse 1-2 (sehr dauerhaft).</p>
        <p class="mb-2"><strong>Verwendung:</strong> Spielplatzger√§te, Gartenm√∂bel, Pf√§hle (Ersatz f√ºr Tropenholz).</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Die gro√üen Fr√ºhholzporen sind im Kernholz vollst√§ndig mit Thyllen (glitzernde Verschl√ºsse) verstopft.
        </div>`,
    "Rosskastanie": `
        <p class="mb-2">Zerstreutporiges Reifholz, wei√ülich bis gelblich. Es ist weich, leicht und wenig dauerhaft. Neigt zum Stocken (Verf√§rben).</p>
        <p class="mb-2"><strong>Verwendung:</strong> Blindholz, Schnitzerei, Kisten, Drechseln.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Besitzt extrem feine, stockwerkartige Markstrahlen, die auf der Tangentialfl√§che eine feine "Rippelung" (Ripple marks) erzeugen k√∂nnen.
        </div>`,
    "Rotbuche": `
        <p class="mb-2">Zerstreutporiges Holz, blassgelb bis r√∂tlich-wei√ü. Durch D√§mpfen wird es intensiv rot. Hart, abriebfest, aber stark schwindend ("nerv√∂ses" Holz).</p>
        <p class="mb-2"><strong>Verwendung:</strong> St√ºhle (Bugholz), M√∂belgestelle, Werkbankplatten, Parkett.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Markstrahlen im Tangentialschnitt als dunkle Spindeln ("Reiskerne") sichtbar. √Ñltere B√§ume bilden oft einen rotbraunen Wolkenkern.
        </div>`,
    "R√ºster": `
        <p class="mb-2">Handelsname f√ºr das Holz der Ulme. Ringporig mit schokobraunem Kern. Z√§h, sto√üfest und dekorativ.</p>
        <p class="mb-2"><strong>Verwendung:</strong> M√∂belbau, Furniere, Treppen, Sportger√§te.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Im Sp√§tholz sind die feinen Poren zu wellenf√∂rmigen, tangentialen B√§ndern ("Ulmen-Wellen") angeordnet.
        </div>`,
    "Tanne": `
        <p class="mb-2">Reifholzbaum. Das Holz ist grau-wei√ü bis gelblich-wei√ü (kein Farbkern). Es √§hnelt der Fichte, ist jedoch harzfrei.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Konstruktionsholz, Fenster, Innenausbau (dunkelt weniger nach als Fichte).</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            <em>Keine</em> Harzkan√§le. Oft "Nasskern" (sehr feuchter Kernbereich).
        </div>`,
    "Teak": `
        <p class="mb-2">Tropisches, ringporiges Kernholz. Goldbraun, sp√§ter mittel- bis dunkelbraun. Enth√§lt Kautschuk und √ñle, daher extrem witterungsbest√§ndig und dimensionsstabil.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Schiffsdecks, hochwertige Gartenm√∂bel, Furniere.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            "Wachsiger" Griff und Geruch nach altem Leder.
        </div>`,
    "Weng√©": `
        <p class="mb-2">Afrikanisches Laubholz. Der Kern ist kaffeebraun bis schwarz mit hellen Strukturlinien. Sehr hart, schwer und splitterig.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Exklusive Bodenbel√§ge, M√∂bel, Intarsien.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            "Rebhuhn-Muster" auf der Tangentialfl√§che durch breite Parenchymb√§nder (Speichergewebe).
        </div>`,
    "Zebrano": `
        <p class="mb-2">Westafrikanisches Laubholz. Grundfarbe grau-gelb mit markanten, regelm√§√üigen dunkelbraunen Streifen.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Furniere, Armaturenbretter, Ziergegenst√§nde.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Unverwechselbare Zebra-Optik. Streng radialer Faserverlauf. Unangenehmer Geruch bei der Bearbeitung.
        </div>`,
    "Zeder": `
        <p class="mb-2">Handelsname, meist f√ºr "Western Red Cedar" (Riesenlebensbaum). Weiches, leichtes und sehr dauerhaftes Nadelholz mit rotbraunem Kern.</p>
        <p class="mb-2"><strong>Verwendung:</strong> Zigarrenkisten, Mottenkugeln, Fassaden, Schindeln.</p>
        <div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">
            <strong>üîç Fachliches Merkmal:</strong><br>
            Intensiver, aromatischer Geruch ("Bleistift-Geruch"). Harzfrei.
        </div>`
};

const reflectionQuestions=[ "Welches Holz w√ºrdest du f√ºr Gartenm√∂bel w√§hlen und warum?", "Eine K√ºchenarbeitsplatte muss schnittfest sein. Welches Holz eignet sich?", "F√ºr einen Dielenboden: Hartes oder weiches Holz?", "Warum ist Teak im Schiffbau so beliebt?" ];

// 7. QUIZ FRAGEN (F√úR DAS STECHEN)
const quizQuestions = [
    {q:"Welche der folgenden Holzarten z√§hlt zu den Nadelh√∂lzern?", o:["Buche","Eiche","Fichte","Esche"], c:2},
    {q:"Welche Holzart besitzt eine geringe Rohdichte und wird h√§ufig im Leichtbau eingesetzt?", o:["Pappel","Eiche","Robinie","Buche"], c:0},
    {q:"Welche Holzart ist f√ºr ihre hohe nat√ºrliche Dauerhaftigkeit bekannt?", o:["Fichte","Robinie","Birke","Ahorn"], c:1},
    {q:"Welche Holzart ist aufgrund ihrer nat√ºrlichen Dauerhaftigkeit besonders f√ºr den unbehandelten Au√üenbereich geeignet?", o:["Buche","Teak","Pappel","Linde"], c:1},
    {q:"Welche Holzart wird im konstruktiven Holzbau h√§ufig f√ºr Dachst√ºhle verwendet?", o:["Fichte","Nussbaum","Kirschbaum","Mahagoni"], c:0},
    {q:"Welche Holzart weist typischerweise eine r√∂tlich-braune Kernholzfarbe auf?", o:["Ahorn","Kirsche","Fichte","Birke"], c:1},
    {q:"Welche Holzart besitzt eine hohe H√§rte und wird h√§ufig f√ºr stark beanspruchte Bauteile verwendet?", o:["Balsa","Pappel","Eiche","Linde"], c:2},
    {q:"Welche Holzart ist ein typisches M√∂belholz im Innenausbau?", o:["Buche","Weide","Tanne","Pappel"], c:0},
    {q:"Welche Holzart zeichnet sich durch ein besonders schnelles Wachstum aus?", o:["Eiche","Buche","Pappel","Nussbaum"], c:2},
    {q:"Welche Holzart wird aufgrund ihrer Formstabilit√§t und Festigkeit h√§ufig f√ºr Gitarrenh√§lse verwendet?", o:["Ahorn","Fichte","Pappel","Weide"], c:0},
    {q:"Welche der folgenden Holzarten z√§hlt zu den Laubh√∂lzern?", o:["Kiefer","L√§rche","Buche","Fichte"], c:2},
    {q:"Welche Holzart gilt als besonders witterungsbest√§ndig durch nat√ºrliche Inhaltsstoffe?", o:["Fichte","Teak","Birke","Ahorn"], c:1},
    {q:"Welche Holzart besitzt h√§ufig eine sehr helle, nahezu wei√üe Holzfarbe?", o:["Linde","Ahorn","Kirsche","Nussbaum"], c:1},
    {q:"Welche Holzart wird besonders h√§ufig f√ºr Parkettb√∂den verwendet?", o:["Eiche","Pappel","Fichte","Tanne"], c:0},
    {q:"Welche Holzart z√§hlt zu den tropischen Handelsh√∂lzern?", o:["Buche","Teak","Eiche","L√§rche"], c:1},
    {q:"Welche Holzart besitzt eine hohe Elastizit√§t und wird traditionell f√ºr Sportger√§te verwendet?", o:["Esche","Fichte","Birke","Linde"], c:0},
    {q:"Welche Holzart wird h√§ufig zur Herstellung von Sperrholz verwendet?", o:["Pappel","Robinie","Eiche","Wenge"], c:0},
    {q:"Welche Holzart ist f√ºr ihre sehr dunkle, fast schwarze Farbe bekannt?", o:["Ahorn","Ebenholz","Birke","Fichte"], c:1},
    {q:"Welche Holzart wird aufgrund ihres angenehmen Geruchs und ihrer Feuchteresistenz im Saunabau eingesetzt?", o:["Fichte","Zeder","Eiche","Buche"], c:1},
    {q:"Welche Holzart weist im Vergleich ein geringes Schwindma√ü auf und gilt als relativ formstabil?", o:["Buche","Teak","Pappel","Weide"], c:1},
    {q:"Welche Holzart ist ein typisches europ√§isches Konstruktionsholz?", o:["Fichte","Mahagoni","Kirschbaum","Nussbaum"], c:0},
    {q:"Welche Holzart besitzt eine besonders kontrastreiche und dekorative Maserung?", o:["Linde","Wenge","Pappel","Birke"], c:1},
    {q:"Welche Holzart wird aufgrund ihrer Weichheit h√§ufig f√ºr Schnitzarbeiten verwendet?", o:["Linde","Eiche","Buche","Robinie"], c:0},
    {q:"Welche Holzart besitzt deutlich ausgepr√§gte Harzkan√§le?", o:["Buche","Fichte","Kiefer","Ahorn"], c:2},
    {q:"Welche Holzart besitzt eine hohe Rohdichte und z√§hlt zu den schweren europ√§ischen H√∂lzern?", o:["Balsa","Pappel","Robinie","Linde"], c:2},
    {q:"Was beschreibt die Rohdichte von Holz?", o:["H√§rte","Masse pro Volumen","Wasseraufnahme","Elastizit√§t"], c:1},
    {q:"In welcher Richtung schwindet und quillt Holz am st√§rksten?", o:["L√§ngs","Radial","Tangential","Gleichm√§√üig"], c:2},
    {q:"Was bedeutet Dauerhaftigkeitsklasse 1 nach DIN EN 350?", o:["Nicht dauerhaft","Sehr dauerhaft","Schwer entflammbar","Besonders elastisch"], c:1},
    {q:"Welche Holzart zeigt ein hohes Quell- und Schwindma√ü?", o:["Teak","Buche","Robinie","Mahagoni"], c:1},
    {q:"Was ist Splintholz?", o:["√Ñltester Teil des Stammes","Innerer Kern","√Ñu√üerer, j√ºngerer Bereich","Rinde"], c:2},
    {q:"Welche Holzart besitzt eine hohe nat√ºrliche Resistenz gegen√ºber holzzerst√∂renden Pilzen?", o:["Fichte","Robinie","Birke","Ahorn"], c:1},
    {q:"Wof√ºr steht das ‚ÄûE-Modul‚Äú bei Holz?", o:["Dichte","Elastizit√§tsmodul","Energiegehalt","Emissionswert"], c:1},
    {q:"Welche der folgenden Holzarten ist ringporig?", o:["Buche","Ahorn","Eiche","Birke"], c:2},
    {q:"Was sind Jahrringe im Holzquerschnitt?", o:["Wurzelreste","Jahreszuw√§chse des Baumes","Harzadern","Pilzspuren"], c:1},
    {q:"Welche Gr√∂√üe beeinflusst das Schwinden und Quellen von Holz ma√ügeblich?", o:["Temperatur","√Ñnderung der Holzfeuchte","UV-Strahlung","Wind"], c:1},
    {q:"Welche Holzart ist zerstreutporig?", o:["Esche","Eiche","Buche","Ulme"], c:2},
    {q:"Welche Ma√ünahme erh√∂ht die Dauerhaftigkeit von Holz im Au√üenbereich am st√§rksten?", o:["Lackieren","Impr√§gnieren","Hobeln","Schleifen"], c:1},
    {q:"Welche Eigenschaft beschreibt die Biegefestigkeit eines Holzes?", o:["Widerstand gegen Druck","Widerstand gegen Zug","Widerstand gegen Biegung","Widerstand gegen Feuchte"], c:2},
    {q:"Was versteht man unter Kernholz?", o:["J√ºngstes Holz","√Ñu√üerstes Holz","Inneres, √§lteres Holz","Wurzelholz"], c:2},
    {q:"Welche Holzart ist besonders resistent gegen√ºber Insektenbefall?", o:["Pappel","Robinie","Birke","Fichte"], c:1},
    {q:"In welcher Richtung weist Holz die h√∂chste Festigkeit auf?", o:["Tangential","Radial","L√§ngs zur Faser","Gleich in alle Richtungen"], c:2},
    {q:"Warum ist dauerhaft stehende Feuchtigkeit f√ºr Holz besonders sch√§dlich?", o:["Sie k√ºhlt das Holz","Sie erh√∂ht die Dichte","Sie f√∂rdert Pilzbefall","Sie h√§rtet das Holz"], c:2},
    {q:"Was ist die Hauptursache f√ºr Verzug bei Holzbauteilen?", o:["UV-Strahlung","Ungleichm√§√üiges Schwinden","Hohe Dichte","Druckbelastung"], c:1},
    {q:"Welche Eigenschaft macht Teak besonders dauerhaft?", o:["Hohe Dichte","Hoher Harzanteil","√ñlige Inhaltsstoffe","Gro√üe Poren"], c:2},
    {q:"Was beschreibt die tangentiale Richtung im Holz?", o:["Entlang der Fasern","Vom Kern nach au√üen","Entlang der Jahrringe","Quer zur Stammachse"], c:2},
    {q:"Bei welcher Holzart ist der Unterschied zwischen Fr√ºh- und Sp√§tholz besonders deutlich sichtbar?", o:["Ahorn","Fichte","Kiefer","Birke"], c:2},
    {q:"Warum ist Kernholz meist dauerhafter als Splintholz?", o:["Es ist feuchter","Es enth√§lt mehr N√§hrstoffe","Es enth√§lt sch√ºtzende Inhaltsstoffe","Es ist heller"], c:2},
    {q:"Welcher Organismus zerst√∂rt Holz bei ausreichender Feuchte am schnellsten?", o:["Bakterien","Algen","Pilze","Moose"], c:2},
    {q:"Welche Holzart besitzt eine sehr hohe nat√ºrliche Dauerhaftigkeit und wird im Au√üenbau gesch√§tzt?", o:["Buche","Robinie","Fichte","Birke"], c:1},
    {q:"Welche Materialeigenschaft ist f√ºr tragende Holzbauteile besonders entscheidend?", o:["Farbe","Maserung","Festigkeit","Geruch"], c:2}
];

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

function showHappyWorm() {
    const k = document.getElementById('happyKlotzi');
    const t = document.getElementById('happyKlotziText');
    if(!k) return;

    // Zuf√§lliger Jubel-Spruch
    const cheers = ["Stark!", "Super!", "Punkt f√ºr uns!", "Weiter so!", "Yeah!", "Klasse!", "Meisterhaft!", "Astrein!", "Jawoll!"];
    if(t) t.childNodes[0].nodeValue = cheers[Math.floor(Math.random() * cheers.length)]; // Text √§ndern, Dreiecke behalten

    k.classList.remove('hidden', 'translate-y-full'); // Reinschieben
    k.querySelector('img').classList.add('animate-klotzi-popup'); // Wurm animieren
    
    // Nach 2.5s wieder rausschieben
    setTimeout(() => {
        k.classList.add('translate-y-full');
        k.querySelector('img').classList.remove('animate-klotzi-popup');
    }, 2500);
    
    // Nach 3s ganz verstecken
    setTimeout(() => k.classList.add('hidden'), 3000);
}

function triggerConfetti() {
    var duration = 3000; var end = Date.now() + duration;
    (function frame() {
        confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
        confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
        if (Date.now() < end) requestAnimationFrame(frame);
    }());
}

window.openAttrConfig = () => {
    document.getElementById('setupModal').classList.add('hidden'); // Hauptmen√º verstecken
    const list = document.getElementById('attrConfigList');
    list.innerHTML = '';
    Object.keys(attributeInfo).forEach(key => {
        const info = attributeInfo[key];
        const isSelected = activeAttributeKeys.includes(key);
        const div = document.createElement('div');
        div.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
        div.onclick = () => toggleAttribute(key, div);
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-xl">${info.icon}</span>
                <div class="text-left leading-tight">
                    <div class="font-bold text-sm">${info.name}</div>
                    <div class="text-[10px] opacity-70">${info.unit}</div>
                </div>
            </div>
            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}">
                ${isSelected ? '‚úì' : ''}
            </div>`;
        list.appendChild(div);
    });
    document.getElementById('attrConfigModal').classList.remove('hidden'); // Optionen anzeigen
};

window.closeAttrConfig = () => {
    document.getElementById('attrConfigModal').classList.add('hidden'); // Optionen verstecken
    document.getElementById('setupModal').classList.remove('hidden'); // Hauptmen√º wieder anzeigen
}

function toggleAttribute(key, el) {
    const idx = activeAttributeKeys.indexOf(key);
    if (idx > -1) {
        if(activeAttributeKeys.length <= 3) { alert("Mindestens 3 Eigenschaften m√ºssen aktiv sein!"); return; }
        activeAttributeKeys.splice(idx, 1);
    } else {
        if(activeAttributeKeys.length >= 5) { return; } 
        activeAttributeKeys.push(key);
    }
    const isSelected = activeAttributeKeys.includes(key);
    el.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
    el.querySelector('.w-6').className = `w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}`;
    el.querySelector('.w-6').innerHTML = isSelected ? '‚úì' : '';
    document.getElementById('attrCountBadge').innerText = activeAttributeKeys.length;
}

function updateStatusBar(p, o){
    const total=p+o; const pct=(total===0)?50:(p/total)*100;
    const bar=document.getElementById('statusBar'); const ball=document.getElementById('statusBall');
    bar.style.width=`${pct}%`; ball.style.left=`${pct}%`;
}

function createCard(data, isRevealed, isPlayer, isActive, highlightAttr){
    const card = document.createElement('div');
    card.className = `card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''}`;
    if(!isRevealed) card.classList.add('card-flipped');
    if(isPlayer) { card.setAttribute('role', 'button'); card.setAttribute('tabindex', '0'); }

    const canSelect = isPlayer && ((gameMode==='ai' && aiGame.turn==='player' && !aiGame.roundInProgress) || (gameMode==='multiplayer' && localGameState.turn===localPlayerId && !localGameState.lastResult));
    
    const front = document.createElement('div');
    const bClass = isActive ? 'border-orange-500 ring-4 ring-orange-200' : 'border-orange-200';
    front.className = `card-front card-front-bg rounded-2xl shadow-lg border-4 ${bClass} flex flex-col transition-all`;
    let html = `<div class="pt-3 px-3 pb-1"><h2 class="text-lg sm:text-xl font-bold text-amber-900 leading-none">${data.name}</h2></div>
                <div class="mx-3 mt-1 mb-2 aspect-[4/3] rounded-xl overflow-hidden bg-white shadow-sm border border-orange-100">
                    <img src="${data.imgTree}" class="w-full h-full object-cover">
                </div>
                <div class="flex-grow flex flex-col justify-start gap-1 sm:gap-2 px-2 pb-2 overflow-y-auto hide-scrollbar">`;
    
    for(const k of activeAttributeKeys){
        const info = attributeInfo[k];
        let flashClass = '';
        if(highlightAttr === k) flashClass = isActive ? 'flash-active' : 'highlight-compare';
        
        const rowInner = `<div class="flex items-center gap-2"><span class="text-base">${info.icon}</span><div class="flex flex-col text-left leading-none"><span class="font-bold text-gray-800 text-[10px] sm:text-sm">${info.name}</span><span class="text-[9px] text-gray-500 font-medium">${info.unit}</span></div></div><span class="text-sm font-bold text-amber-800">${data[k]}</span>`;
        if(canSelect) html += `<div onclick="window.selectAttribute('${k}')" data-attr-btn="${k}" class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl cursor-pointer hover:brightness-95 ${flashClass}">${rowInner}</div>`;
        else html += `<div class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl opacity-90 ${flashClass}" data-attr-row="${k}">${rowInner}</div>`;
    }
    html += '</div>';
    front.innerHTML = html;

    const back = document.createElement('div');
    back.className = `card-back rounded-2xl shadow-lg relative ${isActive ? 'border-orange-500' : 'border-white'}`;
    if(!isPlayer && isOpponentNameBackVisible()){
        const lbl = document.createElement('div'); lbl.className = 'opponent-back-name'; lbl.innerText = data.name; back.appendChild(lbl);
    }
    card.appendChild(front); card.appendChild(back);
    return card;
}

function updateDisplayAI(){
    const pc=aiGame.playerCards.length; const ac=aiGame.aiCards.length;
    document.getElementById('playerCards').innerText=pc; document.getElementById('aiCards').innerText=ac;
    updateStatusBar(pc,ac);
    const pcEl=document.getElementById('playerCard'); pcEl.innerHTML='';
    const acEl=document.getElementById('aiCard'); acEl.innerHTML='';
    const isPTurn = aiGame.turn === 'player';
    
    if(aiGame.currentPlayerCard) pcEl.appendChild(createCard(aiGame.currentPlayerCard, true, true, isPTurn, null));
    if(aiGame.currentAiCard) acEl.appendChild(createCard(aiGame.currentAiCard, false, false, !isPTurn, null));
    
    if(aiGame.turn==='ai' && !aiGame.roundInProgress) setTimeout(aiTurn, 1000);
}

function getNumericValue(val, attr) {
    if (attr === 'dk') {
        if (typeof val === 'string' && val.includes('-')) {
            const parts = val.split('-');
            const v1 = parseFloat(parts[0]);
            const v2 = parseFloat(parts[1]);
            return (v1 + v2) / 2;
        }
        return parseFloat(val);
    }
    return parseFloat(val);
}

// 8. NEUE FUNKTION: DAS QUIZ STARTEN (F√úR BEIDE SPIELER)
let quizTimerInterval;
function startTieBreakerQuiz(qIndex, callback) {
    const modal = document.getElementById('quizModal');
    const timerBar = document.getElementById('quizTimerBar');
    const qText = document.getElementById('quizQuestion');
    const qOptions = document.getElementById('quizOptions');
    const statusText = document.getElementById('quizStatusText');
    
    const question = quizQuestions[qIndex];
    
    qText.innerText = question.q;
    qOptions.innerHTML = '';
    statusText.innerText = "‚ö†Ô∏è Gleichstand! Quiz l√§dt...";
    
    // 1. Reset Bar (Start state)
    // Remove all animations and set initial style
    timerBar.classList.remove('animate-charge', 'animate-shrink');
    timerBar.style.width = "0%";
    timerBar.className = "h-full bg-amber-500 rounded-r-sm relative";
    
    // Force Reflow
    void timerBar.offsetWidth;
    
    // Buttons erstellen (aber deaktiviert)
    let buttons = [];
    question.o.forEach((opt, idx) => {
        const btn = document.createElement('button');
        // Initial state: Disabled, but maintaining border
        btn.className = "w-full bg-gray-100 text-gray-400 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 cursor-not-allowed";
        btn.innerText = opt;
        btn.disabled = true; 
        buttons.push({btn, idx});
        qOptions.appendChild(btn);
    });
    
    modal.classList.remove('hidden');
    
    // 2. Start Charging Animation (1.5s)
    timerBar.classList.add('animate-charge');
    
    // 3. Nach 1.5s: Quiz Start
    setTimeout(() => {
        statusText.innerText = "‚ö° STECHEN! 10 Sekunden Zeit";
        
        // Bar auf "Voll & Rot" setzen f√ºr Entladung
        timerBar.classList.remove('animate-charge');
        timerBar.style.width = '100%'; // Ensure full width before shrinking
        void timerBar.offsetWidth; // Force Reflow
        timerBar.className = "h-full bg-red-500 rounded-r-sm relative animate-shrink"; // Start discharging
        
        playSound(sounds.quizTick);
        
        // Buttons aktivieren
        let answered = false;
        buttons.forEach(obj => {
            const {btn, idx} = obj;
            // Active state: Enabled, maintaining border and adding hover effects
            btn.className = "w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 transition active:scale-95 cursor-pointer";
            btn.disabled = false;
            
            btn.onclick = () => {
                if(answered) return;
                answered = true;
                clearTimeout(quizTimeout);
                sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
                
                if(idx === question.c) {
                    btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-green-600 shadow-lg scale-105";
                    playSound(sounds.win);
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        callback('correct');
                    }, 1000); // 1s Zeit zum Freuen
                } else {
                    btn.className = "w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-red-600 shadow-md transform scale-95 opacity-50";
                    
                    // NEU: Richtige Antwort finden und gr√ºn f√§rben
                    const correctBtnObj = buttons.find(b => b.idx === question.c);
                    if(correctBtnObj) {
                        correctBtnObj.btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-green-600 shadow-lg scale-105 animate-pulse";
                    }

                    setTimeout(() => {
                        modal.classList.add('hidden');
                        callback('wrong');
                    }, 1500); // 1.5s Zeit zum Lernen
                }
            };
        });
        
        // 10 Sekunden Timer (Discharging)
        const quizTimeout = setTimeout(() => {
            if(!answered) {
                answered = true;
                sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
                modal.classList.add('hidden');
                callback('timeout');
            }
        }, 10000);
        
    }, 1500);
}

// Zeigt das "GLEICHSTAND" Overlay f√ºr 2 Sekunden
function showTieOverlay(callback) {
    const overlay = document.getElementById('tieOverlay');
    overlay.classList.remove('hidden');
    playSound(sounds.tieAlert);
    setTimeout(() => {
        overlay.classList.add('hidden');
        if(callback) callback();
    }, 2000);
}

function evaluateRoundAI(attr){
    const rawPv = aiGame.currentPlayerCard[attr];
    const rawAv = aiGame.currentAiCard[attr];
    const pv = getNumericValue(rawPv, attr);
    const av = getNumericValue(rawAv, attr);
    const logic = attributeInfo[attr].logic;
    
    let pWins = (logic === 'Niedrig gewinnt') ? (pv < av) : (pv > av);
    
    // STECHEN IM SINGLEPLAYER
    if(pv === av) {
        showTieOverlay(() => {
            // Starte Quiz NACH dem Overlay
            const qIdx = Math.floor(Math.random() * quizQuestions.length);
            startTieBreakerQuiz(qIdx, (result) => {
                let roundWinner = false;
                if(result === 'correct') roundWinner = true;
                // If wrong or timeout -> PC wins (in Singleplayer logic)
                finishRoundAI(attr, rawPv, rawAv, roundWinner);
            });
        });
        return;
    }
    
    finishRoundAI(attr, rawPv, rawAv, pWins);
}

function finishRoundAI(attr, rawPv, rawAv, pWins) {
    const resText = pWins===true ? 'Du gewinnst!' : 'Computer gewinnt!';
    const resColor = pWins===true ? 'text-green-600' : 'text-red-600';
    
    document.getElementById('resultText').innerText = resText;
    document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
    document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${rawPv} vs ${rawAv}`;
    
    if(pWins===true) { playSound(sounds.win); showHappyWorm(); lastRoundWinningWoodName = aiGame.currentPlayerCard.name; } 
    else { lastRoundWinningWoodName = aiGame.currentAiCard.name; }
    
    openBottomSheet(resText);
    const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
    if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
    else { aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }

    if(aiGame.playerCards.length===0) window.endGame("Computer");
    if(aiGame.aiCards.length===0) window.endGame(aiGame.playerName);
}

function aiTurn(){
    if(aiGame.roundInProgress) return;
    scrollToTop();
    const k=activeAttributeKeys[Math.floor(Math.random()*activeAttributeKeys.length)];
    aiGame.roundInProgress = true;
    const aiCardEl = document.getElementById('aiCard');
    const row = aiCardEl.querySelector(`div[data-attr-row="${k}"]`);
    if(row) row.classList.add('flash-active'); 
    setTimeout(() => { 
        const ac=document.getElementById('aiCard').querySelector('.card-3d');
        if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
        const playerCardEl = document.getElementById('playerCard');
        const pRow = playerCardEl.querySelector(`div[data-attr-btn="${k}"]`) || playerCardEl.querySelector(`div[data-attr-row="${k}"]`);
        if(pRow) pRow.classList.add('highlight-compare');
        setTimeout(() => evaluateRoundAI(k), 2000);
    }, 500);
}

function listenToGameChanges(){
    if(!gameId) return;
    unsubscribeGame=onSnapshot(getPublicDataRef("games", gameId),(ds)=>{
        if(!ds.exists()) { window.resetGame(); return; }
        const gd=ds.data(); localGameState=gd;

        // SYNC ACTIVE ATTRIBUTES FROM HOST
        if(gd.activeAttributes) {
            activeAttributeKeys = gd.activeAttributes;
        }
        
        // CHECK F√úR MULTIPLAYER QUIZ
        // Wenn ein Quiz getriggert wurde und wir es noch nicht gemacht haben
        if(gd.quizTrigger && gd.quizTrigger.active && !document.getElementById('quizModal').dataset.active) {
             document.getElementById('quizModal').dataset.active = "true"; // Mark as open
             
             // ZEIGE ERST GLEICHSTAND OVERLAY, DANN QUIZ
             showTieOverlay(() => {
                 // Starte Quiz f√ºr BEIDE Spieler
                 startTieBreakerQuiz(gd.quizTrigger.qIndex, async (result) => {
                     document.getElementById('quizModal').dataset.active = ""; // Reset
                     
                     const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
                     let winner = 'tie'; // Default to tie (timeout)

                     if (result === 'correct') {
                         winner = localPlayerId;
                     } else if (result === 'wrong') {
                         winner = opp;
                     } 
                     // if result === 'timeout', winner remains 'tie'

                     // Hole aktuelle Werte f√ºr Resultat
                     const rawPv = localGameState.currentCards[localPlayerId][gd.quizTrigger.attr];
                     const rawOv = localGameState.currentCards[opp][gd.quizTrigger.attr];
                     
                     // Schreibe Resultat in DB (der Schnellste gewinnt den Write)
                     await updateDoc(getPublicDataRef("games", gameId),{
                        quizTrigger: null, // Quiz beenden
                        lastResult: {winnerId:winner, attribute:gd.quizTrigger.attr, values:{[localPlayerId]:rawPv, [opp]:rawOv}}
                     });
                 });
             });
        }
        
        // Wenn das Quiz vorbei ist (durch DB Update), Fenster schlie√üen falls noch offen
        if((!gd.quizTrigger || !gd.quizTrigger.active) && document.getElementById('quizModal').classList.contains('hidden') === false) {
             document.getElementById('quizModal').classList.add('hidden');
             document.getElementById('quizModal').dataset.active = "";
             sounds.quizTick.pause(); sounds.quizTick.currentTime = 0; // Sound sicherheitshalber stoppen
        }

        if(gd.status==='playing'||gd.status==='finished'){
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            // Show rule button in Multiplayer mode
            document.getElementById('ruleButton').classList.remove('hidden');
            
            if(!gd.quizTrigger) scrollToTop(); // Nur scrollen wenn kein Quiz l√§uft
            
            const oppId=gd.playerIds.find(id=>id!==localPlayerId);
            document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
            document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
            const pCount = gd.players[localPlayerId]?.cards?.length||0;
            const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
            document.getElementById('playerCards').innerText = pCount;
            document.getElementById('aiCards').innerText = oCount;
            updateStatusBar(pCount, oCount);
            
            const highlightAttr = gd.lastResult ? gd.lastResult.attribute : null;

            const pc = document.getElementById('playerCard'); const ac = document.getElementById('aiCard');
            pc.innerHTML=''; ac.innerHTML='';
            const isPlayerTurn = gd.turn === localPlayerId;
            if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true, isPlayerTurn, highlightAttr));
            
            if(oppId && gd.currentCards[oppId]){
                const c = createCard(gd.currentCards[oppId], false, false, !isPlayerTurn, highlightAttr);
                ac.appendChild(c);
                if(gd.lastResult){
                    setTimeout(()=> { c.classList.remove('card-flipped'); playSound(sounds.flip); }, 100);
                }
            } else {
                ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte auf Gegner-Karte...</div>`;
            }
            
            if(gd.lastResult){
                 const wId = gd.lastResult.winnerId;
                 const iWin = wId===localPlayerId;
                 
                 if(gd.currentCards[wId]) {
                     lastRoundWinningWoodName = gd.currentCards[wId].name;
                 }

                 if(!roundSoundPlayed && iWin) playSound(sounds.win);
                 roundSoundPlayed=true;
                 
                 const resText = iWin ? 'Du gewinnst!' : (wId==='tie'?'Unentschieden':'Gegner gewinnt!');
                 document.getElementById('resultText').className = iWin ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
                 document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
                 if(iWin) showHappyWorm();
                 if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(resText);
            } else {
                 roundSoundPlayed=false; closeBottomSheet();
            }
            document.getElementById('turnIndicator').innerText = (gd.turn===localPlayerId) ? "Du bist am Zug!" : "Gegner w√§hlt...";
            if(gd.status==='finished'){
                let winnerName = "";
                if (gd.players[localPlayerId].cards.length > 0) winnerName = gd.players[localPlayerId].name;
                else if (oppId && gd.players[oppId].cards.length > 0) winnerName = gd.players[oppId].name;
                window.endGame(winnerName);
            }
        }
    });
}

window.selectAttribute = async (attr) => {
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        scrollToTop();
        aiGame.roundInProgress = true;
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`); if(btn) btn.classList.add('flash-active');
        setTimeout(() => {
            const ac=document.getElementById('aiCard').querySelector('.card-3d');
            if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
            const oppRow = document.getElementById('aiCard').querySelector(`div[data-attr-row="${attr}"]`);
            if(oppRow) oppRow.classList.add('highlight-compare');
            setTimeout(() => evaluateRoundAI(attr), 2000);
        }, 500);
    } else {
        if(!localGameState || localGameState.turn!==localPlayerId) return;
        scrollToTop();
        const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
        
        const rawPv = localGameState.currentCards[localPlayerId][attr];
        const rawOv = localGameState.currentCards[opp][attr];
        const pv = getNumericValue(rawPv, attr);
        const ov = getNumericValue(rawOv, attr);
        
        const logic = attributeInfo[attr].logic;
        let pWins = (logic === 'Niedrig gewinnt') ? (pv < ov) : (pv > ov);
        
        // STECHEN IM MULTIPLAYER
        if(pv === ov) {
            // Starte Quiz f√ºr BEIDE Spieler durch Datenbank-Eintrag
            // SOFORTIGES Update ohne Timeout f√ºr besseres Feeling
            const qIdx = Math.floor(Math.random() * quizQuestions.length);
            await updateDoc(getPublicDataRef("games", gameId),{
                quizTrigger: {
                    active: true,
                    attr: attr,
                    qIndex: qIdx,
                    timestamp: Date.now() // Erzwingt Update
                }
            });
            return; 
        }
        
        const winner = pWins ? localPlayerId : opp;
        await updateDoc(getPublicDataRef("games", gameId),{
            lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:rawPv, [opp]:rawOv}}
        });
    }
};

window.startGameAI = (name) => {
    trackEvent('games_ai');
    gameMode='ai'; aiGame.playerName=name;
    window.setNavState('game');
    // Show rule button in AI mode
    document.getElementById('ruleButton').classList.remove('hidden');
    document.getElementById('playerNameDisplay').innerText=name;
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
    document.getElementById('gameContainer').classList.remove('hidden');
    scrollToTop();
    updateDisplayAI();
};

let authRetries = 0;
window.createGame = async (playerName) => {
    if (!auth || !auth.currentUser) { 
        if(authRetries > 10) { alert("Verbindungsfehler"); return; }
        authRetries++; setTimeout(() => window.createGame(playerName), 500); return; 
    }
    localPlayerId = auth.currentUser.uid;
    trackEvent('games_multiplayer');
    gameMode='multiplayer';
    const lobby=document.getElementById('multiplayerLobbyModal'); lobby.classList.remove('hidden');
    gameId=Math.random().toString(36).substring(2,8).toUpperCase();
    const joinUrl=`${window.location.href.split('?')[0]}?game=${gameId}`;
    document.getElementById('shareLink').value=joinUrl;
    
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {text: joinUrl, width: 128, height: 128});
    
    // --- CHANGE: SAVE activeAttributes to Firestore ---
    await setDoc(getPublicDataRef("games", gameId),{
        gameId, status:'waiting', playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
        activeAttributes: activeAttributeKeys, // SAVE CONFIG HERE
        createdAt:serverTimestamp()
    });
    listenToGameChanges();
};

window.joinGame = async (id, playerName) => {
    if (!auth || !auth.currentUser) { setTimeout(()=>window.joinGame(id,playerName), 500); return; }
    localPlayerId = auth.currentUser.uid;
    gameMode='multiplayer'; gameId = id;
    const ref = getPublicDataRef("games", id);
    const snap = await getDoc(ref);
    if(snap.exists() && snap.data().status==='waiting'){
        document.getElementById('lobbyTitle').textContent="Verbinde...";
        document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
        const sh=shuffleArray([...woodCards]);
        const p1=snap.data().playerIds[0];
        
        await updateDoc(ref,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:sh.slice(15,30),status:'online'},
            [`players.${p1}.cards`]:sh.slice(0,15),
            turn:p1, currentCards:{[p1]:sh.slice(0,15)[0],[localPlayerId]:sh.slice(15,30)[0]},
            lastResult:null
        });
        scrollToTop();
        window.setNavState('game');
        listenToGameChanges();
    } else {
        alert("Spiel nicht gefunden oder voll.");
        window.location.href = window.location.href.split('?')[0];
    }
};

window.nextRound = async () => {
    scrollToTop();
    if(gameMode==='ai'){
        aiGame.currentPlayerCard=aiGame.playerCards[0];
        aiGame.currentAiCard=aiGame.aiCards[0];
        aiGame.roundInProgress=false;
        updateDisplayAI();
    } else {
        const gs = localGameState;
        const [p1,p2] = gs.playerIds;
        let c1=gs.players[p1].cards.shift();
        let c2=gs.players[p2].cards.shift();
        const w = gs.lastResult.winnerId;
        
        if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
        else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        
        if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
            await updateDoc(getPublicDataRef("games", gameId), {status:'finished', players:gs.players});
            return;
        }
        const nextT = w==='tie' ? gs.turn : w;
        await updateDoc(getPublicDataRef("games", gameId), {
            lastResult:null, turn:nextT, players:gs.players,
            currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
        });
    }
};

window.showFinalWinScreen = () => {
    document.getElementById('reflectionModal').classList.add('hidden');
};

const calculateRank = (count) => {
    if (count >= 100) return { title: "Leim-Legende", stars: 6 };
    if (count >= 50) return { title: "Astloch-Philosoph", stars: 5 };
    if (count >= 30) return { title: "Brett-Bezwinger", stars: 4 };
    if (count >= 20) return { title: "Hobel-Held", stars: 3 };
    if (count >= 10) return { title: "Schleifklotz-Schwinger", stars: 2 };
    return { title: "Werkstatt-Neuling", stars: 1 };
};

async function updateMainMenuStats(user) {
    if (!user) return;
    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'gamification', 'stats');
    try {
        const snap = await getDoc(statsRef);
        const count = snap.exists() ? (snap.data().gamesPlayed || 0) : 0;
        const rank = calculateRank(count);
        
        const container = document.getElementById('mainMenuStats');
        if(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center gap-1">
                    <div class="text-xs text-white/80 font-bold uppercase tracking-wider">Dein Rang</div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-bold text-white drop-shadow-md">${rank.title}</span>
                        <div class="flex text-amber-400 text-sm drop-shadow-sm">${Array(rank.stars).fill('‚òÖ').join('')}</div>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-lg filter drop-shadow">üî•</span>
                        <span class="font-bold text-white text-lg drop-shadow-md">${count} Spiele</span>
                    </div>
                </div>
            `;
            container.classList.remove('hidden');
        }
    } catch (e) {
        console.error("Stats load error", e);
    }
}

onAuthStateChanged(auth, (user) => {
    if (user) updateMainMenuStats(user);
});

async function updateLeaderboard(name) {
    if (!auth.currentUser) return;
    const ref = getPublicDataRef("leaderboard", auth.currentUser.uid);
    try {
        await setDoc(ref, {
            name: name,
            wins: increment(1),
            last_win: serverTimestamp()
        }, { merge: true });
    } catch (e) {
        console.error("Leaderboard update failed", e);
    }
}

window.endGame = async (winnerName) => {
    document.getElementById('gameContainer').classList.add('hidden');
    document.getElementById('bottomSheet').classList.add('hidden');
    document.getElementById('bottomSheetBackdrop').classList.add('hidden');

    const isWin = (winnerName === (gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name));
    
    // SET WURM IMAGE (Game Over)
    const gameOverImg = document.getElementById('gameOverWorm');
    if(gameOverImg) {
        if(isWin) {
            gameOverImg.src = "https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true";
        } else {
            gameOverImg.src = "https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_lose.png?raw=true";
        }
    }
    
    let newGamesCount = 0;
    let rankData = null;
    
    if (auth.currentUser) {
        const statsRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'gamification', 'stats');
        try {
            await setDoc(statsRef, {
                gamesPlayed: increment(1),
                lastPlayed: serverTimestamp()
            }, { merge: true });
            
            const snap = await getDoc(statsRef);
            newGamesCount = snap.data().gamesPlayed || 0;
            rankData = calculateRank(newGamesCount);
        } catch (e) {
            console.error("Stats update failed", e);
        }

        if (isWin) {
            const playerName = gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name;
            await updateLeaderboard(playerName);
        }
    }

    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    
    if (isWin) {
        title.innerText = "GEWONNEN!";
        title.className = "text-3xl font-black mb-2 text-green-600";
        text.innerHTML = `Herzlichen Gl√ºckwunsch! Du hast gewonnen.<br><br>
                          <div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg">
                            <span class="text-2xl">üî•</span> ${newGamesCount} Flammen gesammelt
                          </div>
                          <div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
        triggerConfetti();
    } else {
        title.innerText = "VERLOREN";
        title.className = "text-3xl font-black mb-2 text-gray-600";
        text.innerHTML = `Schade, ${winnerName} hat gewonnen.<br>Dranbleiben lohnt sich!<br><br>
                          <div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg">
                            <span class="text-2xl">üî•</span> ${newGamesCount} Flammen gesammelt
                          </div>
                          <div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
    }
    
    document.getElementById('gameOverModal').classList.remove('hidden');
};

window.showLeaderboard = async () => { 
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    try {
        const q=query(getPublicDataRef("leaderboard"), orderBy("wins","desc"), limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine Eintr√§ge</div>'; return; }
        list.innerHTML = snap.docs.map((d,i)=>`<div class="flex justify-between p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100"><span class="font-bold text-gray-700">${i+1}. ${d.data().name}</span><span class="font-bold text-amber-600">${d.data().wins} üèÜ</span></div>`).join('');
    } catch(e){ list.innerHTML='<div class="text-center text-red-400 text-sm">Fehler beim Laden</div>'; console.error(e); }
};

window.showNamePrompt = (mode) => {
    document.getElementById('setupModal').classList.add('hidden');
    document.getElementById('nameModal').classList.remove('hidden');
    const btn=document.getElementById('nameSubmitButton');
    const clone=btn.cloneNode(true);
    btn.parentNode.replaceChild(clone,btn);
    
    // Set navigation state to handle the back button correctly
    window.setNavState('name_input');
    
    clone.addEventListener('click',()=>{
        const n=document.getElementById('playerName').value.trim();
        if(!n)return;
        document.getElementById('nameModal').classList.add('hidden');
        if(mode==='ai') window.startGameAI(n);
        else if(mode==='multiplayer') window.createGame(n);
        else if(mode==='join') window.joinGame(gameId, n); 
    });
};
window.copyShareLink = () => { const l=document.getElementById('shareLink'); l.select(); try { document.execCommand('copy'); } catch(e){} };

// MODIFIED SHOW GAME INFO TO HIDE HEADER
window.showGameInfo = () => {
    document.getElementById('mainHeader').classList.add('hidden'); // HIDE HEADER
    const list = document.getElementById('infoCategoryList');
    if (!list) return;
    let html = '';
    for (const key in attributeInfo) {
        const info = attributeInfo[key];
        const isBetter = info.logic === 'Hoch gewinnt';
        html += `<div class="p-3 rounded-xl border-2 ${isBetter ? 'border-green-400 bg-green-50' : 'border-blue-400/80 bg-blue-50/50'} mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-lg font-bold text-gray-800">${info.icon} ${info.name}</span>
                        <span class="text-sm font-semibold ${isBetter ? 'text-green-700' : 'text-blue-700'}">${isBetter ? '‚¨Ü Hoch' : '‚¨á Niedrig'}</span>
                    </div>
                    <p class="text-xs text-gray-700 leading-snug">${info.description || ''}</p>
                 </div>`;
    }
    list.innerHTML = html;
    document.getElementById('gameInfoModal').classList.remove('hidden');
}

// MODIFIED CLOSE GAME INFO TO SHOW HEADER
window.closeGameInfo = () => {
    document.getElementById('gameInfoModal').classList.add('hidden');
    document.getElementById('mainHeader').classList.remove('hidden'); // SHOW HEADER
};

window.closeInfoModal = () => document.getElementById('infoModal').classList.add('hidden');
window.closeLeaderboard = () => { document.getElementById('leaderboardModal').classList.add('hidden'); document.getElementById('gameOverModal').classList.remove('hidden'); };
window.resetGame = () => location.reload();

function closeBottomSheet(){ const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bs.classList.add('translate-y-full'); bd.classList.add('opacity-0'); setTimeout(()=>{bs.classList.add('hidden');bd.classList.add('hidden');},300); }
function openBottomSheet(title){ if(title)document.getElementById('resultText').innerText=title; const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bd.classList.remove('hidden'); bs.classList.remove('hidden'); setTimeout(()=>{bd.classList.remove('opacity-0'); bs.classList.remove('translate-y-full');},10); }

document.getElementById('bsNextBtn').addEventListener('click',()=> { closeBottomSheet(); window.nextRound(); });

// Settings Listeners
const soundToggle = document.getElementById('soundToggle');
if(soundToggle) { soundToggle.checked = !isMuted; soundToggle.addEventListener('change', function() { isMuted = !this.checked; }); }
const revealToggle = document.getElementById('revealBackToggle');
if(revealToggle) { revealToggle.checked = isOpponentNameBackVisible(); revealToggle.addEventListener('change', function() { setOpponentNameBackVisible(this.checked); if(gameMode === 'ai' && !document.getElementById('gameContainer').classList.contains('hidden')) updateDisplayAI(); }); }
document.getElementById('bsInfoBtn').addEventListener('click', ()=>{ 
    const wood = lastRoundWinningWoodName || (aiGame.currentPlayerCard ? aiGame.currentPlayerCard.name : "Eiche");
    const content = detailedWoodInfo[wood] || `<p>Keine Detailinfo zu ${wood}</p>`;
    const modalContent = document.getElementById('infoModalContent');
    modalContent.innerHTML = `<h4 class="font-bold text-xl mb-2">${wood}</h4>` + content;
    
    const cardData = woodCards.find(c=>c.name===wood);
    if(cardData) {
        const img1 = cardData.imgTree || 'https://placehold.co/400x300?text=Bild+fehlt';
        const img2 = cardData.imgCross || 'https://placehold.co/400x300?text=Detail+fehlt';
        
        modalContent.innerHTML += `
            <div class="grid grid-cols-2 gap-3 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Maserung</p>
                    <img src="${img1}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Detailansicht</p>
                    <img src="${img2}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                </div>
            </div>`;
    }
    
    document.getElementById('infoModal').classList.remove('hidden');
});

const p=new URLSearchParams(window.location.search);
if(p.get('game')){ 
    document.getElementById('setupModal').classList.add('hidden');
    gameId=p.get('game'); 
    window.showNamePrompt('join'); 
}

</script>
</body>
</html>
