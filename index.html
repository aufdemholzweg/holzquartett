<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett: Gamifizierung in der Berufsbildung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* DESIGN DEFINITIONEN */
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; touch-action: manipulation; overflow-x: hidden; min-height: 100dvh; }
        .perspective-1000 { perspective: 1000px; }
        .card-3d { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 1rem; overflow: hidden; box-sizing: border-box; }
        .card-back { 
            transform: rotateY(180deg); 
            background-color: #2c3e50;
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/326bdfd40ff4d97de5c70dc584fe767aba056135/images/background_card.jpg?raw=true'); 
            background-size: cover; 
            background-position: center; 
            border: 4px solid white; 
        }
        .card-front-bg { background-color: #fffbeb; background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        /* Status-Ball Animation */
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); transform: translate(-50%, -50%) scale(1); } 50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); transform: translate(-50%, -50%) scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: translate(-50%, -50%) scale(1); } }
        
        /* Pop-In Animation f√ºr Fenster */
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* Bounce Animation f√ºr Gleichstand */
        .animate-bounce-slam { animation: bounce-slam 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes bounce-slam { 
            0% { transform: scale(0); opacity: 0; } 
            60% { transform: scale(1.1); opacity: 1; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        /* KLOTZI JUBEL ANIMATION (Runde gewonnen) */
        @keyframes slide-up-bounce {
            0% { transform: translateY(100%) rotate(10deg); opacity: 0; }
            60% { transform: translateY(-20px) rotate(-5deg); opacity: 1; }
            80% { transform: translateY(10px) rotate(5deg); }
            100% { transform: translateY(0) rotate(0deg); opacity: 1; }
        }
        .animate-klotzi-popup { animation: slide-up-bounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .opponent-back-name { position: absolute; top: 15%; width: 100%; text-align: center; color: rgba(255,255,255,0.95); font-weight: 700; font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dimmer { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .attr-box { background-color: #fff7ed; border: 1px solid #fbbf24; transition: all 0.2s; }
        .attr-box.flash-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; }
        .attr-box.flash-active span { color: white !important; }
        .attr-box.highlight-compare { background-color: #e5e7eb !important; border-color: #9ca3af !important; color: #111827 !important; }
        .attr-box.highlight-compare span { color: #000000 !important; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .attr-toggle-btn { transition: all 0.2s; border: 2px solid transparent; }
        .attr-toggle-btn.selected { background-color: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .attr-toggle-btn:not(.selected) { background-color: #f3f4f6; color: #9ca3af; border-color: transparent; }

        /* ANIMATIONEN F√úR DEN BALKEN & PUNKT */
        @keyframes pulse-dot-anim { 
            0%, 100% { transform: translate(50%, -50%) scale(1); } 
            50% { transform: translate(50%, -50%) scale(1.4); } 
        }
        .animate-pulse-dot { animation: pulse-dot-anim 1s infinite ease-in-out; }

        @keyframes chargeWidth { from { width: 0%; } to { width: 100%; } }
        .animate-charge { animation: chargeWidth 1.5s linear forwards; }
        
        @keyframes shrinkWidth { from { width: 100%; } to { width: 0%; } }
        .animate-shrink { animation: shrinkWidth 10s linear forwards; }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">

<header id="mainHeader" class="fixed top-0 left-0 w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-[120]">
    <div class="max-w-[600px] mx-auto px-4 py-3 relative flex justify-between items-center">
        <a id="navButton" href="#" class="relative z-[121] w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-white shadow-sm hover:bg-white/30 transition-all border border-white/30" aria-label="Navigation">
             </a>
        <h1 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg sm:text-2xl font-black tracking-wider uppercase drop-shadow-sm whitespace-nowrap pointer-events-none">üå≤ HOLZEN! üå≤</h1>
        
        <button id="ruleButton" onclick="window.showGameInfo()" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-[121]" aria-label="Spielregeln">
             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
             </svg>
        </button>
    </div>
</header>

<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto relative p-2 pt-20 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>
    <div class="flex justify-center items-start gap-2 sm:gap-4 w-full flex-grow relative pb-2 mt-2"> 
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="playerNameDisplay" class="text-base sm:text-lg font-bold text-amber-700 leading-tight truncate">Spieler</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="playerCardContainer"><div id="playerCard" class="w-full h-full relative"></div></div>
        </div>
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="opponentNameDisplay" class="text-base sm:text-lg font-bold text-gray-600 leading-tight truncate">COMPUTER</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="aiCardContainer"><div id="aiCard" class="w-full h-full relative"></div></div>
        </div>
    </div>
    <div class="w-full mt-4 mb-24"> 
        <div class="flex justify-between text-[9px] sm:text-[10px] font-bold text-gray-400 mb-1 px-1"><span>Dein Stapel</span><span>Gegenspieler</span></div>
        <div class="h-4 w-full bg-gray-200 rounded-full shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 rounded-l-full transition-all duration-500 ease-out" style="width: 50%;"></div>
            <div id="statusBall" class="absolute top-1/2 w-6 h-6 rounded-full border-2 border-white shadow-md transition-all duration-500 ease-out z-10" style="left: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);"></div>
        </div>
    </div>
</div>

<div id="happyKlotzi" class="fixed bottom-64 right-2 z-[100] transition-transform duration-500 translate-y-full hidden pointer-events-none flex flex-col items-center">
    <div id="happyKlotziText" class="bg-white border-4 border-black text-black font-black text-base sm:text-lg px-4 py-2 rounded-2xl mb-1 shadow-[4px_4px_0px_rgba(0,0,0,0.2)] animate-bounce relative text-center">
        Stark!
        <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[12px] border-t-black"></div>
        <div class="absolute -bottom-[9px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[10px] border-t-white"></div>
    </div>
    <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" alt="Jubel Klotzi" class="w-32 sm:w-40 filter drop-shadow-2xl">
</div>

<div id="tieOverlay" class="fixed inset-0 z-[90] flex items-center justify-center dimmer hidden pt-20">
    <div class="bg-white/10 backdrop-blur-md p-8 rounded-3xl animate-bounce-slam text-center border border-white/20 shadow-2xl relative">
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_quiz.png?raw=true" alt="Klotzi Quiz" class="w-32 mx-auto mb-2 object-contain filter drop-shadow-lg" onerror="this.style.display='none'">
        <div class="text-5xl mb-2 filter drop-shadow-lg">üí•</div>
        <h2 class="text-4xl sm:text-5xl font-black text-white uppercase tracking-wider drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">
            GLEICHSTAND!
        </h2>
        <p class="text-white font-bold text-lg mt-3 drop-shadow-md bg-black/20 px-4 py-1 rounded-full inline-block">Das Quiz entscheidet...</p>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 dimmer flex items-center justify-center z-[80] p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl relative w-full max-w-sm flex flex-col animate-pop-in border-4 border-amber-500 overflow-visible">
        
        <div class="h-4 w-full bg-gray-200 relative overflow-hidden rounded-t-xl">
            <div id="quizTimerBar" class="h-full w-0 bg-amber-500 rounded-r-sm relative"> 
                <div class="absolute right-0 top-1/2 w-4 h-4 bg-white border-2 border-amber-600 rounded-full shadow z-10 animate-pulse-dot transform translate-x-1/2 -translate-y-1/2"></div>
            </div>
        </div>
        
        <div class="p-6 text-center relative z-10">
            <div id="quizStatusText" class="inline-block bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full mb-3 relative z-30">
                ‚ö†Ô∏è Gleichstand! Quiz l√§dt...
            </div>
            <h3 id="quizQuestion" class="text-lg font-bold text-gray-800 mb-6 leading-tight min-h-[3rem] flex items-center justify-center relative z-30 px-2">
                Frage wird geladen...
            </h3>
            <div id="quizOptions" class="grid grid-cols-1 gap-3 relative z-30">
                </div>
            
            <div id="quizExplanation" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-700 leading-snug shadow-sm animate-pop-in">
            </div>
        </div>
    </div>
</div>

<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-xs sm:text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-xl sm:text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>
        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-800 transition text-sm sm:text-base">üéì Zusatzwissen</button>
            <button id="bsNextBtn" class="flex-1 bg-green-600 hover:bg-green-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-green-800 transition text-sm sm:text-base">Weiter &rarr;</button>
        </div>
    </div>
</div>

<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-[130] p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[85vh] flex flex-col">
        <div class="bg-amber-500 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 class="font-bold text-lg">Spielregeln & Eigenschaften</h3>
            <button onclick="window.closeGameInfo()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto hide-scrollbar">
            <h4 class="font-bold text-gray-700 text-md">Regeln</h4>
            <p class="text-sm text-gray-600 leading-relaxed mt-1 mb-4">Die aktive Person w√§hlt auf ihrer Karte die Eigenschaft, die den gr√∂√ütm√∂glichen Vorteil verspricht. Je nach Kategorie z√§hlt der h√∂here oder der niedrigere Wert (siehe die Beschreibung der Eigenschaften).</p>
            
            <p class="text-sm text-gray-600 leading-relaxed mb-6"><strong>Bei Gleichstand:</strong> Haben beide Karten den gleichen Wert, startet f√ºr BEIDE Spieler ein Quiz! Wer die Frage innerhalb von 10 Sekunden am schnellsten richtig beantwortet, gewinnt die Karte und ist als n√§chstes am Zug. Wird die Frage falsch beantwortet, gewinnt dein Gegenspieler. Wird die Frage von beiden Spielern innerhalb der Zeit NICHT beantwortet, bekommen beide keinen Punkt und jeder beh√§lt seine Karte.</p>
            
            <h4 class="font-bold text-gray-700 text-md mb-2">Beschreibung der Eigenschaften</h4>
            <div id="infoCategoryList" class="space-y-3"></div>
        </div>
    </div>
</div>

<div id="infoModal" class="fixed inset-0 dimmer flex items-center justify-center z-[160] p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col max-h-[80vh] mt-12">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Wissenskarte</h3>
            <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto flex-grow"></div>
    </div>
</div>

<div id="imageViewerModal" class="fixed inset-0 z-[200] flex items-center justify-center dimmer hidden p-4" onclick="window.closeImageViewer()">
    <div class="relative max-w-full max-h-full">
        <button onclick="window.closeImageViewer()" class="absolute -top-12 right-0 text-white text-3xl font-bold hover:text-gray-300 pointer-events-auto">&times;</button>
        <img id="fullSizeImage" src="" class="max-h-[85vh] max-w-[95vw] rounded-lg shadow-2xl object-contain border-4 border-white" onclick="event.stopPropagation()">
    </div>
</div>

<div id="impressumModal" class="fixed inset-0 z-[140] flex items-center justify-center p-4 dimmer hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-slate-700 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Impressum</h3>
            <button onclick="document.getElementById('impressumModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto text-sm text-gray-700 space-y-4">
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Angaben gem√§√ü ¬ß 5 TMG</h4>
                <p>Christopher Lehr<br>Waterloostra√üe 49<br>28201 Bremen</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Kontakt</h4>
                <p>E-Mail: christopher_lehr@web.de</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Kontext</h4>
                <p>Dieses interaktive Lernspiel entstand im Rahmen meiner Masterarbeit des Studiengang Lehramt an Berufsbildenden Schulen, Fachrichtung Holztechnik an der <strong>Leibniz Universit√§t Hannover</strong>. Es dient ausschlie√ülich nicht-kommerziellen Bildungs- und Forschungszwecken.</p>
            </div>
            
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Fachliche Grundlagen & Quellen</h4>
                <p class="text-xs text-gray-500 mb-1">Die verwendeten Holzdaten basieren auf folgenden Normen und Quellen:</p>
                <ul class="list-disc pl-4 text-xs text-gray-600 space-y-1">
                    <li><strong>DIN 68364:</strong> Kennwerte von Holzarten (Rohdichte, Elastizit√§tsmodul, Festigkeiten)</li>
                    <li><strong>DIN EN 338:</strong> Bauholz f√ºr tragende Zwecke ‚Äì Festigkeitsklassen</li>
                    <li><strong>DIN EN 350:</strong> Dauerhaftigkeitsklassen von Holz</li>
                    <li><strong>DIN 52184:</strong> Bestimmung der Quellung und Schwindung</li>
                    <li><strong>DIN 52192:</strong> Druckversuch quer zur Faserrichtung</li>
                    <li><strong>Vorlesung:</strong> Dr. Frank Peters (2021): Werkstoffkunde 1, Holzphysik</li>
                    <li><strong>Preise:</strong> <a href="https://www.muehlbauerholz.com/upload/schnittholz-mai-2024.pdf" target="_blank" class="underline text-blue-600">M√ºhlbauer Holz (Preisliste Mai 2024)</a></li>
                </ul>
            </div>

            <div>
                <h4 class="font-bold text-gray-900 mb-1">Haftung f√ºr Inhalte & Daten</h4>
                <p class="mb-2">Die Inhalte dieser Web-App wurden mit gr√∂√üter Sorgfalt und nach bestem Wissen und Gewissen erstellt. F√ºr die Richtigkeit, Vollst√§ndigkeit und Aktualit√§t der Inhalte kann jedoch keine Gew√§hr √ºbernommen werden.</p>
                <p class="mb-2"><strong>Besonderer Hinweis zu fachlichen Daten:</strong> Die im Spiel verwendeten Daten (z. B. Rohdichte, E-Modul, Preise) dienen prim√§r der Spielmechanik und der didaktischen Vereinfachung. Sie stellen Durchschnittswerte oder Richtwerte dar und ersetzen keine fachgerechte Planung nach DIN/EN-Normen.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Haftung f√ºr Links</h4>
                <p>Diese Webseite enth√§lt Links zu externen Webseiten Dritter (z. B. GitHub), auf deren Inhalte wir keinen Einfluss haben. Deshalb k√∂nnen wir f√ºr diese fremden Inhalte auch keine Gew√§hr √ºbernehmen. F√ºr die Inhalte der verlinkten Seiten ist stets der jeweilige Anbieter oder Betreiber der Seiten verantwortlich.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Urheberrecht</h4>
                <p class="mb-2">Die durch den Betreiber erstellten Inhalte und Werke auf diesen Seiten unterliegen dem deutschen Urheberrecht. Die Vervielf√§ltigung, Bearbeitung, Verbreitung und jede Art der Verwertung au√üerhalb der Grenzen des Urheberrechtes bed√ºrfen der schriftlichen Zustimmung des jeweiligen Autors bzw. Erstellers.</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Bild- und Tonquellen</h4>
                <ul class="list-disc pl-4 text-xs text-gray-600 space-y-1">
                    <li><strong>Holzbilder:</strong> <a href="https://holzvomfach.de/" target="_blank" class="underline text-blue-600">holzvomfach.de</a> und <a href="https://www.schreiner-seiten.de/index.php" target="_blank" class="underline text-blue-600">schreiner-seiten.de</a></li>
                    <li><strong>Sounds:</strong> <a href="https://pixabay.com/de/" target="_blank" class="underline text-blue-600">Pixabay.com</a></li>
                    <li><strong>Emojis/Icons:</strong> Systemstandard (Unicode)</li>
                </ul>
            </div>
            
            <hr class="my-4 border-gray-300">
            
            <div>
                <h4 class="font-bold text-gray-900 mb-1">Datenschutz & Technik</h4>
                <p class="mb-2">Da dies ein reines Forschungsprojekt ist, werden so wenige Daten wie m√∂glich gespeichert. Dennoch kommen externe Dienstleister zum Einsatz, um die technische Funktion zu gew√§hrleisten:</p>
                
                <ul class="list-disc pl-4 text-xs text-gray-600 space-y-2">
                    <li>
                        <strong>Hosting (GitHub Pages):</strong><br>
                        Diese Webseite wird auf Servern von GitHub Inc. (USA) gehostet. Beim Aufruf der Seite werden technisch bedingt Verbindungsdaten (z. B. IP-Adresse) an GitHub √ºbertragen, um die Inhalte auszuliefern.
                    </li>
                    <li>
                        <strong>Datenbank & Backend (Google Firebase):</strong><br>
                        F√ºr die Multiplayer-Funktion (Spielst√§nde, Synchronisation) nutzen wir Google Firebase (Google Ireland Limited). Die Spieldaten werden tempor√§r auf deren Servern gespeichert. Wir verwenden die "Anonyme Anmeldung", sodass keine Klarnamen oder E-Mail-Adressen von Nutzern gespeichert werden, sofern diese nicht freiwillig eingegeben werden.
                    </li>
                    <li>
                        <strong>Cookies / LocalStorage:</strong><br>
                        Das Spiel speichert lediglich technische Einstellungen (z. B. Sound an/aus) lokal auf Ihrem Ger√§t ("LocalStorage"). Es werden keine Tracking- oder Werbe-Cookies eingesetzt.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="attrConfigModal" class="fixed inset-0 z-[120] flex items-center justify-center p-4 dimmer hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Spieloptionen</h3>
            <button onclick="window.closeAttrConfig()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto">
            <div class="mb-5 space-y-3">
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <span class="font-bold text-gray-700 text-sm flex items-center gap-2">üîä Ton an</span>
                     <input type="checkbox" id="soundToggle" class="accent-green-500 w-5 h-5">
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <span class="font-bold text-gray-700 text-sm flex items-center gap-2">üëÄ Gegner-Karte sichtbar</span>
                     <input type="checkbox" id="revealBackToggle" class="accent-green-500 w-5 h-5">
                </div>
            </div>
            <hr class="border-gray-200 mb-4 border-t-2 border-dashed">
            <h4 class="font-bold text-gray-800 mb-1 text-sm">Eigenschaften w√§hlen</h4>
            <p class="text-xs text-gray-500 mb-3">W√§hle mindestens 3 und maximal 5 Kategorien.</p>
            <div id="attrConfigList" class="space-y-2"></div>
        </div>
        <div class="p-4 bg-gray-50 border-t">
             <button onclick="window.closeAttrConfig()" class="w-full bg-amber-500 text-white font-bold py-2 rounded-lg shadow">Fertig</button>
        </div>
    </div>
</div>

<div id="setupModal" class="fixed inset-0 z-[110] flex flex-col items-center justify-center p-4 dimmer overflow-y-auto h-screen">
    <div class="w-10 h-10 absolute left-4 top-4"></div>
    
    <a href="https://forms.office.com/r/dPiXWjBiGQ" target="_blank" 
       class="absolute top-20 left-4 z-[120] bg-violet-600 hover:bg-violet-700 text-white text-xs font-bold py-2 px-3 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 no-underline border-2 border-white/20 w-48">
       <span>üí¨</span> Feedback zum Spiel
    </a>

    <div class="relative w-full max-w-sm pt-20">
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_menu.png?raw=true" alt="Klotzi Men√º" class="absolute -top-4 -right-2 w-48 z-20 pointer-events-none transform rotate-3 drop-shadow-xl" onerror="this.style.display='none'">
        
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full relative mb-6 z-10">
            <div class="bg-amber-500 p-5 text-white text-center font-bold text-lg sm:text-xl tracking-wide shadow-md">HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus w√§hlen</span></div>
            <div class="p-6 space-y-4">
                <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">ü§ñ</span> Gegen Computer</button>
                <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">üåç</span> Online gegen Freunde</button>
                <button onclick="window.openAttrConfig()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl border border-gray-200 flex items-center justify-center gap-2 text-sm mt-2">
                    <span>‚öôÔ∏è</span> Spieloptionen <span id="attrCountBadge" class="bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">5</span>
                </button>
            </div>
        </div>
        <div id="mainMenuStats" class="text-center hidden mb-8 relative z-10"></div>
        <div class="mt-auto pt-4 text-center relative z-10">
            <button onclick="document.getElementById('impressumModal').classList.remove('hidden')" class="text-white/70 text-xs font-medium hover:text-white underline transition-colors">Impressum</button>
        </div>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center relative overflow-visible">
        
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_name.png?raw=true" alt="Klotzi Name" class="absolute -top-24 left-1/2 -translate-x-1/2 w-48 pointer-events-none drop-shadow-xl z-20" onerror="this.style.display='none'">
        
        <div class="relative z-10 mt-16"> 
            <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
            <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg" placeholder="Name eingeben" maxlength="12">
            <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600">Starten</button>
        </div>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund scannen:</p>
        <div class="flex justify-center mb-4"><div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div></div>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center relative overflow-visible">
        
        <style>
            .scene-stage { width: 100%; height: 220px; position: relative; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 70%, #8D6E63 70%, #5D4037 100%); border-radius: 16px; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-bottom: 20px; }
            .klotzi-real { height: 100px; width: auto; position: absolute; bottom: 50px; left: 40px; z-index: 10; transform-origin: bottom center; animation: klotzi-logic 6s infinite ease-in-out; }
            .seed { font-size: 20px; position: absolute; bottom: 120px; left: 160px; opacity: 0; animation: seed-fall 6s infinite; }
            .big-tree { font-size: 120px; position: absolute; bottom: 35px; left: 110px; transform-origin: bottom center; transform: scale(0); filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.2)); animation: tree-pop 6s infinite; }
            .sun-ray { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.4) 0deg 10deg, transparent 10deg 20deg); animation: spin-sun 20s linear infinite; z-index: 0; }
            @keyframes klotzi-logic { 0% { transform: translateX(-100px); } 10% { transform: translateX(0); } 15% { transform: scaleY(0.9); } 20% { transform: scaleY(1); } 40% { transform: translateX(0); } 45% { transform: translateY(-20px) rotate(-10deg); } 50% { transform: translateY(0) rotate(0deg); } 55% { transform: translateY(-20px) rotate(10deg); } 60% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(0); } }
            @keyframes seed-fall { 0%, 10% { opacity: 0; transform: translateY(0); } 15% { opacity: 1; transform: translateY(0); } 25% { opacity: 1; transform: translateY(70px) scale(0.5); } 26%, 100% { opacity: 0; } }
            @keyframes tree-pop { 0%, 25% { transform: scale(0); } 35% { transform: scale(1.2); } 40% { transform: scale(0.9); } 45% { transform: scale(1); } 100% { transform: scale(1); } }
            @keyframes spin-sun { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        </style>
        
        <div class="scene-stage" role="img" aria-label="Animation: Klotzi pflanzt einen Baum">
            <div class="sun-ray"></div>
            <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" class="klotzi-real" alt="Klotzi">
            <div class="seed">üå∞</div>
            <div class="big-tree">üå≥</div>
        </div>
        
        <div class="relative z-10 mt-4"> 
            <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
            <p id="gameOverText" class="text-gray-600 mb-6"></p>
            <div class="space-y-3">
                <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">üèÜ Bestenliste</button>
                <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">üîÑ Neues Spiel</button>
            </div>
        </div>
    </div>
</div>

<div id="reflectionModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-amber-800 mb-4">üéâ Super gespielt!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-4 font-medium"></p>
        <textarea id="reflectionAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 min-h-[100px] mb-4 text-sm" placeholder="Deine Gedanken dazu..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg">Weiter</button>
    </div>
</div>

<div id="leaderboardModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full flex flex-col max-h-[80vh]">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="overflow-y-auto flex-grow space-y-2 mb-4"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-2 rounded-lg text-gray-700">Schlie√üen</button>
    </div>
</div>

<script type="module">
// 4. DATENBANK & LOGIK (JAVASCRIPT)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};

const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'holzquartett-3a177';

let app, db, auth;
try {
    app = initializeApp(activeConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (e) {
    console.error("Firebase Init Error:", e);
    alert("Fehler beim Laden der Datenbank-Konfiguration.");
}

const initAuth = async () => {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (e) {
        console.error("Auth Failed", e);
    }
};
initAuth();

const getPublicDataRef = (coll, docId) => {
    if(docId) return doc(db, 'artifacts', appId, 'public', 'data', coll, docId);
    return collection(db, 'artifacts', appId, 'public', 'data', coll);
};

async function trackEvent(type) {
    if (!auth || !auth.currentUser) return;
    const ref = getPublicDataRef("statistics", "usage"); 
    try {
        await setDoc(ref, {
            [type]: increment(1),
            last_activity: serverTimestamp()
        }, { merge: true });
    } catch (e) {
        console.warn("Tracking eingeschr√§nkt.", e);
    }
}

// -------------------------------------------------------------
// NEUES LOGO: Holzmaserung (statt Fingerabdruck)
// -------------------------------------------------------------
const NAV_ICONS = {
    fingerprint: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" />
                    <path d="M8 21s2-4 2-9-2-9-2-9" />
                    <path d="M16 3s-2 4-2 9 2 9 2 9" />
                  </svg>`,
    house: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>`
};

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

window.setNavState = (state) => {
    const btn = document.getElementById('navButton');
    if(!btn) return;
    
    // REMOVE OLD HANDLERS (Clean Navigation)
    btn.onclick = null;
    
    if(state === 'game') {
        btn.innerHTML = NAV_ICONS.house;
        btn.removeAttribute('href'); 
        btn.onclick = (e) => { 
            e.preventDefault(); 
            if(confirm('Spiel abbrechen und zum Startbildschirm zur√ºckkehren?')) { 
                if(typeof unsubscribeGame === 'function') unsubscribeGame();
                window.location.href = window.location.origin + window.location.pathname; 
            } 
        };
        btn.setAttribute('aria-label', 'Zur√ºck zur Holzen! Startseite');
        
    } else if (state === 'name_input') {
        // Navigation im Namens-Fenster -> Zur√ºck zum Hauptmen√º
        btn.innerHTML = NAV_ICONS.house;
        btn.href = "#";
        btn.onclick = (e) => {
            e.preventDefault();
            document.getElementById('nameModal').classList.add('hidden');
            document.getElementById('setupModal').classList.remove('hidden');
            window.setNavState('menu'); // Reset to default menu behavior
        };
        btn.setAttribute('aria-label', 'Zur√ºck zum Hauptmen√º');
        
    } else {
        // Default: Startseite (Splashscreen) mit neuem Holz-Logo
        btn.innerHTML = NAV_ICONS.fingerprint; 
        btn.href = 'https://aufdemholzweg.github.io/Splashscreen-Holztechnik/';
        btn.onclick = null; // Standard link behavior
        btn.setAttribute('aria-label', 'Zum Splashscreen');
    }
};

// Initial Call
window.setNavState('menu');

let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;
let lastRoundWinningWoodName = null;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};

// 5. ATTRIBUTE & EIGENSCHAFTEN (Updated)
const attributeInfo={
druckfestigkeit:{
     icon:'üíé',
     name:'Druckfestigkeit',
     unit:'(N/mm¬≤)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: `Die Druckfestigkeit gibt die maximale Spannung in (N/mm¬≤) an, die das Holz aufnehmen kann, wenn es in Faserrichtung gestaucht wird.
Der Wert wird an kleinen, fehlerfreien Holzkl√∂tzen im Normalklima (20¬∞C, 65% rel. Luftfeuchte) bestimmt. Dabei wird die maximale Kraft, bei der das Holz versagt, durch den urspr√ºnglichen Querschnitt der Probe geteilt.`
 },
rohdichte:{
     icon:'‚öñÔ∏è',
     name:'Rohdichte',
     unit:'(kg/m¬≥)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Die Normal-Rohdichte (Roh) ist der Quotient aus Masse und Volumen (kg/m¬≥) bei gleicher Holzfeuchte. Als Referenz gilt hierbei das Normalklima nach DIN 50014 (20 ¬∞C / 65 % rel. Luftfeuchte), was einer Ausgleichsfeuchte des Holzes von rund 12 % entspricht.'
 },
 emodul:{
     icon:'üìê',
     name:'E-Modul',
     unit:'(N/mm¬≤)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Das E-Modul ist eine Materialkonstante und beschreibt die Steifigkeit des Holzes. Der Wert gibt an, welche Kraft (N) erforderlich ist, um einen Stab mit einem Querschnitt von 1x1 mm auf seine doppelte L√§nge zu verformen. Sie wird in N/mm¬≤ angegeben. Ein hoher E-Modul steht f√ºr ein steifes Material, das sich nur schwer verformen l√§sst (steile Steigung im Spannungs-Dehnungs-Diagramm).'
 },
dk:{
     icon:'üõ°Ô∏è',
     name:'Dauerhaftigkeit',
     unit:'(DK)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Die Dauerhaftigkeit nach DIN EN 350 gibt an, wie resistent das Kernholz gegen biologischen Befall ist: DK 1 bedeutet eine sehr lange Wiederstandsf√§higkeit gegen√ºber Pilze, Insekten und andere Sch√§dlinge, DK 5 dagegen eine sehr geringe Dauerhaftigkeit.'
 },
 quellen:{
     icon:'‚ÜîÔ∏è',
     name:'Quellen/Schw.',
     unit:'(%)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: 'Angegeben ist das maximale tangentiale Schwindma√ü (%). Dieser Wert beschreibt die prozentuale Ma√ü√§nderung in Richtung der Jahresringe vom faserges√§ttigten Zustand (ca. 30 % Holzfeuchte) bis zum darrtrockenen Zustand (0 %).'
 },
 rohdichte:{
     icon:'‚öñÔ∏è',
     name:'Rohdichte',
     unit:'(kg/m¬≥)', 
     logic: 'Hoch gewinnt', 
     default: true,
     description: 'Die Normal-Rohdichte (Roh) ist der Quotient aus Masse und Volumen (kg/m¬≥) bei gleicher Holzfeuchte. Als Referenz gilt hierbei das Normalklima nach DIN 50014 (20 ¬∞C / 65 % rel. Luftfeuchte), was einer Ausgleichsfeuchte des Holzes von rund 12 % entspricht.'
 },
 preis:{
     icon:'üí∞',
     name:'Preisstufe',
     unit:'(Stufe)', 
     logic: 'Niedrig gewinnt', 
     default: true,
     description: `Um eine einfache Vergleichbarkeit der Materialien zu gew√§hrleisten, beziehen sich alle Preisangaben auf das Volumen von einem Kubikmeter (‚Ç¨/m¬≥) Massivholz. Da reale Marktpreise je nach Region und Zeitpunkt schwanken, sind alle H√∂lzer in f√ºnf feste Preisstufen unterteilt. 
    0‚Ç¨ bis 699‚Ç¨  = 1
  700‚Ç¨ bis 1199‚Ç¨ = 2
 1200‚Ç¨ bis 1999‚Ç¨ = 3
 2000‚Ç¨ bis 3999‚Ç¨ = 4
>4000‚Ç¨           = 5`
 }
};


// RANDOM DEFAULT ATTRIBUTES
function getRandomDefaultAttributes() {
    const keys = Object.keys(attributeInfo);
    // Simple shuffle
    for (let i = keys.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [keys[i], keys[j]] = [keys[j], keys[i]];
    }
    return keys.slice(0, 5);
}

let activeAttributeKeys = getRandomDefaultAttributes();

const sounds={
 flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
 win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/64126fed45ff8c3fb4bd833f473d83f51ba0548b/Sounds/spielzuggewonnen.mp3?raw=true'),
 chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
 starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3'),
 quizTick: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/ticken_bei_quizfrage.mp3?raw=true'),
 tieAlert: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/Quiztime.mp3?raw=true')
};
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/main/images";
const IMG_SUFFIX = "?raw=true";

// 6. KARTEN DATEN
const woodCards=[
 {name:"üå≥Ahorn", dk:"5", druckfestigkeit:60, quellen:9, rohdichte:650, emodul:9500, preis:2, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Birke", dk:"5", druckfestigkeit:50, quellen:11.7, rohdichte:650, emodul:14500, preis:2, imgTree:`${IMG_BASE}/birke_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Douglasie", dk:"5", druckfestigkeit:70, quellen:7.5, rohdichte:500, emodul:13000, preis:4, imgTree:`${IMG_BASE}/douglasie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Ebenholz, Afrikanisches", dk:"1-2", druckfestigkeit:70, quellen:12.8, rohdichte:1200, emodul:13000, preis:5, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Kastanie", dk:"2", druckfestigkeit:50, quellen:6.8, rohdichte:620, emodul:9000, preis:3, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Eibe", dk:"2", druckfestigkeit:60, quellen:5.2, rohdichte:670, emodul:15000, preis:4, imgTree:`${IMG_BASE}/eibe_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eibe_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Eiche", dk:"2", druckfestigkeit:40, quellen:11.7, rohdichte:670, emodul:13000, preis:3, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Erle", dk:"5", druckfestigkeit:55, quellen:9.4, rohdichte:550, emodul:9500, preis:1, imgTree:`${IMG_BASE}/erle_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/erle_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Esche", dk:"5", druckfestigkeit:50, quellen:8.5, rohdichte:670, emodul:13000, preis:2, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Fichte", dk:"4", druckfestigkeit:50, quellen:8, rohdichte:480, emodul:11000, preis:2, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Hemlock", dk:"4", druckfestigkeit:55, quellen:8.5, rohdichte:480, emodul:10000, preis:4, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Hickory", dk:"4", druckfestigkeit:65, quellen:11, rohdichte:800, emodul:15000, preis:3, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Kiefer", dk:"3-4", druckfestigkeit:55, quellen:12.4, rohdichte:520, emodul:11000, preis:1, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Kirschbaum", dk:"3", druckfestigkeit:55, quellen:8.5, rohdichte:630, emodul:10600, preis:3, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤L√§rche", dk:"3-4", druckfestigkeit:55, quellen:10.4, rohdichte:590, emodul:13800, preis:3, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Linde", dk:"5", druckfestigkeit:50, quellen:10.7, rohdichte:520, emodul:7200, preis:2, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Mahagoni Amerikanisch", dk:"2", druckfestigkeit:50, quellen:5.8, rohdichte:600, emodul:10600, preis:5, imgTree:`${IMG_BASE}/mahagoni_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Meranti (DR)", dk:"3-4", druckfestigkeit:65, quellen:9.8, rohdichte:720, emodul:14500, preis:4, imgTree:`${IMG_BASE}/meranti_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/meranti_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Nussbaum (EU)", dk:"3", druckfestigkeit:70, quellen:7.5, rohdichte:670, emodul:12000, preis:4, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Palisander", dk:"1", druckfestigkeit:80, quellen:8.1, rohdichte:850, emodul:12800, preis:5, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Pappel", dk:"5", druckfestigkeit:35, quellen:9.8, rohdichte:450, emodul:9000, preis:2, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Platane", dk:"5", druckfestigkeit:45, quellen:8.5, rohdichte:620, emodul:12800, preis:3, imgTree:`${IMG_BASE}/platane_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/platane_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Redwood", dk:"2", druckfestigkeit:40, quellen:5.2, rohdichte:400, emodul:9500, preis:2, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Robinie", dk:"1-2", druckfestigkeit:70, quellen:7.5, rohdichte:770, emodul:13600, preis:3, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Kastanie", dk:"5", druckfestigkeit:30, quellen:6.8, rohdichte:550, emodul:6500, preis:3, imgTree:`${IMG_BASE}/Kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/Kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Rotbuche", dk:"5", druckfestigkeit:60, quellen:11.7, rohdichte:720, emodul:14000, preis:2, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥R√ºster", dk:"4", druckfestigkeit:45, quellen:8.3, rohdichte:670, emodul:11000, preis:3, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Tanne", dk:"4", druckfestigkeit:45, quellen:7.5, rohdichte:450, emodul:11000, preis:2, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Teak", dk:"1", druckfestigkeit:60, quellen:5.8, rohdichte:670, emodul:13000, preis:5, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Weng√©", dk:"2", druckfestigkeit:90, quellen:9.4, rohdichte:850, emodul:16000, preis:4, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≥Zebrano", dk:"2-3", druckfestigkeit:50, quellen:9, rohdichte:770, emodul:15400, preis:4, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"üå≤Zeder", dk:"1-2", druckfestigkeit:40, quellen:11, rohdichte:550, emodul:7200, preis:5, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`}
];

// -------------------------------------------------------------
// NEUE WISSENSKARTEN-DATEN
// -------------------------------------------------------------
const detailedWoodInfo = {
    "Ahorn": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Das helle Holz gl√§nzt seidig und hat eine sehr gleichm√§√üige Struktur. Es ist hart und gleichzeitig elastisch.</p><p class="mb-2"><strong>Verwendung:</strong> Hochwertige Massivm√∂bel, Tischplatten, B√∂den von Streichinstrumenten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Ahorn hat einen typischen <strong>Seidenglanz</strong> auf gehobelten Fl√§chen. Die Poren sind so fein, dass du sie mit blo√üem Auge nicht sehen kannst.</div>`,
    "Birke": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa, Nordasien)</div><p class="mb-2">Die Birke liefert ein helles, gelblich-wei√ües bis r√∂tliches Holz. Es ist m√§√üig hart und z√§h, aber leider nicht witterungsbest√§ndig.</p><p class="mb-2"><strong>Verwendung:</strong> Der Klassiker f√ºr Sperrholz und Multiplex-Platten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Hier sind die Gef√§√üe (Poren) oft breiter als die Markstrahlen. Im Querschnitt sehen die Poren aus wie <strong>feine, helle Punkte</strong>.</div>`,
    "Douglasie": `<div class="text-xs font-bold mb-2">üü© Heimisch (Eingeb√ºrgert)</div><p class="mb-2">Ein Nadelholz mit einem kr√§ftigen, r√∂tlichen Kern. Es ist fester und widerstandsf√§higer als Fichte und enth√§lt Harz.</p><p class="mb-2"><strong>Verwendung:</strong> Konstruktionsholz f√ºr drau√üen, Terrassendielen.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Der √úbergang zwischen dem hellen Fr√ºhholz und dem dunklen Sp√§tholz ist sehr scharf. Wenn du es bearbeitest, riecht es oft leicht nach <strong>Zitrone</strong>.</div>`,
    "Ebenholz, Afr.": `<div class="text-xs font-bold mb-2 text-red-600">üü• Import (Afrika) - Stark gef√§hrdet</div><p class="mb-2">Dieses Holz ist extrem hart, schwer und dicht. Der Kern ist tiefschwarz. Es ist so fein, dass es sich hervorragend polieren l√§sst.</p><p class="mb-2"><strong>Verwendung:</strong> Griffbretter f√ºr Geigen und Gitarren, Klaviertasten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Es hat eine enorme Dichte und <strong>sinkt im Wasser</strong>. Die Poren sind oft mit dunklen Inhaltsstoffen gef√ºllt und kaum sichtbar.</div>`,
    "Kastanie": `<div class="text-xs font-bold mb-2">üü© Heimisch (S√ºdeuropa)</div><p class="mb-2">Ein ringporiges Hartholz mit einem gelbbraunen Kern. Es sieht der Eiche zum Verwechseln √§hnlich, ist aber etwas leichter und weicher.</p><p class="mb-2"><strong>Verwendung:</strong> Fassholz f√ºr Wein, Pf√§hle, M√∂bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Es sieht aus wie Eiche, aber es fehlen die breiten Markstrahlen. Du siehst also <strong>keine Spiegel</strong> auf der radialen Fl√§che.</div>`,
    "Eibe": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Heimisch - Gesch√ºtzt</div><p class="mb-2">Das h√§rteste und schwerste Nadelholz, das wir haben. Der Kern ist r√∂tlich-violett. Es ist extrem z√§h und dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> Drechseln, Kunsttischlerei, Bogenbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Obwohl es ein Nadelholz ist, hat die Eibe <strong>keine Harzkan√§le</strong>. Die Jahresringe verlaufen oft sehr wellig.</div>`,
    "Eiche": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Der Klassiker. Der Kern ist graugelb bis gelbbraun. Das Holz ist hart, schwer und dank der Gerbs√§ure sehr wetterfest.</p><p class="mb-2"><strong>Verwendung:</strong> Massivholzm√∂bel, Parkettb√∂den, Weinf√§sser.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die Eiche erkennst du sofort an den breiten <strong>Markstrahlen</strong>. Im Radialschnitt gl√§nzen sie als auff√§llige Spiegel.</div>`,
    "Erle": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Frisch gef√§llt leuchtet das Holz orange-rot. Es ist ein weiches und leichtes Laubholz.</p><p class="mb-2"><strong>Verwendung:</strong> Kirschbaum-Ersatz (gebeizt), Modellbau. Unter Wasser extrem haltbar.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die Markstrahlen b√ºndeln sich oft zu sogenannten <strong>Scheinmarkstrahlen</strong>, die du als L√§ngsstreifen erkennen kannst.</div>`,
    "Esche": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Ein ringporiges Hartholz. Es ist bekannt f√ºr seine extreme Z√§higkeit und Elastizit√§t.</p><p class="mb-2"><strong>Verwendung:</strong> Perfekt f√ºr Werkzeugstiele (H√§mmer, √Ñxte) und Sportger√§te.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Es ist ringporig wie die Eiche, besitzt aber <strong>keine breiten Markstrahlen</strong>.</div>`,
    "Fichte": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Das wichtigste Bauholz. Es ist hell, weich und leicht, aber fest genug f√ºr Tragwerke.</p><p class="mb-2"><strong>Verwendung:</strong> Dachst√ºhle, Leimholztr√§ger, M√∂bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Im Gegensatz zur Tanne hat die Fichte <strong>Harzkan√§le</strong>. Die √Ñste sind meist klein, schwarz und fest verwachsen.</div>`,
    "Hemlock": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Import (Nordamerika)</div><p class="mb-2">Ein Nadelholz aus Nordamerika. Es ist grau-wei√ü bis gelblich und harzfrei.</p><p class="mb-2"><strong>Verwendung:</strong> Saunabau (harzt nicht), Innenausbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Es sieht der Fichte √§hnlich, ist aber eher <strong>grau im Farbton</strong> und besitzt absolut keine Harzkan√§le.</div>`,
    "Hickory": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Import (Nordamerika)</div><p class="mb-2">Ein sehr hartes Holz aus der Walnuss-Familie. H√∂chste Z√§higkeit aller Handelsh√∂lzer.</p><p class="mb-2"><strong>Verwendung:</strong> Hochwertige Werkzeugstiele, Drumsticks.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Im dunklen Sp√§tholz kannst du feine, helle Linien erkennen. Das sind netzartige <strong>Parenchymb√§nder</strong>.</div>`,
    "Kastanie": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Das Holz ist wei√ülich bis gelblich und weich. Es hat eine sehr homogene Struktur.</p><p class="mb-2"><strong>Verwendung:</strong> Blindholz, Schnitzereien, Kisten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die Markstrahlen sind stockwerkartig angeordnet. Das erzeugt auf der Fl√§che eine sehr feine <strong>Rippelung</strong> (Ripple Marks).</div>`,
    "Kiefer": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Starker Kontrast zwischen dem r√∂tlichen Kern und dem gelben Splint. Harzreich.</p><p class="mb-2"><strong>Verwendung:</strong> Fenster, T√ºren, M√∂bel im Landhausstil, Dielen.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Auf dem Querschnitt siehst du gro√üe, deutliche <strong>Harzkan√§le</strong>. Riecht intensiv nach Harz.</div>`,
    "Kirschbaum": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Ein edles, feinporiges Hartholz. Der Kern ist r√∂tlich und dunkelt feurig nach.</p><p class="mb-2"><strong>Verwendung:</strong> Stilm√∂bel, Innenausbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die Markstrahlen erscheinen im Querschnitt als helle, <strong>scharf begrenzte Linien</strong>.</div>`,
    "L√§rche": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Schwerstes heimisches Nadelholz. Kern intensiv rotbraun. Sehr witterungsbest√§ndig.</p><p class="mb-2"><strong>Verwendung:</strong> Fassaden, Fenster, Br√ºcken, Au√üenbereich.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Der √úbergang vom hellen Fr√ºhholz zum dunklen <strong>Sp√§tholz</strong> ist extrem scharf und kontrastreich.</div>`,
    "Linde": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Ein helles, weiches und leichtes Holz. Kaum sichtbare Jahresringe.</p><p class="mb-2"><strong>Verwendung:</strong> Das klassische Holz f√ºr Bildhauer und Schnitzer.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Das Holz ist in alle Richtungen <strong>sehr homogen</strong> schneidbar (ideal zum Schnitzen).</div>`,
    "Mahagoni (echtes)": `<div class="text-xs font-bold mb-2 text-red-600">üü• Import (Tropen) - CITES!</div><p class="mb-2">Tropisches Kernholz, rotbraun bis kupferrot. M√§√üig hart, arbeitet kaum.</p><p class="mb-2"><strong>Verwendung:</strong> Exklusive M√∂bel, Bootsbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Durch den <strong>Wechseldrehwuchs</strong> entstehen auf der Fl√§che die ber√ºhmten Hell-Dunkel-Streifen.</div>`,
    "Meranti (DR)": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Import (Asien)</div><p class="mb-2">DR steht f√ºr <strong>Dark Red</strong>. Der Kern ist rotbraun. Eigenschaften schwanken stark.</p><p class="mb-2"><strong>Verwendung:</strong> Fensterbau (Standard), Au√üent√ºren.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Grobporig. Auf dem Querschnitt sieht man oft feine wei√üe Linien mit Harz (<strong>Gummiadern</strong>).</div>`,
    "Nussbaum (EU)": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Sehr dekoratives Hartholz. Kern grau-braun, oft dunkel gemasert.</p><p class="mb-2"><strong>Verwendung:</strong> Teure M√∂bel, Furniere, Gewehrsch√§fte.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Es ist <strong>halbringporig</strong>. Die Poren werden vom Fr√ºhjahr zum Sommer hin langsam kleiner.</div>`,
    "Palisander": `<div class="text-xs font-bold mb-2 text-red-600">üü• Import (Tropen) - CITES!</div><p class="mb-2">Sehr schweres, hartes Tropenholz. Violett bis schokobraun mit fast schwarzen Streifen.</p><p class="mb-2"><strong>Verwendung:</strong> Marimbaphone, Gitarren, Luxusobjekte.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Charakteristisch sind die <strong>schwarzen Farbstreifen</strong>. Riecht s√º√ülich bei Bearbeitung.</div>`,
    "Pappel": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Sehr weiches und leichtes Laubholz. Grau-wei√ü bis br√§unlich.</p><p class="mb-2"><strong>Verwendung:</strong> Paletten, Z√ºndh√∂lzer, Saunab√§nke.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Nach dem S√§gen ist die Oberfl√§che sehr <strong>wollig und faserig</strong>.</div>`,
    "Platane": `<div class="text-xs font-bold mb-2">üü© Heimisch (S√ºdeuropa)</div><p class="mb-2">Zerstreutporiges Laubholz mit r√∂tlichem Kern. M√§√üig hart.</p><p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Drechseln.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die Markstrahlen sind ungew√∂hnlich <strong>breit und hoch</strong> (Perlholz-Optik im Schnitt).</div>`,
    "Redwood": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Import (USA)</div><p class="mb-2">Mammutbaum-Holz. Rotbraun, sehr leicht und weich, aber dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> Fassaden, Schindeln.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>√Ñhnelt L√§rche, hat aber <strong>keine Harzkan√§le</strong> und eine sehr grobe Struktur.</div>`,
    "Robinie": `<div class="text-xs font-bold mb-2">üü© Heimisch (Eingeb√ºrgert)</div><p class="mb-2">Kern olivgr√ºn bis goldbraun. Extrem hart, z√§h und dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> Spielpl√§tze, Gartenm√∂bel, Pf√§hle.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die gro√üen Fr√ºhholzporen sind komplett mit <strong>Thyllen</strong> verstopft.</div>`,
    "Rotbuche": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Schlichtes, r√∂tlich-wei√ües Holz. Hart und schwer, arbeitet aber stark.</p><p class="mb-2"><strong>Verwendung:</strong> St√ºhle (Bugholz), Werkb√§nke, Treppen.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Markstrahlen im Tangentialschnitt als dunkle Spindeln (<strong>Reiskerne</strong>) sichtbar.</div>`,
    "R√ºster": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Holz der Ulme. Ringporig, schokobrauner Kern. Sehr z√§h.</p><p class="mb-2"><strong>Verwendung:</strong> M√∂bel, Treppen, Sportger√§te.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Feine Poren im Sp√§tholz bilden wellenf√∂rmige B√§nder (<strong>Ulmenwellen</strong>).</div>`,
    "Tanne": `<div class="text-xs font-bold mb-2">üü© Heimisch (Europa)</div><p class="mb-2">Helles Nadelholz ohne Farbkern. Harzfrei.</p><p class="mb-2"><strong>Verwendung:</strong> Konstruktion, Fenster, Innenausbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Im Gegensatz zur Fichte hat die Tanne absolut <strong>keine Harzkan√§le</strong>.</div>`,
    "Teak": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Import (Asien)</div><p class="mb-2">Goldbraun, f√ºhlt sich √∂lig an. Extrem wetterfest.</p><p class="mb-2"><strong>Verwendung:</strong> Schiffsdecks, Gartenm√∂bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>F√ºhlt sich <strong>wachsig</strong> an und riecht wie altes Leder.</div>`,
    "Weng√©": `<div class="text-xs font-bold mb-2 text-red-600">üü• Import (Afrika) - Gef√§hrdet</div><p class="mb-2">Fast schwarz mit feinen hellen Streifen. Sehr hart, splittert leicht.</p><p class="mb-2"><strong>Verwendung:</strong> Exklusive Parkettb√∂den, M√∂bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Helle Speicherzellen erzeugen auf der Fl√§che ein feines <strong>Rebhuhn-Muster</strong>.</div>`,
    "Zebrano": `<div class="text-xs font-bold mb-2 text-red-600">üü• Import (Afrika) - Gef√§hrdet</div><p class="mb-2">Hellbraun mit regelm√§√üigen dunkelbraunen Streifen.</p><p class="mb-2"><strong>Verwendung:</strong> Furniere, Auto-Interieur.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Die <strong>Zebra-Streifung</strong> ist unverwechselbar. Riecht unangenehm.</div>`,
    "Zeder": `<div class="text-xs font-bold mb-2 text-yellow-600">üü® Import (Nordamerika)</div><p class="mb-2">Meist Western Red Cedar. Sehr leicht, weich, r√∂tlich und haltbar.</p><p class="mb-2"><strong>Verwendung:</strong> Schindeln, Fassaden, Mottenkugeln.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>üîç Hammermerkmal:</strong><br>Intensiver, <strong>aromatischer Geruch</strong> (Bleistift).</div>`
};

const reflectionQuestions=[ "Welches Holz w√ºrdest du f√ºr Gartenm√∂bel w√§hlen und warum?", "Eine K√ºchenarbeitsplatte muss schnittfest sein. Welches Holz eignet sich?", "F√ºr einen Dielenboden: Hartes oder weiches Holz?", "Warum ist Teak im Schiffbau so beliebt?" ];

// 7. QUIZ FRAGEN (F√úR DAS STECHEN) - NEU MIT ERKL√ÑRUNG
const quizQuestions = [
    {q:"Was passiert mit dem Volumen von Holz, wenn es unterhalb des Fasers√§ttigungsbereiches Feuchtigkeit aufnimmt?", o:["Es schwindet","Es quillt","Bleibt gleich","Wird leichter"], c:1, e:"Wasser lagert sich in die Zellw√§nde ein und dr√ºckt sie auseinander."},
    {q:"In welcher anatomischen Richtung sind das Quellen und Schwinden von Holz am st√§rksten ausgepr√§gt?", o:["L√§ngs","Radial","Tangential","√úberall gleich"], c:2, e:"Tangential arbeitet Holz etwa doppelt so stark wie radial."},
    {q:"Was bezeichnet man als den Fasers√§ttigungsbereich bei einer Holzfeuchte von ca. 30 %?", o:["Holz schwimmt","Zellwand voll, Lumen leer","Darrtrocken","M√∂beltrocken"], c:1, e:"Ab diesem Punkt beginnt das Holz beim Trocknen zu schwinden."},
    {q:"Welche Holzfeuchte sollten M√∂belst√ºcke aufweisen, die in zentral beheizten Wohnr√§umen genutzt werden?", o:["8 ‚Äì 10 %","15 ‚Äì 18 %","ca. 25 %","0 %"], c:0, e:"Das entspricht dem durchschnittlichen Raumklima (20¬∞C, 50% Luftfeuchte)."},
    {q:"Was versteht man unter dem Begriff ‚ÄûKernholz‚Äú?", o:["Junges Au√üenholz","Toter, innerer Teil","Die Rinde","Verfaultes Holz"], c:1, e:"Der Kern dient nur noch der Stabilit√§t und ist oft dauerhafter."},
    {q:"Welche physiologische Hauptfunktion erf√ºllt das Splintholz im lebenden Baum?", o:["Wasserleitung","K√§lteschutz","Nur Stabilit√§t","Harzspeicher"], c:0, e:"Der Splint ist der physiologisch aktive, wasserleitende Teil des Holzes."},
    {q:"Welche der folgenden Baumarten z√§hlt zu den Nadelh√∂lzern?", o:["Eiche","Buche","Fichte","Ahorn"], c:2, e:"Die Fichte ist der klassische heimische Nadelbaum."},
    {q:"Welche der folgenden Baumarten geh√∂rt zu den Laubh√∂lzern?", o:["Kiefer","L√§rche","Esche","Tanne"], c:2, e:"Die Esche geh√∂rt zu den Laubb√§umen (Angiospermen)."},
    {q:"Was versteht man unter der sogenannten ‚ÄûDarrdichte‚Äú eines Holzes?", o:["Frischgewicht","Dichte bei 0 % Wasser","H√§rte","Astanteil"], c:1, e:"‚ÄûDarren‚Äú bedeutet technisches Trocknen bis kein Wasser mehr enthalten ist."},
    {q:"Warum ist das Kernholz der Eiche besonders witterungsbest√§ndig und dauerhaft?", o:["Ist sehr weich","Enth√§lt Gerbs√§ure","Speichert Wasser","Ist wei√ü"], c:1, e:"Gerbs√§ure (Tannin) sch√ºtzt das Holz vor Pilzen und Insekten."},
    {q:"Welche heimische Baumart ist an ihrer charakteristischen wei√üen Rinde zu erkennen?", o:["Kiefer","Birke","Eiche","Nussbaum"], c:1, e:"Die wei√üe Rinde ist das sicherste Erkennungsmerkmal der Birke."},
    {q:"Welches Nadelholz wird im traditionellen Holzbau am h√§ufigsten f√ºr Dachst√ºhle verwendet?", o:["Fichte","Nussbaum","Kirschbaum","Balsa"], c:0, e:"Fichte ist leicht, fest, elastisch und g√ºnstig verf√ºgbar."},
    {q:"Was stellen die Jahresringe im Querschnitt eines Baumstammes dar?", o:["Krankheiten","Holzzuwachs pro Jahr","Risse","Wurzeln"], c:1, e:"Ein Ring besteht aus Fr√ºhholz (Fr√ºhling) und Sp√§tholz (Sommer)."},
    {q:"Wodurch unterscheiden sich Fr√ºhholz und Sp√§tholz innerhalb eines Jahresringes?", o:["Fr√ºhholz ist dunkler","Fr√ºhholz hell, Sp√§tholz dunkel","Kein Unterschied","Sp√§tholz ist blau"], c:1, e:"Fr√ºhholz dient dem Wassertransport, Sp√§tholz der Festigkeit."},
    {q:"Welche physikalische Eigenschaft ist typisch f√ºr das Holz der Pappel?", o:["Schwer und hart","Leicht und weich","Witterungsfest","Schwarz"], c:1, e:"Pappelholz hat eine sehr geringe Dichte."},
    {q:"Was ist das Kambium und welche Funktion hat es im Baumstamm?", o:["Die Rinde","Wachstumsschicht","Das Mark","Ein Ast"], c:1, e:"Hier findet die Zellteilung statt (Holz nach innen, Bast nach au√üen)."},
    {q:"Welches Holz verstr√∂mt einen intensiven, aromatischen Geruch, der an Bleistifte erinnert?", o:["Buche","Zeder","Ahorn","Esche"], c:1, e:"Zedern√∂l sorgt f√ºr den typischen Geruch und vertreibt Motten."},
    {q:"Was bedeutet es, wenn ein Holzbauteil als ‚Äûimpr√§gniert‚Äú bezeichnet wird?", o:["Mit Schutzmittel getr√§nkt","Geschliffen","Getrocknet","Lackiert"], c:0, e:"Der Schutz zieht tief in das Holz ein, anders als bei Lack."},
    {q:"Welcher heimische Nadelbaum wirft im Winter seine Nadeln ab?", o:["Fichte","Kiefer","L√§rche","Tanne"], c:2, e:"Die L√§rche wirft ihre Nadeln im Herbst ab wie ein Laubbaum seine Bl√§tter."},
    {q:"Welche Holzart wird aufgrund ihrer Z√§higkeit traditionell f√ºr Hammerstiele verwendet?", o:["Fichte","Esche","Pappel","Balsa"], c:1, e:"Esche ist extrem z√§h und elastisch, sie bricht nicht spr√∂de."},
    {q:"Welche biologische Funktion erf√ºllt das Harz bei Nadelb√§umen?", o:["Wundverschluss","Ein Pilz","Der Kern","Ein D√ºnger"], c:0, e:"Es verschlie√üt Verletzungen und sch√ºtzt vor Insekten."},
    {q:"Was bedeutet der Begriff ‚Äûanisotrop‚Äú in Bezug auf den Werkstoff Holz?", o:["√úberall gleich","Richtungsabh√§ngig","Brennbar","Giftig"], c:1, e:"Holz verh√§lt sich in L√§ngs-, Radial- und Tangentialrichtung unterschiedlich."},
    {q:"Woran kann man die Nadeln einer Fichte bei der Bestimmung erkennen?", o:["Sie stechen","Sind weich","Fallen ab","Schuppenf√∂rmig"], c:0, e:"‚ÄûDie Fichte sticht, die Tanne nicht.‚Äú"},
    {q:"Mit welchem Messger√§t bestimmt man √ºblicherweise die Holzfeuchte auf der Baustelle?", o:["Zollstock","Widerstandsmessger√§t","Wasserwaage","Thermometer"], c:1, e:"Zwei Spitzen werden ins Holz geschlagen; je feuchter, desto besser leitet es Strom."},
    {q:"Was versteht man unter der ‚ÄûDarr-Methode‚Äú zur Bestimmung der Holzfeuchte?", o:["Trocknen bei 103¬∞C","D√ºnsten","W√§ssern","Holzdehnung"], c:0, e:"Dies ist die Referenzmethode, um den exakten Wassergehalt zu bestimmen."},
    {q:"Welchen Zweck erf√ºllt ein gro√üer Dach√ºberstand beim Holzschutz an Fassaden?", o:["Optik","Trockenhalten","Brandschutz","Vogelschutz"], c:1, e:"Trockenes Holz (unter 20 %) kann nicht von Pilzen zerst√∂rt werden."},
    {q:"Welche Funktion √ºbernimmt der Inhaltsstoff Lignin in der Holzzellwand?", o:["Druckfestigkeit (H√§rte)","Weichmacher","Holzf√§rbung","N√§hrstoffreicher"], c:0, e:"Lignin verholzt die Zellwand und sorgt f√ºr die Druckstabilit√§t."},
    {q:"Welche Funktion hat die Cellulose im Aufbau der Holzzellwand?", o:["Zugger√ºst der Fasern","‚ÄûKlebstoff‚Äú","Standf√§stigkeit","Einlagerung"], c:0, e:"Cellulosefasern fangen Zugkr√§fte auf (√§hnlich wie Stahl in Stahlbeton)."},
    {q:"Welche der folgenden Holzarten ist so schwer, dass sie im Wasser sinkt?", o:["Fichte","Ebenholz","Pappel","Linde"], c:1, e:"Diese H√∂lzer haben eine Rohdichte von √ºber 1,0 g/cm¬≥."},
    {q:"Was versteht man unter dem Begriff ‚ÄûMaserholz‚Äú?", o:["Wirbelig strukturiertes Holz","Gerades Holz","Farbiges Holz","Faules Holz"], c:0, e:"Es entsteht oft an Wucherungen und ist sehr dekorativ."},
    {q:"Welche Holzart wird klassischerweise f√ºr die Herstellung von Weinf√§ssern (Barrique) genutzt?", o:["Eiche","Fichte","Pappel","Birke"], c:0, e:"Eiche ist dicht (dank Thyllen) und gibt erw√ºnschte Aromen an den Wein ab."},
    {q:"Was ist ‚ÄûBl√§ue‚Äú im Holz?", o:["Zuwachs von √Ñsten","Verf√§rbung durch Pilze","Holzzerfall","Wuchsfehler"], c:1, e:"Bl√§ue ist meist ein optischer Mangel, keine Zerst√∂rung der Zellwand."},
    {q:"Welcher Teil des Holzes weist die h√∂chste Dichte und H√§rte auf?", o:["Fr√ºhholz","Sp√§tholz","alles gleich","Kambium"], c:1, e:"Sp√§tholz hat dickere Zellw√§nde und kleinere Hohlr√§ume."},
    {q:"Nach welchem Prinzip ist eine Sperrholzplatte aufgebaut?", o:["L√§ngsholz aufeinander","Lagen um 90¬∞ verleimt","St√§be hochkant","PU-Klebstoff"], c:1, e:"Durch das ‚ÄûAbsperren‚Äú (Kreuzen) wird das Quellen und Schwinden minimiert."},
    {q:"Welche Holzart zeigt im Radialschnitt gl√§nzende ‚ÄûSpiegel‚Äú (Markstrahlen)?", o:["Eiche","Fichte","Kiefer","Pappel"], c:0, e:"Die ‚ÄûSpiegel‚Äú sind die angeschnittenen, breiten Markstrahlen der Eiche."},
    {q:"Welches Holz zeichnet sich durch besonders hohe Elastizit√§t aus?", o:["Esche","Eiche","Pappel","Fichte"], c:0, e:"Esche ist biegsam und bricht nicht sofort (ideal f√ºr Sportger√§te)."},
    {q:"Was ist ein Ast im Holz aus technischer Sicht?", o:["Wuchsfehler","Eingewachsener Zweig","Krankheit","Wurzel"], c:1, e:"Jeder Ast im Holz war fr√ºher ein Zweig au√üen am Baum."},
    {q:"Welche Holzart wird h√§ufig f√ºr die Herstellung von einfachen Paletten verwendet?", o:["Kiefer / Fichte","Nussbaum","Eiche","Teak"], c:0, e:"F√ºr Einwegverpackungen muss das Holz billig, leicht und verf√ºgbar sein."},
    {q:"Was meint der Fachmann mit dem Ausdruck ‚ÄûDas Holz arbeitet‚Äú?", o:["Macht Ger√§usche","Quillt & Schwindet","Verrottet","W√§chst"], c:1, e:"Das Quellen und Schwinden ist die wichtigste Eigenschaft bei der Konstruktion."},
    {q:"Welche der folgenden Holzarten bezeichnet man als ringporig?", o:["Eiche","Buche","Ahorn","Fichte"], c:0, e:"Bei der Eiche sieht man die gro√üen Poren im Fr√ºhholz als deutlichen Ring."},
    {q:"Was ist eine OSB-Platte (Oriented Strand Board)?", o:["Grobspanplatte","Massivholz","Vollkunststoff","MDF"], c:0, e:"Die Sp√§ne sind ausgerichtet, um der Platte mehr Festigkeit zu geben."},
    {q:"In welcher Jahreszeit bildet der Baum das dunklere Sp√§tholz?", o:["Fr√ºhling","Sommer","Winter","Immer"], c:1, e:"Im Fr√ºhling muss der Baum schnell Wasser leiten, im Sommer festigt er sich."},
    {q:"Ab welcher Holzfeuchte besteht dauerhaft die Gefahr von Pilzbefall?", o:["0 %","8 %","20 %","100 %"], c:2, e:"Pilze brauchen freies Wasser. Trockenes Holz (unter 20 %) ist sicher."},
    {q:"Warum vergraut Holz im Au√üenbereich mit der Zeit?", o:["Staub","UV-Licht & Regen","F√§ule","Pilze"], c:1, e:"Das Lignin wird zerst√∂rt und ausgewaschen, zur√ºck bleibt helle Cellulose."},
    {q:"Welcher heimische Nadelbaum besitzt keine Harzkan√§le?", o:["Fichte","Kiefer","L√§rche","Tanne"], c:3, e:"Tannenholz ist harzfrei (ein wichtiges Unterscheidungsmerkmal zur Fichte)."},
    {q:"Warum haben Pfannen oft Holzgriffe?", o:["reduziert Gewicht","Leitet Strom","Isoliert W√§rme","Brennt nicht"], c:2, e:"Holz leitet Hitze nur sehr langsam weiter, man verbrennt sich nicht die Finger."},
    {q:"Die Eibe ist ein Nadelholz. Welches typische Nadelholz-Merkmal fehlt ihr jedoch komplett?", o:["Jahresringe","Der farbige Kern","Die Harzkan√§le","Die H√§rte"], c:2, e:"Im Gegensatz zu Fichte oder Kiefer besitzt die Eibe keine Harzkan√§le."},
    {q:"Was ist das besondere Merkmal der Poren bei der Robinie?", o:["Sie sind leer","Sie sind verthyllt","Sie sind quadratisch","Mit Harz gef√ºllt"], c:1, e:"Die Thyllen verstopfen die Poren komplett, was das Holz sehr dauerhaft macht."},
    {q:"Welche Holzfeuchte stellt sich ungef√§hr ein, wenn Holz lange Zeit im Normalklima (20¬∞C/65%) gelagert wird?", o:["ca. 6 ‚Äì 8 %","ca. 12 %","ca. 18 %","ca. 30 %"], c:1, e:"Dies ist ein Standardwert f√ºr die ‚ÄûAusgleichsfeuchte‚Äú im Au√üenklima unter Dach."},
    {q:"Bei welcher Holzart muss man bei der Oberfl√§chenbeschichtung besonders mit Harzgallen rechnen?", o:["Eiche","Fichte (o. Kiefer)","Tanne","Buche"], c:1, e:"Fichte und Kiefer besitzen Harzkan√§le, die bei W√§rme auslaufen k√∂nnen."},
    {q:"Warum f√ºhlt sich Holz bei Raumtemperatur w√§rmer an als ein St√ºck Stahl?", o:["Holz heizt","Schlechter W√§rmeleiter","H√∂here Dichte","Gibt Feuchte ab"], c:1, e:"Stahl leitet die K√∂rperw√§rme sofort ab (kalt), Holz isoliert (warm)."},
    {q:"Woran erkennt man ‚ÄûBraunf√§ule‚Äú am zerst√∂rten Holz?", o:["Das Holz wird wei√ü und faserig","Das Holz zerf√§llt w√ºrfelartig (W√ºrfelbruch)","Das Holz wird blau","Das Holz wird elastisch"], c:1, e:"Der Pilz baut Cellulose ab, das braune Lignin bleibt spr√∂de zur√ºck und bricht in W√ºrfeln."},
    {q:"Woran erkennt man ‚ÄûWei√üf√§ule‚Äú?", o:["Das Holz wird hell und faserig","Das Holz wird schwarz","Es entstehen W√ºrfel","Es wird steinhart"], c:0, e:"Der Pilz baut das braune Lignin ab, die wei√üe Cellulose bleibt als weiche Faserstruktur zur√ºck."},
    {q:"Was sind ‚ÄûT√ºpfel‚Äú in der Zellwand?", o:["Ventile f√ºr den Wasseraustausch","Krankheiten","Farbpigmente","Astl√∂cher"], c:0, e:"Sie verbinden benachbarte Zellen und erm√∂glichen den Fl√ºssigkeitstransport."},
    {q:"Wo bildet ein Laubbaum Reaktionsholz (Zugholz), wenn er schief steht?", o:["Auf der Unterseite","Auf der Oberseite (Zugseite)","Im Kern","In der Wurzel"], c:1, e:"Laubb√§ume ‚Äûziehen‚Äú sich aktiv wieder gerade (im Gegensatz zu Nadelb√§umen, die dr√ºcken)."}
];

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

// Funktion: Klotzi jubeln lassen (MIT NEUEN SPR√úCHEN)
function showHappyWorm() {
    const k = document.getElementById('happyKlotzi');
    const t = document.getElementById('happyKlotziText');
    if(!k) return;

    // NEUE MOTIVATIONSSPR√úCHE
    const cheers = ["Stark!", "Super!", "Punkt f√ºr uns!", "Weiter so!", "Hammerhart!", "Klasse!", "Holz-Meister!", "Holzklasse!", "Jawoll!", "Sauber!", "richtiges Brett!", "Ma√üarbeit!", "Stabil!"];
    if(t) t.childNodes[0].nodeValue = cheers[Math.floor(Math.random() * cheers.length)];

    k.classList.remove('hidden', 'translate-y-full'); 
    k.querySelector('img').classList.add('animate-klotzi-popup');
    
    setTimeout(() => {
        k.classList.add('translate-y-full');
        k.querySelector('img').classList.remove('animate-klotzi-popup');
    }, 2500);
    setTimeout(() => k.classList.add('hidden'), 3000);
}

function triggerConfetti() {
    var duration = 3000; var end = Date.now() + duration;
    (function frame() {
        confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
        confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#d97706', '#fbbf24', '#ffffff'] });
        if (Date.now() < end) requestAnimationFrame(frame);
    }());
}

window.openAttrConfig = () => {
    document.getElementById('setupModal').classList.add('hidden');
    const list = document.getElementById('attrConfigList');
    list.innerHTML = '';
    Object.keys(attributeInfo).forEach(key => {
        const info = attributeInfo[key];
        const isSelected = activeAttributeKeys.includes(key);
        const div = document.createElement('div');
        div.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
        div.onclick = () => toggleAttribute(key, div);
        div.innerHTML = `<div class="flex items-center gap-3"><span class="text-xl">${info.icon}</span><div class="text-left leading-tight"><div class="font-bold text-sm">${info.name}</div><div class="text-[10px] opacity-70">${info.unit}</div></div></div><div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}">${isSelected ? '‚úì' : ''}</div>`;
        list.appendChild(div);
    });
    document.getElementById('attrConfigModal').classList.remove('hidden');
};

window.closeAttrConfig = () => {
    document.getElementById('attrConfigModal').classList.add('hidden');
    document.getElementById('setupModal').classList.remove('hidden');
}

function toggleAttribute(key, el) {
    const idx = activeAttributeKeys.indexOf(key);
    if (idx > -1) {
        if(activeAttributeKeys.length <= 3) { alert("Mindestens 3 Eigenschaften m√ºssen aktiv sein!"); return; }
        activeAttributeKeys.splice(idx, 1);
    } else {
        if(activeAttributeKeys.length >= 5) { return; } 
        activeAttributeKeys.push(key);
    }
    const isSelected = activeAttributeKeys.includes(key);
    el.className = `attr-toggle-btn w-full p-3 rounded-lg flex items-center justify-between cursor-pointer ${isSelected ? 'selected' : ''}`;
    el.querySelector('.w-6').className = `w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500 text-white' : 'border-gray-300 bg-white'}`;
    el.querySelector('.w-6').innerHTML = isSelected ? '‚úì' : '';
    document.getElementById('attrCountBadge').innerText = activeAttributeKeys.length;
}

function updateStatusBar(p, o){
    const total=p+o; const pct=(total===0)?50:(p/total)*100;
    const bar=document.getElementById('statusBar'); const ball=document.getElementById('statusBall');
    bar.style.width=`${pct}%`; ball.style.left=`${pct}%`;
}

function createCard(data, isRevealed, isPlayer, isActive, highlightAttr){
    const card = document.createElement('div');
    card.className = `card-3d w-full h-full relative ${isPlayer?'cursor-pointer hover-lift':''}`;
    if(!isRevealed) card.classList.add('card-flipped');
    if(isPlayer) { card.setAttribute('role', 'button'); card.setAttribute('tabindex', '0'); }

    const canSelect = isPlayer && ((gameMode==='ai' && aiGame.turn==='player' && !aiGame.roundInProgress) || (gameMode==='multiplayer' && localGameState.turn===localPlayerId && !localGameState.lastResult));
    
    const front = document.createElement('div');
    const bClass = isActive ? 'border-orange-500 ring-4 ring-orange-200' : 'border-orange-200';
    front.className = `card-front card-front-bg rounded-2xl shadow-lg border-4 ${bClass} flex flex-col transition-all`;
    let html = `<div class="pt-3 px-3 pb-1"><h2 class="text-lg sm:text-xl font-bold text-amber-900 leading-none">${data.name}</h2></div>
                <div class="mx-3 mt-1 mb-2 aspect-[4/3] rounded-xl overflow-hidden bg-white shadow-sm border border-orange-100"><img src="${data.imgTree}" class="w-full h-full object-cover"></div>
                <div class="flex-grow flex flex-col justify-start gap-1 sm:gap-2 px-2 pb-2 overflow-y-auto hide-scrollbar">`;
    
    for(const k of activeAttributeKeys){
        const info = attributeInfo[k];
        let flashClass = '';
        if(highlightAttr === k) flashClass = isActive ? 'flash-active' : 'highlight-compare';
        const rowInner = `<div class="flex items-center gap-2"><span class="text-base">${info.icon}</span><div class="flex flex-col text-left leading-none"><span class="font-bold text-gray-800 text-[10px] sm:text-sm">${info.name}</span><span class="text-[9px] text-gray-500 font-medium">${info.unit}</span></div></div><span class="text-sm font-bold text-amber-800">${data[k]}</span>`;
        if(canSelect) html += `<div onclick="window.selectAttribute('${k}')" data-attr-btn="${k}" class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl cursor-pointer hover:brightness-95 ${flashClass}">${rowInner}</div>`;
        else html += `<div class="attr-box w-full flex justify-between items-center px-2 py-1.5 rounded-xl opacity-90 ${flashClass}" data-attr-row="${k}">${rowInner}</div>`;
    }
    html += '</div>';
    front.innerHTML = html;
    const back = document.createElement('div');
    back.className = `card-back rounded-2xl shadow-lg relative ${isActive ? 'border-orange-500' : 'border-white'}`;
    if(!isPlayer && isOpponentNameBackVisible()){
        const lbl = document.createElement('div'); lbl.className = 'opponent-back-name'; lbl.innerText = data.name; back.appendChild(lbl);
    }
    card.appendChild(front); card.appendChild(back);
    return card;
}

function updateDisplayAI(){
    const pc=aiGame.playerCards.length; const ac=aiGame.aiCards.length;
    document.getElementById('playerCards').innerText=pc; document.getElementById('aiCards').innerText=ac;
    updateStatusBar(pc,ac);
    const pcEl=document.getElementById('playerCard'); pcEl.innerHTML='';
    const acEl=document.getElementById('aiCard'); acEl.innerHTML='';
    const isPTurn = aiGame.turn === 'player';
    if(aiGame.currentPlayerCard) pcEl.appendChild(createCard(aiGame.currentPlayerCard, true, true, isPTurn, null));
    if(aiGame.currentAiCard) acEl.appendChild(createCard(aiGame.currentAiCard, false, false, !isPTurn, null));
    if(aiGame.turn==='ai' && !aiGame.roundInProgress) setTimeout(aiTurn, 1000);
}

function getNumericValue(val, attr) {
    if (attr === 'dk') {
        if (typeof val === 'string' && val.includes('-')) {
            const parts = val.split('-');
            const v1 = parseFloat(parts[0]);
            const v2 = parseFloat(parts[1]);
            return (v1 + v2) / 2;
        }
        return parseFloat(val);
    }
    return parseFloat(val);
}

// 8. NEUE FUNKTION: DAS QUIZ STARTEN (Mit 4500ms Timer)
function startTieBreakerQuiz(qIndex, callback) {
    const modal = document.getElementById('quizModal');
    const timerBar = document.getElementById('quizTimerBar');
    const qText = document.getElementById('quizQuestion');
    const qOptions = document.getElementById('quizOptions');
    const statusText = document.getElementById('quizStatusText');
    const expBox = document.getElementById('quizExplanation');
    
    const question = quizQuestions[qIndex];
    qText.innerText = question.q;
    qOptions.innerHTML = '';
    statusText.innerText = "‚ö†Ô∏è Gleichstand! Quiz l√§dt...";
    expBox.classList.add('hidden'); 
    
    timerBar.classList.remove('animate-charge', 'animate-shrink');
    timerBar.style.width = "0%";
    timerBar.className = "h-full bg-amber-500 rounded-r-sm relative";
    void timerBar.offsetWidth;
    
    let buttons = [];
    question.o.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full bg-gray-100 text-gray-400 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 cursor-not-allowed";
        btn.innerText = opt;
        btn.disabled = true; 
        buttons.push({btn, idx});
        qOptions.appendChild(btn);
    });
    
    modal.classList.remove('hidden');
    timerBar.classList.add('animate-charge');
    
    setTimeout(() => {
        statusText.innerText = "‚ö° STECHEN! 10 Sekunden Zeit";
        timerBar.classList.remove('animate-charge');
        timerBar.style.width = '100%';
        void timerBar.offsetWidth;
        timerBar.className = "h-full bg-red-500 rounded-r-sm relative animate-shrink";
        playSound(sounds.quizTick);
        
        let answered = false;
        buttons.forEach(obj => {
            const {btn, idx} = obj;
            btn.className = "w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 transition active:scale-95 cursor-pointer";
            btn.disabled = false;
            
            btn.onclick = () => {
                if(answered) return;
                answered = true;
                clearTimeout(quizTimeout);
                sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
                
                const explanation = question.e || "Keine Erkl√§rung verf√ºgbar.";
                expBox.innerText = "üí° " + explanation;
                expBox.classList.remove('hidden');
                
                if(idx === question.c) {
                    btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-green-600 shadow-lg scale-105";
                    playSound(sounds.win);
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        callback('correct');
                    }, 4500); // 4.5 Sekunden warten (ge√§ndert von 3500)
                } else {
                    btn.className = "w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-red-600 shadow-md transform scale-95 opacity-50";
                    const correctBtnObj = buttons.find(b => b.idx === question.c);
                    if(correctBtnObj) correctBtnObj.btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-green-600 shadow-lg scale-105 animate-pulse";
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        callback('wrong');
                    }, 4500); // 4.5 Sekunden warten (ge√§ndert von 3500)
                }
            };
        });
        
        const quizTimeout = setTimeout(() => {
            if(!answered) {
                answered = true;
                sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
                modal.classList.add('hidden');
                callback('timeout');
            }
        }, 10000);
    }, 1500);
}

function showTieOverlay(callback) {
    const overlay = document.getElementById('tieOverlay');
    overlay.classList.remove('hidden');
    playSound(sounds.tieAlert);
    setTimeout(() => {
        overlay.classList.add('hidden');
        if(callback) callback();
    }, 2000);
}

function evaluateRoundAI(attr){
    const rawPv = aiGame.currentPlayerCard[attr];
    const rawAv = aiGame.currentAiCard[attr];
    const pv = getNumericValue(rawPv, attr);
    const av = getNumericValue(rawAv, attr);
    const logic = attributeInfo[attr].logic;
    let pWins = (logic === 'Niedrig gewinnt') ? (pv < av) : (pv > av);
    
    if(pv === av) {
        showTieOverlay(() => {
            const qIdx = Math.floor(Math.random() * quizQuestions.length);
            startTieBreakerQuiz(qIdx, (result) => {
                let roundWinner = false;
                if(result === 'correct') roundWinner = true;
                finishRoundAI(attr, rawPv, rawAv, roundWinner);
            });
        });
        return;
    }
    finishRoundAI(attr, rawPv, rawAv, pWins);
}

function finishRoundAI(attr, rawPv, rawAv, pWins) {
    const resText = pWins===true ? 'Du gewinnst!' : 'Computer gewinnt!';
    const resColor = pWins===true ? 'text-green-600' : 'text-red-600';
    document.getElementById('resultText').innerText = resText;
    document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
    document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${rawPv} vs ${rawAv}`;
    if(pWins===true) { playSound(sounds.win); showHappyWorm(); lastRoundWinningWoodName = aiGame.currentPlayerCard.name; } 
    else { lastRoundWinningWoodName = aiGame.currentAiCard.name; }
    openBottomSheet(resText);
    const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
    if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
    else { aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }
    if(aiGame.playerCards.length===0) window.endGame("Computer");
    if(aiGame.aiCards.length===0) window.endGame(aiGame.playerName);
}

function aiTurn(){
    if(aiGame.roundInProgress) return;
    scrollToTop();
    const k=activeAttributeKeys[Math.floor(Math.random()*activeAttributeKeys.length)];
    aiGame.roundInProgress = true;
    const aiCardEl = document.getElementById('aiCard');
    const row = aiCardEl.querySelector(`div[data-attr-row="${k}"]`);
    if(row) row.classList.add('flash-active'); 
    setTimeout(() => { 
        const ac=document.getElementById('aiCard').querySelector('.card-3d');
        if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
        const playerCardEl = document.getElementById('playerCard');
        const pRow = playerCardEl.querySelector(`div[data-attr-btn="${k}"]`) || playerCardEl.querySelector(`div[data-attr-row="${k}"]`);
        if(pRow) pRow.classList.add('highlight-compare');
        setTimeout(() => evaluateRoundAI(k), 2000);
    }, 500);
}

function listenToGameChanges(){
    if(!gameId) return;
    unsubscribeGame=onSnapshot(getPublicDataRef("games", gameId),(ds)=>{
        if(!ds.exists()) { window.resetGame(); return; }
        const gd=ds.data(); localGameState=gd;
        if(gd.activeAttributes) { activeAttributeKeys = gd.activeAttributes; }
        
        if(gd.quizTrigger && gd.quizTrigger.active && !document.getElementById('quizModal').dataset.active) {
             document.getElementById('quizModal').dataset.active = "true";
             showTieOverlay(() => {
                 startTieBreakerQuiz(gd.quizTrigger.qIndex, async (result) => {
                     document.getElementById('quizModal').dataset.active = "";
                     const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
                     let winner = 'tie';
                     if (result === 'correct') { winner = localPlayerId; } else if (result === 'wrong') { winner = opp; } 
                     const rawPv = localGameState.currentCards[localPlayerId][gd.quizTrigger.attr];
                     const rawOv = localGameState.currentCards[opp][gd.quizTrigger.attr];
                     await updateDoc(getPublicDataRef("games", gameId),{
                        quizTrigger: null,
                        lastResult: {winnerId:winner, attribute:gd.quizTrigger.attr, values:{[localPlayerId]:rawPv, [opp]:rawOv}}
                     });
                 });
             });
        }
        
        if((!gd.quizTrigger || !gd.quizTrigger.active) && document.getElementById('quizModal').classList.contains('hidden') === false) {
             document.getElementById('quizModal').classList.add('hidden');
             document.getElementById('quizModal').dataset.active = "";
             sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
        }

        if(gd.status==='playing'||gd.status==='finished'){
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            document.getElementById('ruleButton').classList.remove('hidden');
            if(!gd.quizTrigger) scrollToTop();
            const oppId=gd.playerIds.find(id=>id!==localPlayerId);
            document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
            document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
            const pCount = gd.players[localPlayerId]?.cards?.length||0;
            const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
            document.getElementById('playerCards').innerText = pCount;
            document.getElementById('aiCards').innerText = oCount;
            updateStatusBar(pCount, oCount);
            const highlightAttr = gd.lastResult ? gd.lastResult.attribute : null;
            const pc = document.getElementById('playerCard'); const ac = document.getElementById('aiCard');
            pc.innerHTML=''; ac.innerHTML='';
            const isPlayerTurn = gd.turn === localPlayerId;
            if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true, isPlayerTurn, highlightAttr));
            if(oppId && gd.currentCards[oppId]){
                const c = createCard(gd.currentCards[oppId], false, false, !isPlayerTurn, highlightAttr);
                ac.appendChild(c);
                if(gd.lastResult){ setTimeout(()=> { c.classList.remove('card-flipped'); playSound(sounds.flip); }, 100); }
            } else { ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte auf Gegner-Karte...</div>`; }
            
            if(gd.lastResult){
                 const wId = gd.lastResult.winnerId;
                 const iWin = wId===localPlayerId;
                 if(gd.currentCards[wId]) { lastRoundWinningWoodName = gd.currentCards[wId].name; }
                 if(!roundSoundPlayed && iWin) playSound(sounds.win);
                 roundSoundPlayed=true;
                 const resText = iWin ? 'Du gewinnst!' : (wId==='tie'?'Unentschieden':'Gegner gewinnt!');
                 document.getElementById('resultText').className = iWin ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
                 document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
                 if(iWin) showHappyWorm();
                 if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(resText);
            } else { roundSoundPlayed=false; closeBottomSheet(); }
            document.getElementById('turnIndicator').innerText = (gd.turn===localPlayerId) ? "Du bist am Zug!" : "Gegner w√§hlt...";
            if(gd.status==='finished'){
                let winnerName = "";
                if (gd.players[localPlayerId].cards.length > 0) winnerName = gd.players[localPlayerId].name;
                else if (oppId && gd.players[oppId].cards.length > 0) winnerName = gd.players[oppId].name;
                window.endGame(winnerName);
            }
        }
    });
}

window.selectAttribute = async (attr) => {
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        scrollToTop();
        aiGame.roundInProgress = true;
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`); if(btn) btn.classList.add('flash-active');
        setTimeout(() => {
            const ac=document.getElementById('aiCard').querySelector('.card-3d');
            if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
            const oppRow = document.getElementById('aiCard').querySelector(`div[data-attr-row="${attr}"]`);
            if(oppRow) oppRow.classList.add('highlight-compare');
            setTimeout(() => evaluateRoundAI(attr), 2000);
        }, 500);
    } else {
        if(!localGameState || localGameState.turn!==localPlayerId) return;
        scrollToTop();
        const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
        const rawPv = localGameState.currentCards[localPlayerId][attr];
        const rawOv = localGameState.currentCards[opp][attr];
        const pv = getNumericValue(rawPv, attr);
        const ov = getNumericValue(rawOv, attr);
        const logic = attributeInfo[attr].logic;
        let pWins = (logic === 'Niedrig gewinnt') ? (pv < ov) : (pv > ov);
        
        if(pv === ov) {
            const qIdx = Math.floor(Math.random() * quizQuestions.length);
            await updateDoc(getPublicDataRef("games", gameId),{
                quizTrigger: { active: true, attr: attr, qIndex: qIdx, timestamp: Date.now() }
            });
            return; 
        }
        const winner = pWins ? localPlayerId : opp;
        await updateDoc(getPublicDataRef("games", gameId),{
            lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:rawPv, [opp]:rawOv}}
        });
    }
};

window.startGameAI = (name) => {
    trackEvent('games_ai');
    gameMode='ai'; aiGame.playerName=name;
    window.setNavState('game');
    document.getElementById('ruleButton').classList.remove('hidden');
    document.getElementById('playerNameDisplay').innerText=name;
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
    document.getElementById('gameContainer').classList.remove('hidden');
    scrollToTop();
    updateDisplayAI();
};

let authRetries = 0;
window.createGame = async (playerName) => {
    if (!auth || !auth.currentUser) { 
        if(authRetries > 10) { alert("Verbindungsfehler"); return; }
        authRetries++; setTimeout(() => window.createGame(playerName), 500); return; 
    }
    localPlayerId = auth.currentUser.uid;
    trackEvent('games_multiplayer');
    gameMode='multiplayer';
    const lobby=document.getElementById('multiplayerLobbyModal'); lobby.classList.remove('hidden');
    gameId=Math.random().toString(36).substring(2,8).toUpperCase();
    const joinUrl=`${window.location.href.split('?')[0]}?game=${gameId}`;
    document.getElementById('shareLink').value=joinUrl;
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {text: joinUrl, width: 128, height: 128});
    
    await setDoc(getPublicDataRef("games", gameId),{
        gameId, status:'waiting', playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
        activeAttributes: activeAttributeKeys,
        createdAt:serverTimestamp()
    });
    listenToGameChanges();
};

window.joinGame = async (id, playerName) => {
    if (!auth || !auth.currentUser) { setTimeout(()=>window.joinGame(id,playerName), 500); return; }
    localPlayerId = auth.currentUser.uid;
    gameMode='multiplayer'; gameId = id;
    const ref = getPublicDataRef("games", id);
    const snap = await getDoc(ref);
    if(snap.exists() && snap.data().status==='waiting'){
        document.getElementById('lobbyTitle').textContent="Verbinde...";
        document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
        const sh=shuffleArray([...woodCards]);
        const p1=snap.data().playerIds[0];
        await updateDoc(ref,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:sh.slice(15,30),status:'online'},
            [`players.${p1}.cards`]:sh.slice(0,15),
            turn:p1, currentCards:{[p1]:sh.slice(0,15)[0],[localPlayerId]:sh.slice(15,30)[0]},
            lastResult:null
        });
        scrollToTop();
        window.setNavState('game');
        listenToGameChanges();
    } else {
        alert("Spiel nicht gefunden oder voll.");
        window.location.href = window.location.href.split('?')[0];
    }
};

window.nextRound = async () => {
    scrollToTop();
    if(gameMode==='ai'){
        aiGame.currentPlayerCard=aiGame.playerCards[0];
        aiGame.currentAiCard=aiGame.aiCards[0];
        aiGame.roundInProgress=false;
        updateDisplayAI();
    } else {
        const gs = localGameState;
        const [p1,p2] = gs.playerIds;
        let c1=gs.players[p1].cards.shift();
        let c2=gs.players[p2].cards.shift();
        const w = gs.lastResult.winnerId;
        if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
        else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
            await updateDoc(getPublicDataRef("games", gameId), {status:'finished', players:gs.players});
            return;
        }
        const nextT = w==='tie' ? gs.turn : w;
        await updateDoc(getPublicDataRef("games", gameId), {
            lastResult:null, turn:nextT, players:gs.players,
            currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
        });
    }
};

window.showFinalWinScreen = () => { document.getElementById('reflectionModal').classList.add('hidden'); };

const calculateRank = (count) => {
    if (count >= 100) return { title: "Leim-Legende", stars: 6 };
    if (count >= 50) return { title: "Astloch-Philosoph", stars: 5 };
    if (count >= 30) return { title: "Brett-Bezwinger", stars: 4 };
    if (count >= 20) return { title: "Hobel-Held", stars: 3 };
    if (count >= 10) return { title: "Schleifklotz-Schwinger", stars: 2 };
    return { title: "Werkstatt-Neuling", stars: 1 };
};

async function updateMainMenuStats(user) {
    if (!user) return;
    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'gamification', 'stats');
    try {
        const snap = await getDoc(statsRef);
        const count = snap.exists() ? (snap.data().gamesPlayed || 0) : 0;
        const rank = calculateRank(count);
        const container = document.getElementById('mainMenuStats');
        if(container) {
            container.innerHTML = `<div class="flex flex-col items-center gap-1"><div class="text-xs text-white/80 font-bold uppercase tracking-wider">Dein Rang</div><div class="flex items-center gap-2"><span class="text-xl font-bold text-white drop-shadow-md">${rank.title}</span><div class="flex text-amber-400 text-sm drop-shadow-sm">${Array(rank.stars).fill('‚òÖ').join('')}</div></div><div class="flex items-center gap-2 mt-1"><span class="text-lg filter drop-shadow">üî•</span><span class="font-bold text-white text-lg drop-shadow-md">${count} Spiele</span></div></div>`;
            container.classList.remove('hidden');
        }
    } catch (e) {}
}
onAuthStateChanged(auth, (user) => { if (user) updateMainMenuStats(user); });

async function updateLeaderboard(name) {
    if (!auth.currentUser) return;
    const ref = getPublicDataRef("leaderboard", auth.currentUser.uid);
    try {
        await setDoc(ref, { name: name, wins: increment(1), last_win: serverTimestamp() }, { merge: true });
    } catch (e) {}
}

window.endGame = async (winnerName) => {
    document.getElementById('gameContainer').classList.add('hidden');
    document.getElementById('bottomSheet').classList.add('hidden');
    document.getElementById('bottomSheetBackdrop').classList.add('hidden');
    const isWin = (winnerName === (gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name));
    const gameOverImg = document.getElementById('gameOverWorm');
    if(gameOverImg) { gameOverImg.src = isWin ? "https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" : "https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_lose.png?raw=true"; }
    let newGamesCount = 0; let rankData = null;
    if (auth.currentUser) {
        const statsRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'gamification', 'stats');
        try {
            await setDoc(statsRef, { gamesPlayed: increment(1), lastPlayed: serverTimestamp() }, { merge: true });
            const snap = await getDoc(statsRef);
            newGamesCount = snap.data().gamesPlayed || 0;
            rankData = calculateRank(newGamesCount);
        } catch (e) {}
        if (isWin) { await updateLeaderboard(gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name); }
    }
    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    if (isWin) {
        title.innerText = "GEWONNEN!";
        title.className = "text-3xl font-black mb-2 text-green-600";
        text.innerHTML = `Herzlichen Gl√ºckwunsch! Du hast gewonnen.<br><br><div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg"><span class="text-2xl">üî•</span> ${newGamesCount} Flammen gesammelt</div><div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
        triggerConfetti();
    } else {
        title.innerText = "VERLOREN";
        title.className = "text-3xl font-black mb-2 text-gray-600";
        text.innerHTML = `Schade, ${winnerName} hat gewonnen.<br>Dranbleiben lohnt sich!<br><br><div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg"><span class="text-2xl">üî•</span> ${newGamesCount} Flammen gesammelt</div><div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
    }
    document.getElementById('gameOverModal').classList.remove('hidden');
};

window.showLeaderboard = async () => { 
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    try {
        const q=query(getPublicDataRef("leaderboard"), orderBy("wins","desc"), limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine Eintr√§ge</div>'; return; }
        list.innerHTML = snap.docs.map((d,i)=>`<div class="flex justify-between p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100"><span class="font-bold text-gray-700">${i+1}. ${d.data().name}</span><span class="font-bold text-amber-600">${d.data().wins} üèÜ</span></div>`).join('');
    } catch(e){ list.innerHTML='<div class="text-center text-red-400 text-sm">Fehler beim Laden</div>'; }
};

window.showNamePrompt = (mode) => {
    document.getElementById('setupModal').classList.add('hidden');
    document.getElementById('nameModal').classList.remove('hidden');
    const btn=document.getElementById('nameSubmitButton');
    const clone=btn.cloneNode(true);
    btn.parentNode.replaceChild(clone,btn);
    window.setNavState('name_input');
    clone.addEventListener('click',()=>{
        const n=document.getElementById('playerName').value.trim();
        if(!n)return;
        document.getElementById('nameModal').classList.add('hidden');
        if(mode==='ai') window.startGameAI(n);
        else if(mode==='multiplayer') window.createGame(n);
        else if(mode==='join') window.joinGame(gameId, n); 
    });
};
window.copyShareLink = () => { const l=document.getElementById('shareLink'); l.select(); try { document.execCommand('copy'); } catch(e){} };

// MODIFIED SHOW GAME INFO TO HIDE HEADER
window.showGameInfo = () => {
    document.getElementById('mainHeader').classList.add('hidden'); // HIDE HEADER
    const list = document.getElementById('infoCategoryList');
    if (!list) return;
    let html = '';
    for (const key in attributeInfo) {
        const info = attributeInfo[key];
        const isBetter = info.logic === 'Hoch gewinnt';
        html += `<div class="p-3 rounded-xl border-2 ${isBetter ? 'border-green-400 bg-green-50' : 'border-blue-400/80 bg-blue-50/50'} mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-lg font-bold text-gray-800">${info.icon} ${info.name}</span>
                        <span class="text-sm font-semibold ${isBetter ? 'text-green-700' : 'text-blue-700'}">${isBetter ? '‚¨Ü Hoch' : '‚¨á Niedrig'}</span>
                    </div>
                    <p class="text-xs text-gray-700 leading-snug">${info.description || ''}</p>
                 </div>`;
    }
    list.innerHTML = html;
    document.getElementById('gameInfoModal').classList.remove('hidden');
}

// MODIFIED CLOSE GAME INFO TO SHOW HEADER
window.closeGameInfo = () => {
    document.getElementById('gameInfoModal').classList.add('hidden');
    document.getElementById('mainHeader').classList.remove('hidden'); // SHOW HEADER
};

window.closeInfoModal = () => document.getElementById('infoModal').classList.add('hidden');
window.closeLeaderboard = () => { document.getElementById('leaderboardModal').classList.add('hidden'); document.getElementById('gameOverModal').classList.remove('hidden'); };
window.resetGame = () => location.reload();

function closeBottomSheet(){ const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bs.classList.add('translate-y-full'); bd.classList.add('opacity-0'); setTimeout(()=>{bs.classList.add('hidden');bd.classList.add('hidden');},300); }
function openBottomSheet(title){ if(title)document.getElementById('resultText').innerText=title; const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bd.classList.remove('hidden'); bs.classList.remove('hidden'); setTimeout(()=>{bd.classList.remove('opacity-0'); bs.classList.remove('translate-y-full');},10); }

document.getElementById('bsNextBtn').addEventListener('click',()=> { closeBottomSheet(); window.nextRound(); });

// Settings Listeners
const soundToggle = document.getElementById('soundToggle');
if(soundToggle) { soundToggle.checked = !isMuted; soundToggle.addEventListener('change', function() { isMuted = !this.checked; }); }
const revealToggle = document.getElementById('revealBackToggle');
if(revealToggle) { revealToggle.checked = isOpponentNameBackVisible(); revealToggle.addEventListener('change', function() { setOpponentNameBackVisible(this.checked); if(gameMode === 'ai' && !document.getElementById('gameContainer').classList.contains('hidden')) updateDisplayAI(); }); }
document.getElementById('bsInfoBtn').addEventListener('click', ()=>{ 
    const wood = lastRoundWinningWoodName || (aiGame.currentPlayerCard ? aiGame.currentPlayerCard.name : "Eiche");
    const content = detailedWoodInfo[wood] || `<p>Keine Detailinfo zu ${wood}</p>`;
    const modalContent = document.getElementById('infoModalContent');
    modalContent.innerHTML = `<h4 class="font-bold text-xl mb-2">${wood}</h4>` + content;
    
    const cardData = woodCards.find(c=>c.name===wood);
    if(cardData) {
        const img1 = cardData.imgTree || 'https://placehold.co/400x300?text=Bild+fehlt';
        const img2 = cardData.imgCross || 'https://placehold.co/400x300?text=Detail+fehlt';
        
        modalContent.innerHTML += `
            <div class="grid grid-cols-2 gap-3 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Maserung</p>
                    <img src="${img1}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.openImageViewer(this.src)">
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Detailansicht</p>
                    <img src="${img2}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.openImageViewer(this.src)">
                </div>
            </div>`;
    }
    
    document.getElementById('infoModal').classList.remove('hidden');
});

const p=new URLSearchParams(window.location.search);
if(p.get('game')){ 
    document.getElementById('setupModal').classList.add('hidden');
    gameId=p.get('game'); 
    window.showNamePrompt('join'); 
}

// IMAGE VIEWER LOGIC (LIGHTBOX)
window.openImageViewer = (src) => {
    document.getElementById('fullSizeImage').src = src;
    document.getElementById('imageViewerModal').classList.remove('hidden');
};
window.closeImageViewer = () => {
    document.getElementById('imageViewerModal').classList.add('hidden');
};
</script>
</body>
</html>
