<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;font-weight:300}

        .card-3d{transform-style:preserve-3d;transition:transform .6s}
        .card-flipped{transform:rotateY(180deg)}
        .card-front,.card-back{backface-visibility:hidden;position:absolute;width:100%;height:100%}
        .card-back{transform:rotateY(180deg);background-image:url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/65fd843a4db1ee434faaf81a32f77951a5afb72a/images/background_card.jpg');background-size:cover;background-position:center}

        .animate-pop-in{animation:pop-in .5s ease-out forwards}
        .animate-glow-win{animation:glow-win 1.2s ease-out}
        .animate-glow-lose{animation:glow-lose 1.2s ease-out}
        @keyframes pop-in{0%{transform:scale(0);opacity:0}70%{transform:scale(1.2);opacity:1}100%{transform:scale(1)}}
        @keyframes glow-win{0%{box-shadow:0 0 0 0 rgba(74,222,128,0)}50%{box-shadow:0 0 30px 15px rgba(74,222,128,.6)}100%{box-shadow:0 0 0 0 rgba(74,222,128,0)}}
        @keyframes glow-lose{0%{box-shadow:0 0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 30px 15px rgba(248,113,113,.6)}100%{box-shadow:0 0 0 0 rgba(248,113,113,0)}}
        .hover-lift:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
        .status-flash-win{animation:flash-green 1.2s ease-out}
        .status-flash-lose{animation:flash-red 1.2s ease-out}
        @keyframes flash-green{50%{background-color:#22c55e;box-shadow:0 0 15px #22c55e}}
        @keyframes flash-red{50%{background-color:#ef4444;box-shadow:0 0 15px #ef4444}}

        .falling-star{position:absolute;font-size:7rem;z-index:100;animation:fall-and-fade 1.2s ease-in forwards}
        @keyframes fall-and-fade{0%{transform:translateY(-30px) scale(1.5);opacity:0}30%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(var(--end-y)) scale(.3);opacity:0}}

        .card-background{
            background-image:url('https://raw.githubusercontent.com/aufdemholzweg/holzquartett/e7cfc18394e2e7f2d0b91df1138b0d7bc7930699/images/background_front.jpg');
            background-size:cover;background-position:center
        }

        /* Name auf der R√ºckseite der Gegnerkarte (Top-Drittel), halb so gro√ü wie vorher */
        .opponent-back-name{
            position:absolute;top:12%;left:0;width:100%;text-align:center;
            font-family:Arial,Helvetica,sans-serif;color:#e5e7eb;font-weight:700;letter-spacing:.02em;line-height:1.1;z-index:2;
            font-size:clamp(0.8rem,3vw,1.375rem); /* halbiert */
            text-shadow:0 1px 2px rgba(0,0,0,.25);pointer-events:none;padding:0 .5rem
        }

        /* Bottom-sheet dimmer (hell) */
        .dimmer-light{background:rgba(0,0,0,0.2)}
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
<header class="bg-white shadow-sm border-b-2 border-amber-200">
    <div class="max-w-6xl mx-auto px-4 p-3">
        <h1 class="text-2xl font-bold text-amber-800 text-center">üå≥ HOLZEN! üå≥</h1>
        <p class="text-xs text-gray-500 text-center mt-1">von Christopher Lehr, in Verbindung mit meiner Masterarbeit</p>
    </div>
</header>

<div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
        <h2 class="text-2xl font-bold text-amber-800 mb-6">Spielmodus w√§hlen</h2>
        <div class="space-y-4">
            <button onclick="window.showNamePrompt('ai')" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üéÆ gegen Computer</button>
            <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors text-lg">üßë‚Äçü§ù‚Äçüßë online gegen Freunde</button>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-4">
            <div class="flex items-center justify-center space-x-3">
                <span class="text-gray-700">üîá</span>
                <label for="soundToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="soundToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                </label>
                <span class="text-gray-700">üîä</span>
            </div>

            <div class="flex items-center justify-center space-x-3">
                <span class="text-gray-700">üôà Gegner-Holz aus</span>
                <label for="revealBackToggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="revealBackToggle" class="sr-only peer">
                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                <span class="text-gray-700">üëÄ Gegner-Holz an</span>
            </div>
        </div>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">Dein Name</h2>
        <div class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Bitte gib deinen Namen ein:</label>
                <input type="text" id="playerName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Spielername">
            </div>
            <button id="nameSubmitButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Weiter</button>
        </div>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
        <h2 id="lobbyTitle" class="text-2xl font-bold text-amber-800 mb-4">Warte auf Mitspieler...</h2>
        <p id="lobbyText" class="text-gray-700 mb-6">Teile diesen Link mit deinem Freund, um das Spiel zu starten:</p>
        <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
            <input id="shareLink" type="text" class="w-full bg-transparent text-center text-blue-600" readonly>
        </div>
        <button onclick="window.copyShareLink()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Link kopieren</button>
        <p id="lobbyStatus" class="mt-6 text-green-600 font-semibold"></p>
    </div>
</div>

<div id="gameContainer" class="hidden max-w-6xl mx-auto px-4 py-4 relative">
    <div id="animationContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"></div>
    <div class="max-w-md mx-auto mb-1 space-y-1">
        <div class="flex justify-center space-x-2">
            <div id="playerScoreBox" class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center relative">
                <p id="playerNameDisplay" class="text-base font-bold text-amber-600 truncate"></p>
                <p class="text-sm text-gray-500">Karten: <span id="playerCards" class="font-semibold">15</span></p>
            </div>
            <div class="w-1/2 bg-white rounded-xl shadow-lg p-2 text-center">
                <p id="opponentNameDisplay" class="text-base font-bold text-red-600">Computer</p>
                <p class="text-sm text-gray-500">Karten: <span id="aiCards" class="font-semibold">15</span></p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden border border-gray-300">
            <div id="statusBar" class="h-full rounded-l-full transition-all duration-500" style="width:50%;background-color:#f59e0b"></div>
            <div class="absolute inset-0 flex justify-center items-center"><div class="w-0.5 h-full bg-white opacity-75"></div></div>
        </div>
    </div>

    <div class="flex justify-center space-x-2 sm:space-x-2 mb-4 max-w-md mx-auto">
        <div class="text-center w-1/2"><div id="playerCard" class="relative aspect-[20/38] perspective-1000"></div></div>
        <div class="text-center w-1/2"><div id="aiCard" class="relative aspect-[20/38] perspective-1000"></div></div>
    </div>

    <div class="bg-white rounded-xl shadow-lg px-1 pt-1 pb-0.5 mt-4 text-center mx-auto flex flex-col items-center max-w-md w-full min-h-[6rem]">
        <div id="turnIndicator" class="hidden text-sm font-semibold p-1"></div>
        <div id="attributeSelection"><h3 class="text-base font-semibold text-gray-700 mb-1">W√§hle eine Eigenschaft!</h3></div>
        <div id="resultDisplay" class="hidden flex flex-col flex-grow w-full px-2">
            <h3 id="resultText" class="text-lg sm:text-xl font-bold"></h3>
            <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mt-auto pb-0.5"></p>
        </div>
        </div>
</div>

<div id="reflectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl text-center">
        <h2 class="text-2xl font-bold text-amber-800 mb-4">üéâ Super gespielt! Zeit zum Reflektieren!</h2>
        <p id="reflectionQuestion" class="text-gray-700 mb-6 text-left"></p>
        <textarea id="reflectionAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent min-h-[100px]" placeholder="Deine Begr√ºndung..."></textarea>
        <button onclick="window.showFinalWinScreen()" class="mt-6 w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Weiter zum Ergebnis</button>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
        <h2 id="gameOverTitle" class="text-3xl font-bold mb-3"></h2>
        <p id="gameOverText" class="text-gray-600 mb-6"></p>
        <div class="space-y-2">
            <button onclick="window.showLeaderboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">üèÜ Bestenliste anzeigen</button>
            <button onclick="window.resetGame()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg">üîÑ Neues Spiel</button>
        </div>
    </div>
</div>

<div id="leaderboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold text-amber-800 mb-6 text-center">üèÜ Bestenliste</h2>
        <div id="leaderboardList" class="space-y-1 mb-6"></div>
        <button onclick="window.closeLeaderboard()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg">Schlie√üen</button>
    </div>
</div>

<div id="infoModal" class="hidden fixed inset-0 dimmer-light flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl relative">
        <button onclick="window.closeInfoModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-gray-600">&times;</button>
        <h2 id="infoModalTitle" class="text-2xl font-bold text-amber-800 mb-3">Zusatzwissen</h2>
        <div id="infoModalContent" class="text-gray-700 space-y-2 max-h-[60vh] overflow-y-auto"></div>
    </div>
</div>

<div id="bottomSheetBackdrop" class="hidden fixed inset-0 dimmer-light z-40"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-50 flex justify-center px-4 pb-4">
  <div class="bg-white rounded-t-2xl shadow-2xl border border-amber-200 w-full max-w-md p-4">
    <h3 id="bottomSheetTitle" class="text-xl font-bold mb-2 text-center">Ergebnis</h3>
    <div class="flex gap-3">
        <button id="bsInfoBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg">Zusatzwissen</button>
        <button id="bsNextBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-3 rounded-lg">N√§chster Zug</button>
    </div>
  </div>
</div>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI",
  authDomain: "holzquartett-3a177.firebaseapp.com",
  projectId: "holzquartett-3a177",
  storageBucket: "holzquartett-3a177.appspot.com",
  messagingSenderId: "1081595025073",
  appId: "1:1081595025073:web:bc571fffb6e4f20b27f490",
  measurementId: "G-HKLWFJE83K"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* State */
let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false;
let isMuted=false;
let roundSoundPlayed=false;

/* Audio */
const sounds={
  flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'),
  win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/894e048eea71ba49921abfe6827bd8dc723f8c2d/gewonnen.mp3?raw=true'),
  chime:new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c744c8.mp3'),
  starWin:new Audio('https://cdn.pixabay.com/audio/2022/10/28/audio_73b90209e7.mp3')
};
sounds.flip.volume=.5; sounds.win.volume=.4; sounds.chime.volume=.6; sounds.starWin.volume=.7;

function playSound(a){ if(isMuted) return; a.currentTime=0; a.play().catch(()=>{}); }

/* Persistenz: Gegner-Holzname sichtbar? */
function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

/* Daten */
const woodCards=[
 {name:"Eiche",dk:2,haerte:85,quellenSchwindenRadial:4.0,dichte:650,gewicht:12000},
 {name:"Buche",dk:5,haerte:80,quellenSchwindenRadial:5.8,dichte:720,gewicht:14000},
 {name:"Kiefer",dk:3,haerte:40,quellenSchwindenRadial:3.5,dichte:520,gewicht:11000},
 {name:"Fichte",dk:4,haerte:35,quellenSchwindenRadial:3.6,dichte:450,gewicht:11000},
 {name:"Tanne",dk:4,haerte:38,quellenSchwindenRadial:3.5,dichte:460,gewicht:10000},
 {name:"L√§rche",dk:3,haerte:55,quellenSchwindenRadial:3.7,dichte:590,gewicht:12000},
 {name:"Birke",dk:5,haerte:60,quellenSchwindenRadial:5.4,dichte:650,gewicht:13000},
 {name:"Ahorn",dk:5,haerte:75,quellenSchwindenRadial:4.8,dichte:630,gewicht:12500},
 {name:"Esche",dk:5,haerte:90,quellenSchwindenRadial:4.9,dichte:700,gewicht:13000},
 {name:"Kirsche",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:600,gewicht:11500},
 {name:"Nussbaum",dk:3,haerte:65,quellenSchwindenRadial:4.0,dichte:640,gewicht:12000},
 {name:"Douglasie",dk:3,haerte:45,quellenSchwindenRadial:3.5,dichte:510,gewicht:12000},
 {name:"Zeder",dk:2,haerte:42,quellenSchwindenRadial:2.8,dichte:480,gewicht:9500},
 {name:"Mahagoni",dk:2,haerte:55,quellenSchwindenRadial:3.0,dichte:550,gewicht:10500},
 {name:"Teak",dk:1,haerte:60,quellenSchwindenRadial:2.5,dichte:650,gewicht:11000},
 {name:"Bambus",dk:4,haerte:50,quellenSchwindenRadial:3.0,dichte:400,gewicht:18000},
 {name:"Pappel",dk:5,haerte:25,quellenSchwindenRadial:4.5,dichte:380,gewicht:9000},
 {name:"Weide",dk:5,haerte:30,quellenSchwindenRadial:4.0,dichte:420,gewicht:8000},
 {name:"Linde",dk:5,haerte:35,quellenSchwindenRadial:3.8,dichte:530,gewicht:9000},
 {name:"Ulme",dk:3,haerte:75,quellenSchwindenRadial:4.5,dichte:680,gewicht:11500},
 {name:"Kastanie",dk:2,haerte:50,quellenSchwindenRadial:3.5,dichte:600,gewicht:10000},
 {name:"Robinie",dk:1,haerte:80,quellenSchwindenRadial:3.0,dichte:730,gewicht:15000},
 {name:"Hemlock",dk:4,haerte:40,quellenSchwindenRadial:3.6,dichte:500,gewicht:10000},
 {name:"Zypresse",dk:2,haerte:48,quellenSchwindenRadial:3.0,dichte:520,gewicht:9000},
 {name:"Redwood",dk:2,haerte:35,quellenSchwindenRadial:2.8,dichte:400,gewicht:8500},
 {name:"Hickory",dk:3,haerte:95,quellenSchwindenRadial:5.5,dichte:750,gewicht:14000},
 {name:"Wenge",dk:2,haerte:88,quellenSchwindenRadial:3.8,dichte:880,gewicht:16000},
 {name:"Zebrano",dk:3,haerte:70,quellenSchwindenRadial:4.0,dichte:750,gewicht:13000},
 {name:"Palisander",dk:2,haerte:82,quellenSchwindenRadial:3.0,dichte:850,gewicht:16000},
 {name:"Ebenholz",dk:1,haerte:98,quellenSchwindenRadial:3.2,dichte:1200,gewicht:16500}
];

const woodInfo = {
 "Eiche": { info: `Eiche (QE) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/eiche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/eiche_2.jpg?raw=true" },
 "Buche": { info: `Buche (BU) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/buche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/buche_2.jpg?raw=true" },
 "Kiefer": { info: `Kiefer (KI) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kiefer_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kiefer_2.jpg?raw=true" },
 "Fichte": { info: `Fichte (FI) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/fichte_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/fichte_2.jpg?raw=true" },
 "Tanne": { info: `Tanne (TA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/tanne_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/tanne_2.jpg?raw=true" },
 "L√§rche": { info: `L√§rche (LA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/laerche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/laerche_2.jpg?raw=true" },
 "Birke": { info: `Birke (BI) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/birke_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/birke_2.jpg?raw=true" },
 "Ahorn": { info: `Ahorn (AM) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ahorn_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ahorn_2.jpg?raw=true" },
 "Esche": { info: `Esche (ES) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/esche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/esche_2.jpg?raw=true" },
 "Kirsche": { info: `Kirsche (KR) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kirsche_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kirsche_2.jpg?raw=true" },
 "Nussbaum": { info: `Nussbaum (NU) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/nussbaum_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/nussbaum_2.jpg?raw=true" },
 "Douglasie": { info: `Douglasie (DO) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/douglasie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/douglasie_2.jpg?raw=true" },
 "Zeder": { info: `Zeder (ZE) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zeder_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zeder_2.jpg?raw=true" },
 "Mahagoni": { info: `Mahagoni (MA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/mahagoni_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/mahagoni_2.jpg?raw=true" },
 "Teak": { info: `Teak (TE) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/teak_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/teak_2.jpg?raw=true" },
 "Bambus": { info: `Bambus (BA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/bambus_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/bambus_2.jpg?raw=true" },
 "Pappel": { info: `Pappel (PA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/pappel_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/pappel_2.jpg?raw=true" },
 "Weide": { info: `Weide (WE) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/weide_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/weide_2.jpg?raw=true" },
 "Linde": { info: `Linde (LI) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/linde_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/linde_2.jpg?raw=true" },
 "Ulme": { info: `Ulme (UL) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ulme_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ulme_2.jpg?raw=true" },
 "Kastanie": { info: `Kastanie (KA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kastanie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/kastanie_2.jpg?raw=true" },
 "Robinie": { info: `Robinie (RO) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/robinie_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/robinie_2.jpg?raw=true" },
 "Hemlock": { info: `Hemlock (HE) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hemlock_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hemlock_2.jpg?raw=true" },
 "Zypresse": { info: `Zypresse (ZY) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zypresse_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zypresse_2.jpg?raw=true" },
 "Redwood": { info: `Redwood (RW) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/redwood_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/redwood_2.jpg?raw=true" },
 "Hickory": { info: `Hickory (HI) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hickory_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/hickory_2.jpg?raw=true" },
 "Wenge": { info: `Wenge (WE-NE) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/wenge_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/wenge_2.jpg?raw=true" },
 "Zebrano": { info: `Zebrano (ZE-RA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zebrano_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/zebrano_2.jpg?raw=true" },
 "Palisander": { info: `Palisander (PA) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/palisander_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/palisander_2.jpg?raw=true" },
 "Ebenholz": { info: `Ebenholz (EB) ...`, bildBaum: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ebenholz_1.jpg?raw=true", bildQuerschnitt: "https://github.com/aufdemholzweg/holzquartett/blob/main/images/ebenholz_2.jpg?raw=true" }
};

const reflectionQuestions=[
 "Stell dir vor, du sollst einen stabilen und langlebigen Esstisch ...",
 "Welches Holz w√ºrdest du f√ºr Gartenm√∂bel w√§hlen ...",
 "Eine K√ºchenarbeitsplatte muss schnittfest ...",
 "F√ºr einen stark beanspruchten Dielenboden ...",
 "Du sollst den Korpus einer Akustikgitarre bauen ...",
 "Fenster sind wechselnder Luftfeuchte ausgesetzt ...",
 "F√ºr ein Modellflugzeug oder ein leichtes Regal ...",
 "Robinie vs. L√§rche im Au√üenbereich ...",
 "Gebogener Handlauf, welches Holz ...",
 "Vergleiche Rohdichte und E-Modul Fichte/Eiche ...",
 "Hohe Quell-/Schwindma√üe, Risiken ...",
 "Hammerstiel: Eigenschaften ...",
 "Eiche + Eisen ‚Üí Verf√§rbungen, warum ...",
 "Weiche H√∂lzer und Oberfl√§chen ...",
 "Furniere: dekorative H√∂lzer ...",
 "Drei heimische H√∂lzer mit Eigenschaften ...",
 "Holz als CO‚ÇÇ-Speicher ...",
 "FSC/PEFC Bedeutung ...",
 "Teak DK 1 ‚Äì Einsatz ...",
 "Bambus ist ein Gras ‚Äì Konsequenzen ...",
 "Upcycling alter Eichenbalken ...",
 "Starker Hell-Dunkel-Kontrast: Kombis ...",
 "Eiche/Esche: ringporig ‚Äì Optik ...",
 "Kinderspielzeug: Kriterien ...",
 "Kirsche/L√§rche: Nachdunkeln ...",
 "Minimalistisches M√∂bel: Ahorn/Birke ...",
 "Rustikale Almh√ºtte: welche H√∂lzer ...",
 "Sch√ºlerprojekt: Werkst√ºckidee ...",
 "Terrasse: Robinie vs. L√§rche...",
 "Welche Eigenschaft ist spielentscheidend ...",
 "Neue Kategorie vorschlagen und begr√ºnden ..."
];

const attributeInfo={
 dk:{icon:'üõ°Ô∏è',name:'Dauerhaftigkeit (DK)',color:'blue'},
 haerte:{icon:'üíé',name:'Druckfestigkeit (N/mm¬≤)',color:'blue'},
 quellenSchwindenRadial:{icon:'‚ÜîÔ∏è',name:'Quellen/Schwinden (%)',color:'blue'},
 dichte:{icon:'‚öñÔ∏è',name:'Rohdichte (kg/m¬≥)',color:'blue'},
 gewicht:{icon:'üèãÔ∏è',name:'E-Modul (N/mm¬≤)',color:'blue'}
};

/* AI-Modus */
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};

/* Bottom-Sheet helpers */
const bottomSheet = document.getElementById('bottomSheet');
const bottomSheetBackdrop = document.getElementById('bottomSheetBackdrop');
const bsTitle = document.getElementById('bottomSheetTitle');
const bsInfoBtn = document.getElementById('bsInfoBtn');
const bsNextBtn = document.getElementById('bsNextBtn');

function openBottomSheet(title){
  bsTitle.textContent = title || 'Ergebnis';
  bottomSheetBackdrop.classList.remove('hidden');
  bottomSheet.classList.remove('hidden');
}

function closeBottomSheet(){
  bottomSheetBackdrop.classList.add('hidden');
  bottomSheet.classList.add('hidden');
}

/* Init */
document.addEventListener('DOMContentLoaded',async()=>{
  try{await signInAnonymously(auth);}catch(e){console.error(e)}
  onAuthStateChanged(auth,(user)=>{
    if(user){
      localPlayerId=user.uid;
      const p=new URLSearchParams(window.location.search);
      const gid=p.get('game');
      if(gid){gameId=gid;gameMode='multiplayer';window.showNamePrompt('join');}
    }
  });

  // Sound toggle
  const soundToggle=document.getElementById('soundToggle');
  const savedMute=localStorage.getItem('holzquartett_isMuted');
  isMuted=savedMute==='true';
  soundToggle.checked=!isMuted;
  soundToggle.addEventListener('change',(e)=>{
    isMuted=!e.target.checked;
    localStorage.setItem('holzquartett_isMuted',isMuted);
    if(!isMuted) playSound(sounds.chime);
  });

  // Opponent Name on Back toggle
  const revealBackToggle=document.getElementById('revealBackToggle');
  revealBackToggle.checked=isOpponentNameBackVisible();
  revealBackToggle.addEventListener('change',(e)=>{
    setOpponentNameBackVisible(e.target.checked);
    // Nur im AI-Modus Karten neu rendern
    if(gameMode==='ai'){
      displayCardsAI();
    }
  });

  document.getElementById('nameSubmitButton').addEventListener('click',window.submitName);

  bsNextBtn.addEventListener('click',window.nextRound);
  bsInfoBtn.addEventListener('click',window.showLastWoodInfo);

  if(!gameId) document.getElementById('setupModal').classList.remove('hidden');
});

/* UI Logic */
window.showNamePrompt=function(mode){
  gameMode=mode;
  document.getElementById('setupModal').classList.add('hidden');
  document.getElementById('nameModal').classList.remove('hidden');
  document.getElementById('playerName').focus();
};

window.submitName=function(){
  const nameInput=document.getElementById('playerName');
  const playerName=nameInput.value.trim();
  if(!playerName) return alert('Bitte gib deinen Namen ein.');
  document.getElementById('nameModal').classList.add('hidden');
  localStorage.setItem('holzquartett_playerName',playerName);
  
  if(gameMode==='ai'){
    startGameAI(playerName);
  }else if(gameMode==='multiplayer'){
    const p=new URLSearchParams(window.location.search);
    const gid=p.get('game');
    if(gid){
      joinGame(gid,playerName);
    }else{
      createGame(playerName);
    }
  }
};

window.showWoodInfo=function(woodName){
  const modal=document.getElementById('infoModal');
  const title=document.getElementById('infoModalTitle');
  const content=document.getElementById('infoModalContent');
  title.textContent=`Zusatzwissen ‚Äì ${woodName}`;
  const key=Object.keys(woodInfo).find(k=>k.toLowerCase()===woodName.toLowerCase());
  const info=key?woodInfo[key]:null;
  if(info){
    content.innerHTML=`
      <p class="text-left text-sm sm:text-base">${info.info||'Keine Beschreibung verf√ºgbar.'}</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
        <div>
          <h4 class="font-semibold mb-2 text-center text-sm sm:text-base">Baum</h4>
          <img src="${info.bildBaum||''}" alt="Bild von ${woodName} Baum" class="w-full max-h-48 sm:max-h-60 h-auto rounded-lg object-contain mx-auto border" onerror="this.parentElement.style.display='none';">
        </div>
        <div>
          <h4 class="font-semibold mb-2 text-center text-sm sm:text-base">Querschnitt</h4>
          <img src="${info.bildQuerschnitt||''}" alt="Bild von ${woodName} Querschnitt" class="w-full max-h-48 sm:max-h-60 h-auto rounded-lg object-contain mx-auto border" onerror="this.parentElement.style.display='none';">
        </div>
      </div>`;
    modal.classList.remove('hidden');
  }
};

window.showLastWoodInfo=function(){
  closeBottomSheet();
  const woodName=gameMode==='ai' ? lastRoundWinningWoodName : localGameState?.lastResult?.woodName;
  if(woodName) window.showWoodInfo(woodName);
}

window.closeInfoModal=function(){
  document.getElementById('infoModal').classList.add('hidden');
  // Wenn im AI-Modus, Bottom-Sheet wieder √∂ffnen, da Info-Button von dort aufgerufen wurde
  if(gameMode==='ai' && aiGame.roundInProgress && !document.getElementById('gameOverModal').classList.contains('hidden')){
    openBottomSheet(document.getElementById('resultText').textContent);
  }
};

window.resetGame=function(){
  if(unsubscribeGame) unsubscribeGame();
  localGameState={};
  gameId=null;
  gameMode=null;
  document.getElementById('gameContainer').classList.add('hidden');
  document.getElementById('gameOverModal').classList.add('hidden');
  document.getElementById('setupModal').classList.remove('hidden');
  document.getElementById('resultDisplay').classList.add('hidden');
  document.getElementById('attributeSelection').classList.add('hidden');
  document.getElementById('turnIndicator').classList.add('hidden');
  document.getElementById('playerCard').innerHTML='';
  document.getElementById('aiCard').innerHTML='';
  window.location.search=''; // Multiplayermodus-Parameter entfernen
};

function updateStatusBar(playerCount, opponentCount){
  const total=playerCount+opponentCount;
  if(total===0) return;
  const playerPercent=(playerCount/total)*100;
  const statusBar=document.getElementById('statusBar');
  statusBar.style.width=`${playerPercent}%`;
  statusBar.style.backgroundColor=playerPercent>50?'#10b981':(playerPercent<50?'#ef4444':'#f59e0b');
}

function triggerWinStarAnimation(){
  const container=document.getElementById('animationContainer');
  const star=document.createElement('div');
  star.className='falling-star text-green-500';
  star.textContent='‚≠ê';
  // Zuf√§llige Positionierung √ºber der Spielerkarte
  const playerCardRect=document.getElementById('playerCard').getBoundingClientRect();
  const startX=playerCardRect.left+playerCardRect.width/2;
  const startY=playerCardRect.top-50; // Etwas √ºber dem Bildschirm
  const endY=playerCardRect.bottom-playerCardRect.height/3;

  star.style.left=`${startX}px`;
  star.style.top=`${startY}px`;
  star.style.setProperty('--end-y',`${endY-startY}px`);

  container.appendChild(star);
  playSound(sounds.starWin);
  star.addEventListener('animationend',()=>star.remove());
}

function triggerLoseStarAnimation(){
  const container=document.getElementById('animationContainer');
  const star=document.createElement('div');
  star.className='falling-star text-red-500';
  star.textContent='‚ùå';
  // Zuf√§llige Positionierung √ºber der KI-Karte
  const aiCardRect=document.getElementById('aiCard').getBoundingClientRect();
  const startX=aiCardRect.left+aiCardRect.width/2;
  const startY=aiCardRect.top-50; // Etwas √ºber dem Bildschirm
  const endY=aiCardRect.bottom-aiCardRect.height/3;

  star.style.left=`${startX}px`;
  star.style.top=`${startY}px`;
  star.style.setProperty('--end-y',`${endY-startY}px`);

  container.appendChild(star);
  playSound(sounds.starWin);
  star.addEventListener('animationend',()=>star.remove());
}

window.showFinalWinScreen=async function(){
  // Reflection speichern (simuliert)
  const playerName=localStorage.getItem('holzquartett_playerName')||'Unbekannt';
  const reflectionAnswer=document.getElementById('reflectionAnswer').value.trim();
  console.log(`Reflexionsantwort von ${playerName}: ${reflectionAnswer}`);
  
  // Bestenliste aktualisieren
  if(gameMode==='ai'){
    const userRef=doc(db,"leaderboard",auth.currentUser.uid);
    try{await updateDoc(userRef,{name:playerName,wins:increment(1),lastWin:serverTimestamp()},{merge:true});}catch(e){console.error("Fehler beim Speichern des Sieges:",e);}
  }

  document.getElementById('reflectionModal').classList.add('hidden');
  const modal=document.getElementById('gameOverModal');
  const title=document.getElementById('gameOverTitle');
  const text=document.getElementById('gameOverText');
  
  if(gameMode==='ai'){
    title.textContent='SPIEL VORBEI!';
    title.className='text-3xl font-bold mb-3 text-green-600';
    text.textContent=`Du hast das Spiel gegen den Computer gewonnen. Dein Wissen √ºber Holz ist beeindruckend, ${playerName}!`;
  } else if(gameMode==='multiplayer'){
     const oppId=localGameState.playerIds.find(id=>id!==localPlayerId);
     const oppName=localGameState.players[oppId]?.name||'Gegner';
     title.textContent='SPIEL VORBEI!';
     title.className='text-3xl font-bold mb-3 text-green-600';
     text.textContent=`Du hast ${oppName} besiegt! Gut gespielt!`;
  }
  
  modal.classList.remove('hidden');
}


function createCard(cardData, isRevealed, isPlayer, playedAttribute=null, result=null){
  const card=document.createElement('div');
  card.className=`card-3d w-full h-full ${isRevealed?'':'card-flipped'}`;
  card.id=`card-${(cardData?.name||'').replace(/[^a-zA-Z0-9]/g,'-').toLowerCase()}`;

  const front=document.createElement('div');
  const winClass=result==='win'?'animate-glow-win':(result==='lose'?'animate-glow-lose':'');
  front.className=`card-front card-background rounded-xl shadow-lg border-2 border-amber-300 p-2 sm:p-3 flex flex-col h-full ${winClass}`;

  const canSelect=isPlayer && ((gameMode==='ai' && !aiGame.roundInProgress && aiGame.turn==='player') || (gameMode==='multiplayer' && localGameState?.turn===localPlayerId && !localGameState?.lastResult));
  const showInfoBtn=isPlayer && ((gameMode==='ai' && aiGame.roundInProgress) || (gameMode==='multiplayer' && !!localGameState?.lastResult));

  const cardName=cardData?.name||'Unbekannt';
  const safeId=(cardName||'').replace(/[^a-zA-Z0-9]/g,'-')||'unknown';

  const wi=woodInfo[cardName]||{};
  const treeImg=wi.bildBaum||'https://placehold.co/160x120/d1d5db/374151?text=?';

  // FIX START: Bild bleibt sichtbar, Info-Button wird als Overlay angezeigt.
  const headerRight = `
    <div class="flex-shrink-0 relative w-24 h-16 sm:w-28 sm:h-20">
      <img src="${treeImg}" alt="${cardName}" id="wood-image-icon-${safeId}" class="absolute inset-0 w-full h-full object-cover rounded-xl border-2 border-amber-200">
      <button id="player-info-button-${safeId}" onclick="window.showWoodInfo('${cardName.replace(/'/g,"\\'")}')" class="${showInfoBtn?'':'hidden'} absolute top-0 right-0 w-6 h-6 sm:w-8 sm:h-8 bg-purple-600 text-white rounded-bl-lg rounded-tr-lg flex items-center justify-center text-xs sm:text-sm font-bold hover:bg-purple-700 z-20 shadow-md p-0 leading-none">üí°</button>
    </div>`;
  // FIX END

  let attrs='<div class="space-y-1 mt-auto">';
  for(const key in attributeInfo){
    const a=attributeInfo[key];
    const v=cardData?.[key]??'?';
    const fv=typeof v==='number'?v.toLocaleString('de-DE'):v;
    const unit=a.name.match(/\(([^)]+)\)/);
    const unitText=unit?`<span class="block text-[10px] sm:text-xs text-gray-500 leading-tight">(${unit[1]})</span>`:'';
    const label=(key==='quellenSchwindenRadial')?'Quellen/Schw.':a.name.replace(/\s*\(([^)]+)\)/,'');

    const isSelected=key===playedAttribute;
    const isWin=isSelected && result==='win';
    const isLose=isSelected && result==='lose';
    const isTie=isSelected && result==='tie';

    let baseBg = canSelect ? 'bg-amber-100' : 'bg-amber-50';
    let hov = canSelect ? 'hover:bg-amber-200' : '';
    let border = canSelect ? 'border-amber-600' : 'border-amber-300';
    let txt = canSelect ? 'text-amber-700' : 'text-amber-800';
    
    if(isSelected){
        baseBg = isWin ? 'bg-green-200' : (isLose ? 'bg-red-200' : 'bg-yellow-200');
        border = isWin ? 'border-green-600' : (isLose ? 'border-red-600' : 'border-yellow-600');
        txt = isWin ? 'text-green-800' : (isLose ? 'text-red-800' : 'text-yellow-800');
        hov = '';
    }

    const common=`w-full flex justify-between items-center py-0.5 sm:py-1 px-1 rounded-lg text-left border ${border} ${baseBg}`;

    if(canSelect){
      attrs+=`<button onclick="window.selectAttribute('${key}')" class="${common} ${hov} transition-colors"><div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${a.icon}</span><div><span class="text-[11px] sm:text-xs font-medium leading-tight">${label}</span>${unitText}</div></div><span class="font-semibold ${txt} text-sm sm:text-base">${fv}</span></button>`;
    }else{
      attrs+=`<div class="${common}"><div class="flex items-center space-x-1 sm:space-x-2"><span class="text-xs sm:text-sm">${a.icon}</span><div><span class="text-[11px] sm:text-xs font-medium leading-tight text-gray-700">${label}</span>${unitText}</div></div><span class="font-semibold ${txt} text-sm sm:text-base">${fv}</span></div>`;
    }
  }
  attrs+='</div>';

  // Header mit dynamischer Mindesth√∂he, damit das gr√∂√üere Bild Platz hat
  front.innerHTML=`
    <div class="flex justify-between items-center w-full mb-2 px-1 min-h-[72px] sm:min-h-[84px]">
      <h3 class="text-base sm:text-lg font-bold text-amber-800 truncate text-left mr-2">${cardName}</h3>
      ${headerRight}
    </div>
    ${attrs}`;

  const back=document.createElement('div');
  back.className='card-back rounded-xl shadow-lg border-2 border-amber-300 flex items-center justify-center relative overflow-hidden';

  // Gegner-Holzname auf R√ºckseite zeigen, falls eingestellt
  if(!isRevealed && !isPlayer && isOpponentNameBackVisible()){
    const label=document.createElement('div');
    label.className='opponent-back-name';
    label.textContent=cardName;
    back.appendChild(label);
  }

  card.appendChild(front);
  card.appendChild(back);
  return card;
}

function displayMultiplayerCards(gameData){
  if(!gameData.currentCards||!gameData.playerIds) return;
  const opp=gameData.playerIds.find(id=>id!==localPlayerId);
  const myCardData=gameData.currentCards[localPlayerId];
  const oppCardData=gameData.currentCards[opp];
  
  const pc=document.getElementById('playerCard');
  const ac=document.getElementById('aiCard');
  pc.innerHTML='';
  ac.innerHTML='';

  let playedAttr=null, result=null, oppResult=null;
  if(gameData.lastResult){
    playedAttr=gameData.lastResult.attribute;
    result=gameData.lastResult.winnerId===localPlayerId?'win':(gameData.lastResult.winnerId===opp?'lose':'tie');
    oppResult=gameData.lastResult.winnerId===opp?'win':(gameData.lastResult.winnerId===localPlayerId?'lose':'tie');
  }

  if(myCardData) pc.appendChild(createCard(myCardData,true,true,playedAttr,result));
  else pc.innerHTML=`<div class="card-front bg-gray-200 ...">Keine Karte</div>`;

  if(oppCardData){
    const isRevealed=!!gameData.lastResult;
    ac.appendChild(createCard(oppCardData,isRevealed,false,playedAttr,oppResult));
    // Wenn aufgedeckt, Flip-Animation triggern
    if(isRevealed && !gameData._cardFlipped){
        const aiCardEl=document.getElementById('aiCard').querySelector('.card-3d');
        if(aiCardEl){
             aiCardEl.classList.remove('card-flipped');
             playSound(sounds.flip);
             gameData._cardFlipped=true;
        }
    }
  }else ac.innerHTML=`<div class="card-front bg-gray-200 ...">Keine Karte</div>`;
}

async function multiplayerSelectAttribute(attribute){
  if(localGameState?.turn!==localPlayerId || localGameState.lastResult || !attributeInfo[attribute]) return;

  const ref=doc(db,"games",gameId);
  try{
    await updateDoc(ref,{
      currentAttribute:attribute,
      lastActivity:serverTimestamp()
    });
    // Warten auf den Gegner und das Ergebnis
    document.getElementById('attributeSelection').classList.add('hidden');
    document.getElementById('turnIndicator').textContent='Warte auf Zug des Gegners...';

  }catch(e){console.error("Fehler beim Attribut w√§hlen:",e); alert("Ein Fehler ist aufgetreten.");}
}

async function multiplayerNextRound(){
  if(localGameState.status==='finished'){ endGameMultiplayer(); return; }
  
  closeBottomSheet();
  if(!localGameState.lastResult) return;
  
  const gs=localGameState;
  const p1=gs.playerIds[0], p2=gs.playerIds[1];
  let p1Cards=[...(gs.players[p1].cards||[])];
  let p2Cards=[...(gs.players[p2].cards||[])];
  
  const c1=p1Cards.shift(), c2=p2Cards.shift();

  if(gs.lastResult.winnerId!=='tie'){
    const winnerCards=gs.lastResult.winnerId===p1?p1Cards:p2Cards;
    const loserCards=gs.lastResult.winnerId===p1?p2Cards:p1Cards;
    
    // Gewinner nimmt Karten an sich
    winnerCards.push(gs.currentCards[gs.lastResult.winnerId]);
    winnerCards.push(gs.currentCards[gs.lastResult.winnerId===p1?p2:p1]);
    
    if(gs.lastResult.winnerId===p1){
      p1Cards=winnerCards; p2Cards=loserCards;
    }else{
      p1Cards=loserCards; p2Cards=winnerCards;
    }
  } else {
    // Unentschieden: Karten bleiben unter den Decks
    if(c1) p1Cards.push(c1);
    if(c2) p2Cards.push(c2);
  }

  if(p1Cards.length===0 || p2Cards.length===0){
    await updateDoc(doc(db,"games",gameId),{status:'finished',players:{[p1]:{...gs.players[p1],cards:p1Cards},[p2]:{...gs.players[p2],cards:p2Cards}},currentCards:{[p1]:null,[p2]:null},lastResult:null});
    return;
  }

  const nextTurn = gs.lastResult.winnerId==='tie' ? gs.turn : gs.lastResult.winnerId;
  await updateDoc(doc(db,"games",gameId),{
    lastResult:null,
    turn:nextTurn,
    players:{[p1]:{...gs.players[p1],cards:p1Cards},[p2]:{...gs.players[p2],cards:p2Cards}},
    currentCards:{[p1]:p1Cards[0]||null,[p2]:p2Cards[0]||null},
    lastActivity:serverTimestamp(),
    _cardFlipped: false // Reset
  });
}

/* Controller */
window.selectAttribute=function(attr){
  if(gameMode==='ai') selectAttributeAI(attr);
  else if(gameMode==='multiplayer') multiplayerSelectAttribute(attr);
};

window.nextRound=function(){
  if(gameMode==='ai') nextRoundAI();
  else if(gameMode==='multiplayer') multiplayerNextRound();
};

/* Helpers */
function shuffleArray(a){const s=[...a]; for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]];} return s;}

/* AI Flow */
let lastRoundWinningWoodName = null;

function startGameAI(name){
  aiGame.playerName=name;
  document.getElementById('playerNameDisplay').textContent=name;
  document.getElementById('opponentNameDisplay').textContent='Computer';
  const sh=shuffleArray(woodCards);
  aiGame.playerCards=sh.slice(0,15);
  aiGame.aiCards=sh.slice(15,30);
  aiGame.currentPlayerCard=aiGame.playerCards[0];
  aiGame.currentAiCard=aiGame.aiCards[0];
  aiGame.roundInProgress=false;
  aiGame.turn='player';
  
  document.getElementById('attributeSelection').classList.remove('hidden');
  document.getElementById('resultDisplay').classList.add('hidden');
  document.getElementById('turnIndicator').classList.remove('hidden');
  document.getElementById('gameContainer').classList.remove('hidden');
  window.scrollTo(0,0);
  
  updateDisplayAI();
  displayCardsAI();
}

function displayCardsAI(){
  const pc=document.getElementById('playerCard');
  const ac=document.getElementById('aiCard');
  pc.innerHTML='';
  ac.innerHTML='';

  // Player card is always revealed (isRevealed=true) and isPlayer=true
  if(aiGame.currentPlayerCard) pc.appendChild(createCard(aiGame.currentPlayerCard,true,true,aiGame.playedAttribute,aiGame.result));
  else pc.innerHTML=`<div class="card-front bg-gray-200 ...">Keine Karte</div>`;

  if(aiGame.currentAiCard){
    const reveal=aiGame.roundInProgress; // Only reveal opponent card when round is in progress
    ac.appendChild(createCard(aiGame.currentAiCard,reveal,false,aiGame.playedAttribute,aiGame.aiResult));
    // Flip animation on reveal
    if(reveal){
      const aiCardEl=document.getElementById('aiCard').querySelector('.card-3d');
      if(aiCardEl){
        aiCardEl.classList.remove('card-flipped');
        playSound(sounds.flip);
      }
    }
  }else ac.innerHTML=`<div class="card-front bg-gray-200 ...">Keine Karte</div>`;
}

function selectAttributeAI(attribute){
  if(aiGame.roundInProgress || aiGame.turn!=='player' || !aiGame.currentPlayerCard || !aiGame.currentAiCard || !attributeInfo[attribute]) return;

  aiGame.roundInProgress=true;
  aiGame.playedAttribute=attribute;
  
  const pv=aiGame.currentPlayerCard[attribute];
  const av=aiGame.currentAiCard[attribute];
  if(pv===undefined||av===undefined){
    aiGame.roundInProgress=false;
    return;
  }
  
  // KI-Karte aufdecken (Flip-Animation) - Wird jetzt in displayCardsAI() gemacht
  displayCardsAI();

  let pWins;
  if(attribute==='quellenSchwindenRadial' || attribute==='dk'){
    pWins = pv<av ? true : (av<pv ? false : 'tie'); // Bei DK/Schwinden gewinnt der niedrigere Wert
  } else{
    pWins = pv>av ? true : (av>pv ? false : 'tie'); // Sonst gewinnt der h√∂here Wert
  }

  aiGame.result = pWins===true ? 'win' : (pWins===false ? 'lose' : 'tie');
  aiGame.aiResult = pWins===true ? 'lose' : (pWins===false ? 'win' : 'tie');


  setTimeout(()=>{
    const pMove=aiGame.playerCards.shift(), aMove=aiGame.aiCards.shift();
    let nextTurn=aiGame.turn;
    let resultTitle = 'ü§ù Unentschieden!';

    if(pWins===true){
      if(pMove) aiGame.playerCards.push(pMove);
      if(aMove) aiGame.playerCards.push(aMove);
      nextTurn='player';
      resultTitle='üéâ Du gewinnst!';
      lastRoundWinningWoodName = aiGame.currentPlayerCard.name;
    } 
    else if(pWins===false){
      if(aMove) aiGame.aiCards.push(aMove);
      if(pMove) aiGame.aiCards.push(pMove);
      nextTurn='ai';
      resultTitle='üòû KI gewinnt!';
      lastRoundWinningWoodName = aiGame.currentAiCard.name;
    } 
    else { // Tie
      if(pMove) aiGame.playerCards.push(pMove);
      if(aMove) aiGame.aiCards.push(aMove);
      lastRoundWinningWoodName = (Math.random() < 0.5 ? aiGame.currentPlayerCard.name : aiGame.currentAiCard.name);
    }
    
    // Karten mit Ergebnissen neu rendern, um die Hervorhebung zu zeigen
    displayCardsAI();

    const res=document.getElementById('resultText');
    const resCls= pWins===true ? 'text-green-600' : (pWins===false ? 'text-red-600' : 'text-yellow-600');
    res.textContent= resultTitle;
    res.className=`text-lg sm:text-xl font-bold ${resCls}`;
    
    document.getElementById('resultDetails').textContent=`${attributeInfo[attribute].name.split(' (')[0]}: ${pv.toLocaleString('de-DE')} vs ${av.toLocaleString('de-DE')}`;
    document.getElementById('attributeSelection').classList.add('hidden');
    document.getElementById('resultDisplay').classList.remove('hidden');
    
    // 2s Pause, dann Bottom-Sheet
    setTimeout(()=>{
      openBottomSheet(resultTitle.replace(/^[^A-Za-z√Ñ√ñ√ú√§√∂√º√ü]+/,'').trim());
    },2000);

    if(pWins===true){
      playSound(sounds.win);
      triggerWinStarAnimation();
    } else if(pWins===false){
      triggerLoseStarAnimation();
    }

    aiGame.turn=nextTurn;
    updateDisplayAI();
    checkGameOverAI();
    window.scrollTo({top:0,behavior:'smooth'});
  },1000); // KI "denkt" 1s
}

function aiSelectAttribute(){
  if(aiGame.roundInProgress || aiGame.turn!=='ai' || !aiGame.currentPlayerCard || !aiGame.currentAiCard) return;

  aiGame.roundInProgress=true;
  
  // Einfache KI-Strategie: W√§hle das Attribut, bei dem die eigene Karte den gr√∂√üten Vorteil hat (oder den gr√∂√üten Nachteil beim Gegner)
  let bestAttr=null;
  let maxAdvantage=-Infinity; // Gr√∂√üter Vorteil (h√∂herer Wert) oder gr√∂√üter Nachteil (niedrigerer Wert bei Schwinden/DK)

  for(const key in attributeInfo){
    const pv=aiGame.currentPlayerCard[key];
    const av=aiGame.currentAiCard[key];
    if(pv===undefined || av===undefined) continue;

    let advantage;
    if(key==='quellenSchwindenRadial' || key==='dk'){
      // Gewinner ist der niedrigere Wert. Vorteil = Gegnerwert - eigener Wert. Hohe positive Zahl = gut.
      advantage=av-pv; 
    }else{
      // Gewinner ist der h√∂here Wert. Vorteil = eigener Wert - Gegnerwert. Hohe positive Zahl = gut.
      advantage=pv-av;
    }

    if(advantage>maxAdvantage){
      maxAdvantage=advantage;
      bestAttr=key;
    }
  }

  // Wenn kein klarer Vorteil (maxAdvantage <= 0), w√§hle zuf√§llig
  if(maxAdvantage<=0 || !bestAttr){
    const availableKeys=Object.keys(attributeInfo);
    bestAttr=availableKeys[Math.floor(Math.random()*availableKeys.length)];
  }

  aiGame.playedAttribute=bestAttr;
  document.getElementById('turnIndicator').textContent=`Computer w√§hlt: ${attributeInfo[bestAttr].name.split(' (')[0]}`;


  // Simulation des Zuges nach 1,5 Sekunden
  setTimeout(()=>selectAttributeAI(bestAttr),1500);
}


function nextRoundAI(){
  // Animationen zur√ºcksetzen
  aiGame.playedAttribute=null;
  aiGame.result=null;
  aiGame.aiResult=null;

  document.querySelectorAll('#playerCard .card-front, #aiCard .card-front').forEach(e=>e.classList.remove('animate-glow-win','animate-glow-lose'));

  if(aiGame.playerCards.length===0||aiGame.aiCards.length===0){
    if(!document.getElementById('gameOverModal').classList.contains('hidden')){
      // Ist bereits am Ende, passiert nichts
    } else {
      endGameAI();
    }
    return;
  }

  closeBottomSheet();

  aiGame.currentPlayerCard=aiGame.playerCards[0];
  aiGame.currentAiCard=aiGame.aiCards[0];
  aiGame.roundInProgress=false;
  document.getElementById('resultDisplay').classList.add('hidden');

  updateDisplayAI();
  displayCardsAI();

  if(aiGame.turn==='ai'){
    document.getElementById('attributeSelection').classList.add('hidden');
    aiSelectAttribute();
  } else{
    document.getElementById('attributeSelection').classList.remove('hidden');
  }
}

function updateDisplayAI(){
  const pc=aiGame.playerCards.length, oc=aiGame.aiCards.length;
  document.getElementById('playerCards').textContent=pc;
  document.getElementById('aiCards').textContent=oc;
  updateStatusBar(pc,oc);

  const ti=document.getElementById('turnIndicator');
  ti.classList.remove('hidden');

  if(aiGame.roundInProgress){
    if(!document.getElementById('resultDisplay').classList.contains('hidden')) ti.textContent='';
    else if(aiGame.turn==='ai'){
      ti.textContent='Computer √ºberlegt...';
      ti.className='text-sm font-semibold p-1 text-gray-500';
    } else ti.textContent='';
  }else if(aiGame.turn==='player'){
    ti.textContent='Dein Zug!';
    ti.className='text-sm font-semibold p-1 text-amber-600 status-flash-win';
  } else{
    ti.textContent='Computer ist am Zug!';
    ti.className='text-sm font-semibold p-1 text-red-600 status-flash-lose';
  }
}

function checkGameOverAI(){
  if(aiGame.playerCards.length===0){
    endGameAI('lose');
  } else if(aiGame.aiCards.length===0){
    // Gewonnen, zeige Reflexions-Modal
    const modal=document.getElementById('reflectionModal');
    document.getElementById('reflectionQuestion').textContent=
      reflectionQuestions[Math.floor(Math.random()*reflectionQuestions.length)];
    modal.classList.remove('hidden');
    document.getElementById('reflectionAnswer').focus();
    closeBottomSheet();
  }
}

function endGameAI(result='win'){
  const modal=document.getElementById('gameOverModal');
  const title=document.getElementById('gameOverTitle');
  const text=document.getElementById('gameOverText');
  
  if(result==='lose'){
    title.textContent='LEIDER VERLOREN';
    title.className='text-3xl font-bold mb-3 text-red-600';
    text.textContent=`Der Computer hat dich besiegt. Die holztechnische Ausbildung hat noch Luft nach oben.`;
  } else {
    // Wenn 'win' direkt aufgerufen, ohne Reflexion
    title.textContent='SPIEL VORBEI!';
    title.className='text-3xl font-bold mb-3 text-green-600';
    text.textContent=`Du hast das Spiel gegen den Computer gewonnen. Dein Wissen √ºber Holz ist beeindruckend!`;
  }
  
  modal.classList.remove('hidden');
  closeBottomSheet();
}

/* Multiplayer */
window.copyShareLink=async()=>{
  const el=document.getElementById('shareLink');
  try{await navigator.clipboard.writeText(el.value);}catch{el.select();document.execCommand('copy');}
  hasCopiedShareLink=true;
  const s=document.getElementById('lobbyStatus');
  if(s) s.textContent='Link kopiert. Warte auf Mitspieler...';
  
  if(localGameState&&(localGameState.status==='playing'||localGameState.status==='finished')){
    document.getElementById('multiplayerLobbyModal').classList.add('hidden');
    document.getElementById('gameContainer').classList.remove('hidden');
    updateMultiplayerUI(localGameState);
  }
};

/* Multiplayer minimal (wie in deiner Fassung) */
async function createGame(playerName){
  const lobby=document.getElementById('multiplayerLobbyModal');
  lobby.classList.remove('hidden');
  hasCopiedShareLink=false;
  gameId=Math.random().toString(36).substring(2,8).toUpperCase();
  const base=window.location.href.split('?')[0];
  document.getElementById('shareLink').value=`${base}?game=${gameId}`;
  
  const ref=doc(db,"games",gameId);
  const data={
    gameId,
    status:'waiting',
    playerIds:[localPlayerId],
    players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
    createdAt:serverTimestamp()
  };
  try{
    await setDoc(ref,data);
    listenToGameChanges();
  }catch(e){alert("Fehler beim Erstellen des Spiels.");}
}

async function joinGame(id,playerName){
  const ref=doc(db,"games",id);
  try{
    const snap=await getDoc(ref);
    if(snap.exists()&&snap.data().status==='waiting'&&snap.data().playerIds.length===1){
      document.getElementById('lobbyTitle').textContent="Spiel wird beigetreten...";
      document.getElementById('lobbyText').textContent="Moment, die Karten werden gemischt.";
      document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
      hasCopiedShareLink=true;

      const shuffled=shuffleArray([...woodCards]);
      const p1=snap.data().playerIds[0];
      const p1Cards=shuffled.slice(0,15);
      const p2Cards=shuffled.slice(15,30);

      await updateDoc(ref,{
        status:'playing',
        playerIds:[p1,localPlayerId],
        [`players.${localPlayerId}`]:{name:playerName,cards:p2Cards,status:'online'},
        [`players.${p1}.cards`]:p1Cards,
        turn:p1,
        currentCards:{[p1]:p1Cards[0],[localPlayerId]:p2Cards[0]},
        lastResult:null,
        lastActivity:serverTimestamp()
      });

      listenToGameChanges();
    }else{
      alert("Spiel nicht gefunden, bereits voll oder beendet.");
      window.location.search='';
    }
  }catch(e){alert("Fehler beim Beitreten zum Spiel."); window.location.search='';}
}

function listenToGameChanges(){
  if(!gameId) return;
  const ref=doc(db,"games",gameId);
  unsubscribeGame=onSnapshot(ref,(ds)=>{
    if(!ds.exists()){
      if(gameMode==='multiplayer'){alert("Das Spiel wurde beendet oder gel√∂scht."); resetGame();}
      return;
    }
    const gameData=ds.data();
    localGameState=gameData;

    if(gameData.status==='playing'||gameData.status==='finished'){
      if(hasCopiedShareLink || (gameData.playerIds.includes(localPlayerId)&&gameData.playerIds.length===2)){
        document.getElementById('multiplayerLobbyModal').classList.add('hidden');
        document.getElementById('gameContainer').classList.remove('hidden');
        updateMultiplayerUI(gameData);
      }else if(!hasCopiedShareLink && gameData.playerIds.length===2){
        const s=document.getElementById('lobbyStatus');
        if(s) s.textContent='Mitspieler ist beigetreten! Klicke ‚ÄûLink kopieren‚Äú, um zu starten.';
      }
    }else if(gameData.status==='waiting'){
      document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
    }

  },(e)=>console.error(e));
}

function updateMultiplayerUI(gameData){
  if(!gameData||!gameData.players||!gameData.playerIds) return;

  const oppId=gameData.playerIds.find(id=>id!==localPlayerId);

  document.getElementById('playerNameDisplay').textContent=gameData.players[localPlayerId]?.name||'Du';
  document.getElementById('playerCards').textContent=gameData.players[localPlayerId]?.cards?.length??'?';
  
  if(oppId && gameData.players[oppId]){
    document.getElementById('opponentNameDisplay').textContent=gameData.players[oppId].name;
    document.getElementById('aiCards').textContent=gameData.players[oppId].cards?.length??'?';
  }else{
    document.getElementById('opponentNameDisplay').textContent="Wartet...";
    document.getElementById('aiCards').textContent='?';
  }

  updateStatusBar(gameData.players[localPlayerId]?.cards?.length??0, gameData.players[oppId]?.cards?.length??0);
  displayMultiplayerCards(gameData);

  const ti=document.getElementById('turnIndicator');
  ti.classList.remove('hidden');
  document.getElementById('resultDisplay').classList.add('hidden');
  document.getElementById('attributeSelection').classList.add('hidden');
  closeBottomSheet();

  if(gameData.status==='finished'){
    endGameMultiplayer();
    return;
  }

  if(gameData.lastResult){
    // Ergebnis anzeigen
    const result=gameData.lastResult.winnerId===localPlayerId?'win':(gameData.lastResult.winnerId===oppId?'lose':'tie');
    const resText=result==='win'?'üéâ Du gewinnst!':(result==='lose'?'üòû Du verlierst!':'ü§ù Unentschieden!');
    const resCls= result==='win' ? 'text-green-600' : (result==='lose' ? 'text-red-600' : 'text-yellow-600');
    
    document.getElementById('resultText').textContent=resText;
    document.getElementById('resultText').className=`text-lg sm:text-xl font-bold ${resCls}`;
    
    const attrName=attributeInfo[gameData.lastResult.attribute]?.name.split(' (')[0]||'Eigenschaft';
    document.getElementById('resultDetails').textContent=`${attrName}: ${gameData.lastResult.playerValue} vs ${gameData.lastResult.opponentValue}`;

    document.getElementById('resultDisplay').classList.remove('hidden');
    ti.textContent='';
    openBottomSheet(resText.replace(/^[^A-Za-z√Ñ√ñ√ú√§√∂√º√ü]+/,'').trim());

    if(result==='win'){
      playSound(sounds.win);
      triggerWinStarAnimation();
    } else if(result==='lose'){
      triggerLoseStarAnimation();
    }

  }else if(gameData.turn===localPlayerId){
    // Eigener Zug
    ti.textContent='Dein Zug!';
    ti.className='text-sm font-semibold p-1 text-amber-600 status-flash-win';
    document.getElementById('attributeSelection').classList.remove('hidden');
  }else if(gameData.turn===oppId){
    // Gegner ist am Zug
    ti.textContent=`Warte auf ${gameData.players[oppId].name}...`;
    ti.className='text-sm font-semibold p-1 text-gray-500';
  }
}

function endGameMultiplayer(){
  const modal=document.getElementById('reflectionModal');
  const title=document.getElementById('gameOverTitle');
  const text=document.getElementById('gameOverText');
  const oppId=localGameState.playerIds.find(id=>id!==localPlayerId);
  
  if(localGameState.players[localPlayerId]?.cards?.length>0){
    // Gewonnen, zeige Reflexions-Modal
    const modal=document.getElementById('reflectionModal');
    document.getElementById('reflectionQuestion').textContent=
      reflectionQuestions[Math.floor(Math.random()*reflectionQuestions.length)];
    modal.classList.remove('hidden');
    document.getElementById('reflectionAnswer').focus();
    
    // update best list
    const playerName=localStorage.getItem('holzquartett_playerName')||'Unbekannt';
    const userRef=doc(db,"leaderboard",auth.currentUser.uid);
    try{updateDoc(userRef,{name:playerName,wins:increment(1),lastWin:serverTimestamp()},{merge:true});}catch(e){console.error("Fehler beim Speichern des Sieges:",e);}
    
  } else {
    // Verloren
    document.getElementById('gameContainer').classList.add('hidden');
    title.textContent='LEIDER VERLOREN';
    title.className='text-3xl font-bold mb-3 text-red-600';
    text.textContent=`${localGameState.players[oppId].name} hat dich besiegt. Die holztechnische Ausbildung hat noch Luft nach oben.`;
    document.getElementById('gameOverModal').classList.remove('hidden');
  }
}


/* Leaderboard */
window.showLeaderboard=async function(){
  const list=document.getElementById('leaderboardList');
  list.innerHTML='<p class="text-center text-gray-500">Lade Bestenliste...</p>';
  document.getElementById('gameOverModal').classList.add('hidden');
  document.getElementById('leaderboardModal').classList.remove('hidden');

  try{
    const q=query(collection(db,"leaderboard"),orderBy("wins","desc"),limit(10));
    const snap=await getDocs(q);

    if(snap.empty){
      list.innerHTML='<p class="text-gray-500 text-center">Noch keine Eintr√§ge vorhanden.</p>';
      return;
    }

    list.innerHTML=snap.docs.map((d,i)=>{
      const data=d.data();
      const safe=(data.name||'Unbekannt').replace(/</g,"&lt;").replace(/>/g,"&gt;");
      return `<div class="flex justify-between items-center p-3 ${i%2===0?'bg-gray-50':'bg-white'} rounded-lg"><span class="font-semibold">${i+1}. ${safe}</span><span class="text-sm text-gray-600">${data.wins||0} Siege</span></div>`;
    }).join('');

  }catch(e){
    list.innerHTML='<p class="text-red-500 text-center">Fehler beim Laden der Bestenliste.</p>';
  }
};

window.closeLeaderboard=function(){
  document.getElementById('leaderboardModal').classList.add('hidden');
  if(localGameState?.status==='finished' || (gameMode==='ai' && (aiGame.playerCards.length===0 || aiGame.aiCards.length===0))){
    document.getElementById('gameOverModal').classList.remove('hidden');
  } else {
    document.getElementById('setupModal').classList.remove('hidden');
  }
};
</script>

</body>
</html>
